# PROJECT DUMP
# Root: /home/blackkungfu/manyagi
# Generated: 2025-11-15 02:34:17.467021
# Limits: total‚âà300.0MB, per-file‚âà1000KB
# Skips: .cache, .git, .husky, .next, .turbo, .venv, .vercel, .vscode, _scanscratch, build, coverage, cypress, dist, node_modules, out, playwright, scan_reports, venv
# Lockfiles excluded: bun.lockb, package-lock.json, package.lock.json, pnpm-lock.yaml, yarn.lock
# ENV INCLUDED: NO (use --include-env to include .env files)
# NOTE: This script file and the output file are excluded.

## ROUTES (Next.js-style)
- /
- /404
- /500
- /about
- /admin
- /api/admin/fulfillment/retry
- /api/admin/quick-create-product
- /api/admin/upload-asset
- /api/admin/upload-asset-multi
- /api/capital/subscriptions-admin
- /api/checkout/create-session
- /api/events
- /api/order-details
- /api/posts
- /api/posts/:slug
- /api/products
- /api/realty/:slug
- /api/realty/availability
- /api/realty/book
- /api/realty/booking-success
- /api/realty/booking-summary
- /api/realty/calendar-blocks
- /api/realty/cleanup-holds
- /api/realty/create-checkout
- /api/realty/external-blocks
- /api/realty/ical
- /api/realty/ical-export
- /api/realty/lead
- /api/realty/property
- /api/realty/quote
- /api/realty/rates
- /api/realty/reservations-admin
- /api/realty/send-booking-confirmation
- /api/realty/sync-ical
- /api/realty/test-email
- /api/realty/upcoming
- /api/realty/webhook
- /api/site-config
- /api/stripe-webhook
- /api/stripe/charge
- /api/track
- /blog
- /blog/:slug
- /capital
- /cart
- /coming-soon
- /contact
- /dashboard
- /designs
- /events
- /links
- /login
- /media
- /media/:slug
- /privacy
- /products
- /publishing
- /r/:code
- /realty
- /realty/:slug
- /realty/booking/:slug
- /signup
- /tech
- /tech/:slug
- /terms
- /thank-you
- /track

### Dynamic Routes
- /r/:code  ‚Üê pages/r/[code].js
- /realty/:slug  ‚Üê pages/realty/[slug].js
- /blog/:slug  ‚Üê pages/blog/[slug].js
- /tech/:slug  ‚Üê pages/tech/[slug].js
- /media/:slug  ‚Üê pages/media/[slug].js
- /realty/booking/:slug  ‚Üê pages/realty/booking/[slug].js
- /api/realty/:slug  ‚Üê pages/api/realty/[slug].js
- /api/posts/:slug  ‚Üê pages/api/posts/[slug].js

## DIRECTORY TREE
manyagi/
‚îú‚îÄ‚îÄ components
‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AffiliatesForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AffiliatesTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AnalyticsTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AssetsTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AttachToProperty.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BlogTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BundlesForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BundlesTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CalendarSyncPanel.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CapitalProductForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CapitalTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DesignsTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EventsTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IcalSyncPanel.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MediaShowcaseForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MediaTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MultiUploader.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OverviewTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PropertyForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PropertyRatesPanel.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PublishingProductForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PublishingTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ QuickProductForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RealtyTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RealtyTestEmailPanelWithProperty.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SectionCard.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TechShowcaseForm.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TechTab.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UpcomingStaysPanel.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UsersTab.js
‚îÇ   ‚îú‚îÄ‚îÄ Calendar.js
‚îÇ   ‚îú‚îÄ‚îÄ Card.js
‚îÇ   ‚îú‚îÄ‚îÄ Cart.js
‚îÇ   ‚îú‚îÄ‚îÄ ErrorBoundary.js
‚îÇ   ‚îú‚îÄ‚îÄ Footer.js
‚îÇ   ‚îú‚îÄ‚îÄ Header.js
‚îÇ   ‚îú‚îÄ‚îÄ Hero.js
‚îÇ   ‚îú‚îÄ‚îÄ RealtyLeadForm.js
‚îÇ   ‚îú‚îÄ‚îÄ Recommender.js
‚îÇ   ‚îú‚îÄ‚îÄ SEO.js
‚îÇ   ‚îú‚îÄ‚îÄ SignalsSubscriptionForm.js
‚îÇ   ‚îú‚îÄ‚îÄ SubscriptionForm.js
‚îÇ   ‚îî‚îÄ‚îÄ ThemeToggle.js
‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îú‚îÄ‚îÄ emails
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bookingReceipt.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ itineraryEmail.js
‚îÇ   ‚îú‚îÄ‚îÄ adminUtils.js
‚îÇ   ‚îú‚îÄ‚îÄ affiliate.js
‚îÇ   ‚îú‚îÄ‚îÄ cartSlice.js
‚îÇ   ‚îú‚îÄ‚îÄ emailTemplates.js
‚îÇ   ‚îú‚îÄ‚îÄ printful.js
‚îÇ   ‚îú‚îÄ‚îÄ realtyHelpers.js
‚îÇ   ‚îú‚îÄ‚îÄ sendEmail.js
‚îÇ   ‚îú‚îÄ‚îÄ store.js
‚îÇ   ‚îú‚îÄ‚îÄ supabase.js
‚îÇ   ‚îî‚îÄ‚îÄ supabaseAdmin.js
‚îú‚îÄ‚îÄ pages
‚îÇ   ‚îú‚îÄ‚îÄ api
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fulfillment
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ retry.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ quick-create-product.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ upload-asset-multi.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ upload-asset.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ capital
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ subscriptions-admin.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ checkout
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ create-session.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ posts
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug].js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ realty
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ [slug].js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ availability.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ booking-success.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ booking-summary.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ calendar-blocks.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cleanup-holds.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ create-checkout.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ external-blocks.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ical-export.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ical.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lead.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ property.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ quote.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ rates.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reservations-admin.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ send-booking-confirmation.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sync-ical.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test-email.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ upcoming.js
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ webhook.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stripe
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ charge.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ events.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ order-details.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ posts.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ products.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ site-config.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stripe-webhook.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ track.js
‚îÇ   ‚îú‚îÄ‚îÄ blog
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug].js
‚îÇ   ‚îú‚îÄ‚îÄ media
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug].js
‚îÇ   ‚îú‚îÄ‚îÄ r
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [code].js
‚îÇ   ‚îú‚îÄ‚îÄ realty
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ booking
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug].js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug].js
‚îÇ   ‚îú‚îÄ‚îÄ tech
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug].js
‚îÇ   ‚îú‚îÄ‚îÄ 404.js
‚îÇ   ‚îú‚îÄ‚îÄ 500.js
‚îÇ   ‚îú‚îÄ‚îÄ _app.js
‚îÇ   ‚îú‚îÄ‚îÄ _document.js
‚îÇ   ‚îú‚îÄ‚îÄ about.js
‚îÇ   ‚îú‚îÄ‚îÄ admin.js
‚îÇ   ‚îú‚îÄ‚îÄ blog.js
‚îÇ   ‚îú‚îÄ‚îÄ capital.js
‚îÇ   ‚îú‚îÄ‚îÄ cart.js
‚îÇ   ‚îú‚îÄ‚îÄ coming-soon.js
‚îÇ   ‚îú‚îÄ‚îÄ contact.js
‚îÇ   ‚îú‚îÄ‚îÄ dashboard.js
‚îÇ   ‚îú‚îÄ‚îÄ designs.js
‚îÇ   ‚îú‚îÄ‚îÄ events.js
‚îÇ   ‚îú‚îÄ‚îÄ index.js
‚îÇ   ‚îú‚îÄ‚îÄ links.js
‚îÇ   ‚îú‚îÄ‚îÄ login.js
‚îÇ   ‚îú‚îÄ‚îÄ media.js
‚îÇ   ‚îú‚îÄ‚îÄ privacy.js
‚îÇ   ‚îú‚îÄ‚îÄ products.js
‚îÇ   ‚îú‚îÄ‚îÄ publishing.js
‚îÇ   ‚îú‚îÄ‚îÄ realty.js
‚îÇ   ‚îú‚îÄ‚îÄ signup.js
‚îÇ   ‚îú‚îÄ‚îÄ tech.js
‚îÇ   ‚îú‚îÄ‚îÄ terms.js
‚îÇ   ‚îú‚îÄ‚îÄ thank-you.js
‚îÇ   ‚îî‚îÄ‚îÄ track.js
‚îú‚îÄ‚îÄ posts
‚îÇ   ‚îî‚îÄ‚îÄ example-post.mdx
‚îú‚îÄ‚îÄ public
‚îÇ   ‚îú‚îÄ‚îÄ assets
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Legacy_of_the_Hidden_Clans (Chapter 1)_by D.N. Manyagi.pdf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Legacy_of_the_Hidden_Clans (Chapter 2)_by D.N. Manyagi.pdf
‚îÇ   ‚îú‚îÄ‚îÄ images
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app-carousel-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app-carousel-2.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app-carousel-3.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ author-portrait.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book-carousel-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book-carousel-2.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book-carousel-3.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ book-carousel-4.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chart-hero.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ daito-screenshot.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ grain-texture.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ home-carousel-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ home-carousel-2.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ home-carousel-3.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ legacy-chapter-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo.svg
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logo.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ merch-carousel-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ merch-carousel-2.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ merch-carousel-3.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ merch-carousel-4.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ merch-carousel-5.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mock-mug-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mock-print-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mock-tee-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-about.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-capital.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-comingsoon.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-contact.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-designs.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-home.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-media.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-publishing.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ og-tech.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ performance-chart.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ team-photo.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video-carousel-1.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video-carousel-2.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video-carousel-3.webp
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video-carousel-4.webp
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ video-carousel-5.webp
‚îÇ   ‚îú‚îÄ‚îÄ videos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ hero-bg.mp4
‚îÇ   ‚îú‚îÄ‚îÄ favicon.ico
‚îÇ   ‚îú‚îÄ‚îÄ placeholder.png
‚îÇ   ‚îú‚îÄ‚îÄ robots.txt
‚îÇ   ‚îú‚îÄ‚îÄ sitemap-0.xml
‚îÇ   ‚îî‚îÄ‚îÄ sitemap.xml
‚îú‚îÄ‚îÄ styles
‚îÇ   ‚îî‚îÄ‚îÄ globals.css
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ next-env.d.ts
‚îú‚îÄ‚îÄ next-sitemap.config.js
‚îú‚îÄ‚îÄ next.config.js
‚îú‚îÄ‚îÄ package-lock.json  (not dumped)
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ postcss.config.js
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ tailwind.config.js
‚îî‚îÄ‚îÄ tsconfig.json

## FILE CONTENTS


===== FILE: components/admin/AffiliatesForm.js  (size=2420 bytes) =====
// components/admin/AffiliatesForm.js
import { useState } from 'react';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';
import { safeJSON } from '@/lib/adminUtils';

function AffiliatesForm({ onCreated }) {
  const [name, setName] = useState('');
  const [referralCode, setReferralCode] = useState('');
  const [commissionRate, setCommissionRate] = useState('0.1');
  const [metadataStr, setMetadataStr] = useState('');

  const create = async () => {
    try {
      if (!name) return alert('Name required.');
      if (!referralCode) return alert('Referral code required.');

      const payload = {
        name,
        referral_code: referralCode,
        commission_rate: Number(commissionRate),
        status: 'active',
        metadata: metadataStr ? safeJSON(metadataStr, {}) : {},
      };

      const { error } = await supabase.from('affiliates').insert(payload);
      if (error) throw error;

      setName('');
      setReferralCode('');
      setCommissionRate('0.1');
      setMetadataStr('');
      onCreated?.();
      alert('Affiliate created.');
    } catch (e) {
      alert(`Create failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Affiliates ‚Äî Add Partner">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input
          placeholder="Partner Name"
          value={name}
          onChange={(e) => setName(e.target.value)}
        />
        <input
          placeholder="Referral Code"
          value={referralCode}
          onChange={(e) => setReferralCode(e.target.value)}
        />
        <input
          placeholder="Commission Rate (e.g., 0.1 for 10%)"
          type="number"
          step="0.01"
          value={commissionRate}
          onChange={(e) => setCommissionRate(e.target.value)}
        />
        <textarea
          className="md:col-span-3"
          placeholder='Metadata (JSON, e.g., {"partner_type":"influencer"})'
          value={metadataStr}
          onChange={(e) => setMetadataStr(e.target.value)}
        />
        <button
          type="button"
          onClick={create}
          className="md:col-span-3 px-4 py-2 rounded bg-blue-600 text-white"
        >
          Create Affiliate
        </button>
      </div>
    </SectionCard>
  );
}

export default AffiliatesForm;


===== FILE: components/admin/AffiliatesTab.js  (size=6354 bytes) =====
// components/admin/AffiliatesTab.js
import React, { useMemo } from 'react';
import SectionCard from '@/components/admin/SectionCard';
import AffiliatesForm from '@/components/admin/AffiliatesForm';
import { supabase } from '@/lib/supabase';

// tiny util
const currency = (n) => {
  const num = Number(n || 0);
  return `$${num.toFixed(2)}`;
};

export default function AffiliatesTab({
  affiliates,
  orders = [],
  reservations = [],
  refreshAll,
}) {
  // Build a lookup so we can aggregate earnings per affiliate
  // We consider two revenue sources:
  // 1. Normal/digital/merch orders in `orders`
  // 2. Realty bookings in `realty_reservations`
  //
  // We only count rows that are "paid".
  // For orders: status === 'paid'
  // For reservations: status === 'paid'
  //
  // We sum:
  // - total revenue attributed
  // - total commission saved on each row (commission_amount)
  //
  // NOTE: commission_amount is already calculated and stored when
  // the checkout session was created. We're just summing it here.

  const affiliateStats = useMemo(() => {
    const stats = {};

    // helper to init stats row
    function ensure(id) {
      if (!stats[id]) {
        stats[id] = {
          revenue: 0,
          commission: 0,
        };
      }
    }

    // 1) aggregate normal product orders
    orders.forEach((o) => {
      if ((o.status || '').toLowerCase() !== 'paid') return;
      if (!o.affiliate_id) return; // only count if attributed
      ensure(o.affiliate_id);

      // total_amount is assumed to be the total charged (before tax/shipping or after?)
      // We're just summing what you stored.
      stats[o.affiliate_id].revenue += Number(o.total_amount || 0);

      // commission_amount numeric(12,2)
      stats[o.affiliate_id].commission += Number(o.commission_amount || 0);
    });

    // 2) aggregate realty reservations
    reservations.forEach((r) => {
      if ((r.status || '').toLowerCase() !== 'paid') return;
      if (!r.affiliate_id) return;
      ensure(r.affiliate_id);

      // amount_cents is in cents; convert to dollars
      const amountDollars = Number(r.amount_cents || 0) / 100;
      stats[r.affiliate_id].revenue += amountDollars;

      // commission_amount for reservations we stored in dollars already
      stats[r.affiliate_id].commission += Number(r.commission_amount || 0);
    });

    return stats;
  }, [orders, reservations]);

  return (
    <SectionCard title="Affiliates Division">
      {/* create new affiliate */}
      <AffiliatesForm onCreated={refreshAll} />

      {/* list affiliates with performance */}
      <div className="mt-6">
        <h3 className="font-semibold mb-3">Affiliates</h3>

        <div className="overflow-x-auto">
          <table className="w-full text-sm border-collapse min-w-[800px]">
            <thead>
              <tr className="text-left border-b dark:border-gray-700">
                <th className="py-2">Name</th>
                <th>Referral Code</th>
                <th>Rate</th>
                <th>Referred Revenue (paid)</th>
                <th>Commission Owed</th>
                <th>Metadata</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              {affiliates.map((aff) => {
                const stat = affiliateStats[aff.id] || {
                  revenue: 0,
                  commission: 0,
                };
                return (
                  <tr
                    key={aff.id}
                    className="border-b dark:border-gray-800 align-top"
                  >
                    <td className="py-2 font-semibold">{aff.name}</td>

                    <td className="py-2 text-xs">
                      <div className="font-mono bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded inline-block">
                        {aff.referral_code}
                      </div>
                    </td>

                    <td className="py-2">
                      {(Number(aff.commission_rate || 0) * 100).toFixed(1)}%
                    </td>

                    <td className="py-2 whitespace-nowrap">
                      {currency(stat.revenue)}
                    </td>

                    <td className="py-2 whitespace-nowrap text-green-600 font-semibold">
                      {currency(stat.commission)}
                    </td>

                    <td className="py-2 min-w-[200px]">
                      <textarea
                        className="w-full h-16 dark:bg-gray-800 text-[11px]"
                        value={JSON.stringify(aff.metadata || {}, null, 0)}
                        readOnly
                      />
                    </td>

                    <td className="py-2">
                      <button
                        className="px-3 py-1 bg-red-600 text-white rounded text-xs"
                        onClick={async () => {
                          if (!confirm('Delete this affiliate?')) return;
                          const { error } = await supabase
                            .from('affiliates')
                            .delete()
                            .eq('id', aff.id);
                          if (error) {
                            alert(`Delete failed: ${error.message}`);
                          } else {
                            refreshAll?.();
                          }
                        }}
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                );
              })}

              {affiliates.length === 0 && (
                <tr>
                  <td colSpan={7} className="py-6 opacity-70 text-center">
                    No affiliates yet.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>

        <p className="text-[10px] opacity-60 mt-4 leading-relaxed">
          Referred Revenue = sum of paid Orders + paid Realty bookings
          attributed to this affiliate.
          Commission Owed = sum of commission_amount we stored at checkout.
        </p>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/AnalyticsTab.js  (size=2910 bytes) =====
// components/admin/AnalyticsTab.js
import React, { useMemo } from 'react';
import SectionCard from '@/components/admin/SectionCard';
import {
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  CartesianGrid,
  LineChart,
  Line,
  Legend,
} from 'recharts';
import { isWithinLastDays } from '@/lib/adminUtils';

export default function AnalyticsTab({ users, orders }) {
  // revenue by division (last 30d)
  const revenueByDivision = useMemo(() => {
    const map = {};
    orders.forEach((o) => {
      if (!isWithinLastDays(o.created_at, 30)) return;
      const d = (o.division || 'site').toLowerCase();
      map[d] = (map[d] || 0) + Number(o.total_amount || 0);
    });
    return Object.entries(map).map(([division, total]) => ({
      division,
      total,
    }));
  }, [orders]);

  // naive user growth per month
  const userGrowth = useMemo(() => {
    const growthMap = users.reduce((acc, u) => {
      const created = new Date(u.created_at || Date.now());
      const monthLabel = created.toLocaleString('default', {
        month: 'short',
        year: 'numeric',
      });
      acc[monthLabel] = (acc[monthLabel] || 0) + 1;
      return acc;
    }, {});
    return Object.entries(growthMap)
      .map(([month, count]) => ({ month, count }))
      .sort(
        (a, b) =>
          new Date(a.month + ' 1').getTime() -
          new Date(b.month + ' 1').getTime()
      );
  }, [users]);

  return (
    <SectionCard title="Analytics Dashboard">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Revenue by Division */}
        <div>
          <h3 className="font-semibold mb-3">Revenue by Division</h3>
          <div className="w-full h-64">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={revenueByDivision}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="division" />
                <YAxis />
                <Tooltip />
                <Bar dataKey="total" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* User Growth */}
        <div>
          <h3 className="font-semibold mb-3">User Growth</h3>
          <div className="w-full h-64">
            <ResponsiveContainer width="100%" height="100%">
              <LineChart data={userGrowth}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="month" />
                <YAxis />
                <Tooltip />
                <Legend />
                <Line
                  type="monotone"
                  dataKey="count"
                  stroke="#8884d8"
                />
              </LineChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/AssetsTab.js  (size=8688 bytes) =====
// components/admin/AssetsTab.js
import React, { useState } from 'react';
import SectionCard from '@/components/admin/SectionCard';
import MultiUploader from '@/components/admin/MultiUploader';
import { toArrayTags, safeJSON, copyText } from '@/lib/adminUtils';

export default function AssetsTab({ assets, refreshAll }) {
  const [assetEdits, setAssetEdits] = useState({});

  const saveAssetRow = async (a) => {
    try {
      const edits = assetEdits[a.id] || {};
      if (!Object.keys(edits).length) return;

      const payload = {
        ...('filename'   in edits ? { filename: edits.filename } : {}),
        ...('division'   in edits ? { division: edits.division } : {}),
        ...('purpose'    in edits ? { purpose: edits.purpose } : {}),
        ...('tagsStr'    in edits ? { tags: toArrayTags(edits.tagsStr) } : {}),
        ...('metadataStr' in edits
          ? { metadata: safeJSON(edits.metadataStr, a.metadata || {}) }
          : {}),
      };

      const { error } = await window.supabase
        .from('assets')
        .update(payload)
        .eq('id', a.id);

      if (error) throw error;

      setAssetEdits((prev) => ({ ...prev, [a.id]: {} }));
      refreshAll?.();
      alert('Asset saved.');
    } catch (e) {
      alert(`Save failed: ${e.message}`);
    }
  };

  const deleteAssetRow = async (a) => {
    if (!confirm(`Delete asset "${a.filename || a.file_url}"?\nThis cannot be undone.`)) {
      return;
    }
    try {
      // Best-effort storage delete
      const parts = (a.file_url || '').split('/storage/v1/object/public/');
      if (parts.length > 1) {
        const bucketAndPath = parts[1].split('?')[0];
        const bucket = bucketAndPath.split('/')[0];
        const filePath = bucketAndPath.split('/').slice(1).join('/');
        if (bucket && filePath) {
          await window.supabase.storage.from(bucket).remove([filePath]);
        }
      }

      const { error } = await window.supabase
        .from('assets')
        .delete()
        .eq('id', a.id);

      if (error) throw error;

      refreshAll?.();
      alert('Asset deleted.');
    } catch (e) {
      alert(`Delete failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Assets Library">
      <p className="text-sm opacity-80 mb-3">
        Upload once, reuse anywhere. Choose division + purpose to route files into
        structured folders in Supabase Storage (e.g., <code>designs/hero</code>).
      </p>

      {/* Uploader (now sends contentType/fileType hints; server sanitizes) */}
      <MultiUploader
        division="site"
        purpose="general"
        fileType="image"
        onUploaded={refreshAll}
      />

      <div className="mt-6 overflow-x-auto">
        <table className="w-full text-sm">
          <thead>
            <tr className="text-left border-b dark:border-gray-700">
              <th className="py-2">Preview</th>
              <th>Filename</th>
              <th>Division</th>
              <th>Purpose</th>
              <th>Tags</th>
              <th>Metadata (JSON)</th>
              <th>URL</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {assets.slice(0, 50).map((a) => {
              const row = assetEdits[a.id] || {};
              return (
                <tr key={a.id} className="align-top border-b dark:border-gray-800">
                  <td className="py-2">
                    {a.file_type === 'image' ? (
                      <img src={a.file_url} className="w-12 h-12 object-cover rounded" alt="" />
                    ) : a.file_type === 'video' ? (
                      <span title="video">üéûÔ∏è</span>
                    ) : a.file_type === 'pdf' ? (
                      <span title="pdf">üìÑ PDF</span>
                    ) : (
                      <span>üìÑ</span>
                    )}
                  </td>

                  <td className="py-2 min-w-[160px]">
                    <input
                      className="w-full dark:bg-gray-800"
                      placeholder={a.filename || '-'}
                      value={row.filename ?? a.filename ?? ''}
                      onChange={(e) =>
                        setAssetEdits((prev) => ({
                          ...prev,
                          [a.id]: { ...row, filename: e.target.value },
                        }))
                      }
                    />
                  </td>

                  <td className="py-2">
                    <select
                      className="dark:bg-gray-800"
                      value={row.division ?? a.division ?? 'site'}
                      onChange={(e) =>
                        setAssetEdits((prev) => ({
                          ...prev,
                          [a.id]: { ...row, division: e.target.value },
                        }))
                      }
                    >
                      {['site','publishing','designs','capital','tech','media','realty'].map((d) => (
                        <option key={d} value={d}>{d}</option>
                      ))}
                    </select>
                  </td>

                  <td className="py-2">
                    <select
                      className="dark:bg-gray-800"
                      value={row.purpose ?? a.purpose ?? 'general'}
                      onChange={(e) =>
                        setAssetEdits((prev) => ({
                          ...prev,
                          [a.id]: { ...row, purpose: e.target.value },
                        }))
                      }
                    >
                      <option value="general">general</option>
                      <option value="hero">hero</option>
                      <option value="carousel">carousel</option>
                      <option value="gallery">gallery</option>
                      <option value="pdf">pdf</option>
                    </select>
                  </td>

                  <td className="py-2 min-w-[200px]">
                    <input
                      className="w-full dark:bg-gray-800"
                      placeholder="comma,separated,tags"
                      value={row.tagsStr ?? (Array.isArray(a.tags) ? a.tags.join(', ') : '')}
                      onChange={(e) =>
                        setAssetEdits((prev) => ({
                          ...prev,
                          [a.id]: { ...row, tagsStr: e.target.value },
                        }))
                      }
                    />
                  </td>

                  <td className="py-2 min-w-[260px]">
                    <textarea
                      className="w-full h-16 dark:bg-gray-800"
                      placeholder='{"scene":"exile-portal"}'
                      value={row.metadataStr ?? JSON.stringify(a.metadata || {}, null, 0)}
                      onChange={(e) =>
                        setAssetEdits((prev) => ({
                          ...prev,
                          [a.id]: { ...row, metadataStr: e.target.value },
                        }))
                      }
                    />
                  </td>

                  <td className="py-2 max-w-[280px] truncate">{a.file_url}</td>

                  <td className="py-2 space-x-2">
                    <button
                      className="text-blue-600 underline"
                      type="button"
                      onClick={() => copyText(a.file_url)}
                    >
                      Copy URL
                    </button>

                    <button
                      className="px-3 py-1 bg-blue-600 text-white rounded"
                      type="button"
                      onClick={() => saveAssetRow(a)}
                    >
                      Save
                    </button>

                    <button
                      className="px-3 py-1 bg-red-600 text-white rounded"
                      type="button"
                      onClick={() => deleteAssetRow(a)}
                    >
                      Delete
                    </button>
                  </td>
                </tr>
              );
            })}

            {assets.length === 0 && (
              <tr>
                <td colSpan={8} className="py-6 opacity-70">
                  No assets yet.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/AttachToProperty.js  (size=1688 bytes) =====
// components/admin/AttachToProperty.js
import { useState } from 'react';
import { supabase } from '@/lib/supabase';

function AttachToProperty({ properties, onAfter }) {
  const [propertyId, setPropertyId] = useState('');
  const [urls, setUrls] = useState(''); // newline or comma separated

  const save = async () => {
    if (!propertyId) return alert('Pick a property');
    const list = Array.from(new Set(
      urls.split(/\s|,/).map(s => s.trim()).filter(Boolean)
    ));

    if (list.length === 0) return alert('Add at least one URL');

    // insert into property_images
    const rows = list.map((u, i) => ({
      property_id: propertyId,
      file_url: u,
      file_type: u.match(/\.(mp4)$/i) ? 'video' : 'image',
      position: i,
    }));

    const { error } = await supabase.from('property_images').insert(rows);
    if (error) return alert(error.message);

    setUrls('');
    onAfter?.();
    alert('Attached!');
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
      <select value={propertyId} onChange={e => setPropertyId(e.target.value)} className="dark:bg-gray-800">
        <option value="">Select property</option>
        {properties.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
      </select>
      <textarea
        className="md:col-span-2 h-24 dark:bg-gray-800"
        placeholder="Paste one URL per line (or comma separated)"
        value={urls}
        onChange={(e) => setUrls(e.target.value)}
      />
      <button onClick={save} className="px-4 py-2 rounded bg-blue-600 text-white">Attach</button>
    </div>
  );
}

export default AttachToProperty;


===== FILE: components/admin/BlogTab.js  (size=10596 bytes) =====
// components/admin/BlogTab.js
import React, { useState, useMemo } from 'react';
import dynamic from 'next/dynamic';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';
import SEO from '@/components/SEO';

// lazy MDX renderer for preview
const MDXRemote = dynamic(
  () => import('next-mdx-remote').then((m) => m.MDXRemote),
  { ssr: false }
);

export default function BlogTab({ posts, refreshAll, user }) {
  const [postForm, setPostForm] = useState({
    id: null,
    title: '',
    slug: '',
    excerpt: '',
    content: '',
    featured_image: '',
    status: 'draft',
    division: 'site',
    description: '', // used also by EventsTab but harmless here
    start_date: '',
    end_date: '',
  });

  const [postFilter, setPostFilter] = useState('all');
  const [postQuery, setPostQuery] = useState('');
  const [showPreview, setShowPreview] = useState(false);
  const [mdx, setMdx] = useState(null);

  // derived filtered list
  const filteredPosts = useMemo(() => {
    return posts
      .filter((p) =>
        postFilter === 'all'
          ? true
          : (p.status || 'draft') ===
            (postFilter === 'draft' ? 'draft' : 'published')
      )
      .filter((p) =>
        !postQuery
          ? true
          : (p.title || '')
              .toLowerCase()
              .includes(postQuery.toLowerCase()) ||
            (p.slug || '')
              .toLowerCase()
              .includes(postQuery.toLowerCase())
      );
  }, [posts, postFilter, postQuery]);

  const clearPostForm = () =>
    setPostForm({
      id: null,
      title: '',
      slug: '',
      excerpt: '',
      content: '',
      featured_image: '',
      status: 'draft',
      division: 'site',
      description: '',
      start_date: '',
      end_date: '',
    });

  const loadPostToForm = (p) => {
    setPostForm({
      id: p.id,
      title: p.title || '',
      slug: p.slug || '',
      excerpt: p.excerpt || '',
      content: p.content || '',
      featured_image: p.featured_image || '',
      status: p.status || 'draft',
      division: p.division || 'site',
      description: p.description || '',
      start_date: p.start_date || '',
      end_date: p.end_date || '',
    });
    setShowPreview(false);
    setMdx(null);
    if (typeof window !== 'undefined') {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  const savePost = async (e) => {
    e.preventDefault();
    try {
      const payload = {
        title: postForm.title,
        slug: postForm.slug,
        excerpt: postForm.excerpt,
        content: postForm.content,
        featured_image: postForm.featured_image,
        status: postForm.status,
        division: postForm.division || 'site',
        author_id: user.id,
      };
      if (postForm.id) {
        const { error } = await supabase
          .from('posts')
          .update(payload)
          .eq('id', postForm.id);
        if (error) throw error;
      } else {
        const { error } = await supabase.from('posts').insert(payload);
        if (error) throw error;
      }
      clearPostForm();
      refreshAll?.();
      alert('Saved post.');
    } catch (err) {
      alert(`Failed to save post: ${err.message}`);
    }
  };

  const publishToggle = async (id, nextStatus) => {
    const { error } = await supabase
      .from('posts')
      .update({ status: nextStatus })
      .eq('id', id);
    if (error) alert(error.message);
    else refreshAll?.();
  };

  const deletePost = async (id) => {
    if (!confirm('Delete this post?')) return;
    const { error } = await supabase.from('posts').delete().eq('id', id);
    if (error) alert(error.message);
    else {
      if (postForm.id === id) clearPostForm();
      refreshAll?.();
    }
  };

  const doPreview = async () => {
    try {
      const { serialize } = await import('next-mdx-remote/serialize');
      const ser = await serialize(postForm.content || '');
      setMdx(ser);
      setShowPreview(true);
    } catch (err) {
      alert(`MDX parse error: ${err.message}`);
    }
  };

  return (
    <SectionCard title="Blog">
      <SEO
        title="Manyagi Admin - Blog Management"
        description="Manage blog posts for Manyagi divisions."
      />

      {/* filters */}
      <div className="flex flex-col md:flex-row gap-3 mb-4">
        <select
          value={postFilter}
          onChange={(e) => setPostFilter(e.target.value)}
          className="p-2 rounded border dark:bg-gray-800"
        >
          <option value="all">All</option>
          <option value="draft">Drafts</option>
          <option value="published">Published</option>
        </select>

        <input
          placeholder="Search title or slug‚Ä¶"
          value={postQuery}
          onChange={(e) => setPostQuery(e.target.value)}
          className="p-2 rounded border flex-1 dark:bg-gray-800"
        />
      </div>

      {/* editor form */}
      <form
        onSubmit={savePost}
        className="grid grid-cols-1 md:grid-cols-2 gap-3 bg-white p-4 rounded border mb-6 dark:bg-gray-800"
      >
        <input
          placeholder="Title"
          value={postForm.title}
          onChange={(e) =>
            setPostForm({ ...postForm, title: e.target.value })
          }
        />

        <input
          placeholder="Slug"
          value={postForm.slug}
          onChange={(e) =>
            setPostForm({ ...postForm, slug: e.target.value })
          }
        />

        <input
          className="col-span-2"
          placeholder="Excerpt"
          value={postForm.excerpt}
          onChange={(e) =>
            setPostForm({ ...postForm, excerpt: e.target.value })
          }
        />

        <input
          className="col-span-2"
          placeholder="Featured Image URL"
          value={postForm.featured_image}
          onChange={(e) =>
            setPostForm({
              ...postForm,
              featured_image: e.target.value,
            })
          }
        />

        <select
          value={postForm.division}
          onChange={(e) =>
            setPostForm({ ...postForm, division: e.target.value })
          }
        >
          {[
            'site',
            'publishing',
            'designs',
            'capital',
            'tech',
            'media',
            'realty',
          ].map((d) => (
            <option key={d} value={d}>
              {d}
            </option>
          ))}
        </select>

        <select
          value={postForm.status}
          onChange={(e) =>
            setPostForm({ ...postForm, status: e.target.value })
          }
        >
          <option value="draft">Draft</option>
          <option value="published">Published</option>
        </select>

        <textarea
          className="col-span-2 h-32"
          placeholder="Content (MDX)"
          value={postForm.content}
          onChange={(e) =>
            setPostForm({ ...postForm, content: e.target.value })
          }
        />

        <div className="flex gap-2 flex-wrap">
          <button className="p-2 bg-black text-white rounded dark:bg-gray-700">
            Save Post
          </button>

          <button
            type="button"
            onClick={doPreview}
            className="p-2 bg-gray-500 text-white rounded"
          >
            Preview
          </button>

          <button
            type="button"
            onClick={() => {
              clearPostForm();
              setShowPreview(false);
              setMdx(null);
            }}
            className="p-2 bg-red-500 text-white rounded"
          >
            Clear
          </button>
        </div>
      </form>

      {/* preview */}
      {showPreview && mdx && (
        <SectionCard>
          <MDXRemote {...mdx} />
        </SectionCard>
      )}

      {/* posts list */}
      <table className="w-full text-sm">
        <thead>
          <tr>
            <th className="text-left py-2">Title</th>
            <th className="text-left py-2">Slug</th>
            <th className="text-left py-2">Division</th>
            <th className="text-left py-2">Status</th>
            <th className="text-left py-2">Actions</th>
          </tr>
        </thead>

        <tbody>
          {filteredPosts.map((p) => (
            <tr
              key={p.id}
              className="border-t dark:border-gray-800 align-top"
            >
              <td className="py-2">{p.title}</td>
              <td className="py-2">{p.slug}</td>
              <td className="py-2">{p.division || 'site'}</td>
              <td className="py-2">
                <span
                  className={`px-2 py-1 rounded text-xs ${
                    (p.status || 'draft') === 'published'
                      ? 'bg-green-100 text-green-800'
                      : 'bg-yellow-100 text-yellow-800'
                  }`}
                >
                  {p.status || 'draft'}
                </span>
              </td>
              <td className="py-2 space-x-2">
                <button
                  onClick={() => loadPostToForm(p)}
                  className="text-blue-500"
                >
                  Edit
                </button>

                <button
                  onClick={() =>
                    publishToggle(
                      p.id,
                      (p.status || 'draft') === 'published'
                        ? 'draft'
                        : 'published'
                    )
                  }
                  className="text-green-600"
                >
                  {(p.status || 'draft') === 'published'
                    ? 'Unpublish'
                    : 'Publish'}
                </button>

                <button
                  onClick={() => deletePost(p.id)}
                  className="text-red-500"
                >
                  Delete
                </button>
              </td>
            </tr>
          ))}

          {filteredPosts.length === 0 && (
            <tr>
              <td colSpan={5} className="py-6 opacity-70">
                No posts found.
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </SectionCard>
  );
}


===== FILE: components/admin/BundlesForm.js  (size=2504 bytes) =====
// components/admin/BundlesForm.js
import { useState } from 'react';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';

function BundlesForm({ products, onCreated }) {
  const [name, setName] = useState('');
  const [description, setDescription] = useState('');
  const [price, setPrice] = useState('49.99');
  const [productIds, setProductIds] = useState([]);

  const create = async () => {
    try {
      if (!name) return alert('Name required.');
      if (!price) return alert('Price required.');
      if (productIds.length === 0) return alert('Select at least one product.');

      const payload = {
        name,
        description,
        price: Number(price),
        product_ids: productIds,
        status: 'active',
      };

      const { error } = await supabase.from('bundles').insert(payload);
      if (error) throw error;

      setName('');
      setDescription('');
      setPrice('49.99');
      setProductIds([]);
      onCreated?.();
      alert('Bundle created.');
    } catch (e) {
      alert(`Create failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Bundles ‚Äî Create Product Bundle">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input
          placeholder="Bundle Name"
          value={name}
          onChange={(e) => setName(e.target.value)}
        />
        <input
          placeholder="Price"
          type="number"
          value={price}
          onChange={(e) => setPrice(e.target.value)}
        />
        <select
          multiple
          value={productIds}
          onChange={(e) =>
            setProductIds([...e.target.selectedOptions].map((o) => o.value))
          }
          className="md:col-span-3 h-32 dark:bg-gray-800"
        >
          {products.map((p) => (
            <option key={p.id} value={p.id}>
              {p.name} ({p.division})
            </option>
          ))}
        </select>
        <textarea
          className="md:col-span-3"
          placeholder="Description"
          value={description}
          onChange={(e) => setDescription(e.target.value)}
        />
        <button
          type="button"
          onClick={create}
          className="md:col-span-3 px-4 py-2 rounded bg-blue-600 text-white"
        >
          Create Bundle
        </button>
      </div>
    </SectionCard>
  );
}

export default BundlesForm;


===== FILE: components/admin/BundlesTab.js  (size=2620 bytes) =====
// components/admin/BundlesTab.js
import React from 'react';
import SectionCard from '@/components/admin/SectionCard';
import BundlesForm from '@/components/admin/BundlesForm';
import { supabase } from '@/lib/supabase';
import { currency } from '@/lib/adminUtils';

export default function BundlesTab({ bundles, products, refreshAll }) {
  return (
    <SectionCard title="Bundles Division">
      <BundlesForm products={products} onCreated={refreshAll} />

      <div className="mt-6">
        <h3 className="font-semibold mb-3">Bundles</h3>

        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="text-left border-b dark:border-gray-700">
              <th className="py-2">Name</th>
              <th>Description</th>
              <th>Price</th>
              <th>Products</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {bundles.map((bund) => (
              <tr
                key={bund.id}
                className="border-b dark:border-gray-800 align-top"
              >
                <td className="py-2">{bund.name}</td>
                <td className="py-2">{bund.description || '‚Äî'}</td>
                <td className="py-2">{currency(bund.price)}</td>
                <td className="py-2">
                  {Array.isArray(bund.product_ids)
                    ? bund.product_ids.length
                    : 0}{' '}
                  products
                </td>
                <td className="py-2">
                  <button
                    className="px-3 py-1 bg-red-600 text-white rounded"
                    onClick={async () => {
                      if (!confirm('Delete this bundle?')) return;
                      const { error } = await supabase
                        .from('bundles')
                        .delete()
                        .eq('id', bund.id);
                      if (error)
                        alert(`Delete failed: ${error.message}`);
                      else {
                        refreshAll?.();
                      }
                    }}
                  >
                    Delete
                  </button>
                </td>
              </tr>
            ))}

            {bundles.length === 0 && (
              <tr>
                <td colSpan={5} className="py-6 opacity-70">
                  No bundles yet.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/CalendarSyncPanel.js  (size=5085 bytes) =====
// components/admin/CalendarSyncPanel.js
import React, { useState } from 'react';

/**
 * Admin panel for syncing external Airbnb/VRBO calendars.
 *
 * props:
 *  - properties: [{ id, name, slug, metadata, ... }]
 *
 * What it does:
 *  - lets you pick a property
 *  - shows that property's metadata.ical_urls (if any)
 *  - "Sync Now" POSTs to /api/realty/sync-ical with { property_id }
 *  - shows alert with results (how many imported)
 *
 * This uses the /api/realty/sync-ical endpoint you already have.
 */
export default function CalendarSyncPanel({ properties = [] }) {
  const [selectedId, setSelectedId] = useState('');
  const [loading, setLoading] = useState(false);
  const [resultMsg, setResultMsg] = useState('');

  async function runSync() {
    if (!selectedId) {
      alert('Select a property first');
      return;
    }

    setLoading(true);
    setResultMsg('');
    try {
      const res = await fetch('/api/realty/sync-ical', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ property_id: selectedId }),
      });

      let data;
      try {
        data = await res.json();
      } catch (parseErr) {
        const txt = await res.text();
        console.error('Non-JSON response from /sync-ical:', txt);
        throw new Error('Server returned non-JSON for sync-ical');
      }

      if (data.error) {
        throw new Error(data.error);
      }

      // happy path
      const msg = `Imported ${data.imported || 0} blocks from ${data.feeds || 0} feed(s).`;
      setResultMsg(msg);
      alert(msg);
    } catch (err) {
      console.error('sync-ical error:', err);
      alert('Sync failed: ' + err.message);
    } finally {
      setLoading(false);
    }
  }

  const currentProperty = properties.find((p) => p.id === selectedId) || null;

  const icalList = Array.isArray(currentProperty?.metadata?.ical_urls)
    ? currentProperty.metadata.ical_urls
    : [];

  return (
    <div className="glass p-4 rounded mb-4">
      {/* Property picker + Sync button */}
      <div className="flex flex-col gap-3 md:flex-row md:items-end md:gap-4">
        <div className="flex-1">
          <label className="block text-sm font-semibold mb-1">Property</label>
          <select
            className="w-full dark:bg-gray-900 border rounded px-2 py-2 text-sm"
            value={selectedId}
            onChange={(e) => {
              setSelectedId(e.target.value);
              setResultMsg('');
            }}
          >
            <option value="">Select property‚Ä¶</option>
            {properties.map((p) => (
              <option key={p.id} value={p.id}>
                {p.name || p.slug || p.id}
              </option>
            ))}
          </select>
        </div>

        <div className="shrink-0">
          <button
            className="bg-purple-600 text-white px-3 py-2 rounded text-sm font-semibold disabled:opacity-50"
            onClick={runSync}
            disabled={loading || !selectedId}
          >
            {loading ? 'Syncing‚Ä¶' : 'Sync Now'}
          </button>
        </div>
      </div>

      {/* Feed preview + result message */}
      {currentProperty && (
        <div className="mt-4 text-xs leading-relaxed text-gray-700 dark:text-gray-300">
          <div className="font-semibold mb-1">
            External iCal Feeds for this property:
          </div>

          {icalList.length > 0 ? (
            <ul className="list-disc ml-4 space-y-1 break-all">
              {icalList.map((u, i) => (
                <li key={i}>{u}</li>
              ))}
            </ul>
          ) : (
            <div className="opacity-70">
              No iCal feeds set. Add an array of URLs in
              <code className="px-1 py-0.5 bg-gray-900 text-white rounded text-[10px] mx-1">
                property.metadata.ical_urls
              </code>
              (edit that in the table below).
              <pre className="bg-gray-900 text-white rounded p-2 text-[10px] mt-2 whitespace-pre-wrap break-all">
{`{
  "location": "Big Bear, CA",
  "ical_urls": [
    "https://airbnb.com/calendar/ical/XXXXX.ics",
    "https://www.vrbo.com/icalendar/XXXXX.ics"
  ],
  "cover_url": "https://.../hero.webp"
}`}
              </pre>
            </div>
          )}

          {resultMsg && (
            <div className="mt-3 text-green-600 dark:text-green-400 font-semibold">
              {resultMsg}
            </div>
          )}

          <div className="mt-3 text-[10px] opacity-70 leading-relaxed">
            When you click Sync Now:
            <br />
            ‚Ä¢ We fetch each .ics feed in metadata.ical_urls<br />
            ‚Ä¢ We insert those ranges into realty_external_blocks<br />
            ‚Ä¢ Those show up as unavailable in the public calendar<br />
            ‚Ä¢ Prevents double-booking against Airbnb / VRBO
          </div>
        </div>
      )}
    </div>
  );
}


===== FILE: components/admin/CapitalProductForm.js  (size=4165 bytes) =====
// components/admin/CapitalProductForm.js
import { useState } from 'react';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';
import { toArrayTags, safeJSON } from '@/lib/adminUtils';

function CapitalProductForm({ onCreated }) {
  const [name, setName] = useState('');
  const [price, setPrice] = useState('99.99');
  const [description, setDescription] = useState('');
  const [thumbnailUrl, setThumbnailUrl] = useState('');
  const [tagsStr, setTagsStr] = useState('trading, signals');
  const [licenseType, setLicenseType] = useState('bot');
  const [apiAccess, setApiAccess] = useState(false);
  const [metadataStr, setMetadataStr] = useState('');

  const create = async () => {
    try {
      if (!name) return alert('Title required.');
      if (!price) return alert('Price required.');
      if (!thumbnailUrl) return alert('Thumbnail URL required.');

      const metadata = {
        license_type: licenseType,
        api_access: apiAccess,
        ...(metadataStr ? safeJSON(metadataStr, {}) : {}),
      };

      const payload = {
        name,
        price: Number(price || 0),
        division: 'capital',
        description,
        display_image: thumbnailUrl,
        thumbnail_url: thumbnailUrl,
        status: 'active',
        tags: toArrayTags(tagsStr),
        metadata,
        productType: 'download',
      };

      const { error } = await supabase.from('products').insert(payload);
      if (error) throw error;

      setName('');
      setPrice('99.99');
      setDescription('');
      setThumbnailUrl('');
      setTagsStr('trading, signals');
      setLicenseType('bot');
      setApiAccess(false);
      setMetadataStr('');
      onCreated?.();
      alert('Capital product created.');
    } catch (e) {
      alert(`Create failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Capital ‚Äî Add Product (Bot License, eBook, etc.)">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input
          placeholder="Product Title (e.g., Trading Bot License)"
          value={name}
          onChange={(e) => setName(e.target.value)}
        />
        <input
          placeholder="Price"
          type="number"
          value={price}
          onChange={(e) => setPrice(e.target.value)}
        />
        <select
          value={licenseType}
          onChange={(e) => setLicenseType(e.target.value)}
          className="dark:bg-gray-800"
        >
          <option value="bot">Bot License</option>
          <option value="ebook">eBook</option>
          <option value="course">Course</option>
          <option value="api">API Access</option>
        </select>
        <input
          placeholder="Thumbnail URL"
          className="md:col-span-2"
          value={thumbnailUrl}
          onChange={(e) => setThumbnailUrl(e.target.value)}
        />
        <textarea
          className="md:col-span-3"
          placeholder="Description"
          value={description}
          onChange={(e) => setDescription(e.target.value)}
        />
        <input
          className="md:col-span-2"
          placeholder="Tags (comma-separated)"
          value={tagsStr}
          onChange={(e) => setTagsStr(e.target.value)}
        />
        <label className="flex items-center gap-2">
          <input
            type="checkbox"
            checked={apiAccess}
            onChange={(e) => setApiAccess(e.target.checked)}
          />
          Includes API Access
        </label>
        <textarea
          className="md:col-span-3"
          placeholder='Additional Metadata (JSON, e.g., {"strategy":"mean-reversion"})'
          value={metadataStr}
          onChange={(e) => setMetadataStr(e.target.value)}
        />
        <button
          type="button"
          onClick={create}
          className="md:col-span-3 px-4 py-2 rounded bg-blue-600 text-white"
        >
          Create Capital Product
        </button>
      </div>
    </SectionCard>
  );
}

export default CapitalProductForm;


===== FILE: components/admin/CapitalTab.js  (size=12460 bytes) =====
// components/admin/CapitalTab.js
import React, { useState, useEffect } from 'react';
import CapitalProductForm from '@/components/admin/CapitalProductForm';
import SectionCard from '@/components/admin/SectionCard';
import {
  toArrayTags,
  safeJSON,
  updateProduct,
  deleteProduct,
} from '@/lib/adminUtils';

export default function CapitalTab({ products: allProducts, refreshAll }) {
  const [edits, setEdits] = useState({});

  // products filtered to capital division
  const capitalProducts = allProducts.filter(
    (p) => p.division === 'capital'
  );

  // --- NEW STATE: subscription analytics panel ---
  const [subsLoading, setSubsLoading] = useState(true);
  const [subsError, setSubsError] = useState('');
  const [subsRows, setSubsRows] = useState([]);
  const [mrr, setMrr] = useState(0);

  // --- NEW EFFECT: load active subs + MRR ---
  useEffect(() => {
    (async () => {
      try {
        setSubsLoading(true);
        const r = await fetch('/api/capital/subscriptions-admin');
        const j = await r.json();
        if (!j.ok) {
          setSubsError(j.error || 'failed to load subscriptions');
        } else {
          setSubsError('');
          setSubsRows(j.subs || []);
          setMrr(j.mrr || 0);
        }
      } catch (e) {
        setSubsError(e.message || 'error');
      } finally {
        setSubsLoading(false);
      }
    })();
  }, []);

  // unchanged: build payload for editing an existing product
  const buildPayload = (row, p) => ({
    ...(row.thumbnail_url !== undefined
      ? { thumbnail_url: row.thumbnail_url }
      : {}),
    ...(row.price !== undefined
      ? { price: parseFloat(row.price || 0) }
      : {}),
    ...(row.tagsStr !== undefined
      ? { tags: toArrayTags(row.tagsStr) }
      : {}),
    ...(row.description !== undefined
      ? { description: row.description }
      : {}),
    ...(row.metadata !== undefined
      ? { metadata: safeJSON(row.metadata, p.metadata || {}) }
      : {}),
  });

  // unchanged: save handler
  const save = async (p) => {
    try {
      const row = edits[p.id] || {};
      if (!Object.keys(row).length) return;
      const payload = buildPayload(row, p);
      await updateProduct(p.id, payload);
      setEdits((prev) => ({ ...prev, [p.id]: {} }));
      refreshAll?.();
      alert('Saved.');
    } catch (e) {
      alert(`Save failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Capital Division">
      {/* ===================== */}
      {/* 1. ADD NEW PRODUCT    */}
      {/* ===================== */}
      <div className="space-y-2 mb-8">
        <h3 className="text-xl font-bold">Add Capital Product</h3>
        <p className="text-sm opacity-80">
          Use this to seed at least one thing so you can see it live on
          /capital. Examples you can create right now:
        </p>

        <ul className="text-xs opacity-70 list-disc ml-5">
          <li>
            <strong>Basic Signals</strong> ‚Äî price: <code>29.99</code>,
            description: daily entries &amp; exits, tags:{' '}
            <code>signals,trading</code>, metadata:{' '}
            <code>
              &#123;"productType":"subscription","plan_type":"Basic
              Signals"&#125;
            </code>
          </li>
          <li>
            <strong>Trading Bot License</strong> ‚Äî price:{' '}
            <code>99.99</code>, description: lifetime bot, tags:{' '}
            <code>bot,automation</code>, metadata:{' '}
            <code>
              &#123;"productType":"download","license_type":"bot","api_access":false&#125;
            </code>
          </li>
        </ul>

        <CapitalProductForm onCreated={refreshAll} />
      </div>

      {/* ============================= */}
      {/* 2. SUBS / REVENUE DASHBOARD   */}
      {/* ============================= */}
      <div className="border-t pt-6 mt-8">
        <h3 className="text-xl font-bold mb-2">
          Active Signals Subscribers
        </h3>

        {subsLoading ? (
          <div className="text-sm opacity-70">Loading subscribers‚Ä¶</div>
        ) : subsError ? (
          <div className="text-sm text-red-500">
            Failed to load: {subsError}
          </div>
        ) : (
          <>
            <div className="mb-4 text-sm">
              <div>
                <span className="font-semibold">Est. MRR: </span>${mrr.toFixed(2)} / month
              </div>
              <div className="text-xs opacity-70">
                MRR is sum of plan_type prices (e.g. "Basic Signals" = $29.99).
              </div>
            </div>

            <div className="overflow-x-auto">
              <table className="w-full text-sm border-collapse">
                <thead>
                  <tr className="text-left border-b dark:border-gray-700">
                    <th className="py-2">Plan</th>
                    <th>Status</th>
                    <th>Telegram ID</th>
                    <th>Next Renewal</th>
                    <th>$/mo</th>
                  </tr>
                </thead>
                <tbody>
                  {subsRows.length > 0 ? (
                    subsRows.map((s) => (
                      <tr
                        key={s.id}
                        className="border-b dark:border-gray-800"
                      >
                        <td className="py-2">{s.plan_type || '‚Äî'}</td>
                        <td className="py-2">{s.status || '‚Äî'}</td>
                        <td className="py-2">{s.telegram_id || '‚Äî'}</td>
                        <td className="py-2 text-xs">
                          {s.current_period_end || '‚Äî'}
                        </td>
                        <td className="py-2">
                          ${Number(s.amount_usd || 0).toFixed(2)}
                        </td>
                      </tr>
                    ))
                  ) : (
                    <tr>
                      <td className="py-4 opacity-70 text-xs" colSpan={5}>
                        No active subscribers yet.
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </>
        )}
      </div>

      {/* ===================== */}
      {/* 3. EDIT EXISTING PRODS */}
      {/* ===================== */}
      <div className="border-t pt-6 mt-8">
        <h3 className="font-semibold mb-3">Products (Capital)</h3>

        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="text-left border-b dark:border-gray-700">
              <th className="py-2">Thumb</th>
              <th>Name</th>
              <th>Price</th>
              <th>Thumbnail URL</th>
              <th>Tags</th>
              <th>Description</th>
              <th>Metadata JSON</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {capitalProducts.length > 0 ? (
              capitalProducts.map((p) => {
                const row = edits[p.id] || {};
                return (
                  <tr
                    key={p.id}
                    className="border-b dark:border-gray-800 align-top"
                  >
                    <td className="py-2">
                      {p.thumbnail_url ? (
                        <img
                          src={p.thumbnail_url}
                          className="w-16 h-16 object-cover rounded"
                          alt=""
                        />
                      ) : null}
                    </td>

                    <td className="py-2">{p.name}</td>

                    <td className="py-2 min-w-[100px]">
                      <input
                        type="number"
                        className="w-full dark:bg-gray-800"
                        value={row.price ?? (p.price ?? '')}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, price: e.target.value },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[220px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="thumbnail_url"
                        value={
                          row.thumbnail_url ?? p.thumbnail_url ?? ''
                        }
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              thumbnail_url: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[200px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="comma,separated,tags"
                        value={
                          row.tagsStr ??
                          (Array.isArray(p.tags)
                            ? p.tags.join(', ')
                            : '')
                        }
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              tagsStr: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[300px]">
                      <textarea
                        className="w-full h-20 dark:bg-gray-800"
                        placeholder="description"
                        value={row.description ?? p.description ?? ''}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              description: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[300px]">
                      <textarea
                        className="w-full h-20 dark:bg-gray-800"
                        placeholder='{"productType":"subscription","plan_type":"Basic Signals"}'
                        value={
                          row.metadata ??
                          JSON.stringify(p.metadata || {}, null, 0)
                        }
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              metadata: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 space-x-2">
                      <button
                        className="px-3 py-1 bg-blue-600 text-white rounded"
                        onClick={() => save(p)}
                      >
                        Save
                      </button>

                      <button
                        className="px-3 py-1 bg-red-600 text-white rounded"
                        onClick={() => deleteProduct(p.id, refreshAll)}
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                );
              })
            ) : (
              <tr>
                <td colSpan={8} className="py-6 opacity-70">
                  No products yet.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/DesignsTab.js  (size=13453 bytes) =====
// components/admin/DesignsTab.js
import React, { useMemo, useState } from 'react';
import QuickProductForm from '@/components/admin/QuickProductForm';
import SectionCard from '@/components/admin/SectionCard';
import {
  toArrayTags,
  safeJSON,
  updateProduct,
  deleteProduct,
  copyText, // small convenience if you already expose this in adminUtils
} from '@/lib/adminUtils';

export default function DesignsTab({
  products: allProducts,
  assets = [],
  refreshAll,
}) {
  const [edits, setEdits] = useState({});

  const designsProducts = useMemo(
    () => allProducts.filter((p) => p.division === 'designs'),
    [allProducts]
  );

  // Show the latest designs uploads (images) so you can quickly copy & paste URLs
  const recentDesignsAssets = useMemo(
    () =>
      (assets || [])
        .filter((a) => a.division === 'designs' && a.file_type === 'image')
        .sort(
          (a, b) =>
            new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
        )
        .slice(0, 30),
    [assets]
  );

  // Build payload; safely merge metadata if nft_url or metadataStr was edited
  const buildPayload = (row, p) => {
    const next = {
      ...(row.thumbnail_url !== undefined
        ? { thumbnail_url: row.thumbnail_url }
        : {}),
      ...(row.printful_product_id !== undefined
        ? { printful_product_id: row.printful_product_id }
        : {}),
      ...(row.price !== undefined ? { price: parseFloat(row.price || 0) } : {}),
      ...(row.description !== undefined ? { description: row.description } : {}),
      ...(row.tagsStr !== undefined ? { tags: toArrayTags(row.tagsStr) } : {}),
    };

    // Merge metadata if needed
    const baseMeta = p.metadata || {};
    let mergedMeta = baseMeta;

    // If user edited the raw JSON field
    if (row.metadataStr !== undefined) {
      mergedMeta = safeJSON(row.metadataStr, baseMeta);
    }

    // If user edited the nft_url field (we set it under metadata.nft_url)
    if (row.nft_url !== undefined) {
      mergedMeta = { ...mergedMeta, nft_url: row.nft_url || '' };
    }

    if (row.metadataStr !== undefined || row.nft_url !== undefined) {
      next.metadata = mergedMeta;
    }

    return next;
  };

  const save = async (p) => {
    try {
      const row = edits[p.id] || {};
      if (!Object.keys(row).length) return;
      const payload = buildPayload(row, p);
      await updateProduct(p.id, payload);
      setEdits((prev) => ({ ...prev, [p.id]: {} }));
      refreshAll?.();
      alert('Saved.');
    } catch (e) {
      alert(`Save failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Designs Division">
      {/* Quick create remains as-is */}
      <QuickProductForm defaultDivision="designs" onCreated={refreshAll} />

      {/* NEW: recent uploads for quick copy/paste into thumbnails or product galleries */}
      <div className="mt-8">
        <h3 className="font-semibold mb-2">Recent Designs Uploads</h3>
        <p className="text-xs opacity-70 mb-3">
          Latest image assets uploaded under <code>division=&quot;designs&quot;</code>.
          Click &quot;Copy URL&quot; to paste into a product thumbnail, NFT, or metadata.
        </p>

        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left border-b dark:border-gray-700">
                <th className="py-2">Preview</th>
                <th>Filename</th>
                <th>Purpose</th>
                <th>Tags</th>
                <th>URL</th>
                <th>Copy</th>
              </tr>
            </thead>
            <tbody>
              {recentDesignsAssets.length > 0 ? (
                recentDesignsAssets.map((a) => (
                  <tr key={a.id} className="border-b dark:border-gray-800 align-top">
                    <td className="py-2">
                      <img
                        src={a.file_url}
                        className="w-14 h-14 object-cover rounded"
                        alt=""
                      />
                    </td>
                    <td className="py-2">{a.filename || '‚Äî'}</td>
                    <td className="py-2">{a.purpose || '‚Äî'}</td>
                    <td className="py-2">
                      {Array.isArray(a.tags) && a.tags.length
                        ? a.tags.join(', ')
                        : '‚Äî'}
                    </td>
                    <td className="py-2 max-w-[360px] truncate">{a.file_url}</td>
                    <td className="py-2">
                      <button
                        className="text-blue-600 underline"
                        onClick={() => {
                          if (typeof copyText === 'function') copyText(a.file_url);
                          else navigator.clipboard?.writeText?.(a.file_url);
                        }}
                      >
                        Copy URL
                      </button>
                    </td>
                  </tr>
                ))
              ) : (
                <tr>
                  <td className="py-6 opacity-70" colSpan={6}>
                    No recent design uploads found.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Products editor (Designs) */}
      <div className="mt-10">
        <h3 className="font-semibold mb-3">Products (Designs)</h3>

        <div className="overflow-x-auto">
          <table className="w-full text-sm border-collapse">
            <thead>
              <tr className="text-left border-b dark:border-gray-700">
                <th className="py-2">Thumb</th>
                <th>Name</th>
                <th>Price</th>
                <th>Printful ID</th>
                <th>Thumbnail URL</th>
                <th>NFT URL</th> {/* ‚úÖ NEW column */}
                <th>Tags</th>
                <th>Description</th>
                <th>Metadata (JSON)</th> {/* ‚úÖ NEW: raw JSON editor */}
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              {designsProducts.map((p) => {
                const row = edits[p.id] || {};
                const currentNFT =
                  row.nft_url ??
                  (p?.metadata && typeof p.metadata.nft_url === 'string'
                    ? p.metadata.nft_url
                    : '');

                return (
                  <tr key={p.id} className="border-b dark:border-gray-800 align-top">
                    <td className="py-2">
                      {p.thumbnail_url ? (
                        <img
                          src={p.thumbnail_url}
                          className="w-16 h-16 object-cover rounded"
                          alt=""
                        />
                      ) : null}
                    </td>

                    <td className="py-2">{p.name}</td>

                    <td className="py-2 min-w-[100px]">
                      <input
                        type="number"
                        className="w-full dark:bg-gray-800"
                        value={row.price ?? (p.price ?? '')}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, price: e.target.value },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[160px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="printful_product_id"
                        value={row.printful_product_id ?? p.printful_product_id ?? ''}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              printful_product_id: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[220px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="thumbnail_url"
                        value={row.thumbnail_url ?? p.thumbnail_url ?? ''}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              thumbnail_url: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    {/* ‚úÖ NFT URL editor (saved inside metadata.nft_url) */}
                    <td className="py-2 min-w-[220px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="https://opensea.io/assets/... (NFT link)"
                        value={currentNFT}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              nft_url: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[200px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="comma,separated,tags"
                        value={
                          row.tagsStr ??
                          (Array.isArray(p.tags) ? p.tags.join(', ') : '')
                        }
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, tagsStr: e.target.value },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[220px]">
                      <textarea
                        className="w-full h-16 dark:bg-gray-800"
                        placeholder="description"
                        value={row.description ?? p.description ?? ''}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              description: e.target.value,
                            },
                          }))
                        }
                      />
                    </td>

                    {/* ‚úÖ Raw metadata editor (optional but handy) */}
                    <td className="py-2 min-w-[280px]">
                      <textarea
                        className="w-full h-20 dark:bg-gray-800"
                        placeholder='{"book":"Nice World","drop":"First Edition"}'
                        value={
                          row.metadataStr ??
                          JSON.stringify(p.metadata || {}, null, 0)
                        }
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: {
                              ...row,
                              metadataStr: e.target.value,
                            },
                          }))
                        }
                      />
                      <div className="text-[10px] opacity-60 mt-1">
                        <code>metadata.nft_url</code> is used by the Designs page/card
                        if you want to show a badge or link to the NFT.
                      </div>
                    </td>

                    <td className="py-2 space-x-2 whitespace-nowrap">
                      <button
                        className="px-3 py-1 bg-blue-600 text-white rounded"
                        onClick={() => save(p)}
                      >
                        Save
                      </button>

                      <button
                        className="px-3 py-1 bg-red-600 text-white rounded"
                        onClick={() => deleteProduct(p.id, refreshAll)}
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                );
              })}

              {designsProducts.length === 0 && (
                <tr>
                  <td colSpan={10} className="py-6 opacity-70">
                    No products yet.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/EventsTab.js  (size=5677 bytes) =====
// components/admin/EventsTab.js
import React, { useState } from 'react';
import SectionCard from '@/components/admin/SectionCard';
import EventCalendar from '@/components/Calendar';
import { supabase } from '@/lib/supabase';

export default function EventsTab({ events, refreshAll }) {
  // lightweight local state for new event
  const [draft, setDraft] = useState({
    title: '',
    description: '',
    start_date: '',
    end_date: '',
    division: 'site',
    metadataStr: '',
  });

  const createEvent = async () => {
    const payload = {
      title: draft.title,
      description: draft.description,
      start_date: draft.start_date,
      end_date: draft.end_date,
      division: draft.division || 'site',
      // safe parse metadataStr -> JSON or {}
      metadata: draft.metadataStr
        ? (() => {
            try {
              return JSON.parse(draft.metadataStr);
            } catch {
              return {};
            }
          })()
        : {},
    };

    const { error } = await supabase.from('events').insert(payload);
    if (error) {
      alert(`Create failed: ${error.message}`);
    } else {
      setDraft({
        title: '',
        description: '',
        start_date: '',
        end_date: '',
        division: 'site',
        metadataStr: '',
      });
      refreshAll?.();
      alert('Event created.');
    }
  };

  const deleteEvent = async (id) => {
    if (!confirm('Delete this event?')) return;
    const { error } = await supabase.from('events').delete().eq('id', id);
    if (error) alert(`Delete failed: ${error.message}`);
    else refreshAll?.();
  };

  return (
    <SectionCard title="Events Management">
      {/* Add Event Form */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
        <input
          placeholder="Event Title"
          value={draft.title}
          onChange={(e) =>
            setDraft({ ...draft, title: e.target.value })
          }
        />

        <input
          type="datetime-local"
          placeholder="Start Date"
          value={draft.start_date}
          onChange={(e) =>
            setDraft({ ...draft, start_date: e.target.value })
          }
        />

        <input
          type="datetime-local"
          placeholder="End Date"
          value={draft.end_date}
          onChange={(e) =>
            setDraft({ ...draft, end_date: e.target.value })
          }
        />

        <select
          className="dark:bg-gray-800"
          value={draft.division}
          onChange={(e) =>
            setDraft({ ...draft, division: e.target.value })
          }
        >
          <option value="site">site</option>
          <option value="tech">tech</option>
          <option value="media">media</option>
          <option value="capital">capital</option>
          <option value="realty">realty</option>
        </select>

        <textarea
          className="md:col-span-2"
          placeholder="Description"
          value={draft.description}
          onChange={(e) =>
            setDraft({ ...draft, description: e.target.value })
          }
        />

        <textarea
          className="md:col-span-3 h-24 text-xs dark:bg-gray-800"
          placeholder='Metadata (JSON, optional) e.g. {"location":"123 Main St, LA"}'
          value={draft.metadataStr}
          onChange={(e) =>
            setDraft({ ...draft, metadataStr: e.target.value })
          }
        />

        <button
          type="button"
          onClick={createEvent}
          className="md:col-span-3 px-4 py-2 rounded bg-blue-600 text-white"
        >
          Add Event
        </button>
      </div>

      {/* Calendar */}
      <EventCalendar events={events} />

      {/* Event List */}
      <div className="mt-6">
        <h3 className="font-semibold mb-3">Events List</h3>

        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="text-left border-b dark:border-gray-700">
              <th className="py-2">Title</th>
              <th>Division</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {events.map((ev) => (
              <tr
                key={ev.id}
                className="border-b dark:border-gray-800"
              >
                <td className="py-2">{ev.title}</td>
                <td className="py-2">
                  {ev.division || 'site'}
                </td>
                <td className="py-2">
                  {ev.start_date
                    ? new Date(ev.start_date).toLocaleString()
                    : '‚Äî'}
                </td>
                <td className="py-2">
                  {ev.end_date
                    ? new Date(ev.end_date).toLocaleString()
                    : '‚Äî'}
                </td>
                <td className="py-2">
                  <button
                    className="px-3 py-1 bg-red-600 text-white rounded"
                    onClick={() => deleteEvent(ev.id)}
                  >
                    Delete
                  </button>
                </td>
              </tr>
            ))}

            {events.length === 0 && (
              <tr>
                <td colSpan={5} className="py-6 opacity-70">
                  No events yet.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/IcalSyncPanel.js  (size=5522 bytes) =====
// components/admin/IcalSyncPanel.js
import React, { useState } from 'react';

/**
 * Admin control to pull Airbnb/VRBO calendar blocks into our DB.
 *
 * Flow:
 * - Select a property.
 * - Click "Sync Now".
 * - Calls /api/realty/sync-ical with { property_id }.
 *
 * On success, Supabase realty_external_blocks is refreshed for that property.
 * The public /realty/[slug] page is already reading merged data from
 * /api/realty/calendar-blocks, so blocked dates appear automatically.
 *
 * Props:
 *  - properties: array of { id, name, metadata, ... }
 */
export default function IcalSyncPanel({ properties = [] }) {
  const [selectedPropertyId, setSelectedPropertyId] = useState('');
  const [statusMsg, setStatusMsg] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const currentProp = properties.find((p) => p.id === selectedPropertyId);

  // pull any ical_urls so admin can see what's going to sync
  const icalList = Array.isArray(currentProp?.metadata?.ical_urls)
    ? currentProp.metadata.ical_urls
    : [];

  async function handleSync() {
    if (!selectedPropertyId) {
      alert('Select a property first');
      return;
    }

    setIsLoading(true);
    setStatusMsg('');
    try {
      const res = await fetch('/api/realty/sync-ical', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ property_id: selectedPropertyId }),
      });

      let data;
      try {
        data = await res.json();
      } catch (parseErr) {
        const txt = await res.text();
        console.error('Non-JSON sync-ical response:', txt);
        throw new Error('Server returned non-JSON for sync-ical');
      }

      if (!data.ok && !data.imported && !data.feeds) {
        // our route returns { ok:true, feeds:n, imported:m }
        // but in some cases { ok:true, imported:0, feeds:0 }
        // if you get here, we didn't get those keys, so assume error
        throw new Error(data.error || 'Sync failed');
      }

      setStatusMsg(
        `Synced ${data.imported ?? 0} blocks from ${data.feeds ?? 0} feed(s).`
      );
    } catch (err) {
      console.error('sync-ical error:', err);
      setStatusMsg(`Error: ${err.message}`);
    } finally {
      setIsLoading(false);
    }
  }

  return (
    <div className="space-y-3 glass p-4 rounded">
      <div className="flex flex-col gap-2 md:flex-row md:items-end md:gap-4">
        {/* Property selector */}
        <div className="flex-1">
          <label className="block text-sm font-semibold mb-1">
            Property
          </label>
          <select
            className="w-full dark:bg-gray-800 border dark:border-gray-600 rounded px-2 py-1 text-sm"
            value={selectedPropertyId}
            onChange={(e) => {
              setSelectedPropertyId(e.target.value);
              setStatusMsg('');
            }}
          >
            <option value="">Select property‚Ä¶</option>
            {properties.map((p) => (
              <option key={p.id} value={p.id}>
                {p.name || '(no name)'}
              </option>
            ))}
          </select>
        </div>

        {/* Sync button */}
        <div className="md:w-auto">
          <button
            className="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-4 py-2 rounded disabled:opacity-50 text-sm w-full md:w-auto"
            disabled={!selectedPropertyId || isLoading}
            onClick={handleSync}
          >
            {isLoading ? 'Syncing‚Ä¶' : 'Sync Now'}
          </button>
        </div>
      </div>

      {/* Show ical_urls so admin knows what‚Äôs being synced */}
      {selectedPropertyId && (
        <div className="text-xs bg-gray-900/5 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-700 rounded p-3">
          <div className="font-semibold mb-1">External Feeds:</div>
          {icalList.length === 0 ? (
            <div className="opacity-70">
              This property does not have any metadata.ical_urls yet.
              Add them in the property metadata JSON:
              <pre className="mt-2 p-2 bg-black/10 dark:bg-black/30 rounded text-[10px] whitespace-pre-wrap break-all">
{`{
  "location": "Big Bear, CA",
  "ical_urls": [
    "https://example.com/airbnb.ics",
    "https://example.com/vrbo.ics"
  ]
}`}
              </pre>
            </div>
          ) : (
            <ul className="list-disc pl-4 space-y-1 break-all">
              {icalList.map((u, i) => (
                <li key={i} className="text-[10px] md:text-[11px]">
                  {u}
                </li>
              ))}
            </ul>
          )}
        </div>
      )}

      {/* Result / status */}
      {statusMsg && (
        <div className="text-xs font-mono bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded p-2 whitespace-pre-wrap break-all">
          {statusMsg}
        </div>
      )}

      <div className="text-[10px] opacity-60 leading-relaxed">
        This pulls reservations from Airbnb/VRBO and writes them into
        <code className="px-1 rounded bg-black/10 dark:bg-black/30">
          realty_external_blocks
        </code>
        . Those dates are merged with paid reservations and shown as
        unavailable on the public listing calendar so guests can‚Äôt double-book.
      </div>
    </div>
  );
}


===== FILE: components/admin/MediaShowcaseForm.js  (size=3991 bytes) =====
// components/admin/MediaShowcaseForm.js
import { useState } from 'react';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';

function MediaShowcaseForm({ onCreated }) {
  const [title, setTitle] = useState('');
  const [slug, setSlug] = useState('');
  const [excerpt, setExcerpt] = useState('');
  const [content, setContent] = useState('');
  const [featuredImage, setFeaturedImage] = useState('');
  const [thumbnailUrl, setThumbnailUrl] = useState('');
  const [mediaUrl, setMediaUrl] = useState('');
  const [mediaType, setMediaType] = useState('playlist');

  const create = async () => {
    try {
      if (!title) return alert('Title required.');
      if (!slug) return alert('Slug required.');

      const payload = {
        title,
        slug,
        excerpt,
        content,
        featured_image: featuredImage || undefined, // hero image on detail page
        thumbnail_url: thumbnailUrl || undefined,   // card image on /media grid
        status: 'published',
        division: 'media',
        metadata: {
          media_type: mediaType,
          media_url: mediaUrl || undefined, // YouTube / Spotify / etc
        },
      };

      const { error } = await supabase.from('posts').insert(payload);
      if (error) throw error;

      // reset form
      setTitle('');
      setSlug('');
      setExcerpt('');
      setContent('');
      setFeaturedImage('');
      setThumbnailUrl('');
      setMediaUrl('');
      setMediaType('playlist');

      onCreated?.();
      alert('Media showcase item created.');
    } catch (e) {
      alert(`Create failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Media ‚Äî Add Showcase Item (Playlist, Podcast, etc.)">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input
          placeholder="Title (e.g., Manyagi Playlist)"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
        />

        <input
          placeholder="Slug (e.g., manyagi-playlist)"
          value={slug}
          onChange={(e) => setSlug(e.target.value)}
        />

        <select
          value={mediaType}
          onChange={(e) => setMediaType(e.target.value)}
          className="dark:bg-gray-800"
        >
          <option value="playlist">Playlist</option>
          <option value="podcast">Podcast</option>
          <option value="reel">Reel</option>
          <option value="short">YouTube Short</option>
          <option value="audiobook">Audiobook</option>
        </select>

        <input
          placeholder="Featured Image URL (hero on detail page)"
          className="md:col-span-2"
          value={featuredImage}
          onChange={(e) => setFeaturedImage(e.target.value)}
        />

        <input
          placeholder="Thumbnail URL (card on /media)"
          className="md:col-span-1"
          value={thumbnailUrl}
          onChange={(e) => setThumbnailUrl(e.target.value)}
        />

        <input
          placeholder="Media URL (YouTube / Spotify / etc)"
          className="md:col-span-3"
          value={mediaUrl}
          onChange={(e) => setMediaUrl(e.target.value)}
        />

        <textarea
          className="md:col-span-3"
          placeholder="Short excerpt / teaser"
          value={excerpt}
          onChange={(e) => setExcerpt(e.target.value)}
        />

        <textarea
          className="md:col-span-3 h-32"
          placeholder="Long content / MDX"
          value={content}
          onChange={(e) => setContent(e.target.value)}
        />

        <button
          type="button"
          onClick={create}
          className="md:col-span-3 px-4 py-2 rounded bg-blue-600 text-white"
        >
          Create Showcase Item
        </button>
      </div>
    </SectionCard>
  );
}

export default MediaShowcaseForm;


===== FILE: components/admin/MediaTab.js  (size=13158 bytes) =====
// components/admin/MediaTab.js
import React, { useState } from 'react';
import { supabase } from '@/lib/supabase';
import MediaShowcaseForm from '@/components/admin/MediaShowcaseForm';
import SectionCard from '@/components/admin/SectionCard';
import { deleteRow, safeJSON } from '@/lib/adminUtils';

export default function MediaTab({ posts: allPosts, refreshAll }) {
  // only show posts that belong to media division
  const mediaPosts = (allPosts || [])
    .filter((p) => p.division === 'media')
    .sort(
      (a, b) =>
        new Date(b.created_at || 0) - new Date(a.created_at || 0)
    );

  // local edit state per row: { [post.id]: { ...fieldsBeingEdited } }
  const [edits, setEdits] = useState({});

  // helper to get current editable value (edit override OR db fallback)
  function val(post, key, fallback = '') {
    return edits[post.id]?.[key] ?? post[key] ?? fallback;
  }

  // metadata editor is a string, so we keep a separate key metadataStr in edits
  function metaVal(post) {
    const row = edits[post.id] || {};
    if (row.metadataStr !== undefined) {
      return row.metadataStr;
    }
    return JSON.stringify(post.metadata || {}, null, 0);
  }

  async function save(post) {
    try {
      const row = edits[post.id] || {};
      if (!Object.keys(row).length) return; // nothing changed

      // parse metadata if user touched it
      const newMeta =
        row.metadataStr !== undefined
          ? safeJSON(row.metadataStr, post.metadata || {})
          : undefined;

      // we support both thumbnail_url and featured_image:
      // thumbnail_url is preferred going forward
      // featured_image is legacy, we'll update whichever they edited
      const payload = {
        ...(row.title !== undefined ? { title: row.title } : {}),
        ...(row.slug !== undefined ? { slug: row.slug } : {}),
        ...(row.excerpt !== undefined ? { excerpt: row.excerpt } : {}),
        ...(row.content !== undefined ? { content: row.content } : {}),
        ...(row.thumbnail_url !== undefined
          ? { thumbnail_url: row.thumbnail_url }
          : {}),
        ...(row.featured_image !== undefined
          ? { featured_image: row.featured_image }
          : {}),
        ...(newMeta !== undefined ? { metadata: newMeta } : {}),
      };

      const { error } = await supabase
        .from('posts')
        .update(payload)
        .eq('id', post.id);

      if (error) throw error;

      // clear edits for that row
      setEdits((prev) => ({ ...prev, [post.id]: {} }));
      refreshAll?.();
      alert('Saved.');
    } catch (e) {
      alert(`Save failed: ${e.message}`);
    }
  }

  async function remove(postId) {
    if (!confirm('Delete this post?')) return;
    try {
      const { error } = await supabase
        .from('posts')
        .delete()
        .eq('id', postId);
      if (error) throw error;
      refreshAll?.();
      alert('Deleted.');
    } catch (e) {
      alert(`Delete failed: ${e.message}`);
    }
  }

  return (
    <SectionCard title="Media Division">
      {/* CREATE NEW MEDIA ITEM */}
      <MediaShowcaseForm onCreated={refreshAll} />

      {/* LIST / EDIT EXISTING MEDIA */}
      <div className="mt-10">
        <h3 className="font-semibold mb-3">Showcase Items (Media)</h3>

        <div className="overflow-x-auto">
          <table className="w-full text-sm border-collapse">
            <thead>
              <tr className="text-left border-b dark:border-gray-700">
                <th className="py-2">Thumb</th>
                <th>Title / Slug</th>
                <th>Excerpt</th>
                <th>Content (MDX)</th>
                <th>Metadata JSON</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              {mediaPosts.length === 0 ? (
                <tr>
                  <td
                    colSpan={6}
                    className="py-6 opacity-70 text-center"
                  >
                    No showcase items yet.
                  </td>
                </tr>
              ) : (
                mediaPosts.map((p) => {
                  const row = edits[p.id] || {};

                  // pick which image field to show in preview
                  const thumbPreview =
                    row.thumbnail_url ??
                    row.featured_image ??
                    p.thumbnail_url ??
                    p.featured_image ??
                    '';

                  return (
                    <tr
                      key={p.id}
                      className="border-b dark:border-gray-800 align-top"
                    >
                      {/* THUMB / IMAGE FIELDS */}
                      <td className="py-2 min-w-[160px]">
                        <div className="w-16 h-16 rounded overflow-hidden bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-[10px] text-gray-500 mb-2">
                          {thumbPreview ? (
                            <img
                              src={thumbPreview}
                              className="w-full h-full object-cover"
                              alt=""
                            />
                          ) : (
                            'no img'
                          )}
                        </div>

                        {/* thumbnail_url (preferred going forward) */}
                        <label className="block text-[10px] opacity-60">
                          thumbnail_url
                        </label>
                        <input
                          className="w-full dark:bg-gray-800 text-[11px] mb-2"
                          placeholder="https://.../hero.webp"
                          value={
                            row.thumbnail_url ??
                            p.thumbnail_url ??
                            ''
                          }
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                thumbnail_url:
                                  e.target.value,
                              },
                            }))
                          }
                        />

                        {/* featured_image (legacy) */}
                        <label className="block text-[10px] opacity-60">
                          featured_image (legacy)
                        </label>
                        <input
                          className="w-full dark:bg-gray-800 text-[11px]"
                          placeholder="https://.../hero.webp"
                          value={
                            row.featured_image ??
                            p.featured_image ??
                            ''
                          }
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                featured_image:
                                  e.target.value,
                              },
                            }))
                          }
                        />
                      </td>

                      {/* TITLE / SLUG */}
                      <td className="py-2 min-w-[200px]">
                        <label className="block text-[10px] opacity-60">
                          Title
                        </label>
                        <input
                          className="w-full dark:bg-gray-800 font-semibold"
                          value={val(p, 'title')}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                title: e.target.value,
                              },
                            }))
                          }
                        />

                        <label className="block text-[10px] opacity-60 mt-2">
                          Slug
                        </label>
                        <input
                          className="w-full dark:bg-gray-800 text-xs"
                          value={val(p, 'slug')}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                slug: e.target.value,
                              },
                            }))
                          }
                        />
                        <div className="text-[10px] opacity-60">
                          /media/{val(p, 'slug', p.slug)}
                        </div>
                      </td>

                      {/* EXCERPT */}
                      <td className="py-2 min-w-[220px]">
                        <label className="block text-[10px] opacity-60">
                          Excerpt
                        </label>
                        <textarea
                          className="w-full h-24 dark:bg-gray-800 text-[12px]"
                          value={val(p, 'excerpt')}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                excerpt:
                                  e.target.value,
                              },
                            }))
                          }
                        />
                      </td>

                      {/* CONTENT */}
                      <td className="py-2 min-w-[260px]">
                        <label className="block text-[10px] opacity-60">
                          Content (MDX / long form)
                        </label>
                        <textarea
                          className="w-full h-24 dark:bg-gray-800 text-[11px]"
                          value={val(p, 'content')}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                content:
                                  e.target.value,
                              },
                            }))
                          }
                        />
                      </td>

                      {/* METADATA */}
                      <td className="py-2 min-w-[260px]">
                        <label className="block text-[10px] opacity-60">
                          Metadata JSON
                        </label>
                        <textarea
                          className="w-full h-24 dark:bg-gray-800 text-[10px]"
                          value={metaVal(p)}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                metadataStr:
                                  e.target.value,
                              },
                            }))
                          }
                        />
                        <div className="text-[10px] opacity-60 mt-1">
                          e.g. {"{ \"media_type\": \"playlist\", \"media_url\": \"https://youtube.com/...\" }"}
                        </div>
                      </td>

                      {/* ACTIONS */}
                      <td className="py-2 min-w-[120px] space-y-2">
                        <button
                          className="px-3 py-1 bg-blue-600 text-white rounded w-full text-xs"
                          onClick={() => save(p)}
                        >
                          Save
                        </button>

                        <button
                          className="px-3 py-1 bg-red-600 text-white rounded w-full text-xs"
                          onClick={() => remove(p.id)}
                        >
                          Delete
                        </button>
                      </td>
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>

        <p className="text-[10px] opacity-60 mt-4 leading-relaxed">
          Tip: After you create/update a media item, you can view it live at
          /media and /media/[slug].
        </p>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/MultiUploader.js  (size=7561 bytes) =====
// components/admin/MultiUploader.js
import { useState, useCallback } from 'react';
import axios from 'axios';
import { supabase } from '@/lib/supabase';

function extFromName(name = '') {
  const m = String(name).split('.').pop();
  return (m || '').toLowerCase();
}

function logicalTypeFromExt(ext) {
  if (['jpg','jpeg','png','webp','gif','svg','heic','heif'].includes(ext)) return 'image';
  if (['mp4','mov','m4v','webm'].includes(ext)) return 'video';
  if (['mp3','wav'].includes(ext)) return 'audio';
  if (ext === 'pdf') return 'pdf';
  return 'file';
}

function acceptFor(localType) {
  switch (localType) {
    case 'image': return 'image/*';
    case 'video': return 'video/*';
    case 'audio': return 'audio/*';
    case 'pdf':   return 'application/pdf';
    default:      return '*/*';
  }
}

function MultiUploader({
  division = 'site',
  purpose = 'general',
  fileType = 'image',     // default UI selection
  metadata = {},
  onUploaded,
}) {
  const [busy, setBusy] = useState(false);
  const [dndOver, setDndOver] = useState(false);
  const [localPurpose, setLocalPurpose] = useState(purpose);
  const [localDivision, setLocalDivision] = useState(division);
  const [localType, setLocalType] = useState(fileType);

  // how many files per request to avoid 413s
  const BATCH_SIZE = 2;

  async function fileToPayload(file) {
    const base64Full = await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(String(r.result));
      r.onerror = reject;
      r.readAsDataURL(file);
    });

    const base64Only = base64Full.includes('base64,')
      ? base64Full.split('base64,').pop()
      : base64Full;

    const ext = extFromName(file?.name || '');
    // Prefer the explicit dropdown selection, otherwise infer from extension
    const inferredType = logicalTypeFromExt(ext);
    const fileTypeToSend = localType || inferredType || 'file';
    const contentTypeToSend = file?.type || (
      ext === 'pdf' ? 'application/pdf' :
      inferredType === 'image' ? 'image/*' :
      inferredType === 'video' ? 'video/*' :
      inferredType === 'audio' ? 'audio/*' : 'application/octet-stream'
    );

    return {
      name: file.name,
      data: base64Only,
      // Hints for the API (it will still sanitize/validate):
      fileType: fileTypeToSend,       // 'image' | 'video' | 'audio' | 'pdf' | 'file'
      contentType: contentTypeToSend, // e.g. 'image/jpeg', 'application/pdf'
    };
  }

  async function uploadBatch({ token, filesChunk }) {
    const encodedFiles = [];
    for (const f of filesChunk) {
      const payloadPiece = await fileToPayload(f);
      encodedFiles.push(payloadPiece);
    }

    const resp = await axios.post(
      '/api/admin/upload-asset-multi',
      {
        files: encodedFiles,
        division: localDivision,
        purpose: localPurpose,
        metadata,
      },
      {
        headers: token ? { Authorization: `Bearer ${token}` } : {},
      }
    );

    return resp.data || { ok: false, items: [], errors: [] };
  }

  const uploadFiles = async (files) => {
    if (!files?.length) return;
    setBusy(true);

    try {
      const {
        data: { session },
      } = await supabase.auth.getSession();
      const token = session?.access_token || null;

      const allFiles = [...files];
      const batches = [];
      for (let i = 0; i < allFiles.length; i += BATCH_SIZE) {
        batches.push(allFiles.slice(i, i + BATCH_SIZE));
      }

      const allItems = [];
      const allErrors = [];

      for (const chunk of batches) {
        try {
          const { ok, items = [], errors = [] } = await uploadBatch({
            token,
            filesChunk: chunk,
          });
          allItems.push(...items);
          allErrors.push(...errors);
        } catch (batchErr) {
          const serverMsg = batchErr?.response?.data?.error || batchErr.message;
          for (const f of chunk) {
            allErrors.push({
              name: f?.name || '(unknown)',
              reason: serverMsg || 'batch failed',
            });
          }
        }
      }

      const successCount = allItems.length;
      const errorCount = allErrors.length;

      if (errorCount === 0) {
        alert(`Upload complete. ${successCount} file(s) uploaded.`);
      } else {
        const errLines = allErrors
          .slice(0, 8)
          .map((e) => `‚Ä¢ ${e.name}: ${e.reason}`)
          .join('\n');
        alert(
          `Uploaded ${successCount} file(s), ${errorCount} failed:\n${errLines}${allErrors.length > 8 ? '\n‚Ä¶' : ''}`
        );
      }

      onUploaded?.({ ok: errorCount === 0, items: allItems, errors: allErrors });
    } catch (e) {
      const serverMsg = e?.response?.data?.error || e.message;
      alert(`Upload failed: ${serverMsg}`);
    } finally {
      setBusy(false);
      setDndOver(false);
    }
  };

  const onDrop = useCallback((e) => {
    e.preventDefault();
    setDndOver(false);
    const files = [...(e.dataTransfer?.files || [])];
    uploadFiles(files);
  }, []);

  return (
    <div
      onDragOver={(e) => {
        e.preventDefault();
        setDndOver(true);
      }}
      onDragLeave={() => setDndOver(false)}
      onDrop={onDrop}
      className={`rounded border-2 border-dashed p-4 ${
        dndOver
          ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20'
          : 'border-gray-300 dark:border-gray-700'
      }`}
    >
      <div className="flex flex-wrap gap-3 mb-3">
        <select
          value={localDivision}
          onChange={(e) => setLocalDivision(e.target.value)}
          className="dark:bg-gray-900"
        >
          {['site','publishing','designs','capital','tech','media','realty'].map((d) => (
            <option key={d} value={d}>{d}</option>
          ))}
        </select>

        <select
          value={localPurpose}
          onChange={(e) => setLocalPurpose(e.target.value)}
          className="dark:bg-gray-900"
        >
          <option value="general">general</option>
          <option value="hero">hero</option>
          <option value="carousel">carousel</option>
          <option value="gallery">gallery</option>
          <option value="pdf">pdf</option>
        </select>

        <select
          value={localType}
          onChange={(e) => setLocalType(e.target.value)}
          className="dark:bg-gray-900"
        >
          <option value="image">image</option>
          <option value="video">video</option>
          <option value="audio">audio</option>
          <option value="pdf">pdf</option>
          <option value="file">file</option>
        </select>

        <label className="ml-auto inline-flex items-center gap-2 px-3 py-2 rounded bg-gray-100 dark:bg-gray-800 cursor-pointer">
          <input
            type="file"
            multiple
            accept={acceptFor(localType)}
            className="hidden"
            onChange={(e) => uploadFiles([...e.target.files])}
          />
          Choose files‚Ä¶
        </label>
      </div>

      <p className="text-sm opacity-80">
        Drag & drop files here (multi-upload supported). They‚Äôll go to{' '}
        <b>{localDivision}</b> / <b>{localPurpose}</b>.
      </p>

      {busy && <p className="mt-2 text-sm">Uploading‚Ä¶</p>}
    </div>
  );
}

export default MultiUploader;


===== FILE: components/admin/OverviewTab.js  (size=3254 bytes) =====
// components/admin/OverviewTab.js
import React, { useMemo } from 'react';
import {
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  CartesianGrid,
} from 'recharts';
import SectionCard from '@/components/admin/SectionCard';
import { currency, isWithinLastDays } from '@/lib/adminUtils';

export default function OverviewTab({ orders, subscriptions, users }) {
  const kpis = useMemo(() => {
    const last30Orders = orders.filter((o) =>
      isWithinLastDays(o.created_at, 30)
    );
    const revenueL30 = last30Orders.reduce(
      (acc, o) => acc + Number(o.total_amount || 0),
      0
    );
    const ordersL30 = last30Orders.length;
    const subsActive = subscriptions.filter(
      (s) => (s.status || '').toLowerCase() === 'active'
    ).length;
    return {
      revenueL30,
      ordersL30,
      subsActive,
      users: users.length,
    };
  }, [orders, subscriptions, users]);

  const revenueByDivision = useMemo(() => {
    const map = {};
    orders.forEach((o) => {
      if (!isWithinLastDays(o.created_at, 30)) return;
      const d = (o.division || 'site').toLowerCase();
      map[d] = (map[d] || 0) + Number(o.total_amount || 0);
    });
    return Object.entries(map).map(([division, total]) => ({
      division,
      total,
    }));
  }, [orders]);

  return (
    <>
      <SectionCard title="Key Metrics (Last 30 Days)">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div className="p-4 rounded border dark:border-gray-700 bg-white dark:bg-gray-800">
            <div className="text-sm opacity-70">Revenue</div>
            <div className="text-2xl font-bold">
              {currency(kpis.revenueL30)}
            </div>
          </div>

          <div className="p-4 rounded border dark:border-gray-700 bg-white dark:bg-gray-800">
            <div className="text-sm opacity-70">Orders</div>
            <div className="text-2xl font-bold">{kpis.ordersL30}</div>
          </div>

          <div className="p-4 rounded border dark:border-gray-700 bg-white dark:bg-gray-800">
            <div className="text-sm opacity-70">Active Subs</div>
            <div className="text-2xl font-bold">{kpis.subsActive}</div>
          </div>

          <div className="p-4 rounded border dark:border-gray-700 bg-white dark:bg-gray-800">
            <div className="text-sm opacity-70">Users</div>
            <div className="text-2xl font-bold">{kpis.users}</div>
          </div>
        </div>
      </SectionCard>

      <SectionCard title="Revenue by Division (Last 30 Days)">
        {revenueByDivision.length === 0 ? (
          <p className="opacity-70">No orders in the last 30 days.</p>
        ) : (
          <div className="w-full h-64">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={revenueByDivision}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="division" />
                <YAxis />
                <Tooltip />
                <Bar dataKey="total" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        )}
      </SectionCard>
    </>
  );
}


===== FILE: components/admin/PropertyForm.js  (size=2257 bytes) =====
// components/admin/PropertyForm.js
import { useState } from 'react';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';
import { safeJSON } from '@/lib/adminUtils';

function PropertyForm({ onCreated }) {
  const [name, setName] = useState('');
  const [slug, setSlug] = useState('');
  const [description, setDescription] = useState('');
  const [price, setPrice] = useState('200');
  const [metadataStr, setMetadataStr] = useState('');

  const create = async () => {
    try {
      if (!name || !slug) return alert('Name and slug required.');
      const metadata = safeJSON(metadataStr, {});
      const payload = {
        name,
        slug,
        description,
        price: Number(price || 0),
        division: 'realty',
        status: 'active',
        metadata,
      };
      const { error } = await supabase.from('properties').insert(payload);
      if (error) throw error;
      setName('');
      setSlug('');
      setDescription('');
      setPrice('200');
      setMetadataStr('');
      onCreated?.();
      alert('Property created.');
    } catch (e) {
      alert(`Create failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Realty ‚Äî Add Property">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input placeholder="Name" value={name} onChange={(e) => setName(e.target.value)} />
        <input placeholder="Slug" value={slug} onChange={(e) => setSlug(e.target.value)} />
        <input placeholder="Nightly Price" type="number" value={price} onChange={(e) => setPrice(e.target.value)} />
        <textarea className="md:col-span-3" placeholder="Description" value={description} onChange={(e) => setDescription(e.target.value)} />
        <textarea className="md:col-span-3" placeholder='Metadata JSON e.g. {"location":"Big Bear, CA", "ical_urls":["https://airbnb.com/ical/xxx"]}' value={metadataStr} onChange={(e) => setMetadataStr(e.target.value)} />
        <button type="button" onClick={create} className="md:col-span-3 px-4 py-2 rounded bg-blue-600 text-white">
          Create Property
        </button>
      </div>
    </SectionCard>
  );
}

export default PropertyForm;


===== FILE: components/admin/PropertyRatesPanel.js  (size=4549 bytes) =====
// components/admin/PropertyRatesPanel.js
import { useState, useEffect } from 'react';

function PropertyRatesPanel({ properties }) {
  const [selected, setSelected] = useState('');
  return (
    <div className="glass p-4 rounded">
      <div className="flex items-center gap-3 mb-3">
        <select
          className="dark:bg-gray-900"
          value={selected}
          onChange={(e)=>setSelected(e.target.value)}
        >
          <option value="">Select property‚Ä¶</option>
          {properties.map(p => (
            <option key={p.id} value={p.id}>{p.name}</option>
          ))}
        </select>
      </div>
      {selected ? <RealtyRatesManager propertyId={selected} /> : <p className="opacity-70 text-sm">Choose a property to manage seasonal rates.</p>}
    </div>
  );
}

function RealtyRatesManager({ propertyId }) {
  const [items, setItems] = useState([]);
  const [form, setForm] = useState({
    start_date: '',
    end_date: '',
    nightly_rate: '',
    min_nights: '',
    priority: 0,
    notes: '',
  });
  const load = async () => {
    if (!propertyId) return;
    const r = await fetch(`/api/realty/rates?property_id=${encodeURIComponent(propertyId)}`);
    const j = await r.json();
    setItems(j.items || []);
  };
  useEffect(() => { load(); }, [propertyId]);

  const add = async () => {
    if (!form.start_date || !form.end_date || !form.nightly_rate) {
      alert('Start, end and nightly rate are required');
      return;
    }
    const r = await fetch('/api/realty/rates', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ property_id: propertyId, ...form }),
    });
    const j = await r.json();
    if (!j.ok) return alert(j.error || 'Failed');
    setForm({ start_date: '', end_date: '', nightly_rate: '', min_nights: '', priority: 0, notes: '' });
    load();
  };
  const delItem = async (id) => {
    if (!confirm('Delete rate?')) return;
    const r = await fetch(`/api/realty/rates?id=${encodeURIComponent(id)}`, { method: 'DELETE' });
    const j = await r.json();
    if (!j.ok) return alert(j.error || 'Failed');
    load();
  };

  return (
    <div className="mt-6 glass p-4 rounded">
      <h3 className="font-semibold mb-3">Seasonal / Holiday Rates</h3>
      <div className="grid grid-cols-1 md:grid-cols-6 gap-2">
        <input type="date" value={form.start_date} onChange={(e)=>setForm({...form,start_date:e.target.value})} />
        <input type="date" value={form.end_date} onChange={(e)=>setForm({...form,end_date:e.target.value})} />
        <input type="number" placeholder="Nightly $" value={form.nightly_rate} onChange={(e)=>setForm({...form,nightly_rate:e.target.value})}/>
        <input type="number" placeholder="Min nights" value={form.min_nights} onChange={(e)=>setForm({...form,min_nights:e.target.value})}/>
        <input type="number" placeholder="Priority (higher wins)" value={form.priority} onChange={(e)=>setForm({...form,priority:e.target.value})}/>
        <input placeholder="Notes" value={form.notes} onChange={(e)=>setForm({...form,notes:e.target.value})}/>
      </div>
      <button className="mt-3 px-3 py-2 rounded bg-blue-600 text-white" onClick={add}>Add Rate</button>

      <div className="mt-4 overflow-x-auto">
        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="text-left border-b dark:border-gray-800">
              <th className="py-2">Dates</th><th>Nightly</th><th>Min</th><th>Priority</th><th>Notes</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {items.map(r => (
              <tr key={r.id} className="border-b dark:border-gray-900">
                <td className="py-2">{r.start_date} ‚Üí {r.end_date}</td>
                <td className="py-2">${Number(r.nightly_rate).toFixed(2)}</td>
                <td className="py-2">{r.min_nights ?? '‚Äî'}</td>
                <td className="py-2">{r.priority ?? 0}</td>
                <td className="py-2">{r.notes || '‚Äî'}</td>
                <td className="py-2">
                  <button className="text-red-600" onClick={()=>delItem(r.id)}>Delete</button>
                </td>
              </tr>
            ))}
            {items.length === 0 && <tr><td colSpan={6} className="py-4 opacity-70">No overrides yet.</td></tr>}
          </tbody>
        </table>
      </div>
    </div>
  );
}

export default PropertyRatesPanel;


===== FILE: components/admin/PublishingProductForm.js  (size=7250 bytes) =====
// components/admin/PublishingProductForm.js
import { useState } from 'react';
import axios from 'axios';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';
import { toArrayTags } from '@/lib/adminUtils';

function PublishingProductForm({ onCreated }) {
  const [name, setName] = useState('');
  const [price, setPrice] = useState('9.99');
  const [description, setDescription] = useState('');
  const [coverUrl, setCoverUrl] = useState('');
  const [tagsStr, setTagsStr] = useState('fantasy, lohc');
  const [amazonUrl, setAmazonUrl] = useState('');
  const [paperbackUrl, setPaperbackUrl] = useState('');
  const [kindleUrl, setKindleUrl] = useState('');
  const [hardcoverUrl, setHardcoverUrl] = useState('');
  const [pdfUrl, setPdfUrl] = useState('');
  const [format, setFormat] = useState('ebook');
  const [year, setYear] = useState(2025);
  const [primaryStore, setPrimaryStore] = useState('amazon');

  const uploadCover = async (file) => {
    if (!file) return;
    const base64 = await new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(String(r.result).split(',')[1] || '');
      r.onerror = reject;
      r.readAsDataURL(file);
    });
    const {
      data: { session },
    } = await supabase.auth.getSession();
    const token = session?.access_token;
    const res = await axios.post(
      '/api/admin/upload-asset',
      {
        file: { data: base64, name: file.name },
        file_type: 'image',
        division: 'publishing',
        purpose: 'general',
        metadata: { type: 'book_cover', year },
      },
      { headers: token ? { Authorization: `Bearer ${token}` } : {} }
    );
    if (res.data?.file_url) setCoverUrl(res.data.file_url);
  };

  const create = async () => {
    try {
      if (!name) return alert('Title required.');
      if (!coverUrl) return alert('Cover image URL required (upload or paste).');

      const numericYear = Number(year);
      const numericPrice = Number(price || 0);

      const metadata = {
        amazon_url: amazonUrl || undefined,
        paperback_url: paperbackUrl || undefined,
        kindle_url: kindleUrl || undefined,
        hardcover_url: hardcoverUrl || undefined,
        pdf_url: pdfUrl || undefined,
        format,
        year: Number.isFinite(numericYear) ? numericYear : undefined,
        primary_store: primaryStore,
      };

      const payload = {
        name,
        price: Number.isFinite(numericPrice) ? numericPrice : 0,
        division: 'publishing',
        description,
        display_image: coverUrl,
        thumbnail_url: coverUrl,
        status: 'active',
        tags: toArrayTags(tagsStr),
        metadata,
        // ‚õîÔ∏è DO NOT SEND productType ‚Äî it is not a column in `products`
      };

      // Supabase prefers an array for inserts; select().single() is optional but convenient
      const { error } = await supabase.from('products').insert([payload]).select().single();
      if (error) throw error;

      // reset form
      setName('');
      setPrice('9.99');
      setDescription('');
      setCoverUrl('');
      setAmazonUrl('');
      setPaperbackUrl('');
      setKindleUrl('');
      setHardcoverUrl('');
      setPdfUrl('');
      setFormat('ebook');
      setYear(2025);
      setTagsStr('');
      setPrimaryStore('amazon');

      onCreated?.();
      alert('Publishing product created.');
    } catch (e) {
      alert(`Create failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Publishing ‚Äî Add Book (Amazon links + sample PDF)">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input
          placeholder="Book Title"
          value={name}
          onChange={(e) => setName(e.target.value)}
        />
        <input
          placeholder="Internal Price (optional)"
          type="number"
          value={price}
          onChange={(e) => setPrice(e.target.value)}
        />
        <select value={format} onChange={(e) => setFormat(e.target.value)}>
          <option value="ebook">ebook</option>
          <option value="paperback">paperback</option>
          <option value="hardcover">hardcover</option>
        </select>

        <input
          placeholder="Cover Image URL"
          className="md:col-span-2"
          value={coverUrl}
          onChange={(e) => setCoverUrl(e.target.value)}
        />
        <label className="inline-flex items-center gap-2 px-3 py-2 rounded bg-gray-100 dark:bg-gray-800 cursor-pointer">
          <input
            type="file"
            accept="image/*"
            className="hidden"
            onChange={(e) => uploadCover(e.target.files?.[0])}
          />
          Upload Cover‚Ä¶
        </label>

        <textarea
          className="md:col-span-3"
          placeholder="Description"
          value={description}
          onChange={(e) => setDescription(e.target.value)}
        />
        <input
          className="md:col-span-3"
          placeholder="Tags (comma-separated)"
          value={tagsStr}
          onChange={(e) => setTagsStr(e.target.value)}
        />

        <input
          className="md:col-span-3"
          placeholder="Amazon (general product) URL"
          value={amazonUrl}
          onChange={(e) => setAmazonUrl(e.target.value)}
        />
        <input
          placeholder="Amazon Paperback URL"
          value={paperbackUrl}
          onChange={(e) => setPaperbackUrl(e.target.value)}
        />
        <input
          placeholder="Amazon Kindle URL"
          value={kindleUrl}
          onChange={(e) => setKindleUrl(e.target.value)}
        />
        <input
          placeholder="Amazon Hardcover URL"
          value={hardcoverUrl}
          onChange={(e) => setHardcoverUrl(e.target.value)}
        />

        <input
          className="md:col-span-2"
          placeholder="Sample PDF URL (Chapter 1)"
          value={pdfUrl}
          onChange={(e) => setPdfUrl(e.target.value)}
        />
        <input
          placeholder="Year"
          type="number"
          value={year}
          onChange={(e) => setYear(e.target.value)}
        />

        <div className="md:col-span-3 flex items-center gap-3">
          <label>Primary Store Button:</label>
          <select
            value={primaryStore}
            onChange={(e) => setPrimaryStore(e.target.value)}
            className="dark:bg-gray-900"
          >
            <option value="amazon">Amazon (auto)</option>
            <option value="paperback">Paperback</option>
            <option value="kindle">Kindle</option>
            <option value="hardcover">Hardcover</option>
            <option value="pdf">PDF (sample)</option>
          </select>

          <button
            type="button"
            onClick={create}
            className="ml-auto px-4 py-2 rounded bg-blue-600 text-white"
          >
            Create Book
          </button>
        </div>
      </div>
    </SectionCard>
  );
}

export default PublishingProductForm;


===== FILE: components/admin/PublishingTab.js  (size=13348 bytes) =====
// components/admin/PublishingTab.js
import React, { useMemo, useState } from 'react';
import PublishingProductForm from '@/components/admin/PublishingProductForm';
import SectionCard from '@/components/admin/SectionCard';
import {
  toArrayTags,
  safeJSON,
  updateProduct,
  deleteProduct,
} from '@/lib/adminUtils';

const extractMetaFields = (m = {}) => ({
  amazon_url:   m.amazon_url   || '',
  kindle_url:   m.kindle_url   || '',
  paperback_url:m.paperback_url|| '',
  store_url:    m.store_url    || '',
  pdf_url:      m.pdf_url      || '',
  format:       m.format       || '',
  year:         m.year ?? '',
});

export default function PublishingTab({ products: allProducts, refreshAll }) {
  const [edits, setEdits] = useState({});
  const publishingProducts = useMemo(
    () => allProducts.filter((p) => p.division === 'publishing'),
    [allProducts]
  );

  const buildPayload = (row, p) => {
    const payload = {
      ...(row.display_image !== undefined
        ? { display_image: row.display_image, thumbnail_url: row.display_image }
        : {}),
      ...(row.price !== undefined ? { price: parseFloat(row.price || 0) } : {}),
      ...(row.description !== undefined ? { description: row.description } : {}),
      ...(row.tagsStr !== undefined ? { tags: toArrayTags(row.tagsStr) } : {}),
    };

    // Merge metadata from quick fields + raw JSON (if user edited it)
    const currentMeta = p.metadata || {};
    const quick = row.metaQuick || {};
    const mergedQuick = {
      ...currentMeta,
      ...quick,
      // normalize simple fields
      ...(quick.year !== undefined && quick.year !== '' ? { year: Number(quick.year) } : {}),
      ...(quick.format !== undefined ? { format: quick.format } : {}),
    };

    // If user typed JSON manually, it wins. Otherwise use mergedQuick.
    if (row.metadataStr !== undefined) {
      payload.metadata = safeJSON(row.metadataStr, mergedQuick);
    } else if (Object.keys(quick).length) {
      payload.metadata = mergedQuick;
    }

    return payload;
  };

  const save = async (p) => {
    try {
      const row = edits[p.id] || {};
      if (!Object.keys(row).length) return;
      const payload = buildPayload(row, p);
      await updateProduct(p.id, payload);
      setEdits((prev) => ({ ...prev, [p.id]: {} }));
      refreshAll?.();
      alert('Saved.');
    } catch (e) {
      alert(`Save failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Publishing Division">
      <PublishingProductForm onCreated={refreshAll} />

      <div className="mt-6">
        <h3 className="font-semibold mb-3">Books</h3>

        <div className="overflow-x-auto">
          <table className="w-full text-sm border-collapse">
            <thead>
              <tr className="text-left border-b dark:border-gray-700">
                <th className="py-2">Cover</th>
                <th>Title</th>
                <th>Display Image</th>
                <th>Price</th>
                <th>Tags</th>
                <th>Description</th>
                <th>Quick Metadata</th>
                <th>Raw Metadata JSON</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              {publishingProducts.map((p) => {
                const row = edits[p.id] || {};
                const prettyMeta = JSON.stringify(p.metadata || {}, null, 2);
                const quickDefaults = extractMetaFields(p.metadata || {});
                const quick = { ...quickDefaults, ...(row.metaQuick || {}) };

                return (
                  <tr key={p.id} className="border-b dark:border-gray-800 align-top">
                    <td className="py-2">
                      {p.thumbnail_url || p.display_image ? (
                        <img
                          src={p.thumbnail_url || p.display_image}
                          className="w-14 h-14 object-cover rounded"
                          alt=""
                        />
                      ) : '‚Äî'}
                    </td>

                    <td className="py-2 min-w-[160px]">{p.name}</td>

                    <td className="py-2 min-w-[220px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="display_image / thumbnail_url"
                        value={row.display_image ?? p.display_image ?? p.thumbnail_url ?? ''}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, display_image: e.target.value },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[100px]">
                      <input
                        type="number"
                        className="w-full dark:bg-gray-800"
                        placeholder={String(p.price ?? '')}
                        value={row.price ?? (p.price ?? '')}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, price: e.target.value },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[200px]">
                      <input
                        className="w-full dark:bg-gray-800"
                        placeholder="comma,separated,tags"
                        value={row.tagsStr ?? (Array.isArray(p.tags) ? p.tags.join(', ') : '')}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, tagsStr: e.target.value },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 min-w-[260px]">
                      <textarea
                        className="w-full h-24 dark:bg-gray-800"
                        value={row.description ?? p.description ?? ''}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, description: e.target.value },
                          }))
                        }
                      />
                    </td>

                    {/* Quick Metadata fields */}
                    <td className="py-2 min-w-[320px]">
                      <div className="grid grid-cols-1 gap-2">
                        <input
                          className="w-full dark:bg-gray-800"
                          placeholder="amazon_url"
                          value={quick.amazon_url}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                metaQuick: { ...quick, amazon_url: e.target.value },
                              },
                            }))
                          }
                        />
                        <input
                          className="w-full dark:bg-gray-800"
                          placeholder="kindle_url"
                          value={quick.kindle_url}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                metaQuick: { ...quick, kindle_url: e.target.value },
                              },
                            }))
                          }
                        />
                        <input
                          className="w-full dark:bg-gray-800"
                          placeholder="paperback_url"
                          value={quick.paperback_url}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                metaQuick: { ...quick, paperback_url: e.target.value },
                              },
                            }))
                          }
                        />
                        <input
                          className="w-full dark:bg-gray-800"
                          placeholder="pdf_url (chapter preview)"
                          value={quick.pdf_url}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                metaQuick: { ...quick, pdf_url: e.target.value },
                              },
                            }))
                          }
                        />
                        <input
                          className="w-full dark:bg-gray-800"
                          placeholder="store_url (optional)"
                          value={quick.store_url}
                          onChange={(e) =>
                            setEdits((prev) => ({
                              ...prev,
                              [p.id]: {
                                ...row,
                                metaQuick: { ...quick, store_url: e.target.value },
                              },
                            }))
                          }
                        />
                        <div className="flex gap-2">
                          <input
                            className="w-1/2 dark:bg-gray-800"
                            placeholder="format (ebook/paperback/‚Ä¶)"
                            value={quick.format}
                            onChange={(e) =>
                              setEdits((prev) => ({
                                ...prev,
                                [p.id]: {
                                  ...row,
                                  metaQuick: { ...quick, format: e.target.value },
                                },
                              }))
                            }
                          />
                          <input
                            className="w-1/2 dark:bg-gray-800"
                            placeholder="year"
                            value={quick.year}
                            onChange={(e) =>
                              setEdits((prev) => ({
                                ...prev,
                                [p.id]: {
                                  ...row,
                                  metaQuick: { ...quick, year: e.target.value },
                                },
                              }))
                            }
                          />
                        </div>
                        <div className="text-[11px] opacity-60">
                          Tip: Paste your PDF URL here (from Assets ‚Üí Copy URL) to show a ‚ÄúPreview Chapter 1‚Äù button on the Publishing page.
                        </div>
                      </div>
                    </td>

                    {/* Raw JSON (optional) */}
                    <td className="py-2 min-w-[360px]">
                      <textarea
                        className="w-full h-36 dark:bg-gray-800"
                        placeholder='{"amazon_url":"‚Ä¶","paperback_url":"‚Ä¶","pdf_url":"‚Ä¶"}'
                        value={row.metadataStr ?? prettyMeta}
                        onChange={(e) =>
                          setEdits((prev) => ({
                            ...prev,
                            [p.id]: { ...row, metadataStr: e.target.value },
                          }))
                        }
                      />
                    </td>

                    <td className="py-2 space-x-2">
                      <button
                        className="px-3 py-1 bg-blue-600 text-white rounded"
                        onClick={() => save(p)}
                      >
                        Save
                      </button>

                      <button
                        className="px-3 py-1 bg-red-600 text-white rounded"
                        onClick={() => deleteProduct(p.id, refreshAll)}
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                );
              })}

              {publishingProducts.length === 0 && (
                <tr>
                  <td colSpan={9} className="py-6 opacity-70">
                    No books yet.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/QuickProductForm.js  (size=9114 bytes) =====
// components/admin/QuickProductForm.js
import { useState } from 'react';
import axios from 'axios';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';
import { toArrayTags, copyText } from '@/lib/adminUtils';

// Derive metadata from tags + title + description + thumbnail/asset
function deriveMetadata({ tags, title, description, thumbnailUrl, assetUrl }) {
  // Tags convention: [BOOKCODE, scene-code, P#, itemtype]
  const bookCode = tags[0] || '';       // e.g. "COLLAPSE"
  const sceneCode = tags[1] || '';      // e.g. "rotunda"
  const promptTag = tags[2] || 'P1';    // e.g. "P1"

  const bookMap = {
    LOHC: 'Legacy of the Hidden Clans',
    SHATTERPOINT: 'Shatterpoint Sky',
    DREAMLESS: 'Dreamless',
    NiceWorld: 'Nice World',
    TW: 'The Wandering',
    CHOICE: 'Choice',
    LAMINA: 'Lamina',
    MAGISCI: 'Magisci',
    COLLAPSE: 'Collapse',
  };

  const promptNumber =
    typeof promptTag === 'string' && promptTag.toUpperCase().startsWith('P')
      ? Number(promptTag.slice(1)) || 1
      : 1;

  const scenePretty = sceneCode ? sceneCode.replace(/-/g, ' ') : '';
  const year = new Date().getFullYear();

  return {
    book: bookCode,                          // e.g. "COLLAPSE"
    series: bookMap[bookCode] || '',         // e.g. "Collapse"
    prompt: promptNumber,                    // e.g. 1
    scene: scenePretty,                      // e.g. "rotunda"
    year,
    drop: `${bookCode || 'GEN'}_P${promptNumber}`, // e.g. "COLLAPSE_P1"
    asset_url: assetUrl || thumbnailUrl || '',
    name: title || '',
    description: description || '',
    tags, // store tags snapshot in metadata as well
  };
}

function QuickProductForm({ defaultDivision = 'designs', onCreated }) {
  const [artFile, setArtFile] = useState(null);
  const [assetUrl, setAssetUrl] = useState('');
  const [isUploading, setIsUploading] = useState(false);

  const [title, setTitle] = useState('');
  const [price, setPrice] = useState('19.99');
  const [printfulId, setPrintfulId] = useState('');
  const [thumbnailUrl, setThumbnailUrl] = useState('');
  const [description, setDescription] = useState('');
  const [tagsStr, setTagsStr] = useState('');

  const [purpose, setPurpose] = useState('general');
  const [fileType, setFileType] = useState('image');

  const doUploadAsset = async () => {
    if (!artFile) {
      alert('Choose a file first.');
      return;
    }
    setIsUploading(true);
    try {
      const base64 = await new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result).split(',')[1] || '');
        r.onerror = reject;
        r.readAsDataURL(artFile);
      });

      const {
        data: { session },
      } = await supabase.auth.getSession();
      const token = session?.access_token;

      // Use current tags/title/description to seed asset metadata
      const tags = toArrayTags(tagsStr);
      const metadata = deriveMetadata({
        tags,
        title,
        description,
        thumbnailUrl,
        assetUrl: undefined,
      });

      const res = await axios.post(
        '/api/admin/upload-asset',
        {
          file: { data: base64, name: artFile.name },
          file_type: fileType,
          division: defaultDivision,
          purpose,
          metadata,
        },
        { headers: token ? { Authorization: `Bearer ${token}` } : {} }
      );
      if (res.data?.error) throw new Error(res.data.error);
      setAssetUrl(res.data.file_url || '');
      alert('Asset uploaded. URL below.');
    } catch (e) {
      alert(`Upload failed: ${e.message}`);
    } finally {
      setIsUploading(false);
    }
  };

  const doCreateProduct = async () => {
    try {
      if (!title || !price) return alert('Title and price are required.');
      if (!thumbnailUrl) return alert('Provide a thumbnail_url (mockup).');
      if (!printfulId) return alert('Printful product ID is required.');

      const tags = toArrayTags(tagsStr);
      const metadata = deriveMetadata({
        tags,
        title,
        description,
        thumbnailUrl,
        assetUrl,
      });

      const payload = {
        name: title,
        price: parseFloat(price),
        division: defaultDivision,
        description,
        thumbnail_url: thumbnailUrl,
        printful_product_id: printfulId,
        status: 'active',
        tags,
        metadata,
        // NOTE: nft_url column is left null here; you can edit it later in DesignsTab
      };

      const { error } = await supabase.from('products').insert(payload);
      if (error) throw error;

      // reset form
      setTitle('');
      setPrice('19.99');
      setPrintfulId('');
      setThumbnailUrl('');
      setDescription('');
      setTagsStr('');
      setArtFile(null);
      setAssetUrl('');

      onCreated?.();
      alert('Product created.');
    } catch (e) {
      alert(`Create product failed: ${e.message}`);
    }
  };

  return (
    <SectionCard title="Quick Product (Designs) ‚Äî Upload ‚Üí Copy URL ‚Üí Create">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        {/* 1) Upload asset */}
        <div className="md:col-span-3 border rounded p-4 dark:border-gray-700">
          <h3 className="font-semibold mb-2">1) Upload asset (optional)</h3>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-3 items-center">
            <input
              type="file"
              onChange={(e) => setArtFile(e.target.files?.[0] || null)}
            />
            <select
              value={fileType}
              onChange={(e) => setFileType(e.target.value)}
              className="dark:bg-gray-800"
            >
              <option value="image">image</option>
              <option value="video">video</option>
              <option value="pdf">pdf</option>
            </select>
            <select
              value={purpose}
              onChange={(e) => setPurpose(e.target.value)}
              className="dark:bg-gray-800"
            >
              <option value="general">general</option>
              <option value="hero">hero</option>
              <option value="carousel">carousel</option>
            </select>
            <button
              type="button"
              onClick={doUploadAsset}
              disabled={isUploading}
              className="p-2 bg-black text-white rounded dark:bg-gray-700"
            >
              {isUploading ? 'Uploading‚Ä¶' : 'Upload ‚Üí Get URL'}
            </button>
          </div>
          {assetUrl && (
            <div className="mt-3 flex items-center gap-2">
              <input
                value={assetUrl}
                readOnly
                className="w-full dark:bg-gray-800"
              />
              <button
                type="button"
                className="px-3 py-2 bg-blue-600 text-white rounded"
                onClick={() => copyText(assetUrl)}
              >
                Copy
              </button>
            </div>
          )}
        </div>

        {/* 2) Create product */}
        <div className="md:col-span-3 border rounded p-4 dark:border-gray-700">
          <h3 className="font-semibold mb-2">2) Create product</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <input
              placeholder="Title"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
            />
            <input
              placeholder="Price"
              type="number"
              value={price}
              onChange={(e) => setPrice(e.target.value)}
            />
            <input
              placeholder="Printful Product ID"
              value={printfulId}
              onChange={(e) => setPrintfulId(e.target.value)}
            />
            <input
              placeholder="thumbnail_url (mockup)"
              value={thumbnailUrl}
              onChange={(e) => setThumbnailUrl(e.target.value)}
            />
            <input
              className="md:col-span-2"
              placeholder="Description"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
            />
            <input
              className="md:col-span-2"
              placeholder="Tags (comma-separated, e.g. COLLAPSE, rotunda, P1, mug)"
              value={tagsStr}
              onChange={(e) => setTagsStr(e.target.value)}
            />
          </div>
          <div className="mt-3">
            <button
              type="button"
              onClick={doCreateProduct}
              className="p-2 bg-black text-white rounded dark:bg-gray-700"
            >
              Create Product
            </button>
          </div>
        </div>
      </div>
    </SectionCard>
  );
}

export default QuickProductForm;


===== FILE: components/admin/RealtyTab.js  (size=41841 bytes) =====
// components/admin/RealtyTab.js
import React, { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import MultiUploader from '@/components/admin/MultiUploader';
import AttachToProperty from '@/components/admin/AttachToProperty';
import PropertyRatesPanel from '@/components/admin/PropertyRatesPanel';
import RealtyTestEmailPanelWithProperty from '@/components/admin/RealtyTestEmailPanelWithProperty';
import PropertyForm from '@/components/admin/PropertyForm';
import SectionCard from '@/components/admin/SectionCard';
import { safeJSON, copyText, updateRow } from '@/lib/adminUtils';

/**
 * Small money formatter helper for table display.
 * amount_cents is stored as integer cents.
 */
function formatMoney(amount_cents, currency = 'usd') {
  if (amount_cents == null) return '‚Äî';
  const dollars = Number(amount_cents) / 100;
  return `${currency.toUpperCase()} $${dollars.toFixed(2)}`;
}

/**
 * UpcomingStaysPanel
 * - Fetches reservations from /api/realty/reservations-admin
 * - Shows future (and recent) stays, guest info, and money
 */
function UpcomingStaysPanel() {
  const [loadingResv, setLoadingResv] = useState(true);
  const [reservations, setReservations] = useState([]);

  useEffect(() => {
    (async () => {
      try {
        const r = await fetch('/api/realty/reservations-admin');
        const j = await r.json();
        if (j.ok) {
          setReservations(j.items || []);
        } else {
          console.error('reservations-admin error:', j.error);
          setReservations([]);
        }
      } catch (err) {
        console.error('reservations-admin crash:', err);
        setReservations([]);
      } finally {
        setLoadingResv(false);
      }
    })();
  }, []);

  // simple revenue sum of PAID
  const totalPaidCents = reservations
    .filter((r) => r.status === 'paid')
    .reduce((acc, r) => acc + (Number(r.amount_cents) || 0), 0);

  return (
    <div className="space-y-4 mb-10">
      <h3 className="text-xl font-bold">Upcoming Stays / Revenue</h3>

      <div className="text-sm opacity-80">
        <div>
          <strong>Total Paid (all listed):</strong>{' '}
          {formatMoney(totalPaidCents, 'usd')}
        </div>
        <div className="text-[11px] opacity-60">
          Includes only reservations currently marked &quot;paid&quot;.
        </div>
      </div>

      <div className="overflow-x-auto border rounded dark:border-gray-700">
        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="text-left border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-900/40">
              <th className="py-2 px-2">Property</th>
              <th className="py-2 px-2">Stay</th>
              <th className="py-2 px-2">Nights / Guests</th>
              <th className="py-2 px-2">Guest Contact</th>
              <th className="py-2 px-2">Notes</th>
              <th className="py-2 px-2 whitespace-nowrap">Total</th>
              <th className="py-2 px-2">Status</th>
            </tr>
          </thead>
          <tbody>
            {loadingResv ? (
              <tr>
                <td
                  className="py-6 text-center opacity-70"
                  colSpan={7}
                >
                  Loading reservations‚Ä¶
                </td>
              </tr>
            ) : reservations.length === 0 ? (
              <tr>
                <td
                  className="py-6 text-center opacity-70"
                  colSpan={7}
                >
                  No reservations yet.
                </td>
              </tr>
            ) : (
              reservations.map((r) => (
                <tr
                  key={r.id}
                  className="border-b dark:border-gray-800 align-top"
                >
                  {/* Property name / link */}
                  <td className="py-2 px-2 min-w-[140px]">
                    <div className="font-semibold">
                      {r.property_name || '‚Äî'}
                    </div>
                    {r.property_slug ? (
                      <a
                        className="text-xs text-blue-600 underline"
                        href={`/realty/${r.property_slug}`}
                        target="_blank"
                        rel="noreferrer"
                      >
                        /realty/{r.property_slug}
                      </a>
                    ) : (
                      <div className="text-[10px] opacity-50">
                        (no slug)
                      </div>
                    )}
                  </td>

                  {/* Dates */}
                  <td className="py-2 px-2 min-w-[140px] text-xs leading-relaxed">
                    <div>
                      <strong>Check-in:</strong> {r.checkin}
                    </div>
                    <div>
                      <strong>Check-out:</strong> {r.checkout}
                    </div>
                  </td>

                  {/* Nights / guests */}
                  <td className="py-2 px-2 min-w-[90px] text-xs leading-relaxed">
                    <div>{r.nights} nights</div>
                    <div>{r.guests} guests</div>
                  </td>

                  {/* Guest contact */}
                  <td className="py-2 px-2 min-w-[160px] text-xs leading-relaxed">
                    <div className="font-medium">
                      {r.guest_name || '‚Äî'}
                    </div>
                    <div className="break-words">
                      {r.guest_email || '‚Äî'}
                    </div>
                    {r.guest_phone ? (
                      <div className="opacity-70">
                        {r.guest_phone}
                      </div>
                    ) : null}
                  </td>

                  {/* Notes to host */}
                  <td className="py-2 px-2 min-w-[160px] text-xs">
                    {r.notes ? r.notes : <span className="opacity-50">‚Äî</span>}
                  </td>

                  {/* Amount */}
                  <td className="py-2 px-2 whitespace-nowrap text-xs font-semibold">
                    {formatMoney(r.amount_cents, r.currency)}
                  </td>

                  {/* Status */}
                  <td className="py-2 px-2 min-w-[80px] text-xs">
                    <span
                      className={
                        r.status === 'paid'
                          ? 'bg-green-100 text-green-800 px-2 py-1 rounded text-[11px] font-semibold'
                          : 'bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-[11px] font-semibold'
                      }
                    >
                      {r.status || '‚Äî'}
                    </span>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      <p className="text-[10px] opacity-60 leading-relaxed">
        This is your internal board. Cleaners / ops can look here for
        arrivals, departures, and payout amounts without touching Stripe
        or Supabase.
      </p>
    </div>
  );
}

export default function RealtyTab({
  properties: allProperties,
  assets,
  refreshAll,
}) {
  const [edits, setEdits] = useState({});
  const [openGalleryFor, setOpenGalleryFor] = useState(null);
  const [galleryDrafts, setGalleryDrafts] = useState({});
  const [newGalleryInput, setNewGalleryInput] = useState({});

  // filter just realty props and gallery assets
  const realtyProperties = allProperties
    .filter((p) => (p.division || 'realty') === 'realty')
    .sort(
      (a, b) =>
        new Date(b.created_at) - new Date(a.created_at)
    );

  const realtyAssets = assets
    .filter(
      (a) => a.division === 'realty' && a.purpose === 'gallery'
    )
    .slice(0, 50);

  // build payload for saving edits of a property row
  const buildPayload = (row, propRow) => {
    const baseMeta = propRow.metadata || {};
    let mergedMeta = baseMeta;

    // user edited metadataStr -> parse
    if (row.metadataStr !== undefined) {
      mergedMeta = safeJSON(row.metadataStr, baseMeta);
    }

    // if they edited cover_url directly, inject into metadata
    if (row.cover_url !== undefined) {
      mergedMeta = {
        ...mergedMeta,
        cover_url: row.cover_url || '',
      };
    }

    return {
      ...(row.name !== undefined ? { name: row.name } : {}),
      ...(row.slug !== undefined ? { slug: row.slug } : {}),
      ...(row.price !== undefined
        ? { price: parseFloat(row.price || 0) }
        : {}),
      ...(row.status !== undefined ? { status: row.status } : {}),
      ...(row.description !== undefined
        ? { description: row.description }
        : {}),
      ...((row.metadataStr !== undefined ||
        row.cover_url !== undefined)
        ? { metadata: mergedMeta }
        : {}),
    };
  };

  // save basic info for a property
  const saveProperty = async (propRow) => {
    try {
      const row = edits[propRow.id] || {};
      if (!Object.keys(row).length) return;
      const payload = buildPayload(row, propRow);

      await updateRow('properties', propRow.id, payload);

      setEdits((prev) => ({ ...prev, [propRow.id]: {} }));
      refreshAll?.();
      alert('Property saved.');
    } catch (e) {
      alert(`Save failed: ${e.message}`);
    }
  };

  // üî• DELETE PROPERTY
  const deleteProperty = async (propRow) => {
    const name = propRow.name || propRow.slug || propRow.id;
    const ok = confirm(
      `Delete property "${name}"?\nThis will remove it from the database.\nBooked reservations and uploaded gallery assets are NOT automatically deleted.`
    );
    if (!ok) return;

    try {
      const { error } = await supabase
        .from('properties')
        .delete()
        .eq('id', propRow.id);

      if (error) throw error;

      refreshAll?.();
      alert('Property deleted.');
    } catch (err) {
      alert(`Delete failed: ${err.message}`);
    }
  };

  // expand/collapse gallery editor for one property
  const toggleGalleryEditor = (propRow) => {
    setOpenGalleryFor((cur) =>
      cur === propRow.id ? null : propRow.id
    );

    setGalleryDrafts((prev) => {
      if (prev[propRow.id]) return prev;
      const existing = Array.from(
        new Set(
          Array.isArray(propRow.metadata?.gallery_urls)
            ? propRow.metadata.gallery_urls
            : []
        )
      );
      return {
        ...prev,
        [propRow.id]: [...existing],
      };
    });

    setNewGalleryInput((prev) => ({
      ...prev,
      [propRow.id]: '',
    }));
  };

  const removeGalleryImage = (propId, idx) => {
    setGalleryDrafts((prev) => {
      const list = prev[propId] || [];
      const next = list.filter((_, i) => i !== idx);
      return { ...prev, [propId]: next };
    });
  };

  // take comma/newline separated URLs in newGalleryInput[propId] and merge them into galleryDrafts[propId]
  const addGalleryImages = (propId) => {
    setGalleryDrafts((prev) => {
      const current = prev[propId] || [];
      const raw = newGalleryInput[propId] || '';
      const toAdd = raw
        .split(/[\n,]/)
        .map((s) => s.trim())
        .filter(Boolean);
      const deduped = Array.from(
        new Set([...current, ...toAdd])
      );
      return { ...prev, [propId]: deduped };
    });

    setNewGalleryInput((prev) => ({
      ...prev,
      [propId]: '',
    }));
  };

  const saveGallery = async (propRow) => {
    const propId = propRow.id;
    const draftList = galleryDrafts[propId] || [];

    const mergedMeta = {
      ...(propRow.metadata || {}),
      gallery_urls: draftList,
    };

    const { error } = await supabase
      .from('properties')
      .update({ metadata: mergedMeta })
      .eq('id', propId);

    if (error) {
      alert(error.message);
      return;
    }

    alert('Gallery saved.');
    refreshAll?.();
  };

  // üî• NEW: deleteAsset (for "Recent Realty Uploads")
  // This removes the asset row from the assets table.
  // NOTE: we're not deleting the actual storage object here because we don't
  // know your bucket/path columns. If you store bucket/path in `assets`,
  // you can extend this to also call supabase.storage.from(bucket).remove([path]).
  const deleteAsset = async (assetRow) => {
    const label = assetRow.filename || assetRow.file_url || assetRow.id;
    const ok = confirm(
      `Delete this uploaded file?\n${label}\n\nThis removes it from the assets table so it won't show up anymore.`
    );
    if (!ok) return;

    try {
      const { error } = await supabase
        .from('assets')
        .delete()
        .eq('id', assetRow.id);

      if (error) throw error;

      refreshAll?.();
      alert('Asset deleted.');
    } catch (err) {
      alert(`Delete failed: ${err.message}`);
    }
  };

  return (
    <SectionCard title="Realty / Rentals">
      <div className="space-y-6">
        {/* NEW: Upcoming stays / revenue dashboard */}
        <UpcomingStaysPanel />

        {/* uploader */}
        <div>
          <h3 className="text-xl font-bold mb-2">
            Realty Gallery Uploader
          </h3>
          <p className="text-sm opacity-80 mb-4">
            Upload multiple images to storage under{' '}
            <code>
              assets/realty/&lt;purpose&gt;/YYYY/MM
            </code>
            . Then attach them to a property (gallery).
          </p>

          <MultiUploader
            division="realty"
            purpose="gallery"
            onUploaded={refreshAll}
          />
        </div>

        {/* attach assets to property */}
        <div className="border-t pt-4">
          <h4 className="font-semibold mb-2">
            Attach uploaded URLs to a property
          </h4>
          <AttachToProperty
            properties={realtyProperties}
            onAfter={refreshAll}
          />
        </div>

        {/* seasonal rates */}
        <div className="border-t pt-4">
          <h4 className="font-semibold mb-2">
            Manage Seasonal Rates for a Property
          </h4>
          <PropertyRatesPanel
            properties={realtyProperties}
          />
        </div>

        {/* test email */}
        <div className="border-t pt-4">
          <h4 className="font-semibold mb-2">
            Send Test Itinerary Email
          </h4>
          <RealtyTestEmailPanelWithProperty />
        </div>

        {/* new property form */}
        <div className="border-t pt-4">
          <h4 className="font-semibold mb-2">
            Create New Property
          </h4>
          <PropertyForm onCreated={refreshAll} />
        </div>

        {/* recent uploads */}
        <div className="border-t pt-4">
          <h4 className="font-semibold mb-2">
            Recent Realty Uploads (gallery)
          </h4>

          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left border-b dark:border-gray-700">
                  <th className="py-2">Preview</th>
                  <th>Filename</th>
                  <th>URL</th>
                  <th>Copy</th>
                  {/* üî• NEW column header */}
                  <th>Delete</th>
                </tr>
              </thead>
              <tbody>
                {realtyAssets.length > 0 ? (
                  realtyAssets.map((a) => (
                    <tr
                      key={a.id}
                      className="border-b dark:border-gray-800 align-top"
                    >
                      <td className="py-2">
                        {a.file_type === 'image' ? (
                          <img
                            src={a.file_url}
                            className="w-16 h-16 object-cover rounded"
                            alt=""
                          />
                        ) : (
                          '‚Äî'
                        )}
                      </td>
                      <td className="py-2">
                        {a.filename || '‚Äî'}
                      </td>
                      <td className="py-2 max-w-[280px] truncate">
                        {a.file_url}
                      </td>
                      <td className="py-2">
                        <button
                          className="text-blue-600 underline"
                          type="button"
                          onClick={() =>
                            copyText(a.file_url)
                          }
                        >
                          Copy URL
                        </button>
                      </td>
                      {/* üî• NEW delete cell */}
                      <td className="py-2">
                        <button
                          className="px-3 py-1 bg-red-600 text-white rounded text-xs"
                          type="button"
                          onClick={() => deleteAsset(a)}
                        >
                          Delete
                        </button>
                      </td>
                    </tr>
                  ))
                ) : (
                  <tr>
                    <td
                      className="py-6 opacity-70"
                      colSpan={5}
                    >
                      No realty uploads yet.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>

          <p className="text-xs opacity-60 mt-2">
            Tip: copy a few URLs, paste them into the property
            gallery editor below.
          </p>
        </div>

        {/* property list / editor */}
        <div className="border-t pt-4">
          <h4 className="font-semibold mb-2">
            Your Properties (Most Recent First)
          </h4>

          <div className="overflow-x-auto">
            <table className="w-full text-sm border-collapse">
              <thead>
                <tr className="text-left border-b dark:border-gray-700">
                  <th className="py-2">Name</th>
                  <th>Slug</th>
                  <th>Base Price</th>
                  <th>Status</th>
                  <th>Description</th>
                  <th>Cover &amp; Metadata</th>
                  <th>Actions</th>
                </tr>
              </thead>

              <tbody>
                {realtyProperties.length > 0 ? (
                  realtyProperties.map((propRow) => {
                    const row =
                      edits[propRow.id] || {};
                    const coverPreview =
                      row.cover_url ??
                      propRow.metadata?.cover_url ??
                      '';

                    return (
                      <React.Fragment
                        key={propRow.id}
                      >
                        <tr className="border-b dark:border-gray-800 align-top">
                          {/* name */}
                          <td className="py-2 min-w-[180px]">
                            <input
                              className="w-full dark:bg-gray-800"
                              placeholder={
                                propRow.name ||
                                ''
                              }
                              value={
                                row.name ??
                                propRow.name ??
                                ''
                              }
                              onChange={(e) =>
                                setEdits(
                                  (prev) => ({
                                    ...prev,
                                    [propRow.id]:
                                      {
                                        ...prev[
                                          propRow
                                            .id
                                        ],
                                        name: e
                                          .target
                                          .value,
                                      },
                                  })
                                )
                              }
                            />
                          </td>

                          {/* slug */}
                          <td className="py-2 min-w-[160px]">
                            <input
                              className="w-full dark:bg-gray-800"
                              placeholder={
                                propRow.slug ||
                                ''
                              }
                              value={
                                row.slug ??
                                propRow.slug ??
                                ''
                              }
                              onChange={(e) =>
                                setEdits(
                                  (prev) => ({
                                    ...prev,
                                    [propRow.id]:
                                      {
                                        ...prev[
                                          propRow
                                            .id
                                        ],
                                        slug: e
                                          .target
                                          .value,
                                      },
                                  })
                                )
                              }
                            />
                            <div className="text-[10px] opacity-60">
                              /realty/
                              {row.slug ??
                                propRow.slug}
                            </div>
                          </td>

                          {/* price */}
                          <td className="py-2 min-w-[100px]">
                            <input
                              type="number"
                              className="w-full dark:bg-gray-800"
                              placeholder={String(
                                propRow.price ??
                                  ''
                              )}
                              value={
                                row.price ??
                                propRow.price ??
                                ''
                              }
                              onChange={(e) =>
                                setEdits(
                                  (prev) => ({
                                    ...prev,
                                    [propRow.id]:
                                      {
                                        ...prev[
                                          propRow
                                            .id
                                        ],
                                        price: e
                                          .target
                                          .value,
                                      },
                                  })
                                )
                              }
                            />
                          </td>

                          {/* status */}
                          <td className="py-2 min-w-[120px]">
                            <input
                              className="w-full dark:bg-gray-800"
                              placeholder={
                                propRow.status ||
                                'active'
                              }
                              value={
                                row.status ??
                                propRow.status ??
                                ''
                              }
                              onChange={(e) =>
                                setEdits(
                                  (prev) => ({
                                    ...prev,
                                    [propRow.id]:
                                      {
                                        ...prev[
                                          propRow
                                            .id
                                        ],
                                        status:
                                          e
                                            .target
                                            .value,
                                      },
                                  })
                                )
                              }
                            />
                          </td>

                          {/* description */}
                          <td className="py-2 min-w-[260px]">
                            <textarea
                              className="w-full h-24 dark:bg-gray-800"
                              placeholder="Description"
                              value={
                                row
                                  .description ??
                                propRow
                                  .description ??
                                ''
                              }
                              onChange={(e) =>
                                setEdits(
                                  (prev) => ({
                                    ...prev,
                                    [propRow.id]:
                                      {
                                        ...prev[
                                          propRow
                                            .id
                                        ],
                                        description:
                                          e
                                            .target
                                            .value,
                                      },
                                  })
                                )
                              }
                            />
                          </td>

                          {/* metadata / cover */}
                          <td className="py-2 min-w-[320px]">
                            <div className="mb-2 flex gap-2 items-start">
                              <div className="w-16 h-16 rounded overflow-hidden bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs text-gray-500">
                                {coverPreview ? (
                                  <img
                                    src={
                                      coverPreview
                                    }
                                    className="w-full h-full object-cover"
                                    alt="cover"
                                  />
                                ) : (
                                  'no img'
                                )}
                              </div>

                              <div className="flex-1">
                                <label className="block text-[11px] opacity-60 mb-1">
                                  Cover URL (card /
                                  hero image)
                                </label>
                                <input
                                  className="w-full dark:bg-gray-800 text-xs"
                                  placeholder="https://.../your-image.webp"
                                  value={
                                    coverPreview
                                  }
                                  onChange={(e) =>
                                    setEdits(
                                      (prev) => ({
                                        ...prev,
                                        [propRow.id]:
                                          {
                                            ...prev[
                                              propRow
                                                .id
                                            ],
                                            cover_url:
                                              e
                                                .target
                                                .value,
                                          },
                                      })
                                    )
                                  }
                                />
                              </div>
                            </div>

                            <textarea
                              className="w-full h-24 dark:bg-gray-800 text-xs"
                              placeholder='{"location":"Big Bear, CA","ical_urls":["https://..."],"cover_url":"https://..."}'
                              value={
                                row
                                  .metadataStr ??
                                JSON.stringify(
                                  propRow
                                    .metadata ||
                                    {},
                                  null,
                                  0
                                )
                              }
                              onChange={(e) =>
                                setEdits(
                                  (prev) => ({
                                    ...prev,
                                    [propRow.id]:
                                      {
                                        ...prev[
                                          propRow
                                            .id
                                        ],
                                        metadataStr:
                                          e
                                            .target
                                            .value,
                                      },
                                  })
                                )
                              }
                            />

                            <div className="text-[10px] opacity-60 mt-1">
                              location,
                              cover_url,
                              ical_urls all
                              live in
                              metadata.
                            </div>
                          </td>

                          {/* actions */}
                          <td className="py-2 min-w-[100px] space-y-2">
                            <button
                              className="px-3 py-1 bg-blue-600 text-white rounded w-full"
                              onClick={() =>
                                saveProperty(
                                  propRow
                                )
                              }
                            >
                              Save
                            </button>

                            <button
                              className="px-3 py-1 bg-gray-700 text-white rounded w-full"
                              onClick={() =>
                                toggleGalleryEditor(
                                  propRow
                                )
                              }
                            >
                              {openGalleryFor ===
                              propRow.id
                                ? 'Close Gallery'
                                : 'Gallery'}
                            </button>

                            <button
                              className="px-3 py-1 bg-red-600 text-white rounded w-full"
                              onClick={() =>
                                deleteProperty(
                                  propRow
                                )
                              }
                            >
                              Delete
                            </button>
                          </td>
                        </tr>

                        {openGalleryFor ===
                          propRow.id && (
                          <tr className="border-b dark:border-gray-800 bg-gray-50 dark:bg-gray-900/40">
                            <td
                              colSpan={7}
                              className="p-4"
                            >
                              {/* gallery editor block */}
                              <div className="space-y-4">
                                <div className="text-sm font-semibold">
                                  Property Gallery (
                                  {galleryDrafts[
                                    propRow
                                      .id
                                  ]?.length || 0}{' '}
                                  images)
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-6 gap-2">
                                  {(
                                    galleryDrafts[
                                      propRow
                                        .id
                                    ] || []
                                  ).map(
                                    (
                                      url,
                                      idx
                                    ) => (
                                      <div
                                        key={
                                          idx
                                        }
                                        className="relative border rounded overflow-hidden bg-gray-200 dark:bg-gray-800"
                                      >
                                        <img
                                          src={
                                            url
                                          }
                                          className="w-full h-24 object-cover"
                                          alt={`img-${idx}`}
                                        />
                                        <button
                                          className="absolute top-1 right-1 bg-red-600 text-white text-xs px-1.5 py-0.5 rounded"
                                          onClick={() =>
                                            removeGalleryImage(
                                              propRow.id,
                                              idx
                                            )
                                          }
                                          title="Remove this image from gallery"
                                        >
                                          ‚úï
                                        </button>
                                      </div>
                                    )
                                  )}

                                  {(
                                    galleryDrafts[
                                      propRow
                                        .id
                                    ] || []
                                  ).length ===
                                    0 && (
                                    <div className="text-xs text-gray-500 col-span-full">
                                      No
                                      images
                                      yet.
                                    </div>
                                  )}
                                </div>

                                <div className="space-y-2">
                                  <label className="block text-xs opacity-70">
                                    Add
                                    image
                                    URLs
                                    (comma
                                    or
                                    newline
                                    separated).
                                    Paste
                                    from
                                    ‚ÄúRecent
                                    Realty
                                    Uploads‚Äù
                                    or
                                    wherever.
                                  </label>

                                  <textarea
                                    className="w-full h-20 text-xs dark:bg-gray-800 border rounded p-2"
                                    value={
                                      newGalleryInput[
                                        propRow
                                          .id
                                      ] ||
                                      ''
                                    }
                                    onChange={(
                                      e
                                    ) =>
                                      setNewGalleryInput(
                                        (
                                          prev
                                        ) => ({
                                          ...prev,
                                          [propRow.id]:
                                            e
                                              .target
                                              .value,
                                        })
                                      )
                                    }
                                    placeholder={`https://.../photo1.webp\nhttps://.../photo2.webp`}
                                  />

                                  <button
                                    className="px-3 py-1 bg-gray-800 text-white rounded text-sm"
                                    type="button"
                                    onClick={() =>
                                      addGalleryImages(
                                        propRow.id
                                      )
                                    }
                                  >
                                    Add to
                                    Gallery
                                  </button>
                                </div>

                                <div>
                                  <button
                                    className="px-4 py-2 bg-green-600 text-white rounded text-sm"
                                    type="button"
                                    onClick={() =>
                                      saveGallery(
                                        propRow
                                      )
                                    }
                                  >
                                    Save
                                    Gallery
                                    Changes
                                  </button>
                                </div>

                                <div className="text-[10px] opacity-60 leading-relaxed">
                                  First
                                  image
                                  in
                                  this
                                  list
                                  shows
                                  as
                                  the
                                  big
                                  hero
                                  on
                                  the
                                  property
                                  page.
                                  Reorder
                                  by
                                  removing
                                  and
                                  re-adding
                                  (drag-and-drop
                                  later).
                                </div>
                              </div>
                            </td>
                          </tr>
                        )}
                      </React.Fragment>
                    );
                  })
                ) : (
                  <tr>
                    <td
                      className="py-6 opacity-70"
                      colSpan={7}
                    >
                      No properties yet.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/RealtyTestEmailPanelWithProperty.js  (size=1603 bytes) =====
// components/admin/RealtyTestEmailPanelWithProperty.js
import { useState } from 'react';
import axios from 'axios';

function RealtyTestEmailPanelWithProperty() {
  // Assume fetching properties or use context; for stub, empty
  return <RealtyTestEmailPanel properties={[]} />;
}

function RealtyTestEmailPanel({ properties }) {
  const [selected, setSelected] = useState('');
  const [email, setEmail] = useState(process.env.NEXT_PUBLIC_TEST_EMAIL || '');
  const [busy, setBusy] = useState(false);

  const sendTest = async () => {
    if (!selected) return alert('Select a property');
    if (!email) return alert('Enter an email');
    setBusy(true);
    try {
      const { data } = await axios.post('/api/realty/test-email', { property_id: selected, email });
      alert(data.message || 'Sent!');
    } catch (e) {
      alert(e.message);
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="glass p-4 rounded">
      <select value={selected} onChange={e => setSelected(e.target.value)} className="dark:bg-gray-800">
        <option value="">Select property</option>
        {properties.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
      </select>
      <input value={email} onChange={e => setEmail(e.target.value)} placeholder="Test email" className="dark:bg-gray-800" />
      <button onClick={sendTest} disabled={busy} className="px-4 py-2 rounded bg-blue-600 text-white">
        {busy ? 'Sending...' : 'Send Test Email'}
      </button>
    </div>
  );
}

export default RealtyTestEmailPanelWithProperty;


===== FILE: components/admin/SectionCard.js  (size=313 bytes) =====
'use client';
import React from 'react';

export default function SectionCard({ title, className = '', children }) {
  return (
    <section className={`glass p-6 rounded ${className}`}>
      {title ? <h2 className="text-2xl font-bold mb-4">{title}</h2> : null}
      {children}
    </section>
  );
}


===== FILE: components/admin/TechShowcaseForm.js  (size=4551 bytes) =====
// components/admin/TechShowcaseForm.js
import { useState, useEffect } from 'react';
import { supabase } from '@/lib/supabase';
import SectionCard from '@/components/admin/SectionCard';

// helper: turn "Daito App: AI Focus" -> "daito-app-ai-focus"
function slugify(str) {
  return str
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '') // remove non alphanum / space / dash
    .trim()
    .replace(/\s+/g, '-'); // collapse whitespace to hyphen
}

function TechShowcaseForm({ onCreated }) {
  const [title, setTitle] = useState('');
  const [slug, setSlug] = useState('');
  const [excerpt, setExcerpt] = useState('');
  const [content, setContent] = useState('');
  const [featuredImage, setFeaturedImage] = useState('');
  const [appUrl, setAppUrl] = useState('');
  const [appType, setAppType] = useState('app');

  // NEW: track if user has manually edited slug
  const [slugTouched, setSlugTouched] = useState(false);

  // whenever title changes, if slug has NOT been manually touched yet,
  // keep slug in sync
  useEffect(() => {
    if (!slugTouched && title) {
      setSlug(slugify(title));
    }
  }, [title, slugTouched]);

  async function create() {
    try {
      if (!title) return alert('Title required.');
      if (!slug) return alert('Slug required.');

      const payload = {
        title,
        slug,
        excerpt,
        content,
        featured_image: featuredImage || null,
        status: 'published',
        division: 'tech',
        metadata: {
          app_type: appType,
          app_url: appUrl || null,
        },
      };

      const { error } = await supabase.from('posts').insert(payload);
      if (error) throw error;

      // reset form
      setTitle('');
      setSlug('');
      setExcerpt('');
      setContent('');
      setFeaturedImage('');
      setAppUrl('');
      setAppType('app');
      setSlugTouched(false);

      onCreated?.();
      alert('‚úÖ Tech showcase item created.');
    } catch (e) {
      alert(`‚ùå Create failed: ${e.message}`);
    }
  }

  return (
    <SectionCard title="Tech ‚Äî Add Showcase Item (App / Site / Tool)">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        {/* Title */}
        <input
          placeholder="Title (e.g. Daito App)"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          className="dark:bg-gray-800"
        />

        {/* Slug */}
        <input
          placeholder="Slug (auto or custom)"
          value={slug}
          onChange={(e) => {
            setSlug(e.target.value);
            setSlugTouched(true); // lock slug so it won't keep auto-updating
          }}
          className="dark:bg-gray-800"
        />

        {/* App Type */}
        <select
          value={appType}
          onChange={(e) => setAppType(e.target.value)}
          className="dark:bg-gray-800"
        >
          <option value="app">App</option>
          <option value="website">Website</option>
          <option value="review">Review</option>
        </select>

        {/* Featured Image */}
        <input
          placeholder="Featured Image URL (screenshot)"
          className="md:col-span-2 dark:bg-gray-800"
          value={featuredImage}
          onChange={(e) => setFeaturedImage(e.target.value)}
        />

        {/* App URL */}
        <input
          placeholder="App/Website URL (App Store, Play Store, etc.)"
          className="md:col-span-1 dark:bg-gray-800"
          value={appUrl}
          onChange={(e) => setAppUrl(e.target.value)}
        />

        {/* Short Excerpt */}
        <textarea
          className="md:col-span-3 dark:bg-gray-800"
          placeholder="Short excerpt (tagline / what this app does)"
          value={excerpt}
          onChange={(e) => setExcerpt(e.target.value)}
        />

        {/* Long Content */}
        <textarea
          className="md:col-span-3 h-32 dark:bg-gray-800"
          placeholder="Content / Description (optional long text or MDX)"
          value={content}
          onChange={(e) => setContent(e.target.value)}
        />

        <button
          type="button"
          onClick={create}
          className="md:col-span-3 px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700 transition"
        >
          Create Showcase Item
        </button>
      </div>
    </SectionCard>
  );
}

export default TechShowcaseForm;


===== FILE: components/admin/TechTab.js  (size=3116 bytes) =====
// components/admin/TechTab.js
import React from 'react';
import TechShowcaseForm from '@/components/admin/TechShowcaseForm';
import SectionCard from '@/components/admin/SectionCard';
import { deleteRow } from '@/lib/adminUtils';

export default function TechTab({ posts: allPosts, refreshAll }) {
  const techPosts = allPosts.filter((p) => p.division === 'tech');

  return (
    <SectionCard title="Tech Division">
      <TechShowcaseForm onCreated={refreshAll} />

      <div className="mt-6">
        <h3 className="font-semibold mb-3">Showcase Items (Tech)</h3>

        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="text-left border-b dark:border-gray-700">
              <th className="py-2">Title</th>
              <th>Slug</th>
              <th>Image</th>
              <th>Metadata</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {techPosts.map((p) => (
              <tr
                key={p.id}
                className="border-b dark:border-gray-800 align-top"
              >
                <td className="py-2 font-semibold">{p.title}</td>
                <td className="py-2 text-xs text-gray-400">{p.slug}</td>
                <td className="py-2">
                  {p.featured_image ? (
                    <img
                      src={p.featured_image}
                      className="w-16 h-16 object-cover rounded"
                      alt={p.title}
                    />
                  ) : (
                    '‚Äî'
                  )}
                </td>
                <td className="py-2 min-w-[220px]">
                  <textarea
                    className="w-full h-20 dark:bg-gray-800 text-xs"
                    value={JSON.stringify(p.metadata || {}, null, 2)}
                    readOnly
                  />
                </td>
                <td className="py-2 space-y-2">
                  <button
                    className="px-3 py-1 bg-blue-600 text-white rounded w-full text-xs"
                    onClick={() => alert('Edit feature coming soon!')}
                  >
                    Edit
                  </button>
                  <button
                    className="px-3 py-1 bg-red-600 text-white rounded w-full text-xs"
                    onClick={() =>
                      deleteRow(
                        'posts',
                        p.id,
                        refreshAll,
                        'Delete this Tech showcase item?'
                      )
                    }
                  >
                    Delete
                  </button>
                </td>
              </tr>
            ))}

            {techPosts.length === 0 && (
              <tr>
                <td colSpan={5} className="py-6 text-center opacity-70">
                  No showcase items yet.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </SectionCard>
  );
}


===== FILE: components/admin/UpcomingStaysPanel.js  (size=6078 bytes) =====
// components/admin/UpcomingStaysPanel.js
import { useEffect, useState } from 'react';

export default function UpcomingStaysPanel() {
  const [stays, setStays] = useState([]);
  const [loading, setLoading] = useState(true);

  // simple filter/search state
  const [search, setSearch] = useState('');

  useEffect(() => {
    (async () => {
      try {
        const res = await fetch('/api/realty/upcoming');
        const data = await res.json();
        if (data.ok) {
          setStays(data.stays || []);
        } else {
          console.error('upcoming error:', data.error);
        }
      } catch (e) {
        console.error('upcoming crash:', e);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  // lightweight client-side search by guest or property
  const filtered = stays.filter((s) => {
    if (!search.trim()) return true;
    const q = search.toLowerCase();
    return (
      s.guest_name.toLowerCase().includes(q) ||
      s.guest_email.toLowerCase().includes(q) ||
      s.property_name.toLowerCase().includes(q)
    );
  });

  return (
    <div className="glass p-4 rounded">
      <h2 className="text-lg font-semibold mb-4 flex items-center justify-between">
        <span>Upcoming Stays</span>
        <span className="text-xs font-normal opacity-70">
          {stays.length} total
        </span>
      </h2>

      {/* search/filter row */}
      <div className="flex flex-col md:flex-row md:items-center gap-3 mb-4">
        <input
          className="border border-gray-300 dark:border-gray-700 rounded px-2 py-1 text-sm dark:bg-gray-900"
          placeholder="Search guest or property‚Ä¶"
          value={search}
          onChange={(e) => setSearch(e.target.value)}
        />
        <div className="text-xs opacity-70">
          Showing reservations with status <code>paid</code> whose checkout is
          today or later.
        </div>
      </div>

      {/* table */}
      <div className="overflow-x-auto border border-gray-200 dark:border-gray-800 rounded">
        <table className="min-w-[700px] w-full text-sm border-collapse">
          <thead className="bg-gray-50 dark:bg-gray-800/50">
            <tr className="text-left border-b border-gray-200 dark:border-gray-800">
              <th className="py-2 px-3">Property</th>
              <th className="py-2 px-3">Dates</th>
              <th className="py-2 px-3">Guest</th>
              <th className="py-2 px-3">Guests</th>
              <th className="py-2 px-3">Total</th>
              <th className="py-2 px-3">Contact</th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr>
                <td
                  className="py-6 px-3 text-center opacity-70"
                  colSpan={6}
                >
                  Loading‚Ä¶
                </td>
              </tr>
            ) : filtered.length === 0 ? (
              <tr>
                <td
                  className="py-6 px-3 text-center opacity-70"
                  colSpan={6}
                >
                  No upcoming paid stays.
                </td>
              </tr>
            ) : (
              filtered.map((stay) => (
                <tr
                  key={stay.id}
                  className="border-b border-gray-200 dark:border-gray-800 align-top"
                >
                  <td className="py-3 px-3">
                    <div className="font-semibold text-sm">
                      {stay.property_name}
                    </div>
                    <div className="text-[11px] opacity-70">
                      /realty/{stay.property_slug}
                    </div>
                    <div className="text-[11px] opacity-70">
                      #{stay.property_id.slice(0, 6)}‚Ä¶
                    </div>
                  </td>

                  <td className="py-3 px-3 text-sm whitespace-nowrap">
                    <div>
                      <span className="font-medium">{stay.checkin}</span> ‚Üí
                      <span className="font-medium"> {stay.checkout}</span>
                    </div>
                    <div className="text-[11px] opacity-70">
                      {stay.status === 'paid' ? '‚úÖ Paid' : stay.status}
                    </div>
                  </td>

                  <td className="py-3 px-3 text-sm">
                    <div className="font-medium">{stay.guest_name}</div>
                    <div className="text-[11px] opacity-70">
                      {stay.guest_email}
                    </div>
                  </td>

                  <td className="py-3 px-3 text-sm">
                    {stay.guests || '‚Äî'}
                  </td>

                  <td className="py-3 px-3 text-sm whitespace-nowrap">
                    {stay.amount
                      ? `$${stay.amount} ${stay.currency || 'usd'}`
                      : '‚Äî'}
                  </td>

                  <td className="py-3 px-3 text-xs leading-relaxed">
                    {stay.guest_phone && (
                      <div className="opacity-90">{stay.guest_phone}</div>
                    )}
                    {stay.guest_email && (
                      <div className="opacity-70 break-all">
                        {stay.guest_email}
                      </div>
                    )}
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      <p className="text-[11px] opacity-60 mt-3 leading-snug">
        Tip: This list comes straight from Stripe ‚Üí webhook ‚Üí Supabase. As
        long as a checkout.session.completed fires and we mark the reservation
        paid, it‚Äôll show up here. If you manually comp a guest and skip Stripe,
        you‚Äôll need to insert a row in <code>realty_reservations</code> with
        status <code>paid</code>.
      </p>
    </div>
  );
}


===== FILE: components/admin/UsersTab.js  (size=2134 bytes) =====
// components/admin/UsersTab.js
import React from 'react';
import SectionCard from '@/components/admin/SectionCard';
import { supabase } from '@/lib/supabase';

export default function UsersTab({ users, refreshAll }) {
  const toggleUserRole = async (userId, currentRole) => {
    const newRole = currentRole === 'admin' ? 'user' : 'admin';
    if (!confirm(`Change role to ${newRole} for this user?`)) return;
    const { error } = await supabase
      .from('users')
      .update({ role: newRole })
      .eq('id', userId);
    if (error) alert(`Failed to update role: ${error.message}`);
    else refreshAll?.();
  };

  return (
    <SectionCard title="Users Management">
      <div className="mt-6 overflow-x-auto">
        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="text-left border-b dark:border-gray-700">
              <th className="py-2">Email</th>
              <th>Role</th>
              <th>Created At</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            {users.map((u) => (
              <tr
                key={u.id}
                className="border-b dark:border-gray-800"
              >
                <td className="py-2">{u.email}</td>
                <td className="py-2">{u.role || 'user'}</td>
                <td className="py-2">
                  {new Date(u.created_at).toLocaleString()}
                </td>
                <td className="py-2">
                  <button
                    className="px-3 py-1 bg-blue-600 text-white rounded"
                    onClick={() => toggleUserRole(u.id, u.role)}
                  >
                    Toggle Role
                  </button>
                </td>
              </tr>
            ))}

            {users.length === 0 && (
              <tr>
                <td colSpan={4} className="py-6 opacity-70">
                  No users yet.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </SectionCard>
  );
}


===== FILE: components/Calendar.js  (size=957 bytes) =====
// components/Calendar.js
import { Calendar, dateFnsLocalizer } from 'react-big-calendar';
import { format, parse, startOfWeek, getDay } from 'date-fns';
import enUS from 'date-fns/locale/en-US'; // Added import
import 'react-big-calendar/lib/css/react-big-calendar.css';

const localizer = dateFnsLocalizer({
  format,
  parse,
  startOfWeek,
  getDay,
  locales: { 'en-US': enUS } // Added locales
});

export default function EventCalendar({ events }) {
  const formattedEvents = events.map(event => ({
    title: event.title,
    start: new Date(event.date),
    end: new Date(event.date),
    allDay: true,
  }));

  return (
    <div className="h-[600px]">
      <Calendar
        localizer={localizer}
        events={formattedEvents}
        startAccessor="start"
        endAccessor="end"
        style={{ height: '100%' }}
        className="bg-white dark:bg-gray-800 p-4 rounded glass"
      />
    </div>
  );
}


===== FILE: components/Card.js  (size=6398 bytes) =====
// components/Card.js
import { motion } from 'framer-motion';
import { useDispatch } from 'react-redux';
import { addToCart } from '../lib/cartSlice';

const Card = ({
  children,
  className = '',
  title,
  description,
  image,
  link,
  category,
  buyButton = null,   // product object
  onBuy,              // optional handler from parent
  tags = [],          // optional explicit tags (fallback if product.tags missing)
  showTags = true,
  showNftBadge = true,
}) => {
  const dispatch = useDispatch();

  // product payload coming from parent (Designs page)
  const product = buyButton || {};
  const resolvedTags =
    Array.isArray(product.tags) && product.tags.length ? product.tags : tags;

  // we support either top-level nft_url or metadata.nft_url
  const nftUrl = product?.nft_url || product?.metadata?.nft_url || null;
  const hasNFT = Boolean(nftUrl);

  // NEW: Media playlist embed
  const metadata = product.metadata || {};
  const isPlaylist = metadata.media_type === 'playlist' && metadata.media_url;
  const playlistId = isPlaylist ? metadata.media_url.split('list=')[1] : null;

  // NEW: Tech app badges
  const isApp = metadata.app_type === 'app' && metadata.app_url;

  const handleClick = () => {
    if (category && typeof window !== 'undefined') {
      try {
        const clicks = JSON.parse(localStorage.getItem('clicks') || '{}');
        clicks[category] = (clicks[category] || 0) + 1;
        localStorage.setItem('clicks', JSON.stringify(clicks));
      } catch {
        /* ignore localStorage errors */
      }
    }
  };

  const handleBuy = (p) => {
    dispatch(addToCart(p));
  };

  return (
    <motion.article
      initial={{ opacity: 0, y: 20 }}
      whileInView={{ opacity: 1, y: 0 }}
      viewport={{ once: true }}
      transition={{ duration: 0.5 }}
      className={`card bg-white rounded-xl shadow-lg overflow-hidden transition-shadow hover:shadow-xl dark:bg-gray-900 ${className}`}
      role="article"
      onClick={handleClick}
    >
      {/* Media */}
      <div className="relative">
        {image && (
          <img
            src={image}
            alt={title || 'Card Image'}
            className="w-full h-[300px] object-cover"
            loading="lazy"
            onError={(e) => {
              if (e.currentTarget.src !== '/placeholder.png') {
                e.currentTarget.src = '/placeholder.png';
              }
            }}
          />
        )}

        {/* NFT Ribbon (clickable) */}
        {showNftBadge && hasNFT && (
          <a
            href={nftUrl}
            target="_blank"
            rel="noopener noreferrer"
            onClick={(e) => e.stopPropagation()}
            className="absolute top-3 right-3 bg-black/80 text-white text-xs font-semibold px-2 py-1 rounded"
            title="View NFT on OpenSea"
          >
            NFT
          </a>
        )}
      </div>

      {/* Body */}
      <div className="p-6 text-center">
        {title && <h3 className="text-2xl font-bold mb-4">{title}</h3>}
        {description && (
          <p className="text-gray-700 dark:text-gray-300 text-base mb-4">
            {description}
          </p>
        )}

        {/* Tags */}
        {showTags && Array.isArray(resolvedTags) && resolvedTags.length > 0 && (
          <div className="flex flex-wrap gap-2 justify-center mb-4">
            {resolvedTags.map((t) => (
              <span
                key={t}
                className="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200"
              >
                {t}
              </span>
            ))}
          </div>
        )}

        {/* Learn more (optional) */}
        {link && (
          <a
            href={link}
            className={`btn bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 transition block mx-auto w-fit mb-4 ${
              className && className.includes('capital') ? 'hover:bg-purple-500' : ''
            }`}
            target="_blank"
            rel="noopener noreferrer"
          >
            Learn More
          </a>
        )}

        {/* Actions */}
        <div className="flex flex-wrap gap-3 justify-center">
          {buyButton && (
            <button
              onClick={(e) => {
                e.stopPropagation();
                if (typeof onBuy === 'function') onBuy(buyButton);
                else handleBuy(buyButton);
              }}
              className="btn bg-yellow-500 text-black py-2 px-4 rounded hover:bg-yellow-400 transition"
            >
              Buy Now
              {typeof buyButton.price !== 'undefined'
                ? ` - $${Number(buyButton.price).toFixed(2)}`
                : ''}
            </button>
          )}

          {hasNFT && (
            <a
              href={nftUrl}
              target="_blank"
              rel="noopener noreferrer"
              onClick={(e) => e.stopPropagation()}
              className="btn bg-gray-900 text-white py-2 px-4 rounded hover:bg-black transition"
              title="View NFT"
            >
              View NFT
            </a>
          )}
        </div>

        {/* Extra children */}
        <div className="flex flex-wrap justify-center gap-4 items-center mt-4">
          {children}
        </div>

        {/* NEW: Playlist embed */}
        {isPlaylist && playlistId && (
          <div className="mt-4">
            <iframe
              width="100%"
              height="315"
              src={`https://www.youtube.com/embed/videoseries?list=${playlistId}`}
              title="YouTube video player"
              frameBorder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowFullScreen
            ></iframe>
          </div>
        )}

        {/* NEW: App store badge */}
        {isApp && (
          <div className="mt-4">
            <a href={metadata.app_url} target="_blank" rel="noopener noreferrer">
              <img src="/app-store-badge.png" alt="Download on the App Store" className="h-10" />
            </a>
          </div>
        )}
      </div>
    </motion.article>
  );
};

export default Card;


===== FILE: components/Cart.js  (size=8359 bytes) =====
// components/Cart.js
import { useSelector, useDispatch } from 'react-redux';
import { removeFromCart, updateQuantity } from '@/lib/cartSlice';
import Link from 'next/link';
import { loadStripe } from '@stripe/stripe-js';
import Recommender from './Recommender';
import { useState, useEffect } from 'react';

const stripePromise = loadStripe(
  process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,
  { automaticMode: 'auto' }
);

// Pick best available image, fallback safe
function lineItemImageSrc(item) {
  return (
    item.thumbnail_url ||
    item.display_image ||
    item.image_url ||
    item.thumbnail ||
    item.image ||
    item?.product?.thumbnail_url ||
    item?.product?.image_url ||
    '/placeholder.png'
  );
}

const Cart = () => {
  const items = useSelector((state) => state.cart.items || []);
  const dispatch = useDispatch();

  // we'll still let user type an email so we can prefill Stripe Checkout session
  const [email, setEmail] = useState('');
  const [error, setError] = useState('');

  // show running total
  const total = Array.isArray(items)
    ? items.reduce(
        (acc, item) =>
          acc + Number(item.price || 0) * (item.quantity || 1),
        0
      )
    : 0;

  // ---- helper: get affiliate code from localStorage
  const [affiliateCode, setAffiliateCode] = useState(null);
  useEffect(() => {
    try {
      const ref = window.localStorage.getItem('affiliate_ref');
      if (ref) setAffiliateCode(ref);
    } catch {
      /* ignore */
    }
  }, []);

  // ---- MAIN CHECKOUT HANDLER
  const handleCheckout = async () => {
    setError('');

    // must have at least 1 item
    if (!items.length) {
      setError('Your cart is empty.');
      return;
    }

    // üîí current backend assumes ONE product per checkout session
    if (items.length > 1) {
      setError(
        'Please checkout one item at a time (we only support single-item checkout right now).'
      );
      return;
    }

    const cartItem = items[0];
    const quantity = cartItem.quantity || 1;

    // special case: Realty bookings should NOT go through create-session,
    // they should already be using /api/realty/book from the property page.
    // If somehow a realty item is in the cart, bail with a message.
    if (cartItem.division === 'realty') {
      setError(
        'This stay needs to be booked from the property page. Please return to the listing to finish checkout.'
      );
      return;
    }

    // normal merch / digital / etc -> /api/checkout/create-session
    try {
      const stripe = await stripePromise;

      // we POST to create-session so it can:
      // - create Stripe Checkout Session
      // - insert pending row in orders
      // - include affiliate_code
      const resp = await fetch('/api/checkout/create-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          product_id: cartItem.id,        // required
          quantity,                       // default 1
          mode: undefined,                // NOT "subscription" (this is one-time)
          email: email || undefined,      // optional convenience
          affiliate_code: affiliateCode || null, // <-- üî• pass affiliate
        }),
      });

      const data = await resp.json();

      if (!resp.ok || data.error) {
        console.error('checkout create-session error:', data.error);
        setError(
          data.error ||
            'Checkout could not start. This product may be missing Stripe config.'
        );
        return;
      }

      if (data.url) {
        // just bounce to Stripe Checkout
        window.location.href = data.url;
        return;
      }

      // Backup path: if for some reason url isn't present
      setError('Checkout session did not return a redirect URL.');
    } catch (err) {
      console.error('Checkout error:', err);
      setError('An error occurred during checkout.');
    }
  };

  return (
    <div className="card max-w-2xl mx-auto bg-white text-black glass py-10">
      <h2 className="text-3xl font-bold mb-6">Your Cart</h2>

      {/* CART EMPTY STATE */}
      {items.length === 0 ? (
        <p className="text-gray-600 text-base mb-4">
          Cart is empty.{` `}
          <Link
            href="/designs"
            className="text-blue-600 hover:underline"
          >
            Shop Designs
          </Link>
          .
        </p>
      ) : (
        <>
          {/* LINE ITEMS */}
          <ul className="space-y-4 mb-6">
            {Array.isArray(items) &&
              items.map((item) => (
                <li
                  key={item.id}
                  className="flex justify-between items-center pb-4 border-b border-gray-300"
                >
                  <div className="flex items-center gap-4">
                    <img
                      src={lineItemImageSrc(item)}
                      alt={item.name || 'Product image'}
                      className="w-[100px] h-[100px] object-cover rounded bg-gray-100"
                      onError={(e) => {
                        e.currentTarget.src = '/placeholder.png';
                      }}
                    />
                    <div>
                      <div className="text-base font-medium">
                        {item.name}{' '}
                        <span className="opacity-70 text-sm">
                          ({item.division || 'site'})
                        </span>
                      </div>

                      <input
                        type="number"
                        value={item.quantity || 1}
                        min="1"
                        onChange={(e) =>
                          dispatch(
                            updateQuantity({
                              id: item.id,
                              quantity:
                                parseInt(e.target.value, 10) || 1,
                            })
                          )
                        }
                        className="w-16 p-1 border rounded mt-2"
                      />
                    </div>
                  </div>

                  <div className="text-right">
                    <div className="text-base">
                      $
                      {(
                        Number(item.price || 0) *
                        (item.quantity || 1)
                      ).toFixed(2)}
                    </div>

                    <button
                      onClick={() =>
                        dispatch(removeFromCart(item.id))
                      }
                      className="text-red-500 hover:text-red-600 text-sm mt-2"
                    >
                      Remove
                    </button>
                  </div>
                </li>
              ))}
          </ul>

          {/* TOTAL */}
          <p className="text-right font-bold text-base mb-4">
            Total: ${total.toFixed(2)}
          </p>

          {/* OPTIONAL EMAIL PREFILL */}
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="Email (for receipt / delivery)"
            className="w-full p-3 border rounded bg-white text-black mb-3"
          />

          {/* affiliate note (read-only visual cue) */}
          {affiliateCode ? (
            <div className="text-xs text-green-700 bg-green-100 border border-green-300 rounded p-2 mb-3">
              Referred by code <strong>{affiliateCode}</strong> ‚Äî this
              purchase will be credited.
            </div>
          ) : null}

          {/* ERRORS */}
          {error && (
            <p className="text-red-500 text-base mb-3">{error}</p>
          )}

          {/* CHECKOUT BUTTON */}
          <button
            onClick={handleCheckout}
            className="btn bg-black text-white py-4 px-6 rounded w-full hover:scale-105 transition"
          >
            Checkout
          </button>

          <Recommender />
        </>
      )}
    </div>
  );
};

export default Cart;


===== FILE: components/ErrorBoundary.js  (size=841 bytes) =====
import React from 'react';

class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }

  componentDidCatch(error, errorInfo) {
    console.error('Client-side error caught:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="p-8 text-center">
          <h2>Something went wrong.</h2>
          <p>{this.state.error?.message || 'Unknown error'}</p>
          <button onClick={() => window.location.reload()} className="btn bg-blue-600 text-white py-2 px-4 rounded">Reload Page</button>
        </div>
      );
    }

    return this.props.children;
  }
}

export default ErrorBoundary;


===== FILE: components/Footer.js  (size=8443 bytes) =====
// components/Footer.js
import Link from "next/link";
import { useRouter } from "next/router";
import {
  FaInstagram,
  FaTiktok,
  FaYoutube,
  FaTwitter,
  FaLinkedin,
  FaPinterest,
  FaFacebook,
  FaEnvelope,
} from "react-icons/fa";

// ===== Social handles you provided =====
const SOCIAL_HANDLES = {
  parent: {
    label: "Manyagi",
    instagram: "manyagiofficial",
    twitter: "manyagiofficial",
    youtube: "@manyagiofficial",
    pinterest: "manyagiofficial",
    linkedin: "manyagiofficial",
    facebook: "manyagiofficial",
    tiktok: "manyagiofficial",
  },
  publishing: {
    label: "Manyagi Publishing",
    instagram: "manyagipublishing",
    twitter: "manyagipublish",
    pinterest: "manyagipublishing",
    linkedin: "manyagipublishing",
    facebook: "manyagipublishing",
    tiktok: "manyagipublishing",
  },
  designs: {
    label: "Manyagi Designs",
    instagram: "manyagidesigns",
    twitter: "manyagidesigns",
    pinterest: "manyagidesigns",
    linkedin: "manyagidesigns",
    facebook: "manyagidesigns",
    tiktok: "manyagidesigns",
  },
  media: {
    label: "Manyagi Media",
    instagram: "manyagimedia",
    twitter: "manyagimedia",
    youtube: "@manyagimedia",
    pinterest: "manyagimedia",
    linkedin: "manyagimedia",
    facebook: "manyagimedia",
    tiktok: "manyagimedia",
  },
  capital: {
    label: "Manyagi Capital",
    instagram: "manyagicapital",
    twitter: "manyagicapital",
    linkedin: "manyagicapital",
    facebook: "manyagicapital",
    tiktok: "manyagicapital",
  },
  tech: {
    label: "Manyagi Tech",
    instagram: "manyagitech",
    twitter: "manyagitech",
    youtube: "@manyagitech",
    linkedin: "manyagitech",
    tiktok: "manyagitech",
  },
  realty: {
    label: "Manyagi Realty",
    instagram: "manyagirealty",
    twitter: "manyagirealty",
    linkedin: "manyagirealty",
    facebook: "manyagirealty",
    tiktok: "manyagirealty1",
  },
};

// ===== Public email per division (homepage uses info@) =====
const DIVISION_EMAIL = {
  parent: "info@manyagi.net",
  publishing: "publishing@manyagi.net",
  designs: "designs@manyagi.net",
  media: "media@manyagi.net",
  capital: "capital@manyagi.net",
  tech: "tech@manyagi.net",
  realty: "realty@manyagi.net",
};

// ===== Short ‚Äúblurb‚Äù to add context + pizazz =====
const DIVISION_BLURB = {
  parent:
    "Manyagi is a creative technology company building IP across publishing, media, commerce, capital, tech, and realty.",
  publishing:
    "Original fiction, poetry, and world-building IP ‚Äî released as ebooks, print, and collectors‚Äô editions.",
  designs:
    "Wear the worlds we build ‚Äî tees, posters, mugs, and collectibles inspired by our stories.",
  media:
    "Shorts, reels, and long-form content documenting how we build a modern IP studio in public.",
  capital:
    "The creator‚Äôs capital desk ‚Äî systematic trading and portfolio construction, shared transparently.",
  tech:
    "Sites, tools, automations ‚Äî shipping product daily and showing our work along the way.",
  realty:
    "Story-inspired stays and property content in destinations we love.",
};

// ===== helpers =====
function platformUrl(platform, handle) {
  if (!handle) return null;
  switch (platform) {
    case "instagram": return `https://instagram.com/${handle}`;
    case "twitter":   return `https://x.com/${handle.replace(/^@/, "")}`;
    case "youtube":   return `https://youtube.com/${handle.startsWith("@") ? handle : `@${handle}`}`;
    case "pinterest": return `https://pinterest.com/${handle}`;
    case "linkedin":  return `https://linkedin.com/company/${handle}`;
    case "facebook":  return `https://facebook.com/${handle}`;
    case "tiktok":    return `https://tiktok.com/@${handle.replace(/^@/, "")}`;
    default:          return null;
  }
}

function Icon({ name }) {
  switch (name) {
    case "instagram": return <FaInstagram />;
    case "tiktok":    return <FaTiktok />;
    case "youtube":   return <FaYoutube />;
    case "twitter":   return <FaTwitter />;
    case "linkedin":  return <FaLinkedin />;
    case "pinterest": return <FaPinterest />;
    case "facebook":  return <FaFacebook />;
    default:          return null;
  }
}

export default function Footer({ division: override }) {
  const router = useRouter();

  const division = override || (() => {
    const p = router.pathname || "";
    if (p.startsWith("/publishing")) return "publishing";
    if (p.startsWith("/designs"))    return "designs";
    if (p.startsWith("/media"))      return "media";
    if (p.startsWith("/capital"))    return "capital";
    if (p.startsWith("/tech"))       return "tech";
    if (p.startsWith("/realty"))     return "realty";
    return "parent";
  })();

  const cfg   = SOCIAL_HANDLES[division] || SOCIAL_HANDLES.parent;
  const email = DIVISION_EMAIL[division] || DIVISION_EMAIL.parent;
  const blurb = DIVISION_BLURB[division] || DIVISION_BLURB.parent;

  const ORDER = ["instagram", "tiktok", "youtube", "twitter", "linkedin", "pinterest", "facebook"];
  let links = ORDER.map((p) => {
    const url = platformUrl(p, cfg[p]);
    return url ? { p, url } : null;
  }).filter(Boolean);

  // Always add Manyagi Media YouTube on division pages (not homepage)
  if (division !== "parent" && !links.some(l => l.url.includes("@manyagimedia"))) {
    links.push({ p: "youtube", url: "https://youtube.com/@manyagimedia" });
  }

  return (
    <footer className="bg-white text-black border-t border-gray-200">
      <div className="container mx-auto px-4 py-10 grid grid-cols-1 md:grid-cols-3 gap-8">
        {/* About / blurb */}
        <div>
          <h4 className="text-xl font-bold mb-2">
            {division === "parent" ? "Manyagi" : cfg.label}
          </h4>
          <p className="text-sm text-gray-700">{blurb}</p>
        </div>

        {/* Explore quick links */}
        <div className="text-sm">
          <h5 className="font-semibold mb-2">Explore</h5>
          <ul className="space-y-1">
            <li><Link href="/publishing" className="hover:text-yellow-600">Publishing</Link></li>
            <li><Link href="/designs"    className="hover:text-yellow-600">Designs</Link></li>
            <li><Link href="/media"      className="hover:text-yellow-600">Media</Link></li>
            <li><Link href="/capital"    className="hover:text-yellow-600">Capital</Link></li>
            <li><Link href="/tech"       className="hover:text-yellow-600">Tech</Link></li>
            <li><Link href="/realty"     className="hover:text-yellow-600">Realty</Link></li>
            <li><Link href="/blog"       className="hover:text-yellow-600">Blog</Link></li>
          </ul>
        </div>

        {/* Contact + socials */}
        <div className="text-sm">
          <h5 className="font-semibold mb-2 flex items-center gap-2">
            <FaEnvelope /> Contact
          </h5>
          <a href={`mailto:${email}`} className="underline hover:text-yellow-600 break-all">
            {email}
          </a>
          <div className="mt-4 flex flex-wrap gap-3 text-xl">
            {links.map(({ p, url }) => (
              <a
                key={`${p}-${url}`}
                href={url}
                target="_blank"
                rel="noopener noreferrer"
                className="hover:text-yellow-600 transition-colors"
                title={p}
              >
                <Icon name={p} />
              </a>
            ))}
          </div>
        </div>
      </div>

      {/* Legal row + tagline moved from Header to Footer */}
      <div className="border-t border-gray-200">
        <div className="container mx-auto px-4 py-4 flex flex-col md:flex-row items-center justify-between gap-3 text-xs text-gray-700">
          <div>¬© {new Date().getFullYear()} {cfg.label}. All rights reserved.</div>
          <div className="flex gap-4">
            <Link href="/privacy" className="hover:text-yellow-600">Privacy</Link>
            <Link href="/terms"   className="hover:text-yellow-600">Terms</Link>
            <Link href="/about"   className="hover:text-yellow-600">About</Link>
          </div>
          <div className="text-gray-600">Creativity Meets Innovation</div>
        </div>
      </div>
    </footer>
  );
}


===== FILE: components/Header.js  (size=3369 bytes) =====
// components/Header.js
import Link from 'next/link';
import Image from 'next/image';
import { useRouter } from 'next/router';
import { useSelector } from 'react-redux';
import { FaShoppingCart } from 'react-icons/fa';
import { useTheme } from 'next-themes';
import { useEffect, useState } from 'react';

const Header = () => {
  const router = useRouter();
  const items = useSelector((state) => state.cart.items || []);
  const cartCount = items.length;
  const { theme, setTheme } = useTheme();
  const [mounted, setMounted] = useState(false);

  useEffect(() => setMounted(true), []);

  return (
    <header className="sticky top-0 bg-white z-50 border-b border-gray-300 text-black">
      <div className="container mx-auto flex items-center justify-between py-4 px-4 md:px-8 flex-col md:flex-row">
        {/* Logo */}
        <div className="flex items-center">
          <Link href="/" className="flex items-center gap-3 font-bold uppercase tracking-widest">
            <Image
              src="/images/logo.svg"
              alt="Manyagi Logo"
              width={100}
              height={50}
              loading="lazy"
            />
          </Link>
        </div>

        {/* Navigation */}
        <nav className="flex flex-wrap gap-4 md:gap-6 items-center justify-center md:justify-end mt-4 md:mt-0">
          <Link href="/" className="hover:text-yellow-500 transition">Home</Link>
          <Link href="/publishing" className="hover:text-yellow-500 transition">Publishing</Link>
          <Link href="/designs" className="hover:text-yellow-500 transition">Designs</Link>
          <Link href="/media" className="hover:text-yellow-500 transition">Media</Link>
          <Link href="/capital" className="hover:text-yellow-500 transition">Capital</Link>
          <Link href="/tech" className="hover:text-yellow-500 transition">Tech</Link>
          <Link href="/realty" className="hover:text-yellow-500 transition">Realty</Link>
          <Link href="/blog" className="hover:text-yellow-500 transition">Blog</Link>
          <Link href="/about" className="hover:text-yellow-500 transition">About</Link>
          <Link href="/contact" className="hover:text-yellow-500 transition">Contact</Link>
          <Link href="/links" className="hover:text-yellow-500 transition">Links</Link>
          <Link href="/admin" className="hover:text-yellow-500 transition bg-blue-100 px-2 py-1 rounded">Admin</Link>

          {/* Cart */}
          <Link href="/cart" className="relative hover:text-yellow-500 transition">
            <FaShoppingCart className="inline-block" />
            {cartCount > 0 && (
              <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full px-2 py-1 min-w-[20px] text-center">
                {cartCount}
              </span>
            )}
          </Link>

          {/* Theme Toggle */}
          {mounted && (
            <button
              onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}
              className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-black dark:text-white transition-colors"
            >
              {theme === 'dark' ? 'Light Mode' : 'Dark Mode'}
            </button>
          )}
        </nav>
      </div>
    </header>
  );
};

export default Header;


===== FILE: components/Hero.js  (size=2986 bytes) =====
// components/Hero.js
import { useEffect, useState } from 'react';
import { motion } from 'framer-motion';
import 'react-responsive-carousel/lib/styles/carousel.min.css';
import { Carousel } from 'react-responsive-carousel';

const Hero = ({ kicker, title, lead, children, carouselImages = [], videoSrc, height = 'h-[600px]' }) => {
  const [isClient, setIsClient] = useState(false);
  useEffect(() => { setIsClient(true); }, []);

  const hasMedia = videoSrc || carouselImages.length > 0;
  const showVideo = isClient && videoSrc && ((window.innerWidth >= 640) || !carouselImages.length);

  return (
    <motion.section
      className={`relative min-h-[600px] sm:${height} flex flex-col items-center overflow-hidden bg-white z-0`}
      aria-labelledby="hero-title"
    >
      {showVideo && videoSrc && (
        <video
          autoPlay
          loop
          muted
          className="relative w-full h-auto object-cover z-0 sm:absolute sm:inset-0 sm:h-full sm:w-full"
          src={videoSrc}
          aria-hidden="true"
        />
      )}
      {carouselImages.length > 0 && !showVideo && (
        <Carousel
          autoPlay
          interval={5000}
          showThumbs={false}
          showStatus={false}
          infiniteLoop
          stopOnHover
          showArrows
          className="z-0 relative w-full h-auto sm:absolute sm:inset-0 sm:h-full sm:w-full"
        >
          {carouselImages.map((img, i) => (
            <img key={i} src={img} alt={`Slide ${i + 1}`} className="object-cover w-full h-auto sm:h-full" loading="lazy" />
          ))}
        </Carousel>
      )}
      {hasMedia && <div className="absolute inset-0 bg-black/50 z-10 hidden sm:block" />}
      <div
        className={`relative z-30 p-10 max-w-4xl mx-auto flex flex-col items-center text-center text-black ${hasMedia ? 'sm:text-white' : ''} mt-auto sm:mt-0`}
      >
        <motion.span
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.2 }}
          className="uppercase tracking-widest text-lg mb-4"
        >
          {kicker}
        </motion.span>
        <motion.h1
          id="hero-title"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.4 }}
          className="text-5xl font-bold mb-4 leading-tight"
        >
          {title}
        </motion.h1>
        <motion.p
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.6 }}
          className="text-base mb-8 max-w-2xl"
        >
          {lead}
        </motion.p>
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.8 }}
          className="flex flex-col md:flex-row gap-4"
        >
          {children}
        </motion.div>
      </div>
    </motion.section>
  );
};

export default Hero;


===== FILE: components/RealtyLeadForm.js  (size=4548 bytes) =====
import { useState } from 'react';

export default function RealtyLeadForm({ propertyId }) {
  const [name, setName] = useState('');
  const [email, setEmail] = useState('');
  const [phone, setPhone] = useState('');
  const [interest, setInterest] = useState('buy'); // default
  const [notes, setNotes] = useState('');
  const [statusMsg, setStatusMsg] = useState('');
  const [submitting, setSubmitting] = useState(false);

  const submitLead = async (e) => {
    e.preventDefault();
    if (!name || !email || !interest) {
      setStatusMsg('Please fill required fields.');
      return;
    }

    try {
      setSubmitting(true);
      setStatusMsg('');

      const res = await fetch('/api/realty/lead', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          email,
          phone,
          interest_type: interest,
          notes,
          property_id: propertyId || null,
        }),
      });

      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || 'Failed to send');
      }

      // success
      setStatusMsg('Thanks ‚Äî we‚Äôll reach out.');
      setName('');
      setEmail('');
      setPhone('');
      setNotes('');
      setInterest('buy');
    } catch (err) {
      console.error('lead submit error:', err);
      setStatusMsg('Something went wrong. Please try again.');
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <form
      onSubmit={submitLead}
      className="bg-white dark:bg-gray-900 border dark:border-gray-700 rounded p-4 space-y-3 max-w-lg"
    >
      <h3 className="text-lg font-semibold">
        Talk to a Realty Specialist
      </h3>
      <p className="text-sm opacity-80 -mt-2">
        California residential, commercial, or property management.
      </p>

      <div>
        <label className="block text-sm font-medium mb-1">
          I'm looking to‚Ä¶
        </label>
        <select
          className="w-full border rounded px-3 py-2 dark:bg-gray-800"
          value={interest}
          onChange={(e) => setInterest(e.target.value)}
        >
          <option value="buy">Buy property</option>
          <option value="sell">Sell my property</option>
          <option value="manage">Get my rental managed</option>
          <option value="rental_inquiry">Ask about a stay</option>
          <option value="other">Other / Not sure yet</option>
        </select>
      </div>

      <div>
        <label className="block text-sm font-medium mb-1">
          Your name *
        </label>
        <input
          className="w-full border rounded px-3 py-2 dark:bg-gray-800"
          value={name}
          onChange={(e) => setName(e.target.value)}
          placeholder="Jane Doe"
          required
        />
      </div>

      <div>
        <label className="block text-sm font-medium mb-1">
          Email *
        </label>
        <input
          type="email"
          className="w-full border rounded px-3 py-2 dark:bg-gray-800"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          placeholder="you@email.com"
          required
        />
      </div>

      <div>
        <label className="block text-sm font-medium mb-1">
          Phone
        </label>
        <input
          className="w-full border rounded px-3 py-2 dark:bg-gray-800"
          value={phone}
          onChange={(e) => setPhone(e.target.value)}
          placeholder="(optional)"
        />
      </div>

      <div>
        <label className="block text-sm font-medium mb-1">
          Notes
        </label>
        <textarea
          className="w-full border rounded px-3 py-2 dark:bg-gray-800 h-24"
          value={notes}
          onChange={(e) => setNotes(e.target.value)}
          placeholder="Tell us what you're looking for. Timeline, budget, area..."
        />
      </div>

      <button
        disabled={submitting}
        className="w-full bg-blue-600 text-white py-2 rounded font-semibold hover:bg-blue-500 disabled:opacity-50"
      >
        {submitting ? 'Sending‚Ä¶' : 'Get in Touch'}
      </button>

      {statusMsg && (
        <p className="text-sm text-center pt-2">{statusMsg}</p>
      )}

      <p className="text-[10px] opacity-60 text-center">
        No spam. We only contact you about this request.
      </p>
    </form>
  );
}


===== FILE: components/Recommender.js  (size=916 bytes) =====
// components/Recommender.js
import { useEffect, useState } from 'react';

const Recommender = () => {
  const [recommendation, setRecommendation] = useState('');

  useEffect(() => {
    const clicks = JSON.parse(localStorage.getItem('clicks') || '{}');
    const mostClicked = Object.keys(clicks).sort((a, b) => clicks[b] - clicks[a])[0];
    setRecommendation(
      mostClicked === 'publishing' ? 'Check out our latest books!' :
      mostClicked === 'designs' ? 'Explore our creative designs!' :
      mostClicked === 'media' ? 'Watch our latest videos!' :
      mostClicked === 'capital' ? 'Get trading signals!' :
      mostClicked === 'tech' ? 'Download our apps!' :
      'Discover all Manyagi divisions!'
    );
  }, []);

  return (
    <div className="p-6 text-center glass mt-4">
      <p className="text-lg">{recommendation}</p>
    </div>
  );
};

export default Recommender;


===== FILE: components/SEO.js  (size=3654 bytes) =====
// components/SEO.js
import Head from 'next/head';
import { useRouter } from 'next/router';

const SITE_NAME = 'Manyagi';
const TAGLINE = 'Creativity Meets Innovation';
const BASE_URL =
  process.env.NEXT_PUBLIC_SITE_URL ||
  process.env.SITE_URL ||
  'https://manyagi.net';

// Put a real image into /public/og-default.jpg (1200x630 recommended)
const DEFAULT_IMAGE = '/og-default.jpg';
const DEFAULT_DESC =
  'Manyagi ‚Äî Creativity Meets Innovation across Publishing, Designs, Media, Capital, Tech, and Realty.';

export default function SEO({
  title,
  description,
  image,
  url,
  type = 'website',         // article | product | video.other, etc.
  noindex = false,
  publishedTime,             // ISO string for articles
  modifiedTime,              // ISO string for articles
  jsonLd = null,             // optional extra JSON-LD object per page
}) {
  const router = useRouter();
  const path = (router && router.asPath) || '/';
  const canonical = (url || `${BASE_URL}${path.split('?')[0]}`).replace(/\/+$/, '') || BASE_URL;

  const pageTitle = title ? `${title} ‚Äî ${SITE_NAME}` : `${SITE_NAME} ‚Äî ${TAGLINE}`;
  const desc = description || DEFAULT_DESC;
  const ogImage = image?.startsWith('http')
    ? image
    : `${BASE_URL}${(image || DEFAULT_IMAGE).startsWith('/') ? '' : '/'}${image || DEFAULT_IMAGE}`;

  const robots = noindex ? 'noindex,nofollow' : 'index,follow';

  const articleMeta = type === 'article'
    ? [
        publishedTime ? <meta key="article:published_time" property="article:published_time" content={publishedTime} /> : null,
        modifiedTime ? <meta key="article:modified_time" property="article:modified_time" content={modifiedTime} /> : null,
      ].filter(Boolean)
    : null;

  const websiteJsonLd = {
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    name: SITE_NAME,
    url: BASE_URL,
    description: DEFAULT_DESC,
    inLanguage: 'en',
    potentialAction: {
      '@type': 'SearchAction',
      target: `${BASE_URL}/search?q={search_term_string}`,
      'query-input': 'required name=search_term_string',
    },
  };

  return (
    <Head>
      {/* Title + Canonical */}
      <title>{pageTitle}</title>
      <link rel="canonical" href={canonical} />

      {/* Basic */}
      <meta name="description" content={desc} />
      <meta name="robots" content={robots} />
      <meta name="theme-color" content="#000000" />

      {/* OpenGraph */}
      <meta property="og:site_name" content={SITE_NAME} />
      <meta property="og:type" content={type} />
      <meta property="og:title" content={pageTitle} />
      <meta property="og:description" content={desc} />
      <meta property="og:url" content={canonical} />
      <meta property="og:image" content={ogImage} />
      <meta property="og:image:width" content="1200" />
      <meta property="og:image:height" content="630" />
      {articleMeta}

      {/* Twitter / X */}
      <meta name="twitter:card" content="summary_large_image" />
      <meta name="twitter:title" content={pageTitle} />
      <meta name="twitter:description" content={desc} />
      <meta name="twitter:image" content={ogImage} />

      {/* Structured Data */}
      <script
        type="application/ld+json"
        // Website baseline
        dangerouslySetInnerHTML={{ __html: JSON.stringify(websiteJsonLd) }}
      />
      {jsonLd ? (
        <script
          key="page-jsonld"
          type="application/ld+json"
          dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }}
        />
      ) : null}
    </Head>
  );
}


===== FILE: components/SignalsSubscriptionForm.js  (size=3734 bytes) =====
// components/SignalsSubscriptionForm.js
import { useState } from 'react';
import { loadStripe } from '@stripe/stripe-js';

// Stripe.js isn't strictly required for a simple redirect, but leaving it is harmless.
const stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY, { automaticMode: 'auto' });

const SignalsSubscriptionForm = ({ priceId: propPriceId }) => {
  // Prefer env price; fallback to prop
  const priceId = process.env.NEXT_PUBLIC_STRIPE_PRICE_ID || propPriceId || '';
  const [email, setEmail] = useState('');
  const [telegramId, setTelegramId] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSubscribe = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      if (!priceId) throw new Error('Plan temporarily unavailable. Please try again later.');
      if (!telegramId || isNaN(Number(telegramId))) throw new Error('Please enter a valid Telegram ID');

      // ‚úÖ use the new unified endpoint and the subscription mode
      const resp = await fetch('/api/checkout/create-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          mode: 'subscription',
          price_id: priceId,
          email,
          telegramId,
        }),
      });

      const data = await resp.json();
      if (!resp.ok || data.error) {
        throw new Error(data.error || 'Failed to create checkout session');
      }

      // simple redirect is fine; Stripe will handle the rest
      const stripe = await stripePromise; // kept for future enhancements
      window.location.href = data.url;
    } catch (err) {
      console.error('Subscription error:', err);
      setError(err.message || 'Failed to start subscription');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="space-y-4 glass p-4 rounded">
      <h3 className="text-2xl font-bold text-black">Subscribe to Basic Signals</h3>
      <p className="text-gray-600 text-base">
        Unlock daily signals for $29/month. Get Telegram alerts after payment.
      </p>

      <form onSubmit={handleSubscribe} className="space-y-4">
        {!priceId && (
          <div className="p-3 rounded bg-yellow-100 text-yellow-800 text-sm">
            Subscription plan is not configured. Set <code>NEXT_PUBLIC_STRIPE_PRICE_ID</code> in your environment.
          </div>
        )}

        <input
          type="email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
          placeholder="Email Address"
          className="w-full p-3 border border-gray-300 rounded bg-white text-black"
          required
        />

        <input
          type="number"
          value={telegramId}
          onChange={(e) => setTelegramId(e.target.value)}
          placeholder="Telegram ID (e.g., 123456789) - Find via @userinfobot"
          className="w-full p-3 border border-gray-300 rounded bg-white text-black"
          required
        />

        <button
          type="submit"
          disabled={loading || !priceId}
          className="w-full py-4 px-6 bg-yellow-500 text-black rounded font-bold hover:bg-yellow-400 hover:scale-105 transition disabled:opacity-60"
        >
          {loading ? 'Processing...' : 'Subscribe Now'}
        </button>

        {error && <p className="text-red-500 text-base">{error}</p>}
      </form>

      <p className="text-sm text-gray-600">Payments processed securely via Stripe. Cancel anytime.</p>
    </div>
  );
};

export default SignalsSubscriptionForm;


===== FILE: components/SubscriptionForm.js  (size=2058 bytes) =====
// components/SubscriptionForm.js
import Script from 'next/script';

const SubscriptionForm = ({
  formId,
  uid,
  title,
  description,
  includeTelegramId = false,
}) => {
  return (
    <div aria-labelledby="form-title" className="space-y-4 glass p-4 rounded">
      {/* Load ConvertKit safely (avoids hydration mismatch) */}
      <Script
        id="convertkit-ckjs"
        src="https://f.convertkit.com/ckjs/ck.5.js"
        strategy="afterInteractive"
      />

      <h3 id="form-title" className="text-2xl font-bold text-black">
        {title}
      </h3>
      <p className="text-gray-600 text-base">{description}</p>

      <form
        action={`https://app.convertkit.com/forms/${formId}/subscriptions`}
        className="seva-form formkit-form"
        method="post"
        data-sv-form={formId}
        data-uid={uid}
        data-format="inline"
        data-version="5"
        target="__blank"
        rel="noopener noreferrer"
      >
        <input
          className="w-full p-3 border border-gray-300 rounded bg-white text-black mb-2"
          name="fields[first_name]"
          placeholder="First Name"
          type="text"
        />

        <input
          className="w-full p-3 border border-gray-300 rounded bg-white text-black mb-2"
          name="email_address"
          placeholder="Email Address"
          required
          type="email"
        />

        {includeTelegramId && (
          <input
            className="w-full p-3 border border-gray-300 rounded bg-white text-black mb-2"
            name="fields[telegram_id]"
            placeholder="Telegram ID (e.g., 123456789)"
            type="number"
            required
          />
        )}

        <button
          className="w-full py-4 px-6 bg-yellow-500 text-black rounded font-bold hover:bg-yellow-400 hover:scale-105 transition"
          type="submit"
        >
          Subscribe
        </button>
      </form>
    </div>
  );
};

export default SubscriptionForm;


===== FILE: components/ThemeToggle.js  (size=632 bytes) =====
// components/ThemeToggle.js
import { useTheme } from 'next-themes';
import { useEffect, useState } from 'react';

export default function ThemeToggle() {
  const { theme, setTheme } = useTheme();
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  if (!mounted) return null;

  return (
    <button
      onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}
      className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-black dark:text-white transition-colors"
    >
      {theme === 'dark' ? 'Light Mode' : 'Dark Mode'}
    </button>
  );
}


===== FILE: lib/adminUtils.js  (size=2054 bytes) =====
// lib/adminUtils.js
import { supabase } from '@/lib/supabase';

// turn "a, b, c" into ["a","b","c"] unique
export const toArrayTags = (s) =>
  Array.from(
    new Set(
      String(s || '')
        .split(',')
        .map((t) => t.trim())
        .filter(Boolean)
    )
  );

export const safeJSON = (s, fallback = {}) => {
  try {
    if (!s) return fallback;
    if (typeof s === 'object') return s;
    return JSON.parse(s);
  } catch {
    return fallback;
  }
};

export const copyText = async (txt) => {
  try {
    await navigator.clipboard.writeText(txt);
    alert('Copied!');
  } catch {
    // ignore clipboard errors silently
  }
};

export const currency = (n) => {
  const num = Number(n || 0);
  return `$${num.toFixed(2)}`;
};

export const isWithinLastDays = (iso, days = 30) => {
  if (!iso) return false;
  const d = new Date(iso);
  const since = new Date();
  since.setDate(since.getDate() - days);
  return d >= since;
};

// generic row updater
export const updateRow = async (table, id, payload) => {
  const { error } = await supabase.from(table).update(payload).eq('id', id);
  if (error) throw error;
};

// products-specific convenience
export const updateProduct = async (id, payload) => {
  await updateRow('products', id, payload);
};

// delete product w/ confirm
export const deleteProduct = async (id, refreshAll) => {
  if (!confirm('Delete this product?')) return;
  const { error } = await supabase.from('products').delete().eq('id', id);
  if (error) {
    alert(`Delete failed: ${error.message}`);
  } else {
    refreshAll?.();
    alert('Product deleted.');
  }
};

// generic delete for any table
export const deleteRow = async (
  table,
  id,
  refreshAll,
  confirmMsg = 'Delete this?'
) => {
  if (!confirm(confirmMsg)) return;
  const { error } = await supabase.from(table).delete().eq('id', id);
  if (error) {
    alert(`Delete failed: ${error.message}`);
  } else {
    refreshAll?.();
    alert('Deleted.');
  }
};


===== FILE: lib/affiliate.js  (size=479 bytes) =====
// /lib/affiliate.js
export function rememberAffiliateFromURL() {
  if (typeof window === 'undefined') return;
  const url = new URL(window.location.href);
  const ref = url.searchParams.get('ref');
  if (ref) {
    // keep simple string like "INF001"
    window.localStorage.setItem('affiliate_ref', ref);
  }
}

export function getRememberedAffiliate() {
  if (typeof window === 'undefined') return null;
  return window.localStorage.getItem('affiliate_ref');
}


===== FILE: lib/cartSlice.js  (size=1035 bytes) =====
// lib/cartSlice.js
import { createSlice } from '@reduxjs/toolkit';

export const cartSlice = createSlice({
  name: 'cart',
  initialState: {
    items: [],
  },
  reducers: {
    addToCart: (state, action) => {
      const item = state.items.find((i) => i.id === action.payload.id);
      if (item) {
        item.quantity += action.payload.quantity || 1;
      } else {
        state.items.push({ ...action.payload, quantity: action.payload.quantity || 1 });
      }
    },
    removeFromCart: (state, action) => {
      state.items = state.items.filter((i) => i.id !== action.payload);
    },
    updateQuantity: (state, action) => {
      const item = state.items.find((i) => i.id === action.payload.id);
      if (item) {
        item.quantity = action.payload.quantity;
      }
    },
    setItems: (state, action) => {
      state.items = action.payload;
    },
  },
});

export const { addToCart, removeFromCart, updateQuantity, setItems } = cartSlice.actions;
export default cartSlice.reducer;


===== FILE: lib/emails/bookingReceipt.js  (size=939 bytes) =====
// lib/emails/bookingReceipt.js
import { sendEmail } from '../sendEmail';
import { itineraryEmailHTML } from '../emailTemplates';

export async function sendBookingReceipt({
  type = 'receipt', // Use 'receipt' to customize template if needed
  guestName = 'Guest',
  to = '',
  property = 'Manyagi Realty Property',
  checkin,
  checkout,
  guests = '',
  replyTo = 'realty@manyagi.net',
  snapshot = {},
}) {
  // Generate HTML using the template (reusing existing for consistency)
  const html = itineraryEmailHTML({
    type,
    guestName,
    to,
    property,
    checkin,
    checkout,
    guests,
    replyTo,
    snapshot,
  });

  // Send the email
  return await sendEmail({
    to,
    subject: `Booking Receipt for ${property}`,
    html,
    text: `Hello ${guestName},\n\nYour booking at ${property} from ${checkin} to ${checkout} for ${guests} guests is confirmed.\n\nThank you!`,
  });
}


===== FILE: lib/emails/itineraryEmail.js  (size=985 bytes) =====
// lib/emails/itineraryEmail.js
import { sendEmail } from '../sendEmail';
import { itineraryEmailHTML } from '../emailTemplates';

export async function sendItineraryEmail({
  type = 'itinerary', // NEW: 'itinerary' or 'receipt'
  guestName = 'Guest',
  to = '',
  property = 'Manyagi Realty Property',
  checkin,
  checkout,
  guests = '',
  replyTo = 'realty@manyagi.net',
  snapshot = {},
}) {
  // Generate HTML using the template
  const html = itineraryEmailHTML({
    type, // Pass to template for customizations
    guestName,
    to,
    property,
    checkin,
    checkout,
    guests,
    replyTo,
    snapshot,
  });

  // Send the email
  return await sendEmail({
    to,
    subject: type === 'receipt' ? `Booking Receipt for ${property}` : `Your Itinerary for ${property}`,
    html,
    text: `Hello ${guestName},\n\nYour booking at ${property} from ${checkin} to ${checkout} for ${guests} guests is confirmed.\n\nThank you!`,
  });
}


===== FILE: lib/emailTemplates.js  (size=3299 bytes) =====
// lib/emailTemplates.js

export function itineraryEmailHTML({
  type = 'itinerary', // NEW: 'itinerary' or 'receipt'
  kicker = 'Manyagi Realty',
  title = type === 'receipt' ? 'Your Booking Receipt' : 'Your Itinerary Quote',
  propertyName = 'Manyagi Realty Property',
  guestName = 'Guest',
  checkin,
  checkout,
  guests = '',
  icsUrl = '',
  detailsUrl = '',
  supportEmail = 'realty@manyagi.net',
}) {
  return `
  <div style="background:#f6f7fb;padding:24px">
    <table role="presentation" style="max-width:640px;margin:0 auto;background:#ffffff;border-radius:12px;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif">
      <tr>
        <td style="background:#111827;padding:20px 24px;color:#fff">
          <div style="font-size:18px;font-weight:700">${kicker}</div>
          <div style="opacity:.85;font-size:12px;margin-top:2px">${title}</div>
        </td>
      </tr>
      <tr>
        <td style="padding:24px">
          <h1 style="font-size:20px;margin:0 0 12px 0;color:#111827">Hi ${guestName},</h1>
          <p style="margin:0 0 16px 0;color:#374151;line-height:1.55">
            Here‚Äôs your ${type === 'receipt' ? 'receipt' : 'itinerary quote'} for <strong>${propertyName}</strong>.
          </p>

          <table role="presentation" style="width:100%;border:1px solid #e5e7eb;border-radius:8px;margin:16px 0">
            <tr>
              <td style="padding:12px 16px;border-bottom:1px solid #e5e7eb">
                <div style="font-size:12px;color:#6b7280;margin-bottom:2px">Check-in</div>
                <div style="font-size:14px;color:#111827">${checkin}</div>
              </td>
            </tr>
            <tr>
              <td style="padding:12px 16px;border-bottom:1px solid #e5e7eb">
                <div style="font-size:12px;color:#6b7280;margin-bottom:2px">Check-out</div>
                <div style="font-size:14px;color:#111827">${checkout}</div>
              </td>
            </tr>
            <tr>
              <td style="padding:12px 16px">
                <div style="font-size:12px;color:#6b7280;margin-bottom:2px">Guests</div>
                <div style="font-size:14px;color:#111827">${guests}</div>
              </td>
            </tr>
          </table>

          <div style="display:flex;gap:10px;margin-top:8px">
            <a href="${icsUrl}" style="background:#111827;color:#fff;text-decoration:none;padding:10px 14px;border-radius:8px;font-weight:600;display:inline-block">Add to Calendar</a>
            <a href="${detailsUrl}" style="background:#f3f4f6;color:#111827;text-decoration:none;padding:10px 14px;border-radius:8px;font-weight:600;display:inline-block">View Listing</a>
          </div>

          <p style="margin:20px 0 0 0;color:#6b7280;font-size:12px;line-height:1.55">
            Have questions? Reply to this email or contact us at
            <a href="mailto:${supportEmail}" style="color:#111827">${supportEmail}</a>.
          </p>
        </td>
      </tr>
      <tr>
        <td style="padding:16px 24px;background:#f9fafb;color:#6b7280;font-size:12px">
          ¬© ${new Date().getFullYear()} Manyagi Realty ‚Ä¢ All rights reserved.
        </td>
      </tr>
    </table>
  </div>
  `;
}


===== FILE: lib/printful.js  (size=876 bytes) =====
// lib/printful.js
import axios from 'axios';

const PRINTFUL_API = 'https://api.printful.com';

export async function createPrintfulOrder({
  externalId,            // e.g., Stripe session id
  recipient,             // { name, address1, city, state_code, country_code, zip, phone, email }
  items,                 // [{ sync_variant_id, quantity }]
  packingSlip = {},      // optional
}) {
  if (!process.env.PRINTFUL_API_KEY) {
    throw new Error('PRINTFUL_API_KEY is not set');
  }

  const headers = {
    Authorization: `Bearer ${process.env.PRINTFUL_API_KEY}`,
    'Content-Type': 'application/json',
  };

  const payload = {
    external_id: externalId,
    recipient,
    items,
    packing_slip: packingSlip,
  };

  const { data } = await axios.post(`${PRINTFUL_API}/orders`, payload, { headers });
  return data?.result || data;
}


===== FILE: lib/realtyHelpers.js  (size=1028 bytes) =====
// lib/realtyHelpers.js
import { supabaseAdmin } from './supabaseAdmin';

export async function isDateBlocked(propertyId, isoDate) {
  const { data: avail } = await supabaseAdmin.from('property_availability').select('status').eq('property_id', propertyId).eq('date', isoDate).maybeSingle();
  if (avail?.status === 'booked') return true;

  const { data: blocks } = await supabaseAdmin.from('realty_external_blocks').select('*').eq('property_id', propertyId);
  return (blocks || []).some(b => new Date(isoDate) >= new Date(b.starts_on) && new Date(isoDate) < new Date(b.ends_on));
}

export async function getRateForDate(propertyId, isoDate) {
  const { data: rates } = await supabaseAdmin.from('realty_rates').select('*').eq('property_id', propertyId).order('priority', { ascending: false });
  for (const r of rates || []) {
    if (new Date(isoDate) >= new Date(r.start_date) && new Date(isoDate) <= new Date(r.end_date)) {
      return r.nightly_rate;
    }
  }
  return null; // fallback to base price
}


===== FILE: lib/sendEmail.js  (size=771 bytes) =====
// lib/sendEmail.js
import nodemailer from 'nodemailer';

const {
  SMTP_HOST,
  SMTP_PORT,
  SMTP_USER,
  SMTP_PASS,
} = process.env;

export async function sendEmail({ to, subject, html }) {
  if (!SMTP_HOST || !SMTP_PORT || !SMTP_USER || !SMTP_PASS) {
    console.warn('SMTP not configured; skipping email send.');
    return { skipped: true };
  }

  const transporter = nodemailer.createTransport({
    host: SMTP_HOST,
    port: Number(SMTP_PORT),
    secure: Number(SMTP_PORT) === 465,
    auth: {
      user: SMTP_USER,
      pass: SMTP_PASS,
    },
  });

  const info = await transporter.sendMail({
    from: 'Manyagi Realty <realty@manyagi.net>',
    to,
    subject,
    html,
  });

  return { messageId: info.messageId };
}


===== FILE: lib/store.js  (size=197 bytes) =====
// lib/store.js
import { configureStore } from '@reduxjs/toolkit';
import cartReducer from './cartSlice';

export const store = configureStore({
  reducer: {
    cart: cartReducer,
  },
});


===== FILE: lib/supabase.js  (size=316 bytes) =====
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;

// Client-side Supabase (safe for pages/, components, etc.)
export const supabase = createClient(supabaseUrl, supabaseAnonKey);


===== FILE: lib/supabaseAdmin.js  (size=431 bytes) =====
// lib/supabaseAdmin.js
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
// IMPORTANT: Server-only. Do not import this from client components/pages.
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

export const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {
  auth: { autoRefreshToken: false, persistSession: false },
});


===== FILE: next-env.d.ts  (size=230 bytes) =====
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/pages/building-your-application/configuring/typescript for more information.


===== FILE: next-sitemap.config.js  (size=847 bytes) =====
/** @type {import('next-sitemap').IConfig} */
const SITE_URL = process.env.NEXT_PUBLIC_SITE_URL || 'https://manyagi.net';

module.exports = {
  siteUrl: SITE_URL,
  generateRobotsTxt: true,
  sitemapSize: 7000,
  changefreq: 'daily',
  priority: 0.7,
  exclude: ['/server-sitemap.xml'], // keep if you later attach a server sitemap
  robotsTxtOptions: {
    policies: [{ userAgent: '*', allow: '/' }],
    additionalSitemaps: [
      `${SITE_URL}/sitemap.xml`,
    ],
  },
  transform: async (config, path) => {
    // Set higher priority for home + divisions
    const hi = ['/', '/publishing', '/designs', '/media', '/capital', '/tech', '/realty', '/blog'];
    return {
      loc: path,
      changefreq: 'daily',
      priority: hi.includes(path) ? 0.9 : 0.7,
      lastmod: new Date().toISOString(),
    };
  },
};


===== FILE: next.config.js  (size=5676 bytes) =====
// next.config.js
const withTM = require('next-transpile-modules')(['gsap']);
const withMDX = require('@next/mdx')({
  extension: /\.mdx?$/,
  options: { remarkPlugins: [], rehypePlugins: [] },
});

/** @type {import('next').NextConfig} */
const nextConfig = withTM({
  pageExtensions: ['js', 'jsx', 'mdx', 'ts', 'tsx'],
  reactStrictMode: true,

  images: {
    remotePatterns: [
      { protocol: 'https', hostname: 'manyagi.net', pathname: '/**' },
      { protocol: 'https', hostname: 'images.unsplash.com', pathname: '/**' },
      { protocol: 'https', hostname: 'myfxbook.com', pathname: '/**' },
      { protocol: 'https', hostname: 'youtube.com', pathname: '/**' },
      { protocol: 'https', hostname: 'i.ytimg.com', pathname: '/**' },
      { protocol: 'https', hostname: 'img.youtube.com', pathname: '/**' },
      { protocol: 'https', hostname: 'dlbbjeohndiwtofitwec.supabase.co', pathname: '/**' },
      // Printful CDNs (mockups)
      { protocol: 'https', hostname: 'files.cdn.printful.com', pathname: '/**' },
      { protocol: 'https', hostname: 'img.printful.com', pathname: '/**' },
      // keep for scripts if you ever use next/image with external script assets
      { protocol: 'https', hostname: 'js.stripe.com', pathname: '/**' },
      // maps tiles / static maps (optional future)
      { protocol: 'https', hostname: 'maps.googleapis.com', pathname: '/**' },
      { protocol: 'https', hostname: 'maps.gstatic.com', pathname: '/**' },
      { protocol: 'https', hostname: 'www.gstatic.com', pathname: '/**' },
      { protocol: 'https', hostname: 'www.google.com', pathname: '/**' },
      { protocol: 'https', hostname: 'maps.google.com', pathname: '/**' },
    ],
    formats: ['image/avif', 'image/webp'],
    minimumCacheTTL: 60,
  },

  async headers() {
    // CSP tuned for:
    // - Stripe checkout
    // - Google Maps iframe + tiles
    // - Google Tag Manager
    // - Supabase storage + realtime
    // - Printful mockup images
    // - Twitter embeds / YouTube iframes
    //
    // NOTE: 'unsafe-eval' + 'unsafe-inline' are currently allowed because:
    // - Next dev / HMR
    // - Inline GTM snippet
    // We can tighten later with nonces/hashes.
    const csp = [
      // default fallback
      "default-src 'self'",
      // scripts we allow to run
      "script-src 'self' 'unsafe-eval' 'unsafe-inline' blob: data: https://www.googletagmanager.com https://www.google-analytics.com https://platform.twitter.com https://f.convertkit.com https://js.stripe.com https://maps.googleapis.com https://www.gstatic.com https://www.google.com",
      // inline styles + Google Fonts CSS
      "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com",
      // images (product thumbs, user uploads, YT thumbs, map tiles, etc)
      [
        "img-src 'self' data: blob:",
        "https://manyagi.net",
        "https://images.unsplash.com",
        "https://myfxbook.com",
        "https://youtube.com",
        "https://i.ytimg.com",
        "https://img.youtube.com",
        "https://syndication.twitter.com",
        "https://dlbbjeohndiwtofitwec.supabase.co",
        "https://files.cdn.printful.com",
        "https://img.printful.com",
        "https://maps.googleapis.com",
        "https://maps.gstatic.com",
        "https://www.gstatic.com",
        "https://www.google.com",
        "https://maps.google.com",
        "https://*.ggpht.com",
        "https://*.googleusercontent.com",
      ].join(' '),
      // audio/video blobs from Supabase, etc.
      "media-src 'self' data: blob: https://dlbbjeohndiwtofitwec.supabase.co",
      // XHR / fetch / websockets
      [
        "connect-src 'self'",
        "https://api.stripe.com",
        "https://api.telegram.org",
        "https://api.formspree.io",
        "https://app.convertkit.com",
        "https://www.google-analytics.com",
        "https://dlbbjeohndiwtofitwec.supabase.co",
        "wss://dlbbjeohndiwtofitwec.supabase.co",
        "https://files.cdn.printful.com",
        "https://img.printful.com",
        "https://maps.googleapis.com",
        "https://www.gstatic.com",
        "https://www.google.com",
        "https://maps.google.com",
      ].join(' '),
      // iframes we embed
      [
        "frame-src 'self'",
        "https://www.youtube.com",
        "https://www.youtube-nocookie.com",
        "https://platform.twitter.com",
        "https://syndication.twitter.com",
        "https://js.stripe.com",
        "https://hooks.stripe.com",
        "https://maps.google.com",
        "https://www.google.com",
      ].join(' '),
      // fonts
      "font-src 'self' data: https://fonts.gstatic.com",
    ].join('; ');

    return [
      {
        source: '/:path*',
        headers: [
          { key: 'X-Frame-Options', value: 'DENY' },
          { key: 'X-Content-Type-Options', value: 'nosniff' },
          { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
          { key: 'Strict-Transport-Security', value: 'max-age=31536000; includeSubDomains' },
          { key: 'Content-Security-Policy', value: csp },
        ],
      },
    ];
  },

  experimental: {
    esmExternals: 'loose',
    optimizePackageImports: ['gsap', 'framer-motion'],
  },

  compress: true,

  async rewrites() {
    return [{ source: '/sitemap.xml', destination: '/sitemap.xml' }];
  },

  env: {
    NEXT_PUBLIC_SITE_URL: process.env.NEXTAUTH_URL || 'https://manyagi.net',
    SITE_URL: process.env.NEXTAUTH_URL || 'https://manyagi.net',
  },
});

module.exports = withMDX(nextConfig);


===== FILE: package.json  (size=1525 bytes) =====
{
  "name": "manyagi-site",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "postbuild": "next-sitemap"
  },
  "dependencies": {
    "@formspree/react": "^3.0.0",
    "@mdx-js/loader": "^3.0.1",
    "@mdx-js/react": "^3.0.1",
    "@netlify/plugin-nextjs": "^5.13.3",
    "@next/mdx": "^14.2.5",
    "@reduxjs/toolkit": "^2.2.8",
    "@stripe/react-stripe-js": "^2.7.3",
    "@stripe/stripe-js": "^4.10.0",
    "@supabase/auth-helpers-nextjs": "^0.10.0",
    "@supabase/supabase-js": "^2.45.4",
    "axios": "^1.12.2",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "framer-motion": "^11.11.9",
    "gray-matter": "^4.0.3",
    "gsap": "^3.12.5",
    "micro": "^10.0.1",
    "next": "^14.2.15",
    "next-mdx-remote": "^4.4.1",
    "next-sitemap": "^4.2.3",
    "next-themes": "^0.4.6",
    "next-transpile-modules": "^10.0.1",
    "node-fetch": "^3.3.2",
    "node-ical": "^0.22.0",
    "nodemailer": "^7.0.10",
    "posthog-js": "^1.268.8",
    "react": "^18.3.1",
    "react-big-calendar": "^1.19.4",
    "react-dom": "^18.3.1",
    "react-icons": "^5.3.0",
    "react-redux": "^9.2.0",
    "react-responsive-carousel": "^3.2.23",
    "react-scroll-parallax": "^3.4.5",
    "recharts": "^3.3.0",
    "redux": "^5.0.1",
    "stripe": "^16.12.0"
  },
  "devDependencies": {
    "autoprefixer": "^10.4.20",
    "postcss": "^8.4.47",
    "tailwindcss": "^3.4.14",
    "tailwindcss-animate": "^1.0.7",
    "typescript": "5.9.2"
  }
}


===== FILE: pages/404.js  (size=3907 bytes) =====
// pages/404.js
import Link from 'next/link';
import Head from 'next/head';
import { motion } from 'framer-motion';
import Recommender from '../components/Recommender';

export default function Custom404() {
  return (
    <>
      <Head>
        <title>Portal Not Found ‚Äî Manyagi</title>
        <meta
          name="description"
          content="This realm doesn‚Äôt exist ‚Äî but your journey continues. Discover Publishing, Designs, Capital, Tech, Media, and Realty."
        />
        <meta name="robots" content="noindex,follow" />
      </Head>

      <section className="relative overflow-hidden">
        {/* Background aura */}
        <div className="absolute inset-0 -z-10 bg-gradient-to-br from-black via-gray-900 to-black" />
        <div className="absolute inset-0 -z-10 opacity-20 pointer-events-none"
             style={{
               backgroundImage:
                 'radial-gradient(40% 40% at 50% 50%, rgba(255,255,255,0.15) 0%, rgba(0,0,0,0) 70%)',
             }}
        />

        <div className="container mx-auto px-4 py-24 text-white text-center">
          <motion.h1
            initial={{ opacity: 0, y: -12 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.5 }}
            className="text-5xl md:text-6xl font-extrabold tracking-tight"
          >
            Portal Not Found
          </motion.h1>

          <motion.p
            initial={{ opacity: 0, y: 6 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.15, duration: 0.5 }}
            className="mt-4 text-gray-300 max-w-2xl mx-auto"
          >
            Looks like this realm doesn‚Äôt exist ‚Äî but your journey continues.
            Choose a gateway below and step back into the Manyagi universe.
          </motion.p>

          {/* Primary actions */}
          <motion.div
            initial={{ opacity: 0, y: 6 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.25, duration: 0.5 }}
            className="mt-8 flex flex-wrap justify-center gap-3"
          >
            <Link href="/" className="btn bg-yellow-500 text-black px-5 py-2 rounded-lg hover:bg-yellow-400 transition">
              Return to HQ
            </Link>
            <Link href="/publishing" className="btn bg-white text-black px-5 py-2 rounded-lg hover:bg-gray-200 transition">
              Explore Publishing
            </Link>
            <Link href="/designs" className="btn bg-white/10 text-white px-5 py-2 rounded-lg hover:bg-white/20 transition border border-white/20">
              Shop Designs
            </Link>
          </motion.div>

          {/* Helpful discovery (turns 404 into a conversion moment) */}
          <div className="mt-14 bg-white text-black rounded-xl shadow-lg p-6 dark:bg-gray-900 dark:text-white">
            <h2 className="text-2xl font-bold mb-3">Recommended for you</h2>
            <p className="text-sm text-gray-600 dark:text-gray-300 mb-4">
              Popular picks across our divisions.
            </p>
            <Recommender />
          </div>

          {/* Quick deep links */}
          <div className="mt-10 grid grid-cols-2 md:grid-cols-3 gap-3 text-sm text-gray-300">
            <Link href="/media" className="hover:text-yellow-400 transition">Media</Link>
            <Link href="/capital" className="hover:text-yellow-400 transition">Capital</Link>
            <Link href="/tech" className="hover:text-yellow-400 transition">Tech</Link>
            <Link href="/realty" className="hover:text-yellow-400 transition">Realty</Link>
            <Link href="/blog" className="hover:text-yellow-400 transition">Blog</Link>
            <Link href="/about" className="hover:text-yellow-400 transition">About</Link>
          </div>
        </div>
      </section>
    </>
  );
}


===== FILE: pages/500.js  (size=2722 bytes) =====
// pages/500.js
import Link from 'next/link';
import Head from 'next/head';
import Recommender from '../components/Recommender';

export default function Custom500() {
  return (
    <>
      <Head>
        <title>System Interruption ‚Äî Manyagi</title>
        <meta
          name="description"
          content="Something went wrong within the Manyagi network. Our engineers are restoring balance."
        />
        <meta name="robots" content="noindex,follow" />
      </Head>

      <section className="relative overflow-hidden">
        {/* Deep crimson background for urgency */}
        <div className="absolute inset-0 -z-10 bg-gradient-to-br from-red-950 via-black to-black" />
        <div className="container mx-auto px-4 py-24 text-white text-center">
          <h1 className="text-5xl md:text-6xl font-extrabold tracking-tight">
            System Interruption
          </h1>
          <p className="mt-4 text-gray-300 max-w-2xl mx-auto">
            Something went wrong within the Manyagi network. Our engineers are restoring balance.
          </p>

          <div className="mt-8 flex flex-wrap justify-center gap-3">
            <Link href="/" className="btn bg-yellow-500 text-black px-5 py-2 rounded-lg hover:bg-yellow-400 transition">
              Return to HQ
            </Link>
            <Link href="/status" className="btn bg-white text-black px-5 py-2 rounded-lg hover:bg-gray-200 transition">
              System Status
            </Link>
          </div>

          {/* Give users somewhere valuable to go */}
          <div className="mt-14 bg-white text-black rounded-xl shadow-lg p-6 dark:bg-gray-900 dark:text-white">
            <h2 className="text-2xl font-bold mb-3">Explore while we fix things</h2>
            <p className="text-sm text-gray-600 dark:text-gray-300 mb-4">
              Here are some popular picks across our divisions.
            </p>
            <Recommender />
          </div>

          <div className="mt-10 grid grid-cols-2 md:grid-cols-3 gap-3 text-sm text-gray-300">
            <Link href="/publishing" className="hover:text-yellow-400 transition">Publishing</Link>
            <Link href="/designs" className="hover:text-yellow-400 transition">Designs</Link>
            <Link href="/media" className="hover:text-yellow-400 transition">Media</Link>
            <Link href="/capital" className="hover:text-yellow-400 transition">Capital</Link>
            <Link href="/tech" className="hover:text-yellow-400 transition">Tech</Link>
            <Link href="/realty" className="hover:text-yellow-400 transition">Realty</Link>
          </div>
        </div>
      </section>
    </>
  );
}


===== FILE: pages/_app.js  (size=3452 bytes) =====
// pages/_app.js
import '@/styles/globals.css';
import { Provider } from 'react-redux';
import { store } from '../lib/store';
import Header from '../components/Header';
import Footer from '../components/Footer';
import ErrorBoundary from '../components/ErrorBoundary';
import { useEffect } from 'react';
import { useRouter } from 'next/router';
import Script from 'next/script';
import Head from 'next/head';
import { ThemeProvider } from 'next-themes';
import SEO from '@/components/SEO';

// üî• NEW: track affiliate codes from URL (?ref=ABC)
import { rememberAffiliateFromURL } from '@/lib/affiliate';

const GA_ID = process.env.NEXT_PUBLIC_GOOGLE_ANALYTICS_ID || '';

function MyApp({ Component, pageProps }) {
  const router = useRouter();

  // üî• NEW: capture & persist affiliate referral code from URL (once per mount / nav)
  useEffect(() => {
    rememberAffiliateFromURL();
  }, []);

  // Persist cart between refreshes
  useEffect(() => {
    const unsubscribe = store.subscribe(() => {
      try {
        localStorage.setItem(
          'cart',
          JSON.stringify(store.getState().cart.items || [])
        );
      } catch {
        /* ignore */
      }
    });

    try {
      const saved = localStorage.getItem('cart');
      if (saved)
        store.dispatch({
          type: 'cart/setItems',
          payload: JSON.parse(saved),
        });
    } catch {
      /* ignore */
    }

    return unsubscribe;
  }, []);

  // Google Analytics: track route changes
  useEffect(() => {
    if (!GA_ID) return;
    const handleRouteChange = (url) => {
      if (
        typeof window !== 'undefined' &&
        typeof window.gtag === 'function'
      ) {
        window.gtag('config', GA_ID, { page_path: url });
      }
    };
    router.events.on('routeChangeComplete', handleRouteChange);
    return () =>
      router.events.off('routeChangeComplete', handleRouteChange);
  }, [router.events]);

  return (
    <Provider store={store}>
      <ErrorBoundary>
        <Head>
          {/* Viewport + icons */}
          <meta
            name="viewport"
            content="width=device-width, initial-scale=1"
          />
          <link rel="icon" href="/favicon.ico" />
        </Head>

        {GA_ID ? (
          <>
            <Script
              strategy="afterInteractive"
              src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}
            />
            <Script id="ga-init" strategy="afterInteractive">
              {`
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', '${GA_ID}');
              `}
            </Script>
          </>
        ) : null}

        <ThemeProvider attribute="class" defaultTheme="light">
          {/* Global SEO defaults; pages can override with their own <SEO .../> */}
          <SEO />

          <div className="min-h-screen gradient-bg dark:bg-gray-900 transition-colors">
            <Header />
            <main className="container mx-auto px-4 py-8 min-h-screen bg-white text-black gradient-bg">
              <Component {...pageProps} />
            </main>
            <Footer />
          </div>
        </ThemeProvider>
      </ErrorBoundary>
    </Provider>
  );
}

export default MyApp;


===== FILE: pages/_document.js  (size=3860 bytes) =====
// pages/_document.js
import { Html, Head, Main, NextScript } from 'next/document';

const SITE_URL = process.env.NEXT_PUBLIC_SITE_URL || 'https://manyagi.net';

export default function Document() {
  // Detect build environment at render time on server
  const isProd = process.env.NODE_ENV === 'production';

  // In dev: go loose so Next.js HMR, inline scripts, eval, etc. work
  const devCsp = `
    default-src 'self' http://localhost:* ws://localhost:* http://127.0.0.1:* ws://127.0.0.1:* blob: data:;
    img-src 'self' blob: data: https:;
    font-src 'self' data: https://fonts.gstatic.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: data: https://js.stripe.com https://maps.googleapis.com https://www.gstatic.com https://www.google.com;
    connect-src 'self' http://localhost:* ws://localhost:* http://127.0.0.1:* ws://127.0.0.1:* https: http: wss: blob:;
    frame-src 'self' https://js.stripe.com https://www.youtube.com https://www.youtube-nocookie.com https://maps.google.com https://www.google.com;
    media-src 'self' blob: data: https:;
    object-src 'none';
    base-uri 'self';
    form-action 'self' https://js.stripe.com;
  `;

  // In prod: tighter, but still allow Stripe checkout + Google Maps iframe + YouTube embeds
  const prodCsp = `
    default-src 'self';
    img-src 'self' data: blob: https:;
    font-src 'self' data: https://fonts.gstatic.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    script-src
      'self'
      'unsafe-inline'
      'unsafe-eval'
      blob:
      https://js.stripe.com
      https://www.gstatic.com
      https://maps.googleapis.com
      https://www.google.com;
    connect-src
      'self'
      https:
      wss:;
    frame-src
      'self'
      https://www.youtube.com
      https://www.youtube-nocookie.com
      https://js.stripe.com
      https://maps.google.com
      https://www.google.com;
    media-src 'self' blob: data: https:;
    object-src 'none';
    base-uri 'self';
    form-action 'self' https://js.stripe.com;
  `;

  const cspToUse = isProd ? prodCsp : devCsp;

  return (
    <Html lang="en">
      <Head>
        {/* Content Security Policy */}
        <meta httpEquiv="Content-Security-Policy" content={cspToUse} />

        {/* Fonts */}
        <link
          href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Georgia&display=swap"
          rel="stylesheet"
        />

        {/* Global org JSON-LD */}
        <script
          type="application/ld+json"
          dangerouslySetInnerHTML={{
            __html: JSON.stringify({
              '@context': 'https://schema.org',
              '@type': 'Organization',
              name: 'Manyagi',
              url: SITE_URL,
              description:
                'Manyagi unites Publishing, Designs, Capital, Tech, Media, and Realty under one HQ.',
              logo: `${SITE_URL}/images/logo.png`,
              sameAs: [
                'https://instagram.com/manyagi.official',
                'https://tiktok.com/@manyagi.official',
                'https://youtube.com/@ManyagiOfficial',
                'https://x.com/ManyagiOfficial',
                'https://linkedin.com/company/manyagi',
                'https://pinterest.com/ManyagiOfficial',
              ],
              contactPoint: {
                '@type': 'ContactPoint',
                email: 'support@manyagi.net',
                contactType: 'customer support',
                availableLanguage: 'en',
              },
            }),
          }}
        />
      </Head>
      <body className="bg-white text-black">
        <Main />
        <NextScript />
      </body>
    </Html>
  );
}


===== FILE: pages/about.js  (size=1376 bytes) =====
import Head from 'next/head';
import Link from 'next/link';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import Hero from '../components/Hero';

export default function About() {
  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/og-about.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/team-photo.webp',
  ];

  return (
    <>
      <Head>
        <title>About Manyagi ‚Äî Our Story</title>
        <meta name="description" content="Learn about Manyagi's mission and team." />
      </Head>
      <Hero kicker="About Us" title="Our Story" lead="Manyagi unites creativity and innovation across publishing, designs, capital, tech, media, and realty." carouselImages={carouselImages} height="h-[600px]">
        <Link href="#team" className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition">Meet the Team</Link>
      </Hero>

      {/* ‚Ä¶your existing content ‚Ä¶ */}

      <section id="subscribe" className="container mx-auto px-4 py-16">
        <SubscriptionForm formId="8427853" uid="637df68a06" title="Stay Connected" description="Join our community for updates and insights." />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/admin.js  (size=9546 bytes) =====
// pages/admin.js
import React, { useEffect, useState, useCallback } from 'react';
import Head from 'next/head';
import { useRouter } from 'next/router';
import { supabase } from '@/lib/supabase';

import OverviewTab from '@/components/admin/OverviewTab';
import PublishingTab from '@/components/admin/PublishingTab';
import DesignsTab from '@/components/admin/DesignsTab';
import CapitalTab from '@/components/admin/CapitalTab';
import TechTab from '@/components/admin/TechTab';
import MediaTab from '@/components/admin/MediaTab';
import RealtyTab from '@/components/admin/RealtyTab';
import AssetsTab from '@/components/admin/AssetsTab';
import BlogTab from '@/components/admin/BlogTab';
import AffiliatesTab from '@/components/admin/AffiliatesTab';
import BundlesTab from '@/components/admin/BundlesTab';
import UsersTab from '@/components/admin/UsersTab';
import AnalyticsTab from '@/components/admin/AnalyticsTab';
import EventsTab from '@/components/admin/EventsTab';

// arrivals / upcoming stays dashboard
import UpcomingStaysPanel from '@/components/admin/UpcomingStaysPanel';

// little pill button for the tab nav
const TabButton = ({ active, onClick, children }) => (
  <button
    onClick={onClick}
    className={`px-3 py-2 rounded text-sm font-medium transition ${
      active
        ? 'bg-blue-500 text-white'
        : 'bg-gray-200 text-gray-800 dark:bg-gray-800 dark:text-gray-200'
    }`}
  >
    {children}
  </button>
);

export default function Admin() {
  const router = useRouter();

  // auth state
  const [user, setUser] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false);

  // dashboard data
  const [products, setProducts] = useState([]);
  const [orders, setOrders] = useState([]);
  const [subscriptions, setSubscriptions] = useState([]);
  const [assets, setAssets] = useState([]);
  const [siteConfig, setSiteConfig] = useState({});
  const [users, setUsers] = useState([]);
  const [properties, setProperties] = useState([]);
  const [affiliates, setAffiliates] = useState([]);
  const [bundles, setBundles] = useState([]);
  const [events, setEvents] = useState([]);
  const [posts, setPosts] = useState([]);

  // reservations from realty_reservations for revenue/ops/affiliates
  const [reservations, setReservations] = useState([]);

  // leads from realty_leads (buy/sell/manage inquiries)
  const [realtyLeads, setRealtyLeads] = useState([]);

  // ui state
  const [loading, setLoading] = useState(true);

  // default active tab
  const [activeTab, setActiveTab] = useState('overview');

  // fetch everything for dashboard
  const refreshAll = useCallback(async () => {
    const [
      p,
      o,
      s,
      a,
      c,
      b,
      u,
      prop,
      aff,
      bund,
      ev,
      rr,   // realty_reservations
      leads // realty_leads
    ] = await Promise.all([
      supabase
        .from('products')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('orders')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('subscriptions')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('assets')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase.from('site_config').select('*'),

      supabase
        .from('posts')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('users')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('properties')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('affiliates')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('bundles')
        .select('*')
        .order('created_at', { ascending: false }),

      supabase
        .from('events')
        .select('*')
        .order('created_at', { ascending: false }),

      // grab reservations so we can display arrivals/revenue and feed affiliates
      supabase
        .from('realty_reservations')
        .select('*')
        .order('created_at', { ascending: false }),

      // grab brokerage / mgmt / seller / buyer leads
      supabase
        .from('realty_leads')
        .select('*')
        .order('created_at', { ascending: false }),
    ]);

    setProducts(p.data || []);
    setOrders(o.data || []);
    setSubscriptions(s.data || []);
    setAssets(a.data || []);
    setSiteConfig(
      (c.data || []).reduce(
        (acc, item) => ({ ...acc, [item.key]: item.value }),
        {}
      )
    );
    setPosts(b.data || []);
    setUsers(u.data || []);
    setProperties(prop.data || []);
    setAffiliates(aff.data || []);
    setBundles(bund.data || []);
    setEvents(ev.data || []);

    setReservations(rr.data || []);
    setRealtyLeads(leads.data || []);
  }, []);

  // bootstrap auth + data
  useEffect(() => {
    (async () => {
      // check session
      const {
        data: { user: supaUser },
      } = await supabase.auth.getUser();

      if (!supaUser) {
        router.push('/login');
        return;
      }

      setUser(supaUser);

      // verify admin role
      const { data: userRow, error } = await supabase
        .from('users')
        .select('role')
        .eq('id', supaUser.id)
        .maybeSingle();

      if (error) {
        console.error('role check error:', error);
      }

      if (userRow?.role !== 'admin') {
        router.push('/dashboard');
        return;
      }

      setIsAdmin(true);

      // load dashboard data
      await refreshAll();
      setLoading(false);
    })();
  }, [router, refreshAll]);

  if (loading) {
    return <p className="p-6">Loading admin dashboard‚Ä¶</p>;
  }

  if (!isAdmin) {
    return <p className="p-6">Not authorized.</p>;
  }

  // tab labels
  const tabs = [
    'overview',
    'publishing',
    'designs',
    'capital',
    'tech',
    'media',
    'realty',
    'upcoming', // stays dashboard for realty arrivals
    'assets',
    'blog',
    'affiliates',
    'bundles',
    'users',
    'analytics',
    'events',
  ];

  return (
    <>
      <Head>
        <title>Manyagi Admin Dashboard</title>
      </Head>

      <div className="container mx-auto px-4 py-8 space-y-12 gradient-bg dark:bg-gray-900 text-gray-900 dark:text-gray-100">
        {/* tab nav */}
        <nav className="flex gap-2 mb-6 flex-wrap">
          {tabs.map((tab) => (
            <TabButton
              key={tab}
              active={activeTab === tab}
              onClick={() => setActiveTab(tab)}
            >
              {tab.charAt(0).toUpperCase() + tab.slice(1)}
            </TabButton>
          ))}
        </nav>

        {/* tab bodies */}
        {activeTab === 'overview' && (
          <OverviewTab
            orders={orders}
            subscriptions={subscriptions}
            users={users}
          />
        )}

        {activeTab === 'publishing' && (
          <PublishingTab products={products} refreshAll={refreshAll} />
        )}

        {activeTab === 'designs' && (
          <DesignsTab
            products={products}
            assets={assets}          // pass assets for Recent Uploads + copy URLs
            refreshAll={refreshAll}
          />
        )}

        {activeTab === 'capital' && (
          <CapitalTab products={products} refreshAll={refreshAll} />
        )}

        {activeTab === 'tech' && (
          <TechTab posts={posts} refreshAll={refreshAll} />
        )}

        {activeTab === 'media' && (
          <MediaTab posts={posts} refreshAll={refreshAll} />
        )}

        {activeTab === 'realty' && (
          <>
            {/* Pass captured leads into RealtyTab without inline prop comments */}
            <RealtyTab
              properties={properties}
              assets={assets}
              leads={realtyLeads}
              refreshAll={refreshAll}
            />
          </>
        )}

        {activeTab === 'upcoming' && (
          <section className="space-y-6">
            <UpcomingStaysPanel />
          </section>
        )}

        {activeTab === 'assets' && (
          <AssetsTab assets={assets} refreshAll={refreshAll} />
        )}

        {activeTab === 'blog' && (
          <BlogTab posts={posts} refreshAll={refreshAll} user={user} />
        )}

        {activeTab === 'affiliates' && (
          <AffiliatesTab
            affiliates={affiliates}
            orders={orders}
            reservations={reservations}
            refreshAll={refreshAll}
          />
        )}

        {activeTab === 'bundles' && (
          <BundlesTab
            bundles={bundles}
            products={products}
            refreshAll={refreshAll}
          />
        )}

        {activeTab === 'users' && (
          <UsersTab users={users} refreshAll={refreshAll} />
        )}

        {activeTab === 'analytics' && (
          <AnalyticsTab users={users} orders={orders} />
        )}

        {activeTab === 'events' && (
          <EventsTab events={events} refreshAll={refreshAll} />
        )}
      </div>
    </>
  );
}


===== FILE: pages/api/admin/fulfillment/retry.js  (size=5870 bytes) =====
// pages/api/admin/fulfillment/retry.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';
import { createPrintfulOrder } from '@/lib/printful';
import Stripe from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: '2024-06-20' });

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  try {
    // --- Auth (admin only) ---
    const auth = req.headers.authorization || '';
    const token = auth.startsWith('Bearer ') ? auth.slice(7) : null;
    if (!token) return res.status(401).json({ error: 'Unauthorized' });

    const { data: userResp, error: getUserErr } = await supabaseAdmin.auth.getUser(token);
    if (getUserErr || !userResp?.user) return res.status(401).json({ error: 'Unauthorized' });

    const { data: roleRow } = await supabaseAdmin
      .from('users')
      .select('role')
      .eq('id', userResp.user.id)
      .maybeSingle();

    if ((roleRow?.role || 'user') !== 'admin') {
      return res.status(403).json({ error: 'Forbidden' });
    }

    // --- Inputs ---
    const { order_id, override_variant_id = null } = req.body || {};
    if (!order_id) return res.status(400).json({ error: 'order_id is required' });

    // --- Load order ---
    const { data: order, error: oErr } = await supabaseAdmin
      .from('orders')
      .select('*')
      .eq('id', order_id)
      .maybeSingle();
    if (oErr) throw oErr;
    if (!order) return res.status(404).json({ error: 'Order not found' });
    if ((order.status || '').toLowerCase() !== 'paid') {
      return res.status(400).json({ error: 'Order is not paid' });
    }
    if (!order.stripe_session_id) {
      return res.status(400).json({ error: 'Missing stripe_session_id on order' });
    }

    // --- Load product & build items ---
    const { data: product } = await supabaseAdmin
      .from('products')
      .select('*')
      .eq('id', order.product_id)
      .maybeSingle();

    const meta = product?.metadata || {};
    const quantity = Math.max(1, Number(order.quantity || 1));

    // If product includes a full multi-line item list, use it; else fall back to single variant
    let items = [];
    if (Array.isArray(meta.printful_items) && meta.printful_items.length > 0) {
      items = meta.printful_items.map(it => ({
        sync_variant_id: Number(it.sync_variant_id),
        quantity: Math.max(1, Number(it.quantity || quantity)),
      }));
    } else {
      const syncVariantId =
        override_variant_id ||
        meta.printful_sync_variant_id ||
        meta.printful_sync_variant ||
        null;

      if (!syncVariantId) {
        return res.status(400).json({
          error: 'Product is not configured for Printful (missing printful_sync_variant_id)',
        });
      }
      items = [{ sync_variant_id: Number(syncVariantId), quantity }];
    }

    // --- Get shipping details from original checkout session ---
    const session = await stripe.checkout.sessions.retrieve(order.stripe_session_id);
    const addr = session?.shipping_details?.address || null;
    if (!addr) {
      return res.status(400).json({
        error: 'This order has no shipping address; cannot send to Printful.',
      });
    }

    const recipient = {
      name: session?.customer_details?.name || 'Customer',
      address1: addr.line1 || '',
      city: addr.city || '',
      state_code: addr.state || '',
      country_code: addr.country || 'US',
      zip: addr.postal_code || '',
      phone: session?.customer_details?.phone || '',
      email: session?.customer_details?.email || '',
    };

    const packingSlip = {
      email: 'support@manyagi.net',
      phone: '',
      message: 'Thank you for supporting Manyagi!',
    };

    // Use stripe_session_id as external id for idempotency across webhook/retry
    const externalId = order.stripe_session_id;

    let pf;
    try {
      pf = await createPrintfulOrder({
        externalId,
        recipient,
        items,
        packingSlip,
      });
    } catch (e) {
      // If this fails because the external_id already exists, treat as success and fetch it
      const msg = e?.response?.data?.result || e?.response?.data || e?.message || '';
      const alreadyExists =
        typeof msg === 'string' && /external.*exist|already.*exist/i.test(msg);

      if (alreadyExists) {
        // Attempt to fetch by external_id
        try {
          const resp = await fetch(
            `https://api.printful.com/orders/@${encodeURIComponent(externalId)}`,
            { headers: { Authorization: `Bearer ${process.env.PRINTFUL_API_KEY}` } }
          );
          if (resp.ok) {
            const j = await resp.json();
            pf = j?.result;
          } else {
            throw new Error('Order exists but could not fetch from Printful');
          }
        } catch (fetchErr) {
          console.warn('Printful fetch-by-externalId failed:', fetchErr?.message || fetchErr);
          throw e; // bubble original
        }
      } else {
        throw e; // real error
      }
    }

    // --- Persist fulfillment back on the order ---
    await supabaseAdmin
      .from('orders')
      .update({
        fulfillment_provider: 'printful',
        fulfillment_status: pf?.status || 'submitted',
        fulfillment_id: pf?.id ? String(pf.id) : order.fulfillment_id || null,
        updated_at: new Date().toISOString(),
      })
      .eq('id', order.id);

    return res.status(200).json({ ok: true, printful: pf });
  } catch (err) {
    console.error('fulfillment/retry error:', err?.response?.data || err.message);
    return res.status(500).json({ error: err.message || 'Internal error' });
  }
}


===== FILE: pages/api/admin/quick-create-product.js  (size=4366 bytes) =====
// pages/api/admin/quick-create-product.js
import Stripe from 'stripe';
import { supabaseAdmin } from '@/lib/supabaseAdmin';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: '2024-06-20' });

async function fetchPrintfulPreview(variantId) {
  if (!variantId || !process.env.PRINTFUL_API_KEY) return { preview_url: null, product_id: null };
  try {
    const headers = { Authorization: `Bearer ${process.env.PRINTFUL_API_KEY}` };
    const vRes = await fetch(`https://api.printful.com/store/variants/${variantId}`, { headers });
    if (!vRes.ok) throw new Error('Variant not found');
    const vJson = await vRes.json();
    const variant = vJson?.result;

    let preview_url =
      variant?.files?.find(f => f?.preview_url)?.preview_url ||
      variant?.thumbnail_url || null;

    const product_id = variant?.product_id ?? null;

    if (!preview_url && product_id) {
      const pRes = await fetch(`https://api.printful.com/store/products/${product_id}`, { headers });
      if (pRes.ok) {
        const pJson = await pRes.json();
        const sp = pJson?.result?.sync_product;
        const sv = pJson?.result?.sync_variants || [];
        preview_url =
          sp?.thumbnail_url ||
          (sv.find(x => (x?.files || []).some(f => f?.preview_url))?.files || []).find(f => f?.preview_url)?.preview_url ||
          null;
      }
    }
    return { preview_url, product_id };
  } catch (e) {
    return { preview_url: null, product_id: null };
  }
}

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  try {
    const {
      name,
      description = '',
      price,                 // number or numeric string
      currency = 'usd',
      image = '',            // optional thumbnail/mockup URL
      printfulVariantId = '',// optional: numeric/id as string
      divisions = ['designs'],
      status = 'active',
      tags = [],
      extraMetadata = {},
    } = req.body || {};

    if (!name) return res.status(400).json({ error: 'Name is required' });
    const amount = Number(price);
    if (!(amount > 0)) return res.status(400).json({ error: 'Valid price required' });

    // If no image provided but we have a variant, try to fetch a mockup URL
    let thumbnail_url = image || null;
    let printful_product_id = null;

    if (!thumbnail_url && printfulVariantId) {
      const { preview_url, product_id } = await fetchPrintfulPreview(printfulVariantId);
      thumbnail_url = preview_url || null;
      printful_product_id = product_id ? String(product_id) : null;
    }

    // 1) Stripe objects
    const sProduct = await stripe.products.create({
      name,
      description,
      images: thumbnail_url ? [thumbnail_url] : undefined,
      default_price_data: {
        currency,
        unit_amount: Math.round(amount * 100),
      },
      metadata: {
        brand: 'Manyagi',
        ...extraMetadata,
      },
    });

    // default_price_data returns price in product‚Äôs default_price
    const sPriceId =
      typeof sProduct.default_price === 'string'
        ? sProduct.default_price
        : sProduct.default_price?.id;

    // 2) Create Supabase products for each division
    const rows = divisions.map((division) => ({
      name,
      division,
      price: amount,
      description,
      status,
      thumbnail_url: thumbnail_url || null,
      printful_product_id: printful_product_id, // may be null if not fetched
      tags,
      metadata: {
        stripe_product_id: sProduct.id,
        stripe_price_id: sPriceId,
        printful_sync_variant_id: printfulVariantId || null,
        extra: extraMetadata || {},
      },
    }));

    const { error: insErr } = await supabaseAdmin.from('products').insert(rows);
    if (insErr) throw insErr;

    return res.status(200).json({
      ok: true,
      stripe_product_id: sProduct.id,
      stripe_price_id: sPriceId,
      used_thumbnail_url: thumbnail_url || null,
      printful_product_id: printful_product_id,
      divisions_created: divisions,
    });
  } catch (err) {
    console.error('quick-create-product error:', err);
    return res.status(500).json({ error: err.message || 'Internal error' });
  }
}


===== FILE: pages/api/admin/upload-asset-multi.js  (size=7478 bytes) =====
// pages/api/admin/upload-asset-multi.js
// Fault-tolerant batch uploader with SAFE storage keys.
//
// Keeps original behavior, adds:
// - server-side filename sanitization (fixes "Invalid key")
// - honors client-sent contentType/fileType when present
// - still catches errors PER FILE and returns { ok, items, errors }

import { supabaseAdmin } from '@/lib/supabaseAdmin';
import { nanoid } from 'nanoid';

export const config = {
  api: {
    bodyParser: { sizeLimit: '50mb' },
  },
};

// --- Helpers ---------------------------------------------------------------

function guessContentType(ext) {
  switch ((ext || '').toLowerCase()) {
    case 'jpg':
    case 'jpeg': return 'image/jpeg';
    case 'png':  return 'image/png';
    case 'webp': return 'image/webp';
    case 'gif':  return 'image/gif';
    case 'svg':  return 'image/svg+xml';
    case 'heic':
    case 'heif': return 'image/heic';
    case 'pdf':  return 'application/pdf';
    case 'mp4':  return 'video/mp4';
    case 'mov':
    case 'm4v':  return 'video/quicktime';
    case 'webm': return 'video/webm';
    case 'mp3':  return 'audio/mpeg';
    case 'wav':  return 'audio/wav';
    default:     return 'application/octet-stream';
  }
}

function logicalTypeFromExt(ext) {
  const e = (ext || '').toLowerCase();
  if (['jpg','jpeg','png','webp','gif','svg','heic','heif'].includes(e)) return 'image';
  if (['mp4','mov','m4v','webm'].includes(e)) return 'video';
  if (['mp3','wav'].includes(e)) return 'audio';
  if (e === 'pdf') return 'pdf';
  return 'file';
}

// sanitize a single path segment for Supabase Storage keys
function sanitizeFilename(name) {
  const dot = name.lastIndexOf('.');
  const base = dot >= 0 ? name.slice(0, dot) : name;
  const ext  = dot >= 0 ? name.slice(dot).toLowerCase() : '';

  const safeBase = base
    .normalize('NFKD')
    // drop diacritics + punctuation not safe for keys
    .replace(/[^\w\s.-]/g, '')
    // spaces -> single dash
    .replace(/\s+/g, '-')
    // collapse multi-dashes
    .replace(/-+/g, '-')
    // trim leading/trailing dots/dashes
    .replace(/^[-.]+|[-.]+$/g, '');

  // keep keys reasonably short
  const trimmed = (safeBase || 'file').slice(0, 80);

  return `${trimmed}${ext || ''}`;
}

function logicalTypeFromClientOrExt(clientType, ext) {
  const allow = ['image','video','audio','pdf','file','other'];
  const t = (clientType || '').toLowerCase();
  if (allow.includes(t)) {
    // normalize "other" to "file" for DB
    return t === 'other' ? 'file' : t;
  }
  return logicalTypeFromExt(ext);
}

// --- Handler --------------------------------------------------------------

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    // 1) Auth (admin only)
    const auth = req.headers.authorization || '';
    const token = auth.startsWith('Bearer ') ? auth.slice(7) : null;
    if (!token) {
      return res.status(200).json({
        ok: false, items: [], errors: [{ name: '(all)', reason: 'Unauthorized (no token)' }],
      });
    }

    const { data: userResp, error: getUserErr } = await supabaseAdmin.auth.getUser(token);
    if (getUserErr || !userResp?.user) {
      return res.status(200).json({
        ok: false, items: [], errors: [{ name: '(all)', reason: 'Unauthorized (bad token)' }],
      });
    }

    const { data: roleRow, error: roleErr } = await supabaseAdmin
      .from('users')
      .select('role')
      .eq('id', userResp.user.id)
      .maybeSingle();

    if (roleErr || (roleRow?.role || 'user') !== 'admin') {
      return res.status(200).json({
        ok: false, items: [], errors: [{ name: '(all)', reason: 'Forbidden (not admin)' }],
      });
    }

    // 2) Parse body
    const {
      files,
      division = 'site',
      purpose = 'general',
      folder = '',
      metadata = {},
    } = req.body || {};

    if (!Array.isArray(files) || files.length === 0) {
      return res.status(200).json({
        ok: false, items: [], errors: [{ name: '(all)', reason: 'No files provided' }],
      });
    }

    // storage prefix: assets/<division>/<purpose>/YYYY/MM[/folder]
    const now = new Date();
    const yyyy = now.getUTCFullYear();
    const mm = String(now.getUTCMonth() + 1).padStart(2, '0');

    const basePrefix = [division, purpose, yyyy, mm, folder ? folder : null]
      .filter(Boolean)
      .join('/');

    const items = [];
    const errors = [];

    // 3) Process each file independently
    for (const f of files) {
      const clientName = f?.name || `upload-${nanoid(8)}`;
      const originalName = clientName; // for messages
      try {
        if (!f?.data) throw new Error('Missing base64 data');

        // base64 -> Buffer
        let buffer;
        try { buffer = Buffer.from(f.data, 'base64'); }
        catch { throw new Error('Invalid base64'); }

        // extension from (possibly unsanitized) input name
        const ext = (clientName.split('.').pop() || 'bin').toLowerCase();

        // choose file_type/contentType
        const fileType = logicalTypeFromClientOrExt(f?.fileType, ext);
        const contentType = f?.contentType || guessContentType(ext);

        // SERVER-SIDE SANITIZATION: never use raw clientName in key
        const safeName = sanitizeFilename(clientName);

        const storagePath = `${basePrefix}/${nanoid(6)}-${safeName}`;

        // 3a) upload to Supabase Storage (bucket: assets)
        const { error: upErr } = await supabaseAdmin.storage
          .from('assets')
          .upload(storagePath, buffer, {
            contentType,
            upsert: false,
          });

        if (upErr) {
          // propagate clean message (this is where "Invalid key" came from before)
          throw new Error(`Storage upload failed: ${upErr.message || 'unknown'}`);
        }

        // 3b) public URL
        const { data: pub } = await supabaseAdmin.storage
          .from('assets')
          .getPublicUrl(storagePath);
        const file_url = pub?.publicUrl;
        if (!file_url) throw new Error('Failed to generate public URL');

        // 3c) insert public.assets row
        const insertPayload = {
          file_url,
          file_type: fileType, // 'image' | 'video' | 'audio' | 'pdf' | 'file'
          division,
          purpose,
          filename: safeName,  // store the cleaned filename
          metadata,
        };

        const { data: inserted, error: insertErr } = await supabaseAdmin
          .from('assets')
          .insert(insertPayload)
          .select('*')
          .single();

        if (insertErr) {
          throw new Error(`DB insert failed: ${insertErr.message}`);
        }

        items.push({
          id: inserted.id,
          file_url,
          filename: safeName,
          division,
          purpose,
        });
      } catch (err) {
        errors.push({ name: originalName, reason: String(err.message || err) });
      }
    }

    // 4) Respond
    return res.status(200).json({ ok: errors.length === 0, items, errors });
  } catch (fatal) {
    return res.status(200).json({
      ok: false,
      items: [],
      errors: [{ name: '(fatal)', reason: String(fatal?.message || fatal) }],
    });
  }
}


===== FILE: pages/api/admin/upload-asset.js  (size=9610 bytes) =====
// pages/api/admin/upload-asset.js
// Upload to Supabase Storage, insert into public.assets, and (optionally) upsert/link tags.
// Works with your existing supabaseAdmin helper (service role).
// Accepts file.data as either raw base64 *or* a data URL.
// Returns the inserted asset row, plus convenience fields.

import { supabaseAdmin } from '@/lib/supabaseAdmin';

export const config = { api: { bodyParser: { sizeLimit: '50mb' } } }; // allow big images/mp4

// ---------- helpers ----------
const clean = (s) =>
  String(s || '')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, '-')
    .replace(/[^a-z0-9._-]/g, '');

const normalizeTags = (input) => {
  if (!input) return [];
  if (Array.isArray(input)) return input.map(clean).filter(Boolean);
  if (typeof input === 'string') return input.split(',').map(clean).filter(Boolean);
  return [];
};

const guessMime = (name, fallbackType) => {
  const ext = (String(name || '').split('.').pop() || '').toLowerCase();
  if (['jpg', 'jpeg'].includes(ext)) return 'image/jpeg';
  if (ext === 'png') return 'image/png';
  if (ext === 'webp') return 'image/webp';
  if (ext === 'gif') return 'image/gif';
  if (ext === 'mp4') return 'video/mp4';
  if (ext === 'pdf') return 'application/pdf';
  // fall back to declared file_type if helpful
  if (fallbackType === 'image') return 'application/octet-stream'; // storage will still host
  if (fallbackType === 'video') return 'video/mp4';
  if (fallbackType === 'pdf') return 'application/pdf';
  return 'application/octet-stream';
};

const toBuffer = (maybeBase64) => {
  // Accept plain base64 or full data URL
  if (!maybeBase64) return null;
  const base64 =
    typeof maybeBase64 === 'string'
      ? (maybeBase64.includes('base64,') ? maybeBase64.split('base64,').pop() : maybeBase64)
      : '';
  try {
    return Buffer.from(base64, 'base64');
  } catch {
    return null;
  }
};

// ---------- SAFE column detector (no pg_catalog / information_schema) ----------
/**
 * We infer column names by selecting a single row from the table
 * and taking Object.keys(row). If the table is empty, we fall back
 * to an empty array. Result is cached per table for this lambda run.
 */
const columnsCache = {};
async function tableColumns(table) {
  if (columnsCache[table]) return columnsCache[table];

  try {
    const { data, error } = await supabaseAdmin.from(table).select('*').limit(1);
    if (error || !data || !data.length) {
      columnsCache[table] = [];
      return [];
    }
    const cols = Object.keys(data[0] || {});
    columnsCache[table] = cols;
    return cols;
  } catch (e) {
    console.warn(`[tableColumns] Failed to inspect table "${table}":`, e?.message || e);
    columnsCache[table] = [];
    return [];
  }
}

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  try {
    // ---------- 1) Auth: Bearer token + admin role ----------
    const auth = req.headers.authorization || '';
    const token = auth.startsWith('Bearer ') ? auth.slice(7) : null;
    if (!token) return res.status(401).json({ error: 'Unauthorized (missing token)' });

    const { data: userResult, error: userErr } = await supabaseAdmin.auth.getUser(token);
    if (userErr || !userResult?.user?.id) {
      return res.status(401).json({ error: 'Unauthorized (invalid token)' });
    }
    const userId = userResult.user.id;

    const { data: roleRow, error: roleErr } = await supabaseAdmin
      .from('users')
      .select('role')
      .eq('id', userId)
      .maybeSingle();
    if (roleErr || roleRow?.role !== 'admin') {
      return res.status(403).json({ error: 'Forbidden' });
    }

    // ---------- 2) Parse inputs ----------
    const { file, file_type, division, purpose, metadata, tags } = req.body || {};
    if (!file?.data || !file?.name) {
      return res.status(400).json({ error: 'Missing file {data,name}' });
    }
    if (!file_type || !division || !purpose) {
      return res.status(400).json({ error: 'Missing file_type/division/purpose' });
    }

    const tagSlugs = normalizeTags(tags);
    const now = new Date().toISOString().replace(/[:.]/g, '-');
    const storage_key = `${clean(division)}/${clean(purpose)}/${now}-${clean(file.name)}`;
    const contentType = guessMime(file.name, file_type);

    // ---------- 3) Upload to Storage (handle duplicate path safely) ----------
    const bin = toBuffer(file.data);
    if (!bin) {
      return res.status(400).json({ error: 'Invalid base64 payload' });
    }

    let finalKey = storage_key;
    let upErr = null;

    const doUpload = async (key) => {
      const { error } = await supabaseAdmin.storage
        .from('assets')
        .upload(key, bin, { contentType, upsert: false });
      return error;
    };

    upErr = await doUpload(finalKey);
    if (upErr && String(upErr.message || '').toLowerCase().includes('duplicate')) {
      finalKey = `${clean(division)}/${clean(purpose)}/${now}-${Date.now()}-${clean(file.name)}`;
      upErr = await doUpload(finalKey);
    }
    if (upErr) {
      console.error('[upload error]', upErr);
      return res
        .status(500)
        .json({ error: `Storage upload failed: ${upErr.message || 'unknown'}` });
    }

    const { data: pub } = await supabaseAdmin.storage.from('assets').getPublicUrl(finalKey);
    const file_url = pub?.publicUrl;
    if (!file_url) {
      return res.status(500).json({ error: 'Failed to compute public URL' });
    }

    // ---------- 4) Normalize metadata ----------
    let meta = {};
    if (metadata) {
      if (typeof metadata === 'string') {
        try {
          meta = JSON.parse(metadata);
        } catch {
          meta = { raw: metadata };
        }
      } else if (typeof metadata === 'object') {
        meta = metadata;
      }
    }

    // ---------- 5) Insert into public.assets (supports assets.tags if present) ----------
    const cols = await tableColumns('assets').catch(() => []);
    const hasTagsColumn = cols.includes('tags'); // text[]
    const hasFilename = cols.includes('filename');
    const hasStorageKey = cols.includes('storage_key');
    const hasUploadedBy = cols.includes('uploaded_by');

    const insertPayload = {
      file_url,
      file_type,
      division,
      purpose,
      metadata: {
        ...meta,
        // ensure tags are always mirrored inside metadata
        tags: Array.isArray(meta?.tags) && meta.tags.length ? meta.tags : tagSlugs,
      },
    };

    if (hasTagsColumn) insertPayload.tags = tagSlugs;
    if (hasFilename) insertPayload.filename = String(file.name);
    if (hasStorageKey) insertPayload.storage_key = finalKey;
    if (hasUploadedBy) insertPayload.uploaded_by = userId;

    let inserted = null;
    {
      const { data, error } = await supabaseAdmin
        .from('assets')
        .insert(insertPayload)
        .select('*')
        .single();
      if (error) {
        console.error('[insert assets error]', error);
        return res.status(500).json({ error: `DB insert failed: ${error.message}` });
      }
      inserted = data;
    }

    // ---------- 6) Optional tags upsert & linking (assets_tags) ----------
    // If you created public.tags + public.assets_tags, we populate them; otherwise we silently skip.
    try {
      if (tagSlugs.length) {
        // upsert tags
        const upsertRows = tagSlugs.map((slug) => ({
          slug,
          label: slug.replace(/-/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase()),
          kind: 'asset',
        }));
        const { data: tagRows } = await supabaseAdmin
          .from('tags')
          .upsert(upsertRows, { onConflict: 'slug' })
          .select('id, slug');

        if (Array.isArray(tagRows) && tagRows.length) {
          const linkRows = tagRows.map((t) => ({ asset_id: inserted.id, tag_id: t.id }));
          await supabaseAdmin.from('assets_tags').insert(linkRows);
        }
      }
    } catch (e) {
      // tables might not exist; ignore silently
      console.warn('[tags upsert/link skipped]', e?.message || e);
    }

    // ---------- 7) Optional site_config hooks ----------
    try {
      if (['hero', 'logo', 'favicon'].includes(purpose)) {
        await supabaseAdmin
          .from('site_config')
          .upsert(
            { key: purpose, value: { asset_id: inserted.id, file_url } },
            { onConflict: 'key' }
          );
      } else if (purpose === 'carousel') {
        const { data: existing } = await supabaseAdmin
          .from('site_config')
          .select('value')
          .eq('key', 'carousel_images')
          .maybeSingle();
        const arr = Array.isArray(existing?.value) ? existing.value : [];
        const updated = [...arr, file_url].slice(-5);
        await supabaseAdmin
          .from('site_config')
          .upsert({ key: 'carousel_images', value: updated }, { onConflict: 'key' });
      }
    } catch (e) {
      console.warn('[site_config hook skipped]', e?.message || e);
    }

    // ---------- 8) Done ----------
    return res.status(200).json({
      ...inserted,
      file_url,
      storage_key: finalKey,
      tags: tagSlugs,
    });
  } catch (error) {
    console.error('Asset upload fatal:', error);
    return res
      .status(500)
      .json({ error: error?.message || 'Failed to upload asset' });
  }
}


===== FILE: pages/api/capital/subscriptions-admin.js  (size=1980 bytes) =====
// pages/api/capital/subscriptions-admin.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

/**
 * Returns:
 * {
 *   ok: true,
 *   mrr: 123.45,
 *   subs: [
 *     {
 *       id,
 *       telegram_id,
 *       plan_type,
 *       status,
 *       current_period_end,
 *       current_period_start,
 *       amount_usd
 *     },
 *     ...
 *   ]
 * }
 *
 * Notes:
 * - We assume "Basic Signals" is $29.99/mo.
 * - You can change this mapping later if you add tiers.
 */
export default async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    // Pull subscriptions we consider ‚Äúactive/paid‚Äù
    const { data, error } = await supabaseAdmin
      .from('subscriptions')
      .select('*')
      .in('status', ['active', 'paid', 'trialing']);

    if (error) {
      console.error('subscriptions-admin error:', error.message);
      return res.status(500).json({ error: error.message });
    }

    const PRICE_MAP = {
      'Basic Signals': 29.99,
    };

    // normalize and compute MRR
    let totalMRR = 0;
    const subs = (data || []).map((row) => {
      const amt = PRICE_MAP[row.plan_type] || 0;
      if (row.status === 'active' || row.status === 'paid' || row.status === 'trialing') {
        totalMRR += amt;
      }
      return {
        id: row.id,
        telegram_id: row.telegram_id,
        plan_type: row.plan_type,
        status: row.status,
        current_period_start: row.current_period_start,
        current_period_end: row.current_period_end,
        amount_usd: amt,
      };
    });

    return res.status(200).json({
      ok: true,
      mrr: Number(totalMRR.toFixed(2)),
      subs,
    });
  } catch (e) {
    console.error('subscriptions-admin crash:', e);
    return res.status(500).json({
      ok: false,
      error: e.message || 'internal error',
    });
  }
}


===== FILE: pages/api/checkout/create-session.js  (size=6043 bytes) =====
// pages/api/checkout/create-session.js
import Stripe from 'stripe';
import { supabaseAdmin } from '@/lib/supabaseAdmin';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: '2024-06-20' });

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  try {
    const {
      // Shared
      success_url,
      cancel_url,

      // SUBSCRIPTION path
      mode,                 // 'subscription' => create subscription checkout
      price_id,             // optional override; falls back to env
      email,                // optional prefill for subscription
      telegramId,           // from Signals form

      // ONE-TIME path
      product_id,           // required for one-time purchase
      quantity = 1,
      user_id = null,

      // üî• NEW: track who referred this customer
      affiliate_code = null,
    } = req.body || {};

    const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000';

    // -------------------------
    // 1) SUBSCRIPTION CHECKOUT
    // -------------------------
    if (mode === 'subscription') {
      const activePrice = price_id || process.env.NEXT_PUBLIC_STRIPE_PRICE_ID;
      if (!activePrice) {
        return res.status(400).json({
          error: 'Missing price_id. Set NEXT_PUBLIC_STRIPE_PRICE_ID or pass price_id in body.',
        });
      }

      const session = await stripe.checkout.sessions.create({
        mode: 'subscription',
        line_items: [{ price: activePrice, quantity: 1 }],
        allow_promotion_codes: true,
        customer_email: email || undefined,
        success_url:
          success_url ||
          `${baseUrl}/checkout/success?session_id={CHECKOUT_SESSION_ID}`,
        cancel_url:
          cancel_url ||
          `${baseUrl}/checkout/cancelled`,
        customer_creation: 'always', // ensures we have a Customer to store metadata on

        // put telegramId everywhere we might read it later
        metadata: {
          telegramId: telegramId ? String(telegramId) : '',
          plan: 'Basic Signals',
          division: 'capital',
          affiliate_code: affiliate_code || '',    // NEW
        },
        subscription_data: {
          metadata: {
            telegramId: telegramId ? String(telegramId) : '',
            plan: 'Basic Signals',
            division: 'capital',
            affiliate_code: affiliate_code || '',  // NEW
          },
        },
      });

      return res.status(200).json({
        ok: true,
        id: session.id,
        url: session.url,
      });
    }

    // --------------------------------
    // 2) ONE-TIME (PRODUCT) CHECKOUT
    // --------------------------------
    if (!product_id) {
      return res.status(400).json({
        error:
          'product_id is required for one-time checkout (or set mode: "subscription")',
      });
    }

    const qty = Math.max(1, parseInt(quantity, 10) || 1);

    // Load product from Supabase
    const { data: product, error: pErr } = await supabaseAdmin
      .from('products')
      .select('*')
      .eq('id', product_id)
      .maybeSingle();

    if (pErr) throw pErr;
    if (!product) return res.status(404).json({ error: 'Product not found' });

    const meta = product.metadata || {};
    const stripePriceId = meta.stripe_price_id;
    if (!stripePriceId) {
      return res
        .status(400)
        .json({ error: 'Missing metadata.stripe_price_id on this product' });
    }

    // Decide if we must collect shipping (for merch/physical items)
    const needsShipping =
      !!meta.printful_sync_variant_id || meta.fulfill_with_printful === true;

    // build Checkout Session
    const session = await stripe.checkout.sessions.create({
      mode: 'payment',
      line_items: [{ price: stripePriceId, quantity: qty }],
      allow_promotion_codes: true,
      automatic_tax: { enabled: true },
      shipping_address_collection: needsShipping
        ? {
            allowed_countries: [
              'US',
              'CA',
              'GB',
              'AU',
              'NZ',
              'DE',
              'FR',
              'ES',
              'IT',
              'NL',
              'SE',
            ],
          }
        : undefined,
      phone_number_collection: needsShipping
        ? { enabled: true }
        : undefined,
      success_url:
        success_url ||
        `${baseUrl}/checkout/success?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url:
        cancel_url ||
        `${baseUrl}/checkout/cancelled`,
      metadata: {
        product_id: String(product.id),
        division: String(product.division || 'site'),
        quantity: String(qty),
        product_name: String(product.name || ''),
        affiliate_code: affiliate_code || '',   // üî• NEW
      },
    });

    // Record a pending order for your webhook to finalize
    const estimatedTotal = Number(product.price || 0) * qty;

    await supabaseAdmin.from('orders').insert({
      user_id,
      product_id: product.id,
      division: product.division || 'site',
      status: 'pending',
      quantity: qty,
      total_amount: estimatedTotal,
      stripe_session_id: session.id,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
      affiliate_code: affiliate_code || null, // üî• store ref so admin can see who drove it
      product_snapshot: {
        name: product.name,
        price: product.price,
        thumbnail_url: product.thumbnail_url || null,
        metadata: meta || {},
      },
    });

    return res.status(200).json({
      ok: true,
      id: session.id,
      url: session.url,
    });
  } catch (err) {
    console.error('create-session error:', err);
    return res.status(500).json({ error: err.message || 'Internal error' });
  }
}


===== FILE: pages/api/events.js  (size=1339 bytes) =====
// pages/api/events.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

/**
 * Public events feed.
 *
 * Accepts optional query params:
 *   ?division=tech      -> only show events for that division
 *   ?upcoming=1         -> only future events (start_date >= now)
 *
 * Returns: [{ id, title, description, start_date, end_date, division }]
 */
export default async function handler(req, res) {
  try {
    const { division, upcoming } = req.query || {};

    let query = supabaseAdmin
      .from('events')
      .select(
        'id,title,description,start_date,end_date,division,metadata'
      )
      .order('start_date', { ascending: true });

    // filter by division if provided
    if (division) {
      query = query.eq('division', division);
    }

    const { data, error } = await query;
    if (error) throw error;

    // upcoming filter (client can pass upcoming=1)
    let list = data || [];
    if (upcoming) {
      const now = Date.now();
      list = list.filter((ev) => {
        if (!ev.start_date) return false;
        const startTs = new Date(ev.start_date).getTime();
        return startTs >= now;
      });
    }

    return res.status(200).json(list);
  } catch (e) {
    console.error('events api error:', e);
    return res.status(200).json([]);
  }
}


===== FILE: pages/api/order-details.js  (size=724 bytes) =====
// pages/api/order-details.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  const { session_id } = req.query;

  if (!session_id) {
    return res.status(400).json({ error: 'Missing session_id' });
  }

  try {
    const { data, error } = await supabaseAdmin.from('orders').select('*').eq('stripe_session_id', session_id).single();
    if (error) throw error;
    if (!data) return res.status(404).json({ error: 'Order not found' });
    res.status(200).json({ ...data, type: data.type || 'general' });
  } catch (error) {
    console.error('Supabase error:', error);
    res.status(500).json({ error: 'Failed to fetch order details' });
  }
}


===== FILE: pages/api/posts.js  (size=3166 bytes) =====
// pages/api/posts.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

/**
 * GET /api/posts
 *
 * Query params:
 *   ?division=tech            -> filter by division
 *   ?slug=daito-app           -> filter by slug (requires division OR will search all divisions)
 *
 * Shapes returned:
 *
 * 1) List mode (no slug):
 *    {
 *      ok: true,
 *      items: [
 *        { id, title, slug, excerpt, created_at, featured_image, content, status, division, metadata }
 *      ],
 *      total: 3
 *    }
 *
 * 2) Detail mode (has slug):
 *    {
 *      ok: true,
 *      post: { id, title, slug, ... }
 *    }
 *
 * Errors:
 *    { ok:false, error:"message" }
 *
 * NOTE:
 * We always .eq('status','published') so drafts won't leak.
 */

export default async function handler(req, res) {
  if (req.method !== 'GET') {
    return res
      .status(405)
      .json({ ok: false, error: 'Method not allowed' });
  }

  try {
    const { division, slug } = req.query || {};

    // --- DETAIL MODE: division + slug (or just slug) -----------------
    // If we have a slug, we're trying to fetch a single post.
    if (slug) {
      // Build the query
      let q = supabaseAdmin
        .from('posts')
        .select(
          'id,title,slug,excerpt,created_at,featured_image,content,status,division,metadata'
        )
        .eq('status', 'published')
        .eq('slug', slug)
        .limit(1);

      // If division was provided, add that filter too
      if (division) {
        q = q.eq('division', division);
      }

      const { data, error } = await q;
      if (error) {
        console.error('posts detail fetch error:', error);
        return res
          .status(200)
          .json({ ok: false, error: error.message || 'query failed' });
      }

      const post = Array.isArray(data) && data.length > 0 ? data[0] : null;

      if (!post) {
        return res
          .status(200)
          .json({ ok: false, error: 'not found' });
      }

      return res.status(200).json({ ok: true, post });
    }

    // --- LIST MODE: no slug, maybe division --------------------------
    // Build base query for list
    let listQuery = supabaseAdmin
      .from('posts')
      .select(
        'id,title,slug,excerpt,created_at,featured_image,content,status,division,metadata'
      )
      .eq('status', 'published')
      .order('created_at', { ascending: false });

    if (division) {
      listQuery = listQuery.eq('division', division);
    }

    const { data: rows, error: listErr } = await listQuery;
    if (listErr) {
      console.error('posts list fetch error:', listErr);
      return res
        .status(200)
        .json({ ok: false, error: listErr.message || 'query failed', items: [], total: 0 });
    }

    return res.status(200).json({
      ok: true,
      items: rows || [],
      total: rows ? rows.length : 0,
    });
  } catch (e) {
    console.error('posts handler crash:', e);
    return res
      .status(200)
      .json({ ok: false, error: e.message || 'internal error', items: [], total: 0 });
  }
}


===== FILE: pages/api/posts/[slug].js  (size=713 bytes) =====
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  const { slug } = req.query;
  if (!slug) return res.status(400).json({ error: 'Missing slug' });
  try {
    const { data, error } = await supabaseAdmin
      .from('posts')
      .select('id,title,slug,excerpt,created_at,featured_image,content,status')
      .eq('slug', slug)
      .eq('status', 'published')
      .maybeSingle();
    if (error) throw error;
    if (!data) return res.status(404).json({ error: 'Not found' });
    res.status(200).json(data);
  } catch (e) {
    console.error('post fetch error:', e);
    res.status(500).json({ error: 'Failed to fetch post' });
  }
}


===== FILE: pages/api/products.js  (size=6010 bytes) =====
// pages/api/products.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

function coerceMetadata(meta) {
  if (!meta) return {};
  if (typeof meta === 'object') return meta;
  if (typeof meta === 'string') {
    try {
      return JSON.parse(meta);
    } catch {
      return {};
    }
  }
  return {};
}

function coerceTags(tags) {
  if (!tags) return [];
  if (Array.isArray(tags)) return tags;
  if (typeof tags === 'string') {
    // try JSON first
    try {
      const parsed = JSON.parse(tags);
      if (Array.isArray(parsed)) return parsed.map(String);
    } catch {
      // CSV fallback
      return tags
        .split(',')
        .map(t => t.trim())
        .filter(Boolean);
    }
  }
  return [];
}

export default async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const {
    division = '',
    collection = '', // maps to metadata fields like book/series/drop/year/prompt
    tag = '',        // matches any item in products.tags text[]
    q = '',          // search in name/description/metadata.scene/book
    sort = 'new',    // 'new' | 'price_asc' | 'price_desc'
    limit = '16',
    offset = '0',
  } = req.query;

  try {
    // IMPORTANT: include nft_url in the selection!
    let query = supabaseAdmin
      .from('products')
      .select(
        `
        id, name, description, price, division, status,
        image_url, thumbnail_url, printful_product_id,
        metadata, tags, nft_url,
        created_at
      `,
        { count: 'exact' }
      )
      .eq('status', 'active');

    if (division) query = query.eq('division', division);

    if (q) {
      // Search across name, description, and metadata fields
      query = query.or(
        [
          `name.ilike.%${q}%`,
          `description.ilike.%${q}%`,
          `metadata->>scene.ilike.%${q}%`,
          `metadata->>book.ilike.%${q}%`,
        ].join(',')
      );
    }

    if (tag) {
      // products.tags is text[]; Supabase contains() works with arrays
      query = query.contains('tags', [tag]);
    }

    if (collection) {
      // support "prompt-1" or "2025" or direct book/series/drop strings
      if (/^prompt-\d+$/i.test(collection)) {
        const p = collection.split('-')[1];
        query = query.eq('metadata->>prompt', String(Number(p)));
      } else if (/^\d{4}$/.test(collection)) {
        query = query.eq('metadata->>year', collection);
      } else {
        // try book or series or drop match
        query = query.or(
          [
            `metadata->>book.eq.${collection}`,
            `metadata->>series.eq.${collection}`,
            `metadata->>drop.eq.${collection}`,
          ].join(',')
        );
      }
    }

    if (sort === 'price_asc') {
      query = query.order('price', { ascending: true, nullsFirst: true });
    } else if (sort === 'price_desc') {
      query = query.order('price', { ascending: false, nullsFirst: false });
    } else {
      query = query.order('created_at', { ascending: false });
    }

    const lim = Math.max(1, Math.min(100, Number(limit) || 16));
    const off = Math.max(0, Number(offset) || 0);
    query = query.range(off, off + lim - 1);

    const { data, error, count } = await query;
    if (error) throw error;

    const items = (data || []).map((row) => {
      const metadata = coerceMetadata(row.metadata);
      const tags = coerceTags(row.tags);

      // Prefer top-level nft_url; then metadata.nft_url; support legacy nftUrl as well
      const nft_url =
        row.nft_url ||
        metadata.nft_url ||
        row.nftUrl ||
        metadata.nftUrl ||
        null;

      return {
        id: row.id,
        name: row.name,
        description: row.description || '',
        division: row.division,
        status: row.status,
        price: Number(row.price),
        image_url: row.image_url || '',
        thumbnail_url: row.thumbnail_url || '',
        display_image: row.thumbnail_url || row.image_url || '',
        printful_product_id: row.printful_product_id || '',
        tags,
        metadata,
        // expose nft_url so Card can show the ribbon & button
        nft_url,
        // convenience fields that your UI already uses
        prompt: metadata?.prompt,
        book: metadata?.book,
        scene: metadata?.scene,
        productType:
          row.division === 'designs'
            ? 'merch'
            : row.division === 'publishing'
            ? 'book'
            : row.division === 'capital'
            ? 'download'
            : 'general',
        created_at: row.created_at,
      };
    });

    res.status(200).json({ items, total: count ?? items.length });
  } catch (error) {
    console.error('Supabase products error:', error);

    const fallback =
      division === 'designs'
        ? [
            {
              id: 'fallback-tee',
              name: 'Sample T-Shirt',
              price: 29.99,
              display_image:
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/mock-tee-1.webp',
              thumbnail_url:
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/mock-tee-1.webp',
              image_url:
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/mock-tee-1.webp',
              division: 'designs',
              description: 'Fallback design merchandise',
              printful_product_id: 'fallback-tee-id',
              productType: 'merch',
              metadata: { prompt: 1, book: 'Sample', scene: 'Portal' },
              tags: ['sample', 'tee'],
              nft_url: null,
            },
          ]
        : [];

    res.status(200).json({ items: fallback, total: fallback.length });
  }
}


===== FILE: pages/api/realty/[slug].js  (size=5759 bytes) =====
// pages/realty/[slug].js
import Head from 'next/head';
import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';
import { Calendar, dateFnsLocalizer } from 'react-big-calendar';
import { format, parse, startOfWeek, getDay } from 'date-fns';
import enUS from 'date-fns/locale/en-US';
import 'react-big-calendar/lib/css/react-big-calendar.css';

const localizer = dateFnsLocalizer({
  format,
  parse,
  startOfWeek,
  getDay,
  locales: { 'en-US': enUS }
});

export default function PropertyDetail() {
  const router = useRouter();
  const { slug } = router.query;
  const [property, setProperty] = useState(null);
  const [availability, setAvailability] = useState([]);
  const [checkin, setCheckin] = useState('');
  const [checkout, setCheckout] = useState('');
  const [guests, setGuests] = useState(1);
  const [quote, setQuote] = useState(null);
  const [guestName, setGuestName] = useState('');
  const [guestEmail, setGuestEmail] = useState('');
  const [guestPhone, setGuestPhone] = useState('');
  const [notes, setNotes] = useState('');
  const [loading, setLoading] = useState(true);
  const [busy, setBusy] = useState(false);

  useEffect(() => {
    if (slug) {
      fetch(`/api/realty/property?slug=${slug}`)
        .then(res => res.json())
        .then(data => {
          setProperty(data.property);
          setAvailability(data.availability || []);
          setLoading(false);
        })
        .catch(() => setLoading(false));
    }
  }, [slug]);

  const getQuote = async () => {
    if (!checkin || !checkout) return alert('Select dates');
    setBusy(true);
    try {
      const res = await fetch('/api/realty/quote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ property_id: property.id, checkin, checkout }),
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error);
      setQuote(data);
    } catch (e) {
      alert(e.message);
    } finally {
      setBusy(false);
    }
  };

  const book = async () => {
    if (!quote) return alert('Get a quote first');
    if (!guestName || !guestEmail) return alert('Enter guest details');
    setBusy(true);
    try {
      const res = await fetch('/api/realty/create-checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          property_id: property.id,
          checkin,
          checkout,
          guests,
          guest_name: guestName,
          guest_email: guestEmail,
          guest_phone: guestPhone,
          notes,
        }),
      });
      const data = await res.json();
      if (data.url) window.location.href = data.url;
      else alert('Failed to book');
    } catch (e) {
      alert(e.message);
    } finally {
      setBusy(false);
    }
  };

  const events = availability.map(a => ({
    title: a.status,
    start: new Date(a.date),
    end: new Date(a.date),
    allDay: true,
  }));

  if (loading) return <div>Loading property...</div>;
  if (!property) return <div>Property not found</div>;

  return (
    <>
      <Head>
        <title>{property.name} ‚Äî Manyagi Realty</title>
        <meta name="description" content={property.description} />
      </Head>
      <section className="container mx-auto px-4 py-16">
        <h1 className="text-4xl font-bold mb-4">{property.name}</h1>
        <img src={property.image_url} alt={property.name} className="w-full h-64 object-cover rounded mb-6" />
        <p className="mb-4">{property.description}</p>
        <p><strong>Price per night:</strong> ${property.nightly_price}</p>

        {/* NEW: Google Map embed if location */}
        {property.metadata?.location && (
          <div className="mt-6">
            <h2 className="text-2xl font-bold mb-2">Location</h2>
            <iframe
              src={`https://maps.google.com/maps?q=${encodeURI(property.metadata.location)}&output=embed`}
              width="100%"
              height="450"
              style={{ border: 0 }}
              allowFullScreen=""
              loading="lazy"
              referrerPolicy="no-referrer-when-downgrade"
            ></iframe>
          </div>
        )}

        <h2 className="text-2xl font-bold mt-8">Availability</h2>
        <Calendar
          localizer={localizer}
          events={events}
          startAccessor="start"
          endAccessor="end"
          style={{ height: 500 }}
        />

        <h2 className="text-2xl font-bold mt-8">Book Now</h2>
        <div className="space-y-4">
          <input type="date" value={checkin} onChange={e => setCheckin(e.target.value)} />
          <input type="date" value={checkout} onChange={e => setCheckout(e.target.value)} />
          <input type="number" value={guests} onChange={e => setGuests(e.target.value)} min="1" />
          <button onClick={getQuote} disabled={busy}>Get Quote</button>
          {quote && (
            <div>
              <p>Total: ${quote.summary.total}</p>
              <input placeholder="Name" value={guestName} onChange={e => setGuestName(e.target.value)} />
              <input placeholder="Email" value={guestEmail} onChange={e => setGuestEmail(e.target.value)} />
              <input placeholder="Phone" value={guestPhone} onChange={e => setGuestPhone(e.target.value)} />
              <textarea placeholder="Notes" value={notes} onChange={e => setNotes(e.target.value)} />
              <button onClick={book} disabled={busy}>Book Now</button>
            </div>
          )}
        </div>
      </section>
    </>
  );
}


===== FILE: pages/api/realty/availability.js  (size=640 bytes) =====
// pages/api/realty/availability.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  if (req.method !== 'GET') return res.status(405).json({ error: 'Method not allowed' });
  const { property_id } = req.query;
  if (!property_id) return res.status(400).json({ error: 'property_id required' });

  const { data, error } = await supabaseAdmin
    .from('property_availability')
    .select('*')
    .eq('property_id', property_id)
    .order('date');

  if (error) return res.status(500).json({ error: error.message });
  return res.status(200).json({ items: data });
}


===== FILE: pages/api/realty/book.js  (size=5569 bytes) =====
// pages/api/realty/book.js
import Stripe from 'stripe';
import { supabaseAdmin } from '@/lib/supabaseAdmin';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: '2024-06-20' });

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  try {
    const {
      property_id,
      checkin,        // 'YYYY-MM-DD'
      checkout,       // 'YYYY-MM-DD' (exclusive)
      guests = 1,
      quote_total_cents,
      currency = 'usd',

      // guest details
      guestName,
      guestEmail,
      guestPhone,
      notes,

      includeDamageDeposit = false,
      success_url,
      cancel_url,

      // üî• NEW
      affiliate_ref,
    } = req.body || {};

    if (!property_id || !checkin || !checkout || !quote_total_cents) {
      return res.status(400).json({ error: 'Missing required fields' });
    }

    // helper to resolve affiliate
    async function getAffiliateInfo(refCode) {
      if (!refCode) return { affiliate_id: null, referral_code: null, commission_rate: null };
      const { data: affRow, error: affErr } = await supabaseAdmin
        .from('affiliates')
        .select('id, referral_code, commission_rate')
        .eq('referral_code', refCode)
        .maybeSingle();
      if (affErr || !affRow) {
        return { affiliate_id: null, referral_code: null, commission_rate: null };
      }
      return {
        affiliate_id: affRow.id,
        referral_code: affRow.referral_code,
        commission_rate: Number(affRow.commission_rate || 0),
      };
    }

    // Load property for deposit & name
    const { data: prop } = await supabaseAdmin
      .from('properties')
      .select('id, name, metadata')
      .eq('id', property_id)
      .maybeSingle();
    if (!prop) return res.status(404).json({ error: 'Property not found' });

    const meta = prop.metadata || {};
    const depositCents = includeDamageDeposit ? Number(meta.damage_deposit_cents || 0) : 0;

    // nights
    const nights = Math.max(
      1,
      Math.round(
        (new Date(checkout).getTime() - new Date(checkin).getTime()) / (1000 * 60 * 60 * 24)
      )
    );

    // figure affiliate commission (you can tweak calc: e.g. only on rent, not on deposit)
    const affInfo = await getAffiliateInfo(affiliate_ref);
    const subtotalCents = Number(quote_total_cents) + Number(depositCents || 0);
    // commission stored in dollars just like orders.commission_amount
    const commissionAmount =
      affInfo.commission_rate != null
        ? (subtotalCents / 100) * affInfo.commission_rate
        : 0;

    // Stripe line items
    const line_items = [
      {
        price_data: {
          currency,
          unit_amount: Number(quote_total_cents),
          product_data: {
            name: `${prop.name} ‚Äî ${checkin} ‚Üí ${checkout} (${nights} nights)`,
            metadata: { division: 'realty', property_id },
          },
        },
        quantity: 1,
      },
    ];

    if (depositCents > 0) {
      line_items.push({
        price_data: {
          currency,
          unit_amount: depositCents,
          product_data: {
            name: 'Damage Deposit (refundable)',
            metadata: { division: 'realty', property_id, type: 'deposit' },
          },
        },
        quantity: 1,
      });
    }

    const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000';
    const session = await stripe.checkout.sessions.create({
      mode: 'payment',
      line_items,
      customer_email: guestEmail || undefined,
      success_url: success_url || `${baseUrl}/realty/booking-success?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: cancel_url || `${baseUrl}/realty/booking-cancelled`,
      metadata: {
        type: 'realty_booking',
        property_id,
        checkin,
        checkout,
        guests: String(guests),
        nights: String(nights),
        guestName: guestName || '',
        guestEmail: guestEmail || '',
        guestPhone: guestPhone || '',
        notes: notes || '',
        includeDamageDeposit: includeDamageDeposit ? 'true' : 'false',

        // affiliate trail for webhook visibility
        affiliate_ref: affInfo.referral_code || '',
        affiliate_id: affInfo.affiliate_id || '',
        commission_rate: affInfo.commission_rate != null ? String(affInfo.commission_rate) : '',
      },
    });

    // Create or update pending reservation row keyed by session id
    await supabaseAdmin.from('realty_reservations').upsert(
      {
        property_id,
        checkin,
        checkout,
        nights,
        guests,
        status: 'pending',
        amount_cents: subtotalCents,
        currency,
        stripe_session_id: session.id,
        guest_name: guestName || null,
        guest_email: guestEmail || null,
        guest_phone: guestPhone || null,
        notes: notes || null,

        // üî• NEW affiliate tracking columns in DB
        affiliate_id: affInfo.affiliate_id,
        referral_code: affInfo.referral_code,
        commission_rate: affInfo.commission_rate,
        commission_amount: commissionAmount,
      },
      { onConflict: 'stripe_session_id' }
    );

    return res.status(200).json({ ok: true, url: session.url, session_id: session.id });
  } catch (e) {
    console.error('book error', e);
    return res.status(500).json({ error: e.message });
  }
}


===== FILE: pages/api/realty/booking-success.js  (size=1433 bytes) =====
// pages/realty/booking-success.js
import Head from 'next/head';
import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';

export default function BookingSuccess() {
  const router = useRouter();
  const { session_id } = router.query;
  const [summary, setSummary] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (session_id) {
      fetch(`/api/realty/booking-summary?session_id=${session_id}`)
        .then(res => res.json())
        .then(data => {
          setSummary(data);
          setLoading(false);
        })
        .catch(() => setLoading(false));
    }
  }, [session_id]);

  if (loading) return <div>Loading booking summary...</div>;

  return (
    <>
      <Head>
        <title>Booking Success ‚Äî Manyagi Realty</title>
      </Head>
      <section className="container mx-auto px-4 py-16 text-center">
        <h1 className="text-4xl font-bold mb-4">Booking Confirmed!</h1>
        {summary ? (
          <div>
            <p>Property: {summary.property}</p>
            <p>Check-in: {summary.checkin}</p>
            <p>Check-out: {summary.checkout}</p>
            <p>Guests: {summary.guests}</p>
            <p>Status: {summary.status}</p>
          </div>
        ) : (
          <p>Thank you for your booking. Check your email for details.</p>
        )}
      </section>
    </>
  );
}


===== FILE: pages/api/realty/booking-summary.js  (size=893 bytes) =====
// pages/api/realty/booking-summary.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  if (req.method !== 'GET') return res.status(405).json({ error: 'Method not allowed' });
  const { session_id } = req.query;
  if (!session_id) return res.status(400).json({ error: 'session_id required' });

  const { data: resv } = await supabaseAdmin.from('realty_reservations').select('*').eq('stripe_session_id', session_id).maybeSingle();
  if (!resv) return res.status(404).json({ error: 'Reservation not found' });

  const { data: prop } = await supabaseAdmin.from('properties').select('name').eq('id', resv.property_id).maybeSingle();

  return res.status(200).json({
    property: prop?.name || 'Unknown',
    checkin: resv.checkin,
    checkout: resv.checkout,
    guests: resv.guests,
    status: resv.status,
  });
}


===== FILE: pages/api/realty/calendar-blocks.js  (size=2737 bytes) =====
// pages/api/realty/calendar-blocks.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

/**
 * Returns merged "unavailable" ranges for a property.
 *
 * Output:
 * {
 *   ok: true,
 *   blocks: [
 *     {
 *       start: '2025-11-26', // YYYY-MM-DD inclusive
 *       end:   '2025-11-30', // YYYY-MM-DD inclusive
 *       label: 'Booked' | 'External Block',
 *       kind:  'reservation' | 'external'
 *     }
 *   ]
 * }
 *
 * NOTE:
 * - Reservations: checkout is exclusive in DB, so we subtract 1 day
 *   and report that as inclusive `end`.
 * - External blocks: already inclusive starts_on..ends_on.
 */

export default async function handler(req, res) {
  if (req.method !== 'GET')
    return res.status(405).json({ error: 'Method not allowed' });

  const { property_id } = req.query || {};
  if (!property_id) {
    return res.status(400).json({ error: 'property_id required' });
  }

  try {
    // --- paid reservations ---
    const { data: reservations, error: resErr } = await supabaseAdmin
      .from('realty_reservations')
      .select('checkin, checkout, status')
      .eq('property_id', property_id)
      .eq('status', 'paid');

    if (resErr) {
      console.error('calendar-blocks reservations err', resErr.message);
    }

    // --- external blocks (Airbnb/VRBO etc synced) ---
    const { data: blocks, error: blkErr } = await supabaseAdmin
      .from('realty_external_blocks')
      .select('starts_on, ends_on, source')
      .eq('property_id', property_id);

    if (blkErr) {
      console.error('calendar-blocks blocks err', blkErr.message);
    }

    const out = [];

    // Reservations:
    // DB has checkin (inclusive) -> checkout (exclusive).
    // We'll make `end` = checkout-1day so UI can highlight those nights.
    (reservations || []).forEach((r) => {
      const start = r.checkin; // 'YYYY-MM-DD'
      const checkoutDate = new Date(r.checkout + 'T00:00:00Z');
      checkoutDate.setUTCDate(checkoutDate.getUTCDate() - 1);
      const end_display = checkoutDate.toISOString().slice(0, 10);

      out.push({
        start,
        end: end_display,
        label: 'Booked',
        kind: 'reservation',
      });
    });

    // External blocks are already inclusive
    (blocks || []).forEach((b) => {
      out.push({
        start: b.starts_on,
        end: b.ends_on,
        label: 'External Block',
        kind: 'external',
      });
    });

    return res.status(200).json({ ok: true, blocks: out });
  } catch (e) {
    console.error('calendar-blocks crash', e);
    return res
      .status(500)
      .json({ ok: false, error: e.message || 'internal error', blocks: [] });
  }
}


===== FILE: pages/api/realty/cleanup-holds.js  (size=544 bytes) =====
// pages/api/realty/cleanup-holds.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  // Delete pending reservations older than 30 min
  const threshold = new Date(Date.now() - 30 * 60 * 1000).toISOString();
  const { error } = await supabaseAdmin
    .from('realty_reservations')
    .delete()
    .eq('status', 'pending')
    .lt('created_at', threshold);

  if (error) return res.status(500).json({ error: error.message });
  return res.status(200).json({ ok: true });
}


===== FILE: pages/api/realty/create-checkout.js  (size=4171 bytes) =====
// pages/api/realty/create-checkout.js
import Stripe from 'stripe';
import { supabaseAdmin } from '@/lib/supabaseAdmin';
import { calculateQuote } from './quote'; // reuse the logic, no internal fetch

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
  apiVersion: '2024-06-20',
});

export default async function handler(req, res) {
  try {
    if (req.method !== 'POST')
      return res.status(405).json({ error: 'Method not allowed' });

    const {
      property_id,
      checkin,
      checkout,
      guests = 1,
      guest_name,
      guest_email,
      guest_phone,
      notes,
    } = req.body || {};

    if (
      !property_id ||
      !checkin ||
      !checkout ||
      !guest_name ||
      !guest_email
    ) {
      return res
        .status(400)
        .json({ error: 'Missing required fields' });
    }

    // 1. Load property row
    const { data: propRow, error: propErr } = await supabaseAdmin
      .from('properties')
      .select('*')
      .eq('id', property_id)
      .maybeSingle();

    if (propErr)
      return res.status(500).json({ error: propErr.message });
    if (!propRow)
      return res.status(404).json({ error: 'property not found' });

    // 2. Load override rates for quote calculation
    const { data: rateRows, error: rateErr } = await supabaseAdmin
      .from('realty_rates')
      .select('*')
      .eq('property_id', property_id);

    if (rateErr)
      return res.status(500).json({ error: rateErr.message });

    // 3. Build quote on the server (NO fetch('/api/...'))
    const quote = calculateQuote({
      propRow,
      rates: rateRows || [],
      checkin,
      checkout,
    });

    if (!quote.ok) {
      return res
        .status(500)
        .json({ error: quote.error || 'Failed to build quote' });
    }

    const amountCents = Math.round(quote.summary.total * 100);
    const nightsCount = quote.summary.nights;

    // 4. Create "pending" reservation in Supabase
    const { data: reservation, error: resErr } = await supabaseAdmin
      .from('realty_reservations')
      .insert({
        property_id,
        checkin,
        checkout,
        nights: nightsCount,
        guests,
        guest_name,
        guest_email,
        guest_phone,
        notes,
        amount_cents: amountCents,
        currency: 'usd',
        status: 'pending',
      })
      .select('*')
      .maybeSingle();

    if (resErr)
      return res.status(500).json({ error: resErr.message });

    // 5. Create Stripe Checkout Session
    const successUrl = `${req.headers.origin}/realty/booking-success?session_id={CHECKOUT_SESSION_ID}`;
    // cancel should go back to the property detail, which is /realty/[slug]
    const cancelUrl = `${req.headers.origin}/realty/${propRow.slug}?cancelled=true`;

    const session = await stripe.checkout.sessions.create({
      mode: 'payment',
      line_items: [
        {
          price_data: {
            currency: 'usd',
            product_data: {
              name: `Booking: ${propRow.name}`,
              description: `Check-in ${checkin} ‚Üí Check-out ${checkout}`,
            },
            unit_amount: amountCents,
          },
          quantity: 1,
        },
      ],
      metadata: {
        type: 'realty_booking',
        reservation_id: reservation.id,
        property_id: property_id,
        checkin,
        checkout,
        guest_name,
        guest_email,
        guest_phone: guest_phone || '',
        notes: notes || '',
      },
      success_url: successUrl,
      cancel_url: cancelUrl,
    });

    // 6. Store Stripe session ID back on reservation
    await supabaseAdmin
      .from('realty_reservations')
      .update({ stripe_session_id: session.id })
      .eq('id', reservation.id);

    // 7. Send the Stripe hosted checkout URL back to frontend
    return res.status(200).json({ url: session.url });
  } catch (e) {
    console.error('create-checkout crash:', e);
    return res.status(500).json({
      error: e.message || 'checkout failed',
    });
  }
}


===== FILE: pages/api/realty/external-blocks.js  (size=1500 bytes) =====
// pages/api/realty/external-blocks.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  if (req.method === 'GET') {
    const { property_id } = req.query;
    if (!property_id) return res.status(400).json({ error: 'property_id required' });
    const { data, error } = await supabaseAdmin
      .from('realty_external_blocks')
      .select('*')
      .eq('property_id', property_id);
    if (error) return res.status(500).json({ error: error.message });
    return res.status(200).json({ items: data });
  }

  if (req.method === 'POST') {
    const { property_id, starts_on, ends_on, source, uid } = req.body || {};
    if (!property_id || !starts_on || !ends_on || !source) return res.status(400).json({ error: 'required fields missing' });
    const { error } = await supabaseAdmin.from('realty_external_blocks').insert({ property_id, starts_on, ends_on, source, uid });
    if (error) return res.status(500).json({ error: error.message });
    return res.status(200).json({ ok: true });
  }

  if (req.method === 'DELETE') {
    const { id } = req.query;
    if (!id) return res.status(400).json({ error: 'id required' });
    const { error } = await supabaseAdmin.from('realty_external_blocks').delete().eq('id', id);
    if (error) return res.status(500).json({ error: error.message });
    return res.status(200).json({ ok: true });
  }

  return res.status(405).json({ error: 'Method not allowed' });
}


===== FILE: pages/api/realty/ical-export.js  (size=3420 bytes) =====
// pages/api/realty/ical-export.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

const fmt = (d) => {
  const pad = (n) => String(n).padStart(2, '0');
  const y = d.getUTCFullYear();
  const m = pad(d.getUTCMonth() + 1);
  const day = pad(d.getUTCDate());
  const hh = pad(d.getUTCHours());
  const mm = pad(d.getUTCMinutes());
  const ss = pad(d.getUTCSeconds());
  return `${y}${m}${day}T${hh}${mm}${ss}Z`;
};

// Return VEVENT for a date range (all-day style, DTEND exclusive)
const vevent = ({ uid, start, end, summary }) => {
  const dtstamp = fmt(new Date());
  const dtstart = `${start.getUTCFullYear()}${String(start.getUTCMonth() + 1).padStart(2, '0')}${String(start.getUTCDate()).padStart(2, '0')}`;
  const dtend = `${end.getUTCFullYear()}${String(end.getUTCMonth() + 1).padStart(2, '0')}${String(end.getUTCDate()).padStart(2, '0')}`;
  return [
    'BEGIN:VEVENT',
    `UID:${uid}`,
    `DTSTAMP:${dtstamp}`,
    `DTSTART;VALUE=DATE:${dtstart}`,
    `DTEND;VALUE=DATE:${dtend}`,
    `SUMMARY:${summary || 'Reserved'}`,
    'TRANSP:OPAQUE',
    'END:VEVENT',
  ].join('\r\n');
};

export default async function handler(req, res) {
  try {
    const { property_id } = req.query || {};
    if (!property_id) {
      res.statusCode = 400;
      return res.end('Missing property_id');
    }

    // Property (for title)
    const { data: prop } = await supabaseAdmin
      .from('properties')
      .select('id,name')
      .eq('id', property_id)
      .maybeSingle();

    // Paid reservations
    const { data: paid } = await supabaseAdmin
      .from('realty_reservations')
      .select('id, checkin, checkout, status')
      .eq('property_id', property_id)
      .eq('status', 'paid');

    // External blocks
    const { data: blocks } = await supabaseAdmin
      .from('realty_external_blocks')
      .select('id, starts_on, ends_on, source')
      .eq('property_id', property_id);

    const events = [];

    (paid || []).forEach((r) => {
      const ci = new Date(r.checkin);
      const co = new Date(r.checkout); // checkout is exclusive
      events.push(
        vevent({
          uid: `${r.id}@manyagi`,
          start: ci,
          end: co,
          summary: `${prop?.name || 'Property'} ‚Äî Reserved`,
        })
      );
    });

    (blocks || []).forEach((b) => {
      const s = new Date(b.starts_on + 'T00:00:00Z');
      const e = new Date(b.ends_on + 'T00:00:00Z');
      // Make DTEND exclusive
      const eExclusive = new Date(e);
      eExclusive.setUTCDate(eExclusive.getUTCDate() + 1);
      events.push(
        vevent({
          uid: `${b.id}@manyagi-block`,
          start: s,
          end: eExclusive,
          summary: `${prop?.name || 'Property'} ‚Äî ${b.source || 'External Block'}`,
        })
      );
    });

    const ics = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      `PRODID:-//Manyagi Realty//Booking Calendar//EN`,
      `X-WR-CALNAME:${(prop?.name || 'Property') + ' ‚Äî Manyagi'}`,
      ...events,
      'END:VCALENDAR',
      '',
    ].join('\r\n');

    res.setHeader('Content-Type', 'text/calendar; charset=utf-8');
    res.setHeader('Content-Disposition', `attachment; filename="manyagi-${property_id}.ics"`);
    return res.status(200).send(ics);
  } catch (e) {
    return res.status(500).send('ICS error: ' + e.message);
  }
}


===== FILE: pages/api/realty/ical.js  (size=487 bytes) =====
// pages/api/realty/ical.js
export default async function handler(req, res) {
  try {
    const { url } = req.query;
    if (!url) return res.status(400).send('missing url');
    const r = await fetch(url);
    if (!r.ok) return res.status(502).send('ical fetch failed');
    const text = await r.text();
    res.setHeader('Content-Type', 'text/calendar; charset=utf-8');
    return res.status(200).send(text);
  } catch (e) {
    return res.status(500).send('error');
  }
}


===== FILE: pages/api/realty/lead.js  (size=1188 bytes) =====
// pages/api/realty/lead.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res
      .status(405)
      .json({ error: 'Method not allowed' });
  }

  try {
    const {
      name,
      email,
      phone,
      interest_type, // 'buy' | 'sell' | 'manage' | 'rental_inquiry' | 'other'
      notes,
      property_id,
    } = req.body || {};

    if (!name || !email || !interest_type) {
      return res
        .status(400)
        .json({ error: 'Missing required fields' });
    }

    const { error } = await supabaseAdmin
      .from('realty_leads')
      .insert({
        name,
        email,
        phone: phone || null,
        interest_type,
        notes: notes || null,
        property_id: property_id || null,
        status: 'new',
      });

    if (error) throw error;

    return res
      .status(200)
      .json({ ok: true, message: 'Lead captured.' });
  } catch (err) {
    console.error('lead capture error:', err);
    return res
      .status(500)
      .json({ error: err.message || 'Internal error' });
  }
}


===== FILE: pages/api/realty/property.js  (size=3256 bytes) =====
// pages/api/realty/property.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

function sendJSON(res, status, payload) {
  res.status(status).json(payload);
}

export default async function handler(req, res) {
  if (req.method !== 'GET') {
    return sendJSON(res, 405, { error: 'Method not allowed' });
  }

  const { slug, all } = req.query;

  try {
    //
    // LIST MODE: /api/realty/property?all=1
    //
    if (all) {
      const { data, error } = await supabaseAdmin
        .from('properties')
        .select('*')
        .eq('division', 'realty')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('properties list error', error);
        return sendJSON(res, 500, { error: error.message });
      }

      const properties = (data || []).map((p) => ({
        id: p.id,
        name: p.name,
        slug: p.slug,
        description: p.description || '',
        nightly_price: Number(p.price || 0),
        image_url:
          (p.metadata && p.metadata.cover_url) ||
          (p.metadata && p.metadata.hero_url) ||
          '',
        metadata: p.metadata || {},
        created_at: p.created_at,
      }));

      return sendJSON(res, 200, { ok: true, properties });
    }

    //
    // DETAIL MODE: /api/realty/property?slug=...
    //
    if (!slug) {
      return sendJSON(res, 400, { error: 'slug required' });
    }

    const { data: rows, error: propErr } = await supabaseAdmin
      .from('properties')
      .select('*')
      .eq('slug', slug)
      .limit(1);

    if (propErr) {
      console.error('property fetch error', propErr);
      return sendJSON(res, 500, { error: propErr.message });
    }

    const prop = rows && rows[0];
    if (!prop) {
      return sendJSON(res, 404, { error: 'Property not found' });
    }

    // pull gallery_urls array off metadata if present
    const gallery_urls = Array.isArray(prop.metadata?.gallery_urls)
      ? prop.metadata.gallery_urls
      : [];

    // normalize the property for frontend
    const property = {
      id: prop.id,
      name: prop.name,
      slug: prop.slug,
      description: prop.description || '',
      nightly_price: Number(prop.price || 0),
      image_url:
        (prop.metadata && prop.metadata.cover_url) ||
        (prop.metadata && prop.metadata.hero_url) ||
        '',
      metadata: prop.metadata || {},
      gallery_urls, // <-- NEW
    };

    // availability (optional table)
    let availability = [];
    try {
      const { data: availRows, error: aErr } = await supabaseAdmin
        .from('property_availability')
        .select('*')
        .eq('property_id', prop.id)
        .order('date');

      if (aErr) {
        console.warn('availability lookup error (non-fatal)', aErr.message);
      } else {
        availability = availRows || [];
      }
    } catch (innerErr) {
      console.warn('availability lookup threw (non-fatal)', innerErr);
    }

    return sendJSON(res, 200, { ok: true, property, availability });
  } catch (err) {
    console.error('unhandled property api error', err);
    return sendJSON(res, 500, { error: 'Server error' });
  }
}


===== FILE: pages/api/realty/quote.js  (size=5282 bytes) =====
// pages/api/realty/quote.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

// helper: iterate nights from checkin (inclusive) to checkout (exclusive)
function* dateRangeUTC(startISO, endISO) {
  const d = new Date(startISO + 'T00:00:00Z');
  const end = new Date(endISO + 'T00:00:00Z');
  for (; d < end; d.setUTCDate(d.getUTCDate() + 1)) {
    yield new Date(d);
  }
}

// helper: format YYYY-MM-DD in UTC
const ymd = (d) =>
  `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}-${String(
    d.getUTCDate()
  ).padStart(2, '0')}`;

/**
 * Build nightly pricing and enforce seasonal overrides.
 *
 * NEW: We now also calculate the min night requirement for the stay,
 * using the max() of any applicable min_nights for those dates.
 *
 * Returns { ok, nights[], summary{...}, min_nights_required, meets_min_stay, currency }
 */
export function calculateQuote({ propRow, rates, checkin, checkout }) {
  if (!propRow) {
    return { ok: false, error: 'missing property' };
  }

  const m = propRow.metadata || {};
  const pr = m.pricing || {};

  // base nightly, weekend override, fees/taxes
  const base =
    (typeof pr.base === 'number' ? pr.base : null) ?? Number(propRow.price || 0);
  const weekend = typeof pr.weekend === 'number' ? pr.weekend : null;
  const cleaningFee = Number(pr.cleaning_fee || 0);
  const taxRate = Number(pr.tax_rate || 0);

  // Track required min_nights across the stay
  // We'll take the max requirement across all nights in the quote.
  let requiredMinNights = 1; // default fallback
  const nights = [];

  for (const d of dateRangeUTC(checkin, checkout)) {
    const iso = ymd(d);

    // all override rows that cover this date
    const candidates = (rates || []).filter(
      (r) => iso >= r.start_date && iso <= r.end_date
    );

    // choose the top candidate by priority, then fallback to base
    candidates.sort((a, b) => (b.priority || 0) - (a.priority || 0));

    let nightly = candidates.length
      ? Number(candidates[0].nightly_rate)
      : base;

    // weekend logic if no seasonal override
    if (!candidates.length && weekend && [5, 6].includes(d.getUTCDay())) {
      nightly = weekend;
    }

    // ADDED:
    // pull min_nights from the chosen candidate and update requiredMinNights
    if (candidates.length) {
      const minN = candidates[0].min_nights
        ? Number(candidates[0].min_nights)
        : null;
      if (minN && minN > requiredMinNights) {
        requiredMinNights = minN;
      }
    }

    nights.push({ date: iso, nightly });
  }

  // money math
  const subtotal = nights.reduce((acc, n) => acc + Number(n.nightly), 0);
  const totalBeforeTax = subtotal + cleaningFee;
  const taxAmt =
    Math.round((totalBeforeTax * taxRate + Number.EPSILON) * 100) / 100;
  const total = totalBeforeTax + taxAmt;

  const stayLength = nights.length;

  // ADDED:
  // If no seasonal override enforced anything, we still might want a global min
  // For example, you might set metadata.pricing.min_nights = 2 in property.metadata.pricing
  const globalMinNights =
    typeof pr.min_nights === 'number' ? pr.min_nights : null;

  if (globalMinNights && globalMinNights > requiredMinNights) {
    requiredMinNights = globalMinNights;
  }

  // ADDED:
  const meetsMinStay = stayLength >= requiredMinNights;

  return {
    ok: true,
    currency: 'usd',
    nights,
    summary: {
      nights: stayLength,
      base_subtotal: subtotal,
      cleaning_fee: cleaningFee,
      tax_rate: taxRate,
      tax_amount: taxAmt,
      total,
    },
    // ADDED:
    min_nights_required: requiredMinNights,
    meets_min_stay: meetsMinStay,
  };
}

export default async function handler(req, res) {
  try {
    if (req.method !== 'POST')
      return res.status(405).json({ error: 'Method not allowed' });

    const { property_id, checkin, checkout } = req.body || {};

    if (!property_id || !checkin || !checkout) {
      return res.status(400).json({
        error:
          'property_id, checkin, checkout required (YYYY-MM-DD)',
      });
    }

    // Load property
    const { data: propRow, error: propErr } = await supabaseAdmin
      .from('properties')
      .select('*')
      .eq('id', property_id)
      .maybeSingle();

    if (propErr)
      return res.status(500).json({ error: propErr.message });
    if (!propRow)
      return res.status(404).json({ error: 'property not found' });

    // Load seasonal / override rates
    const { data: rateRows, error: rateErr } = await supabaseAdmin
      .from('realty_rates')
      .select('*')
      .eq('property_id', property_id);

    if (rateErr)
      return res.status(500).json({ error: rateErr.message });

    const quote = calculateQuote({
      propRow,
      rates: rateRows || [],
      checkin,
      checkout,
    });

    if (!quote.ok) {
      return res
        .status(500)
        .json({ error: quote.error || 'quote failed' });
    }

    return res.status(200).json(quote);
  } catch (e) {
    console.error('quote handler crash:', e);
    res
      .status(500)
      .json({ error: e.message || 'internal error' });
  }
}


===== FILE: pages/api/realty/rates.js  (size=2199 bytes) =====
// pages/api/realty/rates.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  try {
    // ---- GET ----
    if (req.method === 'GET') {
      const { property_id } = req.query;
      if (!property_id)
        return res.status(400).json({ error: 'property_id required' });

      const { data, error } = await supabaseAdmin
        .from('realty_rates')
        .select('*')
        .eq('property_id', property_id)
        .order('start_date', { ascending: true });

      if (error) throw error;
      return res.status(200).json({ ok: true, items: data || [] });
    }

    // ---- POST ----
    if (req.method === 'POST') {
      const body =
        typeof req.body === 'string' ? JSON.parse(req.body) : req.body;
      const {
        property_id,
        start_date,
        end_date,
        nightly_rate,
        min_nights,
        priority,
        notes,
      } = body || {};

      if (!property_id || !start_date || !end_date || !nightly_rate)
        return res.status(400).json({ error: 'missing required fields' });

      const { error } = await supabaseAdmin.from('realty_rates').insert({
        property_id,
        start_date,
        end_date,
        nightly_rate: Number(nightly_rate),
        min_nights: min_nights ? Number(min_nights) : null,
        priority: priority ? Number(priority) : 0,
        notes: notes || '',
      });

      if (error) throw error;
      return res.status(200).json({ ok: true });
    }

    // ---- DELETE ----
    if (req.method === 'DELETE') {
      const { id } = req.query;
      if (!id) return res.status(400).json({ error: 'id required' });

      const { error } = await supabaseAdmin
        .from('realty_rates')
        .delete()
        .eq('id', id);

      if (error) throw error;
      return res.status(200).json({ ok: true });
    }

    res.setHeader('Allow', ['GET', 'POST', 'DELETE']);
    return res.status(405).json({ error: `Method ${req.method} not allowed` });
  } catch (e) {
    console.error('realty/rates error:', e);
    return res.status(500).json({ error: e.message });
  }
}


===== FILE: pages/api/realty/reservations-admin.js  (size=3249 bytes) =====
// pages/api/realty/reservations-admin.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';

/**
 * Admin-facing fetch of upcoming / recent reservations.
 *
 * Returns:
 * [
 *   {
 *     id,
 *     property_id,
 *     property_name,
 *     property_slug,
 *     checkin,
 *     checkout,
 *     nights,
 *     guests,
 *     guest_name,
 *     guest_email,
 *     amount_cents,
 *     currency,
 *     status,
 *     notes,
 *     created_at,
 *   },
 *   ...
 * ]
 *
 * NOTE: This assumes only admins can load /admin (which you already enforce),
 * so we're not doing auth checks here. Do not expose this to public UI.
 */

export default async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    // pull reservations
    const { data: reservations, error: rErr } = await supabaseAdmin
      .from('realty_reservations')
      .select(
        `
        id,
        property_id,
        checkin,
        checkout,
        nights,
        guests,
        guest_name,
        guest_email,
        guest_phone,
        notes,
        amount_cents,
        currency,
        status,
        stripe_session_id,
        created_at
      `
      )
      .order('checkin', { ascending: true });

    if (rErr) {
      console.error('reservations-admin fetch error:', rErr.message);
      return res.status(500).json({ error: rErr.message });
    }

    if (!reservations || reservations.length === 0) {
      return res.status(200).json({ ok: true, items: [] });
    }

    // gather property_ids
    const propIds = Array.from(
      new Set(reservations.map((r) => r.property_id).filter(Boolean))
    );

    // fetch property metadata for name/slug
    const { data: props, error: pErr } = await supabaseAdmin
      .from('properties')
      .select('id, name, slug')
      .in('id', propIds);

    if (pErr) {
      console.error('reservations-admin property join error:', pErr.message);
      return res.status(500).json({ error: pErr.message });
    }

    const propMap = {};
    (props || []).forEach((p) => {
      propMap[p.id] = {
        name: p.name || '(unnamed)',
        slug: p.slug || null,
      };
    });

    // normalize + decorate each reservation we return to the dashboard
    const items = reservations.map((r) => {
      const propInfo = propMap[r.property_id] || {};
      return {
        id: r.id,
        property_id: r.property_id,
        property_name: propInfo.name,
        property_slug: propInfo.slug,
        checkin: r.checkin,
        checkout: r.checkout,
        nights: r.nights,
        guests: r.guests,
        guest_name: r.guest_name,
        guest_email: r.guest_email,
        guest_phone: r.guest_phone,
        notes: r.notes,
        amount_cents: r.amount_cents,
        currency: r.currency || 'usd',
        status: r.status,
        created_at: r.created_at,
      };
    });

    return res.status(200).json({ ok: true, items });
  } catch (e) {
    console.error('reservations-admin crash:', e);
    return res.status(500).json({ error: e.message || 'internal error' });
  }
}


===== FILE: pages/api/realty/send-booking-confirmation.js  (size=1538 bytes) =====
// pages/api/realty/send-booking-confirmation.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';
import { sendItineraryEmail } from '@/lib/emails/itineraryEmail';
import { sendBookingReceipt } from '@/lib/emails/bookingReceipt';

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  const { session_id } = req.body;
  if (!session_id) return res.status(400).json({ error: 'session_id required' });

  const { data: resv } = await supabaseAdmin.from('realty_reservations').select('*').eq('stripe_session_id', session_id).maybeSingle();
  if (!resv) return res.status(404).json({ error: 'Reservation not found' });

  const { data: prop } = await supabaseAdmin.from('properties').select('name').eq('id', resv.property_id).maybeSingle();

  try {
    await sendItineraryEmail({
      guestName: resv.guest_name,
      to: resv.guest_email,
      property: prop?.name || 'Property',
      checkin: resv.checkin,
      checkout: resv.checkout,
      guests: resv.guests,
      replyTo: 'realty@manyagi.net',
    });

    await sendBookingReceipt({
      guestName: resv.guest_name,
      to: resv.guest_email,
      property: prop?.name || 'Property',
      checkin: resv.checkin,
      checkout: resv.checkout,
      guests: resv.guests,
      replyTo: 'realty@manyagi.net',
    });

    return res.status(200).json({ ok: true });
  } catch (e) {
    return res.status(500).json({ error: e.message });
  }
}


===== FILE: pages/api/realty/sync-ical.js  (size=3803 bytes) =====
// pages/api/realty/sync-ical.js
// Fetch external ICS feeds from property.ical_urls (array of URLs) and upsert blocks
import { supabaseAdmin } from '@/lib/supabaseAdmin';

function parseIcsDate(v) {
  // supports VALUE=DATE (YYYYMMDD) and UTC date-time
  const m = String(v).trim();
  if (/^\\d{8}$/.test(m)) {
    const y = Number(m.slice(0, 4));
    const mm = Number(m.slice(4, 6)) - 1;
    const d = Number(m.slice(6, 8));
    return new Date(Date.UTC(y, mm, d, 0, 0, 0));
  }
  // try basic YYYYMMDDTHHMMSSZ
  const iso = m.replace(
    /^(\d{4})(\d{2})(\d{2})T?(\d{2})(\d{2})(\d{2})Z$/,
    '$1-$2-$3T$4:$5:$6Z'
  );
  const dt = new Date(iso);
  if (!isNaN(dt)) return dt;
  return null;
}

function extractEvents(icsText) {
  const blocks = icsText.split(/BEGIN:VEVENT/gi).slice(1);
  const events = [];
  blocks.forEach((raw) => {
    const seg = 'BEGIN:VEVENT' + raw;
    const endIdx = seg.indexOf('END:VEVENT');
    const vevent = seg.slice(0, endIdx);
    const lines = vevent.split(/\r?\n/).map((l) => l.trim()).filter(Boolean);
    let dtstart, dtend, uid, summary = '';
    lines.forEach((ln) => {
      if (ln.startsWith('UID:')) uid = ln.slice(4);
      if (ln.startsWith('SUMMARY:')) summary = ln.slice(8);
      if (ln.startsWith('DTSTART')) {
        const val = ln.split(':')[1];
        dtstart = parseIcsDate(val);
      }
      if (ln.startsWith('DTEND')) {
        const val = ln.split(':')[1];
        dtend = parseIcsDate(val);
      }
    });
    if (dtstart && dtend) {
      events.push({ uid, summary, dtstart, dtend });
    }
  });
  return events;
}

const ymd = (d) => d.toISOString().slice(0, 10);

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  try {
    const { property_id } = req.body || {};
    if (!property_id) return res.status(400).json({ error: 'property_id required' });

    // Load property to get feeds
    const { data: prop, error: pErr } = await supabaseAdmin
      .from('properties')
      .select('id, metadata')
      .eq('id', property_id)
      .maybeSingle();
    if (pErr) throw pErr;
    if (!prop) return res.status(404).json({ error: 'Property not found' });

    const feeds = (prop.metadata?.ical_urls || []).filter(Boolean);
    if (!feeds.length) return res.status(200).json({ ok: true, imported: 0, feeds: 0 });

    let imported = 0;

    for (const url of feeds) {
      const r = await fetch(url);
      if (!r.ok) continue;
      const text = await r.text();
      const events = extractEvents(text);

      // Clear previous blocks for this source (optional: keep rolling window)
      await supabaseAdmin
        .from('realty_external_blocks')
        .delete()
        .eq('property_id', property_id)
        .eq('source', url);

      const rows = [];
      for (const ev of events) {
        // many channel feeds use DTEND exclusive; make the inclusive date:
        const dtend = new Date(ev.dtend);
        dtend.setUTCDate(dtend.getUTCDate() - 1);
        rows.push({
          property_id,
          starts_on: ymd(ev.dtstart),
          ends_on: ymd(dtend),
          source: url,
          uid: ev.uid || null,
        });
      }
      if (rows.length) {
        // insert in chunks
        const chunk = 500;
        for (let i = 0; i < rows.length; i += chunk) {
          const slice = rows.slice(i, i + chunk);
          await supabaseAdmin.from('realty_external_blocks').insert(slice);
        }
        imported += rows.length;
      }
    }

    return res.status(200).json({ ok: true, feeds: feeds.length, imported });
  } catch (e) {
    return res.status(500).json({ error: e.message });
  }
}


===== FILE: pages/api/realty/test-email.js  (size=1009 bytes) =====
// pages/api/realty/test-email.js
import { supabaseAdmin } from '@/lib/supabaseAdmin';
import { sendItineraryEmail } from '@/lib/emails/itineraryEmail';

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  const { property_id, email } = req.body;
  if (!property_id || !email) return res.status(400).json({ error: 'property_id and email required' });

  const { data: prop } = await supabaseAdmin.from('properties').select('name').eq('id', property_id).maybeSingle();
  if (!prop) return res.status(404).json({ error: 'Property not found' });

  try {
    await sendItineraryEmail({
      guestName: 'Test Guest',
      to: email,
      property: prop.name,
      checkin: '2025-10-25',
      checkout: '2025-10-28',
      guests: 2,
    });
    return res.status(200).json({ ok: true, message: 'Test email sent' });
  } catch (e) {
    return res.status(500).json({ error: e.message });
  }
}


===== FILE: pages/api/realty/upcoming.js  (size=2898 bytes) =====
// pages/api/realty/upcoming.js
//
// Returns upcoming (future or current) paid reservations so you,
// the host, can see who is coming and when.
//
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    // "today" in YYYY-MM-DD for filtering
    const todayISO = new Date().toISOString().slice(0, 10);

    // 1. get paid reservations that haven't ended yet
    const { data: reservations, error: resErr } = await supabaseAdmin
      .from('realty_reservations')
      .select(
        `
        id,
        property_id,
        checkin,
        checkout,
        guests,
        guest_name,
        guest_email,
        guest_phone,
        amount_cents,
        currency,
        status
      `
      )
      .eq('status', 'paid')
      // checkout is the last night+1 (guest leaves that morning),
      // we want anything where checkout >= today
      .gte('checkout', todayISO)
      .order('checkin', { ascending: true });

    if (resErr) {
      console.error('[upcoming] reservations error:', resErr.message);
      return res.status(500).json({ error: resErr.message });
    }

    if (!reservations || reservations.length === 0) {
      return res.status(200).json({ ok: true, stays: [] });
    }

    // 2. get unique property_ids so we can attach property names/slugs
    const propIds = [...new Set(reservations.map((r) => r.property_id))];

    const { data: props, error: propErr } = await supabaseAdmin
      .from('properties')
      .select('id, name, slug')
      .in('id', propIds);

    if (propErr) {
      console.error('[upcoming] props error:', propErr.message);
      return res.status(500).json({ error: propErr.message });
    }

    const propMap = {};
    (props || []).forEach((p) => {
      propMap[p.id] = {
        name: p.name,
        slug: p.slug,
      };
    });

    // 3. normalize stays for frontend
    const stays = reservations.map((r) => ({
      id: r.id,
      property_id: r.property_id,
      property_name: propMap[r.property_id]?.name || 'Property',
      property_slug: propMap[r.property_id]?.slug || r.property_id,
      checkin: r.checkin,
      checkout: r.checkout,
      guests: r.guests,
      guest_name: r.guest_name || '‚Äî',
      guest_email: r.guest_email || '‚Äî',
      guest_phone: r.guest_phone || '‚Äî',
      amount: r.amount_cents
        ? (Number(r.amount_cents) / 100).toFixed(2)
        : '0.00',
      currency: r.currency || 'usd',
      status: r.status,
    }));

    return res.status(200).json({ ok: true, stays });
  } catch (e) {
    console.error('[upcoming] crash:', e);
    return res.status(500).json({ error: e.message || 'internal error' });
  }
}


===== FILE: pages/api/realty/webhook.js  (size=3948 bytes) =====
// pages/api/realty/webhook.js
import Stripe from 'stripe';
import { buffer } from 'micro';
import { supabaseAdmin } from '@/lib/supabaseAdmin';
import { sendItineraryEmail } from '@/lib/emails/itineraryEmail';
import { sendBookingReceipt } from '@/lib/emails/bookingReceipt';

// We need the raw body for Stripe signature verification
export const config = {
  api: {
    bodyParser: false,
  },
};

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
  apiVersion: '2024-06-20',
});

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).send('Method not allowed');
  }

  let event;
  const sig = req.headers['stripe-signature'];

  let buf;
  try {
    buf = await buffer(req);
  } catch (e) {
    console.error('Webhook: failed to read buffer', e);
    return res.status(400).send(`Webhook Error: ${e.message}`);
  }

  try {
    event = stripe.webhooks.constructEvent(
      buf,
      sig,
      process.env.STRIPE_WEBHOOK_SECRET // <-- set this in env
    );
  } catch (err) {
    console.error('Webhook signature verify failed:', err.message);
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }

  // We only really care about a successful Checkout payment
  if (event.type === 'checkout.session.completed') {
    const session = event.data.object;

    // We stored these in create-checkout.js metadata
    const {
      reservation_id,
      property_id,
      checkin,
      checkout,
      guest_name,
      guest_email,
      guest_phone,
      notes,
    } = session.metadata || {};

    try {
      // 1. Mark reservation as paid
      const { error: updErr } = await supabaseAdmin
        .from('realty_reservations')
        .update({
          status: 'paid',
        })
        .eq('id', reservation_id);

      if (updErr) {
        console.error('Webhook: failed to update reservation:', updErr.message);
      }

      // 2. Load property details for email context
      const { data: propRow, error: propErr } = await supabaseAdmin
        .from('properties')
        .select('name')
        .eq('id', property_id)
        .maybeSingle();

      if (propErr) {
        console.error('Webhook: property lookup err', propErr.message);
      }

      // 3. Send itinerary email (guest gets arrival details)
      try {
        await sendItineraryEmail({
          guestName: guest_name || 'Guest',
          to: guest_email,
          property: propRow?.name || 'Property',
          checkin,
          checkout,
          guests: session.metadata?.guests || '1',
          replyTo: 'realty@manyagi.net',
        });
      } catch (e) {
        console.error('Webhook: itinerary email failed', e);
      }

      // 4. Send receipt email (basic confirmation / thank you)
      try {
        await sendBookingReceipt({
          guestName: guest_name || 'Guest',
          to: guest_email,
          property: propRow?.name || 'Property',
          checkin,
          checkout,
          guests: session.metadata?.guests || '1',
          replyTo: 'realty@manyagi.net',
        });
      } catch (e) {
        console.error('Webhook: receipt email failed', e);
      }

      // 5. (Optional) You could also insert into property_availability here
      // so your frontend calendar shows it as blocked. We will instead expose
      // paid reservations via /api/realty/calendar-blocks.js.

      console.log(
        `[Realty] Reservation ${reservation_id} marked paid for ${propRow?.name}`
      );
    } catch (e) {
      console.error('Webhook crashed:', e);
      // We purposely do NOT fail the webhook with 500 because Stripe will retry.
      // Returning 200 tells Stripe we're good. If you want retries, return 400/500.
    }
  }

  // Stripe requires 2xx fast
  res.status(200).json({ received: true });
}


===== FILE: pages/api/site-config.js  (size=460 bytes) =====
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(_req, res) {
  try {
    const { data, error } = await supabaseAdmin.from('site_config').select('*');
    if (error) throw error;
    const map = (data || []).reduce((acc, row) => { acc[row.key] = row.value; return acc; }, {});
    res.status(200).json(map);
  } catch (e) {
    console.error('site-config error:', e);
    res.status(200).json({});
  }
}


===== FILE: pages/api/stripe-webhook.js  (size=15570 bytes) =====
// pages/api/stripe-webhook.js
import { buffer } from 'micro';
import Stripe from 'stripe';
import axios from 'axios';
import { supabaseAdmin } from '@/lib/supabaseAdmin';
import { createPrintfulOrder } from '@/lib/printful';
import { sendEmail } from '@/lib/sendEmail';
import { sendItineraryEmail } from '@/lib/emails/itineraryEmail';
import { sendBookingReceipt } from '@/lib/emails/bookingReceipt';

export const config = { api: { bodyParser: false } };

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: '2024-06-20' });
const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;
const telegramBotToken = process.env.TELEGRAM_BOT_TOKEN;
const telegramGroupChatId = process.env.TELEGRAM_GROUP_CHAT_ID;

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  // 1. Verify Stripe signature against the raw body
  const buf = await buffer(req);
  const sig = req.headers['stripe-signature'];

  let event;
  try {
    event = stripe.webhooks.constructEvent(buf, sig, webhookSecret);
  } catch (err) {
    return res.status(400).json({ error: `Webhook Error: ${err.message}` });
  }

  try {
    switch (event.type) {
      case 'checkout.session.completed': {
        // pull full session w/ expansions so we get payment info
        const session = await stripe.checkout.sessions.retrieve(
          event.data.object.id,
          { expand: ['customer_details', 'shipping_details', 'payment_intent'] }
        );

        //
        // ========== REALTY BOOKING FLOW ==========
        //
        if (session?.metadata?.type === 'realty_booking') {
          // Metadata your checkout added in /api/realty/create-checkout
          const {
            reservation_id,
            property_id,
            checkin,
            checkout,
            guests,
            guest_name,
            guest_email,
            guest_phone,
            notes,
          } = session.metadata || {};

          // Amount + currency actually charged
          const amountCents = session.amount_total ?? null;
          const currency = session.currency ?? 'usd';

          // 1) Mark reservation row as paid (and attach info)
          await supabaseAdmin
            .from('realty_reservations')
            .update({
              status: 'paid',
              updated_at: new Date().toISOString(),
              amount_cents: amountCents,
              currency,
              stripe_session_id: session.id,
              stripe_payment_intent: session.payment_intent || null,
              guest_name: guest_name || null,
              guest_email: guest_email || null,
              guest_phone: guest_phone || null,
              notes: notes || null,
            })
            .eq('id', reservation_id || '')
            .eq('property_id', property_id || '');

          // 2) Get property info for emails / ICS
          const { data: prop } = await supabaseAdmin
            .from('properties')
            .select('id, name, slug, metadata')
            .eq('id', property_id)
            .maybeSingle();

          const propName = prop?.name || 'Your Stay';
          const publicSlug = prop?.slug || prop?.metadata?.slug || property_id;
          const site = process.env.NEXT_PUBLIC_SITE_URL || 'https://manyagi.net';

          // calendar feed (ics) for guest
          const icsUrl = `${site}/api/realty/ical-export?property_id=${property_id}`;
          const detailsUrl = `${site}/realty/${publicSlug}`;

          // 3) Send itinerary email (arrival details)
          if (guest_email) {
            try {
              await sendItineraryEmail({
                guestName: guest_name || 'Guest',
                to: guest_email,
                property: propName,
                checkin,
                checkout,
                guests,
                replyTo: process.env.SUPPORT_EMAIL || 'realty@manyagi.net',
              });
            } catch (e) {
              console.warn('sendItineraryEmail failed:', e.message);
            }

            // 4) Send booking receipt / thank you
            try {
              await sendBookingReceipt({
                guestName: guest_name || 'Guest',
                to: guest_email,
                property: propName,
                checkin,
                checkout,
                guests,
                replyTo: process.env.SUPPORT_EMAIL || 'realty@manyagi.net',
              });
            } catch (e) {
              console.warn('sendBookingReceipt failed:', e.message);
            }

            // 5) (Optional) fallback transactional email using generic sendEmail
            //    If you want the basic HTML approach you had before, keep this.
            //    If not needed, you can delete this block.
            try {
              const html = `
                <h1>Your Manyagi stay is confirmed ‚úÖ</h1>
                <p><strong>${propName}</strong></p>
                <p>Check-in: ${checkin}</p>
                <p>Check-out: ${checkout}</p>
                <p>Guests: ${guests}</p>
                <p>View property: <a href="${detailsUrl}">${detailsUrl}</a></p>
                <p>Add to Calendar (ICS): <a href="${icsUrl}">${icsUrl}</a></p>
                <p>We‚Äôll be in touch with arrival details.</p>
              `;
              await sendEmail({
                to: guest_email,
                subject: 'Your Manyagi stay is confirmed',
                html,
              });
            } catch (e) {
              console.warn('sendEmail fallback failed:', e.message);
            }
          }

          // Important:
          // No need to modify availability table here ‚Äî your
          // /api/realty/calendar-blocks endpoint already uses
          // realty_reservations where status='paid', so this guest's
          // nights will now show as unavailable automatically.
          break;
        }

        //
        // ========== PHYSICAL MERCH (Printful) ==========
        //
        {
          const email = session?.customer_details?.email || null;
          const name  = session?.customer_details?.name || null;
          const addr  = session?.shipping_details?.address || null;

          // mark normal product order paid
          await supabaseAdmin
            .from('orders')
            .update({
              status: 'paid',
              customer_email: email,
              customer_name: name,
              shipping_snapshot: addr
                ? {
                    line1: addr.line1 || '',
                    line2: addr.line2 || '',
                    city: addr.city || '',
                    state: addr.state || '',
                    postal_code: addr.postal_code || '',
                    country: addr.country || '',
                  }
                : null,
              updated_at: new Date().toISOString(),
            })
            .eq('stripe_session_id', session.id);

          try {
            const { data: orderRow } = await supabaseAdmin
              .from('orders')
              .select('*')
              .eq('stripe_session_id', session.id)
              .maybeSingle();

            if (orderRow) {
              const { data: product } = await supabaseAdmin
                .from('products')
                .select('*')
                .eq('id', orderRow.product_id)
                .maybeSingle();

              const meta = product?.metadata || {};
              const syncVariantId =
                meta.printful_sync_variant_id ||
                meta.printful_sync_variant ||
                null;

              const haveShippingAddress = Boolean(
                session?.shipping_details?.address?.line1
              );

              if (syncVariantId && haveShippingAddress) {
                const a = session.shipping_details.address;
                const recipient = {
                  name: session?.customer_details?.name || 'Customer',
                  address1: a.line1 || '',
                  address2: a.line2 || '',
                  city: a.city || '',
                  state_code: a.state || '',
                  country_code: a.country || 'US',
                  zip: a.postal_code || '',
                  phone: session?.customer_details?.phone || '',
                  email: session?.customer_details?.email || '',
                };

                const qty = Math.max(1, Number(orderRow?.quantity || 1));
                const items = [
                  {
                    sync_variant_id: Number(syncVariantId),
                    quantity: qty,
                  },
                ];

                const packingSlip = {
                  email: 'support@manyagi.net',
                  phone: '',
                  message: 'Thank you for supporting Manyagi!',
                };

                try {
                  const pf = await createPrintfulOrder({
                    externalId: session.id,
                    recipient,
                    items,
                    packingSlip,
                  });

                  await supabaseAdmin
                    .from('orders')
                    .update({
                      fulfillment_provider: 'printful',
                      fulfillment_status: pf?.status || 'submitted',
                      fulfillment_id: pf?.id ? String(pf.id) : null,
                      updated_at: new Date().toISOString(),
                    })
                    .eq('stripe_session_id', session.id);
                } catch (pfErr) {
                  await supabaseAdmin
                    .from('orders')
                    .update({
                      fulfillment_provider: 'printful',
                      fulfillment_status: 'error',
                      fulfillment_error: String(
                        pfErr?.response?.data?.error ||
                          pfErr.message ||
                          'unknown'
                      ),
                      updated_at: new Date().toISOString(),
                    })
                    .eq('stripe_session_id', session.id);

                  console.warn(
                    'Printful error:',
                    pfErr?.response?.data || pfErr.message
                  );
                }
              }
            }
          } catch (fulfillErr) {
            console.warn(
              'Fulfillment skipped:',
              fulfillErr?.response?.data || fulfillErr.message
            );
          }
        }

        break;
      }

      //
      // ========== TELEGRAM SUBSCRIPTIONS / SIGNALS ==========
      //
      case 'customer.subscription.created': {
        const subscription = event.data.object;
        const customer = await stripe.customers.retrieve(subscription.customer);
        const telegramId =
          subscription?.metadata?.telegramId ||
          customer?.metadata?.telegramId;

        if (telegramId && !isNaN(telegramId)) {
          try {
            await axios.post(
              `https://api.telegram.org/bot${telegramBotToken}/unbanChatMember`,
              {
                chat_id: telegramGroupChatId,
                user_id: telegramId,
              }
            );
          } catch (tgErr) {
            console.warn(
              'Telegram unban (created) error:',
              tgErr?.response?.data || tgErr.message
            );
          }
        }
        break;
      }

      case 'invoice.paid': {
        const invoice = event.data.object;
        const customerId = invoice.customer;
        const subId = invoice.subscription;

        const [subscription, customer] = await Promise.all([
          subId ? stripe.subscriptions.retrieve(subId) : null,
          customerId ? stripe.customers.retrieve(customerId) : null,
        ]);

        const telegramId =
          subscription?.metadata?.telegramId ||
          customer?.metadata?.telegramId ||
          invoice?.metadata?.telegramId;

        if (!telegramId || isNaN(telegramId)) {
          console.warn(
            `[stripe-webhook] Missing/invalid Telegram ID, event=${event.type}, invoice=${invoice.id}`
          );
          break;
        }

        try {
          await axios.post(
            `https://api.telegram.org/bot${telegramBotToken}/unbanChatMember`,
            {
              chat_id: telegramGroupChatId,
              user_id: telegramId,
            }
          );
        } catch (tgErr) {
          console.warn(
            'Telegram unban error:',
            tgErr?.response?.data || tgErr.message
          );
        }

        const periodStart = subscription?.current_period_start
          ? new Date(subscription.current_period_start * 1000).toISOString()
          : new Date().toISOString();
        const periodEnd = subscription?.current_period_end
          ? new Date(subscription.current_period_end * 1000).toISOString()
          : null;

        await supabaseAdmin.from('subscriptions').upsert({
          stripe_subscription_id: subId || null,
          user_id: null,
          status: 'active',
          plan_type: 'Basic Signals',
          division: 'capital',
          current_period_start: periodStart,
          current_period_end: periodEnd,
          telegram_id: String(telegramId),
          created_at: new Date().toISOString(),
        });

        try {
          const message = `Welcome to Manyagi Capital Signals! Join our Telegram group for real-time updates: ${process.env.TELEGRAM_INVITE_LINK}`;
          await axios.post(
            `https://api.telegram.org/bot${telegramBotToken}/sendMessage`,
            {
              chat_id: telegramId,
              text: message,
            }
          );
        } catch (tgMsgErr) {
          console.warn(
            'Telegram welcome message error:',
            tgMsgErr?.response?.data || tgMsgErr.message
          );
        }
        break;
      }

      case 'customer.subscription.deleted':
      case 'invoice.payment_failed': {
        const obj = event.data.object;
        const customer = await stripe.customers.retrieve(obj.customer);
        const telegramId =
          obj.metadata?.telegramId || customer?.metadata?.telegramId;

        if (telegramId) {
          await supabaseAdmin
            .from('subscriptions')
            .delete()
            .eq('telegram_id', String(telegramId));

          try {
            await axios.post(
              `https://api.telegram.org/bot${telegramBotToken}/banChatMember`,
              {
                chat_id: telegramGroupChatId,
                user_id: telegramId,
              }
            );
          } catch (tgBanErr) {
            console.warn(
              'Telegram ban error:',
              tgBanErr?.response?.data || tgBanErr.message
            );
          }
        }
        break;
      }

      default:
        console.log(`Unhandled event type: ${event.type}`);
    }

    return res.status(200).json({ received: true });
  } catch (err) {
    console.error('Webhook processing error:', err.message);
    return res.status(500).json({
      error: `Webhook processing failed: ${err.message}`,
    });
  }
}


===== FILE: pages/api/stripe/charge.js  (size=3698 bytes) =====
import Stripe from 'stripe';
import { supabaseAdmin } from '@/lib/supabaseAdmin';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: '2024-06-20' });

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    res.setHeader('Allow', ['POST']);
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { items, telegramId, priceId, email, address } = req.body;

  try {
    if (!items && !priceId) {
      return res.status(400).json({ error: 'Missing items or priceId' });
    }

    const lineItems = items
      ? items.map(item => ({
          price_data: {
            currency: 'usd',
            product_data: { 
              name: item.name, 
              metadata: { 
                division: item.division || 'general',
                type: item.productType || 'general',
                product_id: item.id 
              } 
            },
            unit_amount: Math.round(item.price * 100),
          },
          quantity: item.quantity || 1,
        }))
      : [{ price: priceId, quantity: 1 }];

    const mode = items ? 'payment' : 'subscription';

    const sessionMetadata = {
      telegramId: telegramId ?? '',
      address: JSON.stringify(address || {}),
    };

    const checkoutSession = await stripe.checkout.sessions.create({
      payment_method_types: ['card'],
      line_items: lineItems,
      mode,
      success_url: `${process.env.SITE_URL}/thank-you?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: `${process.env.SITE_URL}/`,
      customer_email: email,
      // üëá ensure a Customer object exists (so metadata can live on it)
      customer_creation: 'always',
      // üëá only for subscriptions: attach telegramId on the Subscription itself
      ...(mode === 'subscription'
        ? {
            subscription_data: {
              metadata: { telegramId: String(telegramId || '') },
            },
          }
        : {}),
      // Keep session-level metadata as well (belt & suspenders)
      metadata: sessionMetadata,
    });

    // Calculate total amount
    let totalAmount = 0;
    if (mode === 'subscription') {
      const pricePromises = lineItems.map(async (li) => {
        if (li.price_data?.unit_amount) return li.price_data.unit_amount / 100;
        const price = await stripe.prices.retrieve(li.price);
        return price.unit_amount / 100;
      });
      const prices = await Promise.all(pricePromises);
      totalAmount = lineItems.reduce((acc, li, index) => acc + (li.quantity * prices[index]), 0);
    } else {
      totalAmount = items.reduce((acc, item) => acc + (item.price * (item.quantity || 1)), 0);
    }

    // Save to Supabase
    const { error: saveError } = await supabaseAdmin.from('orders').insert({
      stripe_session_id: checkoutSession.id,
      total_amount: totalAmount,
      status: 'pending',
      items: items || [],
      shipping_address: address ? { ...address } : null,
      user_id: null,
      division: items?.[0]?.division || 'general',
      type: mode === 'subscription' ? 'signals' : items?.[0]?.productType || 'general',
      created_at: new Date().toISOString(),
    }).select().single();
    
    if (saveError) {
      console.error('Supabase save error:', saveError);
      return res.status(500).json({ error: 'Failed to save order' });
    }

    return res.status(200).json({ sessionId: checkoutSession.id, url: checkoutSession.url });
  } catch (error) {
    console.error('Stripe error:', error);
    return res.status(500).json({ error: error.message || 'Failed to process payment' });
  }
}


===== FILE: pages/api/track.js  (size=809 bytes) =====
import { supabaseAdmin } from '@/lib/supabaseAdmin';

export default async function handler(req, res) {
  const { order_id } = req.query;

  if (!order_id) {
    return res.status(400).json({ error: 'Missing order_id' });
  }

  try {
    const { data: order, error } = await supabaseAdmin
      .from('orders')
      .select('*')
      .eq('id', order_id)
      .single();
      
    if (error || !order) throw new Error('Order not found');

    res.status(200).json({
      status: order.status,
      estimated_delivery: order.updated_at,
      division: order.division,
      total: order.total_amount,
      items: order.items
    });
  } catch (error) {
    console.error('Supabase track error:', error);
    res.status(500).json({ error: 'Failed to track order' });
  }
}


===== FILE: pages/blog.js  (size=2829 bytes) =====
import Head from 'next/head';
import Link from 'next/link';
import { useEffect, useState } from 'react';
import { MDXRemote } from 'next-mdx-remote';
import { serialize } from 'next-mdx-remote/serialize';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';

export default function Blog() {
  const [blogPosts, setBlogPosts] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => { (async () => {
    try {
      const posts = await fetch('/api/posts').then(r => r.json());
      const serialized = await Promise.all((posts || []).map(async (p) => ({ ...p, mdxContent: await serialize(p.content || '') })));
      setBlogPosts(serialized);
    } catch (e) {
      console.error('Blog fetch error:', e);
      const fallback = [{
        id: '1',
        title: 'Welcome to Manyagi',
        slug: 'welcome-to-manyagi',
        excerpt: 'An introduction to our multi-division platform.',
        created_at: '2025-09-01T00:00:00Z',
        featured_image: 'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/og-home.webp',
        mdxContent: await serialize('# Welcome to Manyagi\n\nThis is our first blog post introducing our platform.')
      }];
      setBlogPosts(fallback);
    } finally { setLoading(false); }
  })(); }, []);

  if (loading) return <div className="container mx-auto px-4 py-16 text-center">Loading blog posts...</div>;

  return (
    <>
      <Head>
        <title>Manyagi Blog ‚Äî Insights & Updates</title>
        <meta name="description" content="Read the latest updates and insights from Manyagi." />
      </Head>
      <section className="container mx-auto px-4 py-16">
        <h1 className="text-4xl font-bold mb-8 text-center">Manyagi Blog</h1>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {blogPosts.map((post) => (
            <div key={post.id} className="border rounded p-4">
              <img src={post.featured_image} alt={post.title} className="w-full h-48 object-cover rounded mb-4" />
              <h2 className="text-2xl font-bold mb-2">{post.title}</h2>
              <p className="text-gray-600 mb-2">{new Date(post.created_at).toLocaleDateString()}</p>
              <p className="mb-4">{post.excerpt}</p>
              <Link href={`/blog/${post.slug}`} className="text-blue-600 hover:underline">Read More</Link>
            </div>
          ))}
        </div>
      </section>

      <section id="subscribe" className="container mx-auto px-4 py-16">
        <SubscriptionForm formId="8427852" uid="637df68a05" title="Subscribe to Blog Updates" description="Stay informed with our latest posts and insights." />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/blog/[slug].js  (size=2568 bytes) =====
import Head from 'next/head';
import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';
import { MDXRemote } from 'next-mdx-remote';
import { serialize } from 'next-mdx-remote/serialize';
import SubscriptionForm from '../../components/SubscriptionForm';
import Recommender from '../../components/Recommender';

export default function BlogPost() {
  const router = useRouter();
  const { slug } = router.query;
  const [post, setPost] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => { if (!slug) return; (async () => {
    try {
      const data = await fetch(`/api/posts/${slug}`).then(r => r.json());
      if (!data || data.error) throw new Error('Post not found');
      const mdxContent = await serialize(data.content || '');
      setPost({ ...data, mdxContent });
    } catch (e) {
      const fallback = {
        id: '1',
        title: 'Welcome to Manyagi',
        slug: 'welcome-to-manyagi',
        excerpt: 'An introduction to our multi-division platform.',
        created_at: '2025-09-01T00:00:00Z',
        featured_image: 'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/og-home.webp',
        mdxContent: await serialize('# Welcome to Manyagi\n\nThis is our first blog post introducing our platform.'),
      };
      setPost(fallback);
    } finally { setLoading(false); }
  })(); }, [slug]);

  if (loading) return <div className="container mx-auto px-4 py-16 text-center">Loading post...</div>;
  if (!post) return <div className="container mx-auto px-4 py-16 text-center">Post not found</div>;

  return (
    <>
      <Head>
        <title>{post.title} ‚Äî Manyagi Blog</title>
        <meta name="description" content={post.excerpt} />
      </Head>
      <section className="container mx-auto px-4 py-16">
        <h1 className="text-4xl font-bold mb-4">{post.title}</h1>
        <p className="text-gray-600 mb-4">{new Date(post.created_at).toLocaleDateString()}</p>
        <img src={post.featured_image} alt={post.title} className="w-full h-64 object-cover rounded mb-6" />
        <div className="prose max-w-none">
          <MDXRemote {...post.mdxContent} />
        </div>
      </section>

      <section id="subscribe" className="container mx-auto px-4 py-16">
        <SubscriptionForm formId="8427852" uid="637df68a05" title="Subscribe to Blog Updates" description="Stay informed with our latest posts and insights." />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/capital.js  (size=9543 bytes) =====
// pages/capital.js
import Head from 'next/head';
import Link from 'next/link';
import { useEffect, useState } from 'react';
import { useDispatch } from 'react-redux';
import { addToCart } from '../lib/cartSlice';
import SignalsSubscriptionForm from '../components/SignalsSubscriptionForm';
import Recommender from '../components/Recommender';
import Hero from '../components/Hero';
import Card from '../components/Card';

// Helpers
const asList = (v) => {
  if (Array.isArray(v)) return v;
  if (Array.isArray(v?.items)) return v.items;
  return [];
};

const pickImage = (p) =>
  p?.thumbnail_url ||
  p?.display_image ||
  p?.image_url ||
  p?.image ||
  '';

export default function Capital() {
  const [products, setProducts] = useState([]);
  const [total, setTotal] = useState(0);
  const [loading, setLoading] = useState(true);
  const dispatch = useDispatch();

  // pull the public price id for Basic Signals from env
  const signalsPriceId =
    process.env.NEXT_PUBLIC_STRIPE_PRICE_ID || '';

  useEffect(() => {
    (async () => {
      try {
        // fetch only capital division products from your existing API
        const res = await fetch('/api/products?division=capital');
        const json = await res.json();

        const list = asList(json).map((p) => ({
          ...p,
          display_image: pickImage(p),
          // unify productType between db row and fallback logic:
          productType:
            p.metadata?.productType ||
            p.productType ||
            'download',
        }));

        if (list.length === 0) {
          // fallback seed if DB is empty
          const fallback = [
            {
              id: 'signals-basic',
              name: 'Basic Signals',
              price: 29.99,
              display_image:
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/chart-hero.webp',
              division: 'capital',
              description:
                'Daily trade entries & exits. Telegram alerts.',
              productType: 'subscription',
              metadata: {
                productType: 'subscription',
                plan_type: 'Basic Signals',
              },
            },
            {
              id: 'bot1',
              name: 'Trading Bot License',
              price: 99.99,
              display_image:
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/bot-license.webp',
              division: 'capital',
              description:
                'Lifetime access to premium trading bot, trusted by 100K+ users.',
              productType: 'download',
              metadata: {
                productType: 'download',
                license_type: 'bot',
              },
            },
          ];

          setProducts(fallback);
          setTotal(fallback.length);
        } else {
          setProducts(list);
          setTotal(Number(json?.total ?? list.length));
        }
      } catch (error) {
        console.error('Capital fetch error:', error);

        // on error, show the same useful fallback
        const fallback = [
          {
            id: 'signals-basic',
            name: 'Basic Signals',
            price: 29.99,
            display_image:
              'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/chart-hero.webp',
            division: 'capital',
            description:
              'Daily trade entries & exits. Telegram alerts.',
            productType: 'subscription',
            metadata: {
              productType: 'subscription',
              plan_type: 'Basic Signals',
            },
          },
          {
            id: 'bot1',
            name: 'Trading Bot License',
            price: 99.99,
            display_image:
              'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/bot-license.webp',
            division: 'capital',
            description:
              'Lifetime access to premium trading bot, trusted by 100K+ users.',
            productType: 'download',
            metadata: {
              productType: 'download',
              license_type: 'bot',
            },
          },
        ];

        setProducts(fallback);
        setTotal(fallback.length);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const handleAddToCart = (product) => {
    // this is only for non-subscription products
    const payload = {
      ...product,
      productType: 'download',
    };
    if (!payload.display_image)
      payload.display_image = pickImage(product);
    dispatch(addToCart(payload));
  };

  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/chart-hero.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/performance-chart.webp',
  ];

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16 text-center">
        Loading capital products...
      </div>
    );
  }

  const list = asList(products);

  return (
    <>
      <Head>
        <title>Manyagi Capital ‚Äî Trusted Trading Insights</title>
        <meta
          name="description"
          content="Access real-time signals and bots used by millions."
        />
      </Head>

      <Hero
        kicker="Capital"
        title="Maximize Your Trades"
        lead="Leverage signals trusted by 100M+ users for better decisions."
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <Link
          href="#subscribe"
          className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition"
        >
          Get Started
        </Link>
      </Hero>

      <section
        id="performance"
        className="container mx-auto px-4 py-16"
      >
        <h2 className="text-3xl font-bold mb-6">
          Performance Charts
        </h2>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
          <Card
            title="Weekly Performance"
            description="View our latest trading results."
            image="https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/performance-chart.webp"
            link="https://www.myfxbook.com/members/Blackkungfu/manyagi-meanpulse/11661957"
            category="capital"
          >
            <iframe
              src="https://www.myfxbook.com/widgets/11661957"
              width="100%"
              height="300"
              title="MyFXBook Chart"
              className="mt-4"
            ></iframe>
          </Card>

          <Card
            title="Bot Insights"
            description="Automated trading with proven results."
            image="https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/chart-hero.webp"
            category="capital"
          >
            <Link
              href="#products"
              className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition"
            >
              Explore Bots
            </Link>
          </Card>
        </div>
      </section>

      {/* PRODUCTS GRID */}
      <section
        id="products"
        className="container mx-auto px-4 py-16 grid grid-cols-1 md:grid-cols-2 gap-5"
      >
        {list.length === 0 ? (
          <div className="col-span-full text-center text-lg">
            No capital products found.
          </div>
        ) : (
          list.map((product) => {
            const isSub =
              product.metadata?.productType === 'subscription' ||
              product.productType === 'subscription';

            return (
              <Card
                key={product.id}
                title={product.name}
                description={product.description}
                image={
                  product.display_image || pickImage(product)
                }
                category="capital"
                buyButton={
                  isSub ? null : product /* for non-sub products */
                }
                onBuy={
                  isSub
                    ? undefined
                    : () => handleAddToCart(product)
                }
              >
                {/* If it's a subscription product, render inline subscribe CTA */}
                {isSub && (
                  <div className="mt-4 border rounded p-3 bg-white text-black">
                    <div className="text-sm font-semibold mb-2">
                      {product.price
                        ? `$${Number(
                            product.price
                          ).toFixed(2)}/month`
                        : '$/month'}
                    </div>
                    <SignalsSubscriptionForm
                      priceId={signalsPriceId}
                    />
                  </div>
                )}
              </Card>
            );
          })
        )}
      </section>

      {/* Big subscribe block / hero CTA */}
      <section
        id="subscribe"
        className="container mx-auto px-4 py-16"
      >
        <SignalsSubscriptionForm priceId={signalsPriceId} />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/cart.js  (size=401 bytes) =====
import Head from 'next/head';
import Cart from '../components/Cart';

export default function CartPage() {
  return (
    <>
      <Head>
        <title>Manyagi ‚Äî Cart</title>
        <meta name="description" content="Review and checkout your Manyagi Designs." />
      </Head>
      <section className="container mx-auto px-4 py-10">
        <Cart />
      </section>
    </>
  );
};


===== FILE: pages/coming-soon.js  (size=1293 bytes) =====
// pages/coming-soon.js
import Head from 'next/head';
import Hero from '../components/Hero';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';

export default function ComingSoon() {
  const carouselImages = [
    '/images/og-comingsoon.webp',
    '/images/home-carousel-1.webp',
    '/images/home-carousel-2.webp',
  ];

  return (
    <>
      <Head>
        <title>Coming Soon ‚Äî Manyagi</title>
        <meta name="description" content="This page is under construction. Sign up for updates." />
      </Head>
      <Hero
        kicker="Coming Soon"
        title="Page Under Construction"
        lead="We're building this page ‚Äî join the Manyagi newsletter for updates and early access."
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <a href="https://manyagi.net" className="btn bg-blue-600 text-white py-4 px-6 rounded hover:scale-105 transition">
          Back to Home
        </a>
      </Hero>
      <section className="container mx-auto px-4 py-16">
        <SubscriptionForm formId="8427635" uid="db12290300" title="Get Notified" description="Be the first to know when it's live." />
      </section>
      <Recommender />
    </>
  );
};


===== FILE: pages/contact.js  (size=2612 bytes) =====
import Head from 'next/head';
import { useForm, ValidationError } from '@formspree/react';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import Hero from '../components/Hero';

export default function Contact() {
  const [state, handleSubmit] = useForm('xwkdwgdp');

  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/og-contact.webp',
  ];

  return (
    <>
      <Head>
        <title>Contact Manyagi ‚Äî Get in Touch</title>
        <meta name="description" content="Reach out to Manyagi for inquiries and support." />
      </Head>
      <Hero
        kicker="Contact"
        title="Get in Touch"
        lead="Have questions? We're here to help."
        carouselImages={carouselImages}
        height="h-[600px]"
      />

      <section className="container mx-auto px-4 py-16">
        <h2 className="text-3xl font-bold mb-6 text-center">Contact Form</h2>
        <form onSubmit={handleSubmit} className="max-w-lg mx-auto space-y-4">
          <div>
            <label htmlFor="email" className="block text-sm font-medium">Email Address</label>
            <input
              id="email"
              type="email"
              name="email"
              className="w-full p-2 border rounded"
              required
            />
            <ValidationError prefix="Email" field="email" errors={state.errors} />
          </div>
          <div>
            <label htmlFor="message" className="block text-sm font-medium">Message</label>
            <textarea
              id="message"
              name="message"
              className="w-full p-2 border rounded"
              rows="5"
              required
            />
            <ValidationError prefix="Message" field="message" errors={state.errors} />
          </div>
          <button
            type="submit"
            disabled={state.submitting}
            className="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700"
          >
            Submit
          </button>
          {state.succeeded && <p className="text-green-600">Thanks for your message!</p>}
        </form>
      </section>

      <section id="subscribe" className="container mx-auto px-4 py-16">
        <SubscriptionForm
          formId="8427853"
          uid="637df68a06"
          title="Stay Connected"
          description="Join our community for updates and insights."
        />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/dashboard.js  (size=6700 bytes) =====
// pages/dashboard.js
import Head from 'next/head';
import { useEffect, useState } from 'react';
import { useRouter } from 'next/router';
import { supabase } from '@/lib/supabase';

function formatDate(d) {
  try {
    return new Date(d).toLocaleDateString();
  } catch {
    return '‚Äî';
  }
}

function formatCurrency(n) {
  if (typeof n !== 'number') return n ?? '‚Äî';
  try {
    return new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(n);
  } catch {
    return `$${n.toFixed(2)}`;
  }
}

export default function Dashboard() {
  const router = useRouter();
  const [user, setUser] = useState(null);
  const [error, setError] = useState(null);
  const [orders, setOrders] = useState([]);
  const [subscriptions, setSubscriptions] = useState([]);
  const [affiliate, setAffiliate] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    let isMounted = true;

    (async () => {
      try {
        // Authenticated user
        const {
          data: { user: authUser },
          error: authError,
        } = await supabase.auth.getUser();

        if (authError || !authUser) {
          router.push('/login');
          return;
        }
        if (!isMounted) return;
        setUser(authUser);

        // Role check
        const { data: userRow, error: roleError } = await supabase
          .from('users')
          .select('role')
          .eq('id', authUser.id)
          .maybeSingle();

        if (roleError) {
          if (!isMounted) return;
          setError('Failed to load user role. Please try again.');
          setLoading(false);
          return;
        }
        if (!userRow) {
          if (!isMounted) return;
          setError('User data not found. Contact support.');
          setLoading(false);
          return;
        }
        if (userRow.role === 'admin') {
          router.push('/admin');
          return;
        }

        // Parallel fetches
        const [o, s, a] = await Promise.all([
          supabase
            .from('orders')
            .select('*')
            .eq('user_id', authUser.id)
            .order('created_at', { ascending: false }),
          supabase
            .from('subscriptions')
            .select('*')
            .eq('user_id', authUser.id)
            .order('created_at', { ascending: false }),
          supabase.from('affiliates').select('*').eq('user_id', authUser.id).maybeSingle(),
        ]);

        if (!isMounted) return;

        if (o.error || s.error || a.error) {
          setError('Failed to load some dashboard data. Please try again.');
        }

        setOrders(o.data || []);
        setSubscriptions(s.data || []);
        setAffiliate(a.data || null);
        setLoading(false);
      } catch {
        if (!isMounted) return;
        setError('An unexpected error occurred. Please try again.');
        setLoading(false);
      }
    })();

    return () => {
      isMounted = false;
    };
  }, [router]);

  if (error) return <p className="p-6 text-red-500">{error}</p>;
  if (loading) return <p className="p-6">Loading dashboard...</p>;

  return (
    <>
      <Head>
        <title>Manyagi User Dashboard</title>
      </Head>

      <div className="container mx-auto px-4 py-8 space-y-8">
        <h1 className="text-2xl font-bold">User Dashboard</h1>

        {/* Orders */}
        <section>
          <h2 className="text-xl font-bold mb-2">Your Orders</h2>
          {orders.length === 0 ? (
            <p>No orders yet.</p>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full border-collapse">
                <thead>
                  <tr className="bg-gray-50">
                    <th className="border p-2 text-left">Order ID</th>
                    <th className="border p-2 text-left">Date</th>
                    <th className="border p-2 text-left">Total</th>
                    <th className="border p-2 text-left">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {orders.map((order) => (
                    <tr key={order.id}>
                      <td className="border p-2">{order.id}</td>
                      <td className="border p-2">{formatDate(order.created_at)}</td>
                      <td className="border p-2">{formatCurrency(order.total_amount)}</td>
                      <td className="border p-2 capitalize">{order.status}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>

        {/* Subscriptions */}
        <section>
          <h2 className="text-xl font-bold mb-2">Your Subscriptions</h2>
          {subscriptions.length === 0 ? (
            <p>No subscriptions yet.</p>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full border-collapse">
                <thead>
                  <tr className="bg-gray-50">
                    <th className="border p-2 text-left">Subscription ID</th>
                    <th className="border p-2 text-left">Start Date</th>
                    <th className="border p-2 text-left">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {subscriptions.map((sub) => (
                    <tr key={sub.id}>
                      <td className="border p-2">{sub.id}</td>
                      <td className="border p-2">{formatDate(sub.created_at)}</td>
                      <td className="border p-2 capitalize">{sub.status}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>

        {/* Affiliate */}
        <section>
          <h2 className="text-xl font-bold mb-2">Your Affiliate Info</h2>
          {affiliate ? (
            <div className="rounded border p-3">
              <p>
                <span className="font-semibold">Referral Code:</span>{' '}
                <span className="font-mono">{affiliate.referral_code}</span>
              </p>
            </div>
          ) : (
            <p>No affiliate account. Contact support to join.</p>
          )}
        </section>

        <button
          onClick={() => supabase.auth.signOut().then(() => router.push('/'))}
          className="p-2 bg-red-500 text-white rounded"
        >
          Logout
        </button>
      </div>
    </>
  );
}


===== FILE: pages/designs.js  (size=13567 bytes) =====
// pages/designs.js
import Head from 'next/head';
import Link from 'next/link';
import { useEffect, useState, useMemo } from 'react';
import { useRouter } from 'next/router';
import { useDispatch } from 'react-redux';
import { addToCart } from '../lib/cartSlice';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import Hero from '../components/Hero';
import Card from '../components/Card';

const PAGE_SIZE = 16;

// Prefer higher-quality image fields when available
function pickImage(p) {
  return (
    (p?.thumbnail_url && typeof p.thumbnail_url === 'string' && p.thumbnail_url) ||
    (p?.display_image && typeof p.display_image === 'string' && p.display_image) ||
    (p?.image_url && typeof p.image_url === 'string' && p.image_url) ||
    (p?.image && typeof p.image === 'string' && p.image) ||
    '/placeholder.png' // CSP-safe local fallback
  );
}

export default function Designs() {
  const router = useRouter();
  const dispatch = useDispatch();

  const [items, setItems] = useState([]);
  const [total, setTotal] = useState(0);
  const [loading, setLoading] = useState(true);
  const [fetchingMore, setFetchingMore] = useState(false);
  const [showModal, setShowModal] = useState(false);

  const initial = useMemo(
    () => ({
      q: (router.query.q || '').toString(),
      collection: (router.query.collection || '').toString(),
      tag: (router.query.tag || '').toString(),
      sort: (router.query.sort || 'new').toString(),
    }),
    [router.query]
  );

  const [q, setQ] = useState(initial.q);
  const [collection, setCollection] = useState(initial.collection);
  const [tag, setTag] = useState(initial.tag);
  const [sort, setSort] = useState(initial.sort);

  const canLoadMore = items.length < total;

  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/merch-carousel-1.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/merch-carousel-2.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/merch-carousel-3.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/merch-carousel-4.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/merch-carousel-5.webp',
  ];

  const fetchProducts = async ({ offset = 0, append = false } = {}) => {
    const params = new URLSearchParams({
      division: 'designs',
      limit: String(PAGE_SIZE),
      offset: String(offset),
      sort: sort || 'new',
    });
    if (q) params.set('q', q);
    if (collection) params.set('collection', collection);
    if (tag) params.set('tag', tag);

    try {
      if (offset === 0) setLoading(true);
      else setFetchingMore(true);

      const res = await fetch(`/api/products?${params.toString()}`);
      const data = await res.json();

      const nextItemsRaw = Array.isArray(data?.items)
        ? data.items
        : Array.isArray(data)
        ? data
        : [];

      // Normalize the image field so cards never break
      const nextItems = nextItemsRaw.map((p) => ({
        ...p,
        display_image: pickImage(p),
      }));

      setItems((prev) => (append ? [...prev, ...nextItems] : nextItems));
      setTotal(Number(data?.total ?? nextItems.length));
    } catch (e) {
      console.error('Designs fetch error:', e);
      if (offset === 0) {
        const sample = [
          {
            id: 'fallback-tee',
            name: 'Sample T-Shirt',
            price: 29.99,
            display_image:
              'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/mock-tee-1.webp',
            division: 'designs',
            description: 'Fallback design merchandise. Made with 100% cotton for comfort.',
            printful_product_id: 'fallback-tee-id',
            productType: 'merch',
            metadata: { book: 'Sample', prompt: 1 },
          },
        ];
        setItems(sample);
        setTotal(sample.length);
      }
    } finally {
      setLoading(false);
      setFetchingMore(false);
    }
  };

  useEffect(() => {
    setQ(initial.q);
    setCollection(initial.collection);
    setTag(initial.tag);
    setSort(initial.sort || 'new');
    fetchProducts({ offset: 0, append: false });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [initial.q, initial.collection, initial.tag, initial.sort]);

  const applyFilters = (e) => {
    e?.preventDefault?.();
    const params = new URLSearchParams();
    params.set('division', 'designs');
    if (q) params.set('q', q);
    if (collection) params.set('collection', collection);
    if (tag) params.set('tag', tag);
    if (sort) params.set('sort', sort);
    router.push(`/designs?${params.toString()}`, undefined, { shallow: true });
  };

  const clearFilters = () => {
    setQ('');
    setCollection('');
    setTag('');
    setSort('new');
    router.push('/designs?division=designs', undefined, { shallow: true });
  };

  const loadMore = () => {
    if (!canLoadMore || fetchingMore) return;
    fetchProducts({ offset: items.length, append: true });
  };

  const collectionOptions = useMemo(() => {
    const set = new Set();
    items.forEach((p) => {
      if (p?.metadata?.book) set.add(p.metadata.book);
      if (p?.metadata?.series) set.add(p.metadata.series);
      if (p?.metadata?.drop) set.add(p.metadata.drop);
      if (p?.metadata?.year) set.add(String(p.metadata.year));
      if (p?.metadata?.prompt) set.add(`prompt-${p.metadata.prompt}`);
    });
    return Array.from(set);
  }, [items]);

  const tagOptions = useMemo(() => {
    const set = new Set();
    items.forEach((p) => (p?.tags || []).forEach((t) => set.add(t)));
    return Array.from(set);
  }, [items]);

  const handleAddToCart = (product) => {
    dispatch(
      addToCart({
        ...product,
        productType: 'merch',
        printful_product_id: product.printful_product_id,
        metadata: product.metadata || {},
      })
    );
    setShowModal(true);
    setTimeout(() => setShowModal(false), 1600);
  };

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16 text-center">
        Loading designs‚Ä¶
      </div>
    );
  }

  return (
    <>
      <Head>
        <title>Manyagi Designs ‚Äî Premium Apparel & Gear</title>
        <meta name="description" content="High-quality T-shirts, mugs, and prints inspired by our stories. Shop now for exclusive designs." />
      </Head>

      <Hero
        kicker="Designs"
        title="Elevate Your Style"
        lead="Discover apparel and gear crafted with premium materials, inspired by epic tales."
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <Link
          href="#products"
          className="btn bg-blue-600 text-white py-3 px-5 rounded hover:scale-105 transition"
        >
          Browse Collection
        </Link>
      </Hero>

      {/* Trust Badges */}
      <section className="container mx-auto px-4 py-8 flex justify-center gap-6">
        <div className="flex items-center gap-2">
          <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/></svg>
          Secure Payment
        </div>
        <div className="flex items-center gap-2">
          <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8z"/><path d="M3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15v3a2 2 0 01-2 2H5a2 2 0 01-2-2V5zM15 11h2a1 1 0 110 2h-2v-2z"/></svg>
          Free Shipping
        </div>
        <div className="flex items-center gap-2">
          <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/></svg>
          30-Day Returns
        </div>
      </section>

      {/* Filter Bar */}
      <section className="container mx-auto px-4 mt-8">
        <form
          onSubmit={applyFilters}
          className="flex flex-col md:flex-row gap-3 items-stretch md:items-end"
        >
          <div className="flex-1">
            <label className="block text-sm font-medium mb-1">Search</label>
            <input
              value={q}
              onChange={(e) => setQ(e.target.value)}
              placeholder="Search title, scene, book‚Ä¶"
              className="w-full border rounded px-3 py-2 dark:bg-gray-900"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Collection</label>
            <select
              value={collection}
              onChange={(e) => setCollection(e.target.value)}
              className="border rounded px-3 py-2 w-48 dark:bg-gray-900"
            >
              <option value="">All</option>
              {collectionOptions.map((opt) => (
                <option key={opt} value={opt}>
                  {opt}
                </option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Tag</label>
            <select
              value={tag}
              onChange={(e) => setTag(e.target.value)}
              className="border rounded px-3 py-2 w-48 dark:bg-gray-900"
            >
              <option value="">All</option>
              {tagOptions.map((t) => (
                <option key={t} value={t}>
                  {t}
                </option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Sort</label>
            <select
              value={sort}
              onChange={(e) => setSort(e.target.value)}
              className="border rounded px-3 py-2 w-40 dark:bg-gray-900"
            >
              <option value="new">Newest</option>
              <option value="price_asc">Price ‚Üë</option>
              <option value="price_desc">Price ‚Üì</option>
            </select>
          </div>
          <div className="flex gap-2">
            <button className="px-4 py-2 bg-blue-600 text-white rounded">
              Apply
            </button>
            <button
              type="button"
              onClick={clearFilters}
              className="px-4 py-2 bg-gray-200 rounded dark:bg-gray-800"
            >
              Clear
            </button>
          </div>
        </form>
      </section>

      {/* Products Grid */}
      <section id="products" className="container mx-auto px-4 py-10">
        {items.length === 0 ? (
          <div className="text-center py-20">
            <p className="text-lg">No products found for your filters.</p>
            <button
              onClick={clearFilters}
              className="mt-4 px-4 py-2 bg-blue-600 text-white rounded"
            >
              Reset Filters
            </button>
          </div>
        ) : (
          <>
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-5">
              {items.map((product) => (
                <Card
                  key={product.id}
                  title={product.name}
                  description={`${product.description} Made with premium cotton for lasting comfort.`}
                  image={product.display_image}
                  category="designs"
                  buyButton={product}
                  onBuy={() => handleAddToCart(product)}
                />
              ))}
            </div>

            {canLoadMore && (
              <div className="text-center mt-10">
                <button
                  disabled={fetchingMore}
                  onClick={loadMore}
                  className="px-5 py-2 rounded bg-gray-200 hover:bg-gray-300 dark:bg-gray-800 dark:hover:bg-gray-700"
                >
                  {fetchingMore ? 'Loading‚Ä¶' : 'Load more'}
                </button>
              </div>
            )}
          </>
        )}
      </section>

      {/* RESTORED: subscribe block from production */}
      <section id="subscribe" className="container mx-auto px-4 pb-16">
        <SubscriptionForm
          formId="8432506"
          uid="a194031db7"
          title="Stay Updated on New Designs"
          description="Get notified about new drops and exclusive offers."
        />
      </section>

      {showModal && (
        <div className="fixed inset-0 flex items-center justify-center bg-black/50 z-50">
          <div className="bg-white p-6 rounded shadow-lg text-center dark:bg-gray-900">
            <p className="text-base">Added to cart!</p>
            <Link
              href="/cart"
              className="text-blue-600 hover:underline mt-4 inline-block"
            >
              View Cart
            </Link>
          </div>
        </div>
      )}

      <Recommender />
    </>
  );
}


===== FILE: pages/events.js  (size=7187 bytes) =====
// pages/events.js
import Head from 'next/head';
import { useEffect, useState } from 'react';
import Hero from '@/components/Hero';

function formatRange(startISO, endISO) {
  if (!startISO && !endISO) return 'Date TBA';

  const start = startISO ? new Date(startISO) : null;
  const end = endISO ? new Date(endISO) : null;

  const fmt = (d) =>
    d.toLocaleString(undefined, {
      month: 'short',
      day: 'numeric',
      hour: 'numeric',
      minute: '2-digit',
    });

  if (start && end) {
    return `${fmt(start)} ‚Üí ${fmt(end)}`;
  }
  if (start && !end) {
    return fmt(start);
  }
  return fmt(end);
}

export default function EventsPage() {
  const [events, setEvents] = useState([]);
  const [loading, setLoading] = useState(true);

  // could later add filter like "tech", "media", etc.
  const [divisionFilter, setDivisionFilter] = useState('all');

  useEffect(() => {
    (async () => {
      try {
        const qs =
          divisionFilter === 'all'
            ? 'upcoming=1'
            : `division=${encodeURIComponent(
                divisionFilter
              )}&upcoming=1`;

        const res = await fetch(`/api/events?${qs}`);
        const json = await res.json();
        setEvents(Array.isArray(json) ? json : []);
      } catch (err) {
        console.error('events load error:', err);
        setEvents([]);
      } finally {
        setLoading(false);
      }
    })();
  }, [divisionFilter]);

  const heroImages = [
    // totally optional, reuse anything from storage so the hero feels alive
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/video-carousel-3.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/app-carousel-1.webp',
  ];

  return (
    <>
      <Head>
        <title>Manyagi Events ‚Äî Live Drops & Appearances</title>
        <meta
          name="description"
          content="Launches, signings, demos, reveals, and appearances across Manyagi divisions."
        />
      </Head>

      <Hero
        kicker="Events"
        title="Live Drops & Appearances"
        lead="See what's coming next across Realty, Media, Capital, and Tech."
        carouselImages={heroImages}
        height="h-[400px]"
      >
        <div className="flex flex-col sm:flex-row gap-2">
          <button
            onClick={() => setDivisionFilter('all')}
            className={`px-4 py-2 rounded text-sm font-semibold ${
              divisionFilter === 'all'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-black hover:bg-gray-300'
            }`}
          >
            All
          </button>

          <button
            onClick={() => setDivisionFilter('tech')}
            className={`px-4 py-2 rounded text-sm font-semibold ${
              divisionFilter === 'tech'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-black hover:bg-gray-300'
            }`}
          >
            Tech
          </button>

          <button
            onClick={() => setDivisionFilter('media')}
            className={`px-4 py-2 rounded text-sm font-semibold ${
              divisionFilter === 'media'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-black hover:bg-gray-300'
            }`}
          >
            Media
          </button>

          <button
            onClick={() => setDivisionFilter('capital')}
            className={`px-4 py-2 rounded text-sm font-semibold ${
              divisionFilter === 'capital'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-black hover:bg-gray-300'
            }`}
          >
            Capital
          </button>

          <button
            onClick={() => setDivisionFilter('realty')}
            className={`px-4 py-2 rounded text-sm font-semibold ${
              divisionFilter === 'realty'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-black hover:bg-gray-300'
            }`}
          >
            Realty
          </button>
        </div>
      </Hero>

      <section className="container mx-auto px-4 py-16 max-w-4xl">
        {loading ? (
          <div className="text-center text-lg">
            Loading upcoming events‚Ä¶
          </div>
        ) : events.length === 0 ? (
          <div className="text-center text-lg opacity-70">
            No upcoming events.
          </div>
        ) : (
          <ul className="space-y-6">
            {events.map((ev) => (
              <li
                key={ev.id}
                className="rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 p-4 shadow-sm"
              >
                {/* Title + division badge */}
                <div className="flex flex-wrap items-start justify-between gap-2 mb-2">
                  <h2 className="text-xl font-bold text-black dark:text-white">
                    {ev.title || 'Untitled Event'}
                  </h2>
                  <span className="text-[11px] px-2 py-1 rounded bg-black text-white dark:bg-gray-700 dark:text-white font-semibold uppercase tracking-wide">
                    {ev.division || 'site'}
                  </span>
                </div>

                {/* Time range */}
                <div className="text-sm font-medium text-blue-600 dark:text-blue-400 mb-2">
                  {formatRange(ev.start_date, ev.end_date)}
                </div>

                {/* Description */}
                {ev.description && (
                  <p className="text-sm text-gray-800 dark:text-gray-200 whitespace-pre-line mb-3">
                    {ev.description}
                  </p>
                )}

                {/* Optional location/map if provided in metadata */}
                {ev.metadata &&
                  typeof ev.metadata.location === 'string' &&
                  ev.metadata.location.trim().length > 0 && (
                    <div className="mt-4">
                      <div className="text-xs font-semibold mb-1">
                        Location
                      </div>
                      <div className="w-full h-48 bg-gray-200 rounded overflow-hidden border border-gray-300 dark:border-gray-700">
                        <iframe
                          className="w-full h-full"
                          src={`https://maps.google.com/maps?q=${encodeURIComponent(
                            ev.metadata.location
                          )}&output=embed`}
                          loading="lazy"
                          referrerPolicy="no-referrer-when-downgrade"
                        />
                      </div>
                      <div className="text-[11px] text-gray-600 dark:text-gray-400 mt-1">
                        {ev.metadata.location}
                      </div>
                    </div>
                  )}
              </li>
            ))}
          </ul>
        )}
      </section>
    </>
  );
}


===== FILE: pages/index.js  (size=9862 bytes) =====
import Head from 'next/head';
import Link from 'next/link';
import { useDispatch } from 'react-redux';
import { addToCart } from '../lib/cartSlice';
import Hero from '../components/Hero';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import Card from '../components/Card';
import { useEffect, useState } from 'react';

function getCfgImg(val, fallback) {
  // site_config values might be a plain string URL or { file_url }
  if (!val) return fallback;
  if (typeof val === 'string') return val;
  if (typeof val === 'object' && val.file_url) return val.file_url;
  return fallback;
}

export default function Home() {
  const dispatch = useDispatch();
  const [siteConfig, setSiteConfig] = useState({});
  const [products, setProducts] = useState([]);

  useEffect(() => {
    (async () => {
      try {
        // 1) site config
        const cfg = await fetch('/api/site-config')
          .then((r) => r.json())
          .catch(() => ({}));
        setSiteConfig(cfg || {});

        // 2) products (accept both array and { items, total })
        const res = await fetch('/api/products?limit=12');
        const json = await res.json().catch(() => []);
        const items = Array.isArray(json) ? json : Array.isArray(json.items) ? json.items : [];

        // normalize image field so Card gets a valid image
        const normalized = items.map((p) => ({
          ...p,
          image_url: p.image_url || p.thumbnail_url || p.image || p.imageUrl || p.display_image || '',
        }));

        setProducts(normalized);
      } catch (e) {
        console.error('Home fetch error:', e);
        setProducts([]); // stay safe
      }
    })();
  }, []);

  const carouselImages = siteConfig.carousel_images || [
    '/images/home-carousel-1.webp',
    '/images/home-carousel-2.webp',
    '/images/home-carousel-3.webp',
  ];
  const heroImage = getCfgImg(siteConfig.hero, '/videos/hero-bg.mp4');

  // Division card images with safe fallbacks
  const publishingImg = getCfgImg(siteConfig.publishing_hero, '/images/legacy-chapter-1.webp');
  const designsImg = getCfgImg(siteConfig.designs_hero, '/images/mock-tee-1.webp');
  const capitalImg = getCfgImg(siteConfig.capital_hero, '/images/chart-hero.webp');
  const techImg = getCfgImg(siteConfig.tech_hero, '/images/daito-screenshot.webp');
  const mediaImg = getCfgImg(siteConfig.media_hero, '/images/og-media.webp');

  // IMPORTANT: use Supabase URL as fallback so it won't 404 locally
  const realtyImg = getCfgImg(
    siteConfig.realty_hero,
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/realty-hero.webp'
  );

  return (
    <>
      <Head>
        <title>Manyagi ‚Äî Creativity Meets Innovation</title>
        <meta
          name="description"
          content="Manyagi unifies Publishing, Designs, Capital, Tech, and Media."
        />
        {getCfgImg(siteConfig.favicon, null) && (
          <link rel="icon" href={getCfgImg(siteConfig.favicon)} />
        )}
      </Head>

      <Hero
        kicker="Welcome"
        title="Explore Our Worlds"
        lead="One HQ powering books, fashion, trading, audio, and apps."
        carouselImages={carouselImages}
        videoSrc={heroImage}
        height="h-[600px]"
      >
        <Link
          href="#divisions"
          className="btn bg-blue-600 text-white py-2 px-4 rounded hover:scale-105 transition"
        >
          Explore
        </Link>
      </Hero>

      <section
        id="divisions"
        className="container mx-auto px-4 py-16 grid grid-cols-1 md:grid-cols-3 gap-5"
      >
        <Card
          title="Publishing"
          description="Two novels + poetry. Read the opening chapter."
          image={publishingImg}
          link="/publishing"
          category="publishing"
        />
        <Card
          title="Designs"
          description="Wear our stories with T-shirts, mugs."
          image={designsImg}
          link="/designs"
          category="designs"
        />
        <Card
          title="Capital"
          description="Trading signals and bot charts for success."
          image={capitalImg}
          link="/capital"
          category="capital"
        />
        <Card
          title="Tech"
          description="Apps for commerce and community."
          image={techImg}
          link="/tech"
          category="tech"
        />
        <Card
          title="Media"
          description="Stories in motion with videos and audio."
          image={mediaImg}
          link="/media"
          category="media"
        />
        <Card
          title="Realty"
          description="Premium properties and rentals."
          image={realtyImg}
          link="/realty"
          category="realty"
        />
      </section>

      <section id="featured" className="container mx-auto px-4 py-16">
        <h2 className="text-3xl font-bold mb-6">Featured Products</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
          {(Array.isArray(products) ? products : []).slice(0, 3).map((product) => {
            if (product.division === 'publishing') {
              const m = product.metadata || {};
              const buyUrl =
                m.amazon_url ||
                m.kindle_url ||
                m.paperback_url ||
                m.store_url ||
                null;

              const alsoLinks = [
                m.kindle_url ? { label: "Kindle", url: m.kindle_url } : null,
                m.paperback_url ? { label: "Paperback", url: m.paperback_url } : null,
              ].filter(Boolean);

              const chips = [
                m.format ? String(m.format).toUpperCase() : null,
                m.year ? `Y${m.year}` : null,
              ].filter(Boolean);

              return (
                <Card
                  key={product.id}
                  title={product.name}
                  description={product.description}
                  image={product.image_url}
                  category={product.division}
                  tags={Array.isArray(product.tags) ? product.tags : []}
                >
                  {/* Meta chips */}
                  {chips.length > 0 && (
                    <div className="flex flex-wrap gap-2 justify-center mb-2">
                      {chips.map((c) => (
                        <span key={c} className="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200">
                          {c}
                        </span>
                      ))}
                    </div>
                  )}

                  {/* Primary CTAs */}
                  <div className="flex flex-wrap gap-3 mt-2 justify-center">
                    {buyUrl && (
                      <a
                        href={buyUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition"
                      >
                        Get Your Copy
                      </a>
                    )}
                    {m.pdf_url && (
                      <a
                        href={m.pdf_url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="btn bg-gray-700 text-white py-2 px-4 rounded hover:bg-gray-800 transition"
                      >
                        Preview Chapter 1
                      </a>
                    )}
                  </div>

                  {/* Secondary storefront links */}
                  {alsoLinks.length > 0 && (
                    <div className="text-xs text-gray-600 mt-3">
                      Also available:{' '}
                      {alsoLinks.map((l, i) => (
                        <a
                          key={l.label}
                          href={l.url}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="underline hover:text-blue-700"
                        >
                          {l.label}{i < alsoLinks.length - 1 ? ', ' : ''}
                        </a>
                      ))}
                    </div>
                  )}
                </Card>
              );
            }

            // Non-publishing products keep buyButton
            return (
              <Card
                key={product.id}
                title={product.name}
                description={product.description}
                image={product.image_url}
                category={product.division}
                buyButton={product}
                onBuy={() =>
                  dispatch(
                    addToCart({
                      ...product,
                      productType:
                        product.division === 'designs'
                          ? 'merch'
                          : product.division === 'capital'
                          ? 'download'
                          : 'book',
                    })
                  )
                }
              />
            );
          })}
        </div>
      </section>

      <section id="subscribe" className="container mx-auto px-4 py-16">
        <SubscriptionForm
          formId="8427635"
          uid="db12290300"
          title="Get Chapter 1 + Drops + Early Access"
          description="Be the first to know about updates."
        />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/links.js  (size=3725 bytes) =====
import Head from 'next/head';
import Link from 'next/link';
import { FaInstagram, FaTiktok, FaYoutube, FaTwitter, FaLinkedin, FaPinterest } from 'react-icons/fa';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import Hero from '../components/Hero';

export default function Links() {
  const socialLinks = [
    { platform: 'Instagram', handle: 'https://instagram.com/manyagi.official', icon: <FaInstagram size={24} /> },
    { platform: 'Twitter', handle: 'https://x.com/ManyagiOfficial', icon: <FaTwitter size={24} /> },
    { platform: 'YouTube', handle: 'https://youtube.com/@ManyagiOfficial', icon: <FaYoutube size={24} /> },
    { platform: 'LinkedIn', handle: 'https://linkedin.com/company/manyagi', icon: <FaLinkedin size={24} /> },
    { platform: 'Pinterest', handle: 'https://pinterest.com/ManyagiOfficial', icon: <FaPinterest size={24} /> },
    { platform: 'TikTok', handle: 'https://tiktok.com/@manyagi.official', icon: <FaTiktok size={24} /> },
  ];

  const divisionLinks = [
    { name: 'Publishing', url: '/publishing', description: 'Novels and poetry' },
    { name: 'Designs', url: '/designs', description: 'T-shirts, mugs, and prints' },
    { name: 'Capital', url: '/capital', description: 'Trading signals and bots' },
    { name: 'Tech', url: '/tech', description: 'Innovative apps' },
    { name: 'Media', url: '/media', description: 'Videos and audio' },
    { name: 'Realty', url: '/realty', description: 'Premium properties' },
  ];

  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/og-home.webp',
  ];

  return (
    <>
      <Head>
        <title>Manyagi Links ‚Äî Connect with Us</title>
        <meta name="description" content="Find all our social media and division links." />
      </Head>
      <Hero
        kicker="Links"
        title="Connect with Manyagi"
        lead="Explore our social media and divisions."
        carouselImages={carouselImages}
        height="h-[600px]"
      />

      <section className="container mx-auto px-4 py-16">
        <h2 className="text-3xl font-bold mb-6 text-center">Social Media</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-2xl mx-auto">
          {socialLinks.map((link) => (
            <a
              key={link.platform}
              href={link.handle}
              target="_blank"
              rel="noopener noreferrer"
              className="flex items-center gap-2 p-4 border rounded hover:bg-gray-100"
            >
              {link.icon}
              <span>{link.platform}</span>
            </a>
          ))}
        </div>
      </section>

      <section className="container mx-auto px-4 py-16">
        <h2 className="text-3xl font-bold mb-6 text-center">Our Divisions</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-4xl mx-auto">
          {divisionLinks.map((link) => (
            <Link
              key={link.name}
              href={link.url}
              className="p-4 border rounded hover:bg-gray-100"
            >
              <h3 className="text-xl font-bold">{link.name}</h3>
              <p className="text-gray-600">{link.description}</p>
            </Link>
          ))}
        </div>
      </section>

      <section id="subscribe" className="container mx-auto px-4 py-16">
        <SubscriptionForm
          formId="8427853"
          uid="637df68a06"
          title="Stay Connected"
          description="Join our community for updates and insights."
        />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/login.js  (size=3735 bytes) =====
import Head from 'next/head';
import { useState } from 'react';
import { useRouter } from 'next/router';
import { supabase } from '@/lib/supabase';
import Hero from '../components/Hero';  // Add Hero for background

export default function Login() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isSignup, setIsSignup] = useState(false);
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  const handleAuth = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      let data, authError;
      if (isSignup) {
        ({ data, error: authError } = await supabase.auth.signUp({ email, password }));
        if (authError) throw authError;
        await supabase.from('users').insert({
          id: data.user.id,
          email,
          role: 'user',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        });
      } else {
        ({ data, error: authError } = await supabase.auth.signInWithPassword({ email, password }));
        if (authError) throw authError;
      }
      router.push('/dashboard');
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const handleGoogleLogin = async () => {
    try {
      const { error } = await supabase.auth.signInWithOAuth({ provider: 'google' });
      if (error) throw error;
    } catch (err) {
      setError(err.message);
    }
  };

  return (
    <>
      <Head>
        <title>{isSignup ? 'Sign Up' : 'Login'} - Manyagi</title>
      </Head>
      <Hero
        kicker={isSignup ? "Join Us" : "Welcome Back"}
        title={isSignup ? "Sign Up" : "Login"}
        lead={isSignup ? "Create your Manyagi account." : "Access your dashboard."}
        carouselImages={[]}  // Optional, or add images
        height="h-screen"  // Full screen for login
      >
        <div className="card max-w-md mx-auto bg-white text-black glass p-8 rounded-lg shadow-xl">
          {error && <p className="text-red-500 mb-4 text-center">{error}</p>}
          <form onSubmit={handleAuth} className="space-y-4">
            <input
              type="email"
              placeholder="Email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full p-3 border rounded bg-white text-black"
              required
            />
            <input
              type="password"
              placeholder="Password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full p-3 border rounded bg-white text-black"
              required
            />
            <button
              type="submit"
              disabled={loading}
              className="w-full p-3 bg-black text-white rounded disabled:opacity-50 hover:bg-gray-800 transition"
            >
              {loading ? 'Processing...' : isSignup ? 'Sign Up' : 'Login'}
            </button>
          </form>
          <button
            onClick={handleGoogleLogin}
            className="mt-4 w-full p-3 bg-blue-500 text-white rounded hover:bg-blue-600 transition"
          >
            {isSignup ? 'Sign Up' : 'Login'} with Google
          </button>
          <button
            onClick={() => setIsSignup(!isSignup)}
            className="mt-4 text-blue-500 underline w-full text-center"
          >
            {isSignup ? 'Switch to Login' : 'Switch to Sign Up'}
          </button>
        </div>
      </Hero>
    </>
  );
}


===== FILE: pages/media.js  (size=7257 bytes) =====
// pages/media.js
import Head from 'next/head';
import Link from 'next/link';
import { useEffect, useState } from 'react';
import Hero from '../components/Hero';
import Recommender from '../components/Recommender';

// helper to pick an image for cards
function pickCardImage(post) {
  return (
    post.thumbnail_url ||
    post.featured_image ||
    (post.metadata && post.metadata.cover_url) ||
    '/placeholder.png'
  );
}

// try to guess if we can embed this media URL (YouTube / etc)
function MediaEmbed({ mediaUrl }) {
  if (!mediaUrl) return null;

  // very simple YouTube detection
  const isYouTube =
    mediaUrl.includes('youtube.com') || mediaUrl.includes('youtu.be');

  if (isYouTube) {
    // turn a YouTube watch URL into an embed URL if needed
    let embed = mediaUrl;
    if (mediaUrl.includes('watch?v=')) {
      const videoId = mediaUrl.split('watch?v=')[1].split('&')[0];
      embed = `https://www.youtube.com/embed/${videoId}`;
    }
    return (
      <div className="w-full aspect-video bg-black rounded overflow-hidden border border-gray-300 dark:border-gray-700">
        <iframe
          src={embed}
          title="Media Preview"
          className="w-full h-full"
          allowFullScreen
        />
      </div>
    );
  }

  // fallback: just show a link button
  return (
    <a
      href={mediaUrl}
      target="_blank"
      rel="noopener noreferrer"
      className="inline-block bg-blue-600 text-white text-sm font-semibold py-2 px-3 rounded hover:bg-blue-700 transition"
    >
      View Media
    </a>
  );
}

export default function MediaPage() {
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(true);

  // load posts where division='media' from the API
  useEffect(() => {
    (async () => {
      try {
        const res = await fetch('/api/posts?division=media');
        const json = await res.json();

        // /api/posts returns an array of published posts with fields:
        // id,title,slug,excerpt,created_at,featured_image,content,status
        // We aren't guaranteed thumbnail_url unless admin set it, so we normalize
        const list = Array.isArray(json)
          ? json.map((p) => ({
              ...p,
              card_img: pickCardImage(p),
              media_type: p.metadata?.media_type || '',
              media_url: p.metadata?.media_url || '',
            }))
          : [];

        setItems(list);
      } catch (err) {
        console.error('media fetch error:', err);
        setItems([]);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/video-carousel-1.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/video-carousel-2.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/video-carousel-3.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/video-carousel-4.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/video-carousel-5.webp',
  ];

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16 text-center">
        Loading media...
      </div>
    );
  }

  return (
    <>
      <Head>
        <title>Manyagi Media ‚Äî Stories in Motion</title>
        <meta
          name="description"
          content="Playlists, podcasts, reels, and audiobooks from the Manyagi universe."
        />
      </Head>

      <Hero
        kicker="Media"
        title="Stories in Motion"
        lead="Watch, listen, and explore the world through our voice."
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <Link
          href="#library"
          className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition"
        >
          Browse Library
        </Link>
      </Hero>

      {/* MEDIA GRID */}
      <section
        id="library"
        className="container mx-auto px-4 py-16 grid grid-cols-1 md:grid-cols-3 gap-8"
      >
        {items.length === 0 ? (
          <div className="col-span-full text-center text-lg">
            No media yet. Check back soon.
          </div>
        ) : (
          items.map((item) => (
            <div
              key={item.id}
              className="bg-white dark:bg-gray-900 rounded shadow border border-gray-200 dark:border-gray-700 flex flex-col overflow-hidden"
            >
              {/* image */}
              <div className="w-full h-48 bg-gray-200 dark:bg-gray-800 overflow-hidden">
                <img
                  src={item.card_img}
                  alt={item.title}
                  className="w-full h-full object-cover"
                />
              </div>

              {/* body */}
              <div className="p-4 flex flex-col gap-3 flex-1">
                <div className="flex flex-wrap gap-2 text-[10px] font-semibold">
                  {item.media_type && (
                    <span className="inline-block bg-gray-900 text-white px-2 py-1 rounded uppercase tracking-wide">
                      {item.media_type}
                    </span>
                  )}
                  <span className="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                    Manyagi Media
                  </span>
                </div>

                <h2 className="text-lg font-bold leading-snug text-gray-900 dark:text-gray-100">
                  {item.title}
                </h2>

                {item.excerpt && (
                  <p className="text-sm text-gray-700 dark:text-gray-300 line-clamp-4">
                    {item.excerpt}
                  </p>
                )}

                {/* inline preview if it's something embeddable like YT */}
                {item.media_url && (
                  <div className="mt-2">
                    <MediaEmbed mediaUrl={item.media_url} />
                  </div>
                )}

                <div className="mt-auto flex flex-col gap-2 text-sm">
                  {/* View details page */}
                  <Link
                    className="inline-block text-blue-600 dark:text-blue-400 underline font-semibold"
                    href={`/media/${item.slug}`}
                  >
                    View Details ‚Üí
                  </Link>

                  {/* direct link to hosted media (if provided) */}
                  {item.media_url && (
                    <a
                      className="inline-block text-gray-700 dark:text-gray-300 text-xs underline"
                      href={item.media_url}
                      target="_blank"
                      rel="noopener noreferrer"
                    >
                      Open Original Source
                    </a>
                  )}
                </div>
              </div>
            </div>
          ))
        )}
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/media/[slug].js  (size=4537 bytes) =====
// pages/media/[slug].js
import Head from 'next/head';
import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';

// helper to pick a hero image
function pickHero(post) {
  return (
    post.featured_image ||
    post.thumbnail_url ||
    (post.metadata && post.metadata.cover_url) ||
    '/placeholder.png'
  );
}

// same embed helper logic as list page
function MediaEmbed({ mediaUrl }) {
  if (!mediaUrl) return null;

  const isYouTube =
    mediaUrl.includes('youtube.com') || mediaUrl.includes('youtu.be');

  if (isYouTube) {
    let embed = mediaUrl;
    if (mediaUrl.includes('watch?v=')) {
      const videoId = mediaUrl.split('watch?v=')[1].split('&')[0];
      embed = `https://www.youtube.com/embed/${videoId}`;
    }
    return (
      <div className="w-full aspect-video bg-black rounded overflow-hidden border border-gray-300 dark:border-gray-700 mb-6">
        <iframe
          src={embed}
          title="Media Player"
          className="w-full h-full"
          allowFullScreen
        />
      </div>
    );
  }

  // fallback if not YouTube
  return (
    <div className="mb-6">
      <a
        href={mediaUrl}
        target="_blank"
        rel="noopener noreferrer"
        className="inline-block bg-blue-600 text-white text-sm font-semibold py-2 px-3 rounded hover:bg-blue-700 transition"
      >
        Open / Play Media
      </a>
    </div>
  );
}

export default function MediaDetailPage() {
  const router = useRouter();
  const { slug } = router.query;

  const [post, setPost] = useState(null);
  const [loading, setLoading] = useState(true);

  // fetch single media post by slug
  useEffect(() => {
    if (!slug) return;
    (async () => {
      try {
        const res = await fetch(`/api/posts?division=media&slug=${slug}`);
        const json = await res.json();

        // normalize result
        let row = null;
        if (Array.isArray(json)) {
          row = json[0] || null;
        } else if (json.post) {
          row = json.post;
        } else if (json.items) {
          row = json.items[0] || null;
        }

        setPost(row);
      } catch (err) {
        console.error('media slug fetch error:', err);
        setPost(null);
      } finally {
        setLoading(false);
      }
    })();
  }, [slug]);

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16">Loading‚Ä¶</div>
    );
  }

  if (!post) {
    return (
      <div className="container mx-auto px-4 py-16">
        Media item not found.
      </div>
    );
  }

  const heroImg = pickHero(post);
  const mediaType = post.metadata?.media_type;
  const mediaUrl = post.metadata?.media_url;

  return (
    <>
      <Head>
        <title>{post.title} ‚Äî Manyagi Media</title>
        <meta
          name="description"
          content={
            post.excerpt || 'Manyagi Media feature'
          }
        />
      </Head>

      <section className="container mx-auto px-4 pb-32 pt-16 md:pb-16 max-w-3xl">
        {/* Title */}
        <h1 className="text-4xl font-bold mb-4">
          {post.title}
        </h1>

        {/* Badges */}
        <div className="flex flex-wrap gap-2 text-xs font-semibold mb-6">
          {mediaType && (
            <span className="inline-block bg-gray-900 text-white px-2 py-1 rounded uppercase tracking-wide">
              {mediaType}
            </span>
          )}
          <span className="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
            Manyagi Media
          </span>
        </div>

        {/* Hero image */}
        <div className="w-full h-64 md:h-[360px] rounded overflow-hidden bg-gray-200 mb-6 border border-gray-300 dark:border-gray-700">
          <img
            src={heroImg}
            alt={post.title}
            className="w-full h-full object-cover"
          />
        </div>

        {/* Player / CTA */}
        <MediaEmbed mediaUrl={mediaUrl} />

        {/* Excerpt */}
        {post.excerpt && (
          <p className="mb-6 text-lg text-gray-800 dark:text-gray-200 whitespace-pre-line">
            {post.excerpt}
          </p>
        )}

        {/* Content */}
        {post.content && (
          <article className="prose prose-neutral dark:prose-invert max-w-none whitespace-pre-line">
            {post.content}
          </article>
        )}
      </section>
    </>
  );
}


===== FILE: pages/privacy.js  (size=1152 bytes) =====
// pages/privacy.js
import Head from 'next/head';
import Link from 'next/link';
import Hero from '../components/Hero';

export default function Privacy() {
  return (
    <>
      <Head>
        <title>Manyagi ‚Äî Privacy Policy</title>
        <meta name="description" content="Read Manyagi‚Äôs Privacy Policy." />
      </Head>
      <Hero
        kicker="Privacy"
        title="Privacy Policy"
        lead="Learn how we protect your data."
        carouselImages={['/images/og-home.webp']}
        height="h-[600px]"
      />
      <section className="container mx-auto px-4 py-16 text-sm space-y-4">
        <h2 className="text-xl font-bold">1. Data Collection</h2>
        <p>We collect minimal data for services like subscriptions and orders.</p>
        <h2 className="text-xl font-bold">2. GDPR Compliance</h2>
        <p>We protect your data under GDPR. Contact us at <a href="mailto:support@manyagi.net" className="text-blue-600 hover:underline">support@manyagi.net</a>.</p>
        <h2 className="text-xl font-bold">3. Cookies</h2>
        <p>We use cookies for analytics.</p>
      </section>
    </>
  );
}


===== FILE: pages/products.js  (size=2200 bytes) =====
import Head from 'next/head';
import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabase';

export default function Products() {
  const [products, setProducts] = useState([]);
  const [division, setDivision] = useState('all');

  useEffect(() => {
    (async () => {
      let query = supabase.from('products').select('*');
      if (division !== 'all') query = query.eq('division', division);
      const { data } = await query;
      setProducts(data || []);
    })();
  }, [division]);

  const handleBuy = async (productId) => {
    const { data: session } = await supabase.auth.getSession();
    const response = await fetch('/api/stripe/charge', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ productId, userId: session?.session?.user?.id })
    });
    const { url } = await response.json();
    window.location.href = url; // Redirect to Stripe checkout
  };

  return (
    <>
      <Head>
        <title>Products - Manyagi</title>
      </Head>
      <div className="container mx-auto px-4 py-8">
        <h1 className="text-4xl font-bold mb-4">Products</h1>
        <select onChange={(e) => setDivision(e.target.value)} className="p-2 border rounded mb-4">
          <option value="all">All Divisions</option>
          <option value="publishing">Publishing</option>
          <option value="designs">Designs</option>
          <option value="capital">Capital</option>
          <option value="tech">Tech</option>
          <option value="media">Media</option>
          <option value="realty">Realty</option>
        </select>
        <ul className="grid grid-cols-1 md:grid-cols-3 gap-5">
          {products.map((p) => (
            <li key={p.id} className="border p-4 rounded">
              <h2 className="text-2xl">{p.name} - ${p.price} ({p.division})</h2>
              <button
                onClick={() => handleBuy(p.id)}
                className="mt-2 p-2 bg-green-500 text-white rounded"
              >
                Buy Now
              </button>
            </li>
          ))}
        </ul>
      </div>
    </>
  );
}


===== FILE: pages/publishing.js  (size=9672 bytes) =====
import Head from 'next/head';
import Link from 'next/link';
import { useEffect, useState, useMemo } from 'react';
import { useDispatch } from 'react-redux';
import { addToCart } from '../lib/cartSlice';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import Hero from '../components/Hero';
import Card from '../components/Card';
import { supabase } from '@/lib/supabase';

const asList = (v) => (Array.isArray(v) ? v : Array.isArray(v?.items) ? v.items : []);
const pickImage = (p) => p?.thumbnail_url || p?.display_image || p?.image_url || p?.image || '/placeholder.png';

export default function Publishing() {
  const dispatch = useDispatch();
  const [products, setProducts] = useState([]);
  const [carouselImages, setCarouselImages] = useState([]);
  const [total, setTotal] = useState(0);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    (async () => {
      try {
        // Fetch products
        const res = await fetch('/api/products?division=publishing');
        const json = await res.json();
        const list = asList(json).map((p) => ({ ...p, display_image: pickImage(p) }));
        setProducts(list);
        setTotal(Number(json?.total ?? list.length));

        // Fetch carousel images from assets
        const { data: assetData } = await supabase
          .from('assets')
          .select('file_url')
          .eq('division', 'publishing')
          .eq('purpose', 'carousel')
          .order('created_at', { ascending: false });
        const fetchedImages = assetData?.map((d) => d.file_url) || [];
        setCarouselImages(
          fetchedImages.length > 0
            ? fetchedImages
            : [
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/book-carousel-1.webp',
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/book-carousel-2.webp',
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/book-carousel-3.webp',
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/book-carousel-4.webp',
              ]
        );
      } catch (err) {
        console.error('Publishing fetch error:', err);
        setProducts([]);
        setTotal(0);
        setCarouselImages([]); // No fallback here to encourage admin uploads
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const handleAddToCart = (product) => {
    dispatch(addToCart({ ...product, productType: 'book' }));
  };

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16 text-center">
        Loading books...
      </div>
    );
  }

  const list = asList(products);

  return (
    <>
      <Head>
        <title>Manyagi Publishing ‚Äî Discover Epic Tales</title>
        <meta name="description" content="Immerse yourself in captivating novels and poetry by D.N. Manyagi." />
      </Head>

      <Hero
        kicker="Publishing"
        title="Uncover Hidden Worlds"
        lead="Dive into stories that transport you to new realms ‚Äî and take a piece home."
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <Link href="#books" className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition">
          Explore Our Library
        </Link>
      </Hero>

      {/* Testimonials */}
      <section className="container mx-auto px-4 py-8">
        <h2 className="text-3xl font-bold mb-6 text-center">What Readers Say</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
          <div className="card p-4 text-center">
            <p>"A masterpiece of fantasy!"</p>
            <p className="text-sm mt-2">- Jenna Bush Hager</p>
          </div>
          <div className="card p-4 text-center">
            <p>"Captivating from page one."</p>
            <p className="text-sm mt-2">- Anonymous Reader</p>
          </div>
          <div className="card p-4 text-center">
            <p>"Poetry that resonates."</p>
            <p className="text-sm mt-2">- Literary Critic</p>
          </div>
        </div>
      </section>

      <section id="books" className="container mx-auto px-4 py-16 grid grid-cols-1 md:grid-cols-3 gap-5">
        {list.length === 0 ? (
          <div className="col-span-full text-center text-lg">
            No publishing items found.
          </div>
        ) : (
          list.map((product) => {
            const m = product.metadata || {};
            const buyUrl =
              m.amazon_url ||
              m.kindle_url ||
              m.paperback_url ||
              m.store_url ||
              null;

            const alsoLinks = [
              m.kindle_url ? { label: "Kindle", url: m.kindle_url } : null,
              m.paperback_url ? { label: "Paperback", url: m.paperback_url } : null,
            ].filter(Boolean);

            const chips = [
              m.format ? String(m.format).toUpperCase() : null,
              m.year ? `Y${m.year}` : null,
            ].filter(Boolean);

            return (
              <Card
                key={product.id}
                title={product.name}
                description={product.description}
                image={product.display_image || pickImage(product)}
                category="publishing"
                tags={Array.isArray(product.tags) ? product.tags : []}
              >
                {/* Meta chips */}
                {chips.length > 0 && (
                  <div className="flex flex-wrap gap-2 justify-center mb-2">
                    {chips.map((c) => (
                      <span key={c} className="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-200">
                        {c}
                      </span>
                    ))}
                  </div>
                )}

                {/* Primary CTAs */}
                <div className="flex flex-wrap gap-3 mt-2 justify-center">
                  {buyUrl && (
                    <a
                      href={buyUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition"
                    >
                      Get Your Copy
                    </a>
                  )}
                  {m.pdf_url && (
                    <a
                      href={m.pdf_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="btn bg-gray-700 text-white py-2 px-4 rounded hover:bg-gray-800 transition"
                    >
                      Preview Chapter 1
                    </a>
                  )}
                </div>

                {/* Secondary storefront links */}
                {alsoLinks.length > 0 && (
                  <div className="text-xs text-gray-600 mt-3">
                    Also available:{' '}
                    {alsoLinks.map((l, i) => (
                      <a
                        key={l.label}
                        href={l.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="underline hover:text-blue-700"
                      >
                        {l.label}{i < alsoLinks.length - 1 ? ', ' : ''}
                      </a>
                    ))}
                  </div>
                )}
              </Card>
            );
          })
        )}

        {/* Free chapter promo card (evergreen) */}
        <Card
          title="Legacy - Chapter 1 (Free)"
          description="Sample the first chapter at no cost."
          image="https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/legacy-chapter-1.webp"
          category="publishing"
        >
          <a
            href="https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/pdfs/Legacy_of_the_Hidden_Clans_(Chapter_1)_by_D.N._Manyagi.pdf"
            className="btn bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 transition"
            target="_blank"
            rel="noopener noreferrer"
          >
            Download Free Preview
          </a>
        </Card>
      </section>

      {/* Curated Recommendations */}
      <section className="container mx-auto px-4 py-8">
        <h2 className="text-3xl font-bold mb-6 text-center">Our Top Picks</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
          {products.slice(0, 3).map((p) => (
            <Card
              key={p.id}
              title={p.name}
              description={p.description}
              image={p.display_image}
            />
          ))}
          {products.length < 3 && <p className="col-span-full text-center opacity-70">Add more products in admin to populate recommendations.</p>}
        </div>
      </section>

      {/* RESTORED: subscribe block from production */}
      <section id="subscribe" className="container mx-auto px-4 py-16">
        <SubscriptionForm
          formId="8427848"
          uid="637df68a01"
          title="Subscribe to Publishing Updates"
          description="Get new chapters, poetry releases."
        />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/r/[code].js  (size=1020 bytes) =====
// pages/r/[code].js
import { useRouter } from 'next/router';
import { useEffect } from 'react';

export default function AffiliateRedirect() {
  const router = useRouter();
  const { code } = router.query;

  useEffect(() => {
    if (!code) return;
    try {
      // Store cookie for 30 days
      document.cookie = `affiliate=${encodeURIComponent(
        code
      )}; path=/; max-age=${60 * 60 * 24 * 30}; SameSite=Lax`;

      // Redirect user after short delay (optional)
      setTimeout(() => {
        router.replace('/'); // or /capital, /tech, etc.
      }, 500);
    } catch (err) {
      console.error('Affiliate redirect error:', err);
    }
  }, [code]);

  return (
    <div className="flex flex-col items-center justify-center min-h-screen text-center p-8">
      <h1 className="text-2xl font-bold mb-2">
        Thanks for supporting our partners!
      </h1>
      <p className="opacity-80">
        Redirecting you to Manyagi HQ‚Ä¶
      </p>
    </div>
  );
}


===== FILE: pages/realty.js  (size=6117 bytes) =====
// pages/realty.js
import Head from 'next/head';
import Link from 'next/link';
import { useEffect, useState } from 'react';
import Hero from '../components/Hero';
import Card from '../components/Card';
import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import RealtyLeadForm from '../components/RealtyLeadForm'; // ‚úÖ NEW import

// pick best image to show on the card
const pickCardImage = (p) =>
  p.image_url ||
  (p.metadata && p.metadata.cover_url) ||
  '/placeholder.png';

export default function RealtyList() {
  const [properties, setProperties] = useState([]);
  const [loading, setLoading] = useState(true);

  // load all properties in division=realty
  useEffect(() => {
    (async () => {
      try {
        const res = await fetch('/api/realty/property?all=1');
        const json = await res.json();

        // json.properties should be [{id,name,slug,description,nightly_price,image_url,metadata,...}]
        const list = (json.properties || []).map((p) => ({
          ...p,
          display_image: pickCardImage(p),
        }));

        setProperties(list);
      } catch (err) {
        console.error('Realty list fetch error:', err);
        setProperties([]);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/rental-bigbear.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/og-realty.webp',
  ];

  return (
    <>
      <Head>
        <title>Manyagi Realty ‚Äî Premium Properties & Rentals</title>
        <meta
          name="description"
          content="Discover story-inspired stays and premium rentals."
        />
      </Head>

      <Hero
        kicker="Realty"
        title="Story-Inspired Stays"
        lead="Escape to properties that bring our worlds to life."
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <Link
          href="#properties"
          className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition"
        >
          Browse Rentals
        </Link>
      </Hero>

      {/* Rentals grid */}
      <section
        id="properties"
        className="container mx-auto px-4 py-16 grid grid-cols-1 md:grid-cols-3 gap-5"
      >
        {loading ? (
          <div className="col-span-full text-center text-lg">
            Loading properties...
          </div>
        ) : properties.length === 0 ? (
          <div className="col-span-full text-center text-lg">
            No properties available yet. Check back soon!
          </div>
        ) : (
          properties.map((prop) => (
            <Card
              key={prop.id}
              title={
                <div className="space-y-2">
                  <div className="text-lg font-semibold leading-snug">
                    {prop.name}
                  </div>

                  {prop.nightly_price ? (
                    <div className="inline-block bg-yellow-100 text-yellow-800 text-[11px] font-semibold px-2 py-1 rounded">
                      From ${prop.nightly_price}/night
                    </div>
                  ) : null}
                </div>
              }
              description={
                prop.description ||
                'Premium rental property experience.'
              }
              image={prop.display_image}
              category="realty"
            >
              <div className="mt-4">
                {prop.slug ? (
                  <Link
                    href={`/realty/${prop.slug}`}
                    className="btn bg-yellow-500 text-black py-2 px-4 rounded hover:bg-yellow-400 transition text-sm font-semibold"
                  >
                    View Details &amp; Book
                  </Link>
                ) : (
                  <span className="text-xs opacity-70">
                    (no slug set yet, cannot view details)
                  </span>
                )}
              </div>
            </Card>
          ))
        )}
      </section>

      {/* ‚úÖ NEW: Brokerage / Management / Seller Lead Capture */}
      <section className="container mx-auto px-4 py-16">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
          <div className="space-y-4">
            <h2 className="text-2xl font-bold">
              Buying, selling, or need management in California?
            </h2>
            <p className="text-base opacity-80 leading-relaxed">
              Residential. Commercial. Short-term rentals.
              We‚Äôll help you find the deal, list the asset, or run it
              for you like an Airbnb pro ‚Äî without you touching messages,
              cleaners, or pricing.
            </p>

            <ul className="text-sm list-disc pl-5 space-y-1 opacity-80">
              <li>Sell your home off-market or on-market.</li>
              <li>Get full-service Airbnb/VRBO management.</li>
              <li>Find cash-flow or lifestyle properties.</li>
            </ul>

            <p className="text-xs opacity-50">
              If you're already under contract with us as a seller,
              your property will appear on this page as a featured
              listing.
            </p>
          </div>

          <div>
            {/* This posts to /api/realty/lead and writes to realty_leads */}
            <RealtyLeadForm />
          </div>
        </div>
      </section>

      {/* Newsletter opt-in stays the same */}
      <section id="subscribe" className="container mx-auto px-4 py-16">
        <SubscriptionForm
          formId="8427851"
          uid="637df68a04"
          title="Stay Updated on Realty Listings"
          description="Get notified about new properties and rentals."
        />
      </section>

      <Recommender />
    </>
  );
}


===== FILE: pages/realty/[slug].js  (size=21075 bytes) =====
// pages/realty/[slug].js
import Head from 'next/head';
import { useRouter } from 'next/router';
import { useEffect, useState, useMemo } from 'react';
import { Calendar, dateFnsLocalizer } from 'react-big-calendar';
import { format, parse, startOfWeek, getDay } from 'date-fns';
import enUS from 'date-fns/locale/en-US';
import 'react-big-calendar/lib/css/react-big-calendar.css';

// react-big-calendar localizer
const localizer = dateFnsLocalizer({
  format,
  parse,
  startOfWeek,
  getDay,
  locales: { 'en-US': enUS },
});

// safer date builder (avoid DST weirdness by using noon local time)
function ymdToDate(ymd) {
  const [y, m, d] = ymd.split('-').map(Number);
  return new Date(y, m - 1, d, 12, 0, 0);
}

// build calendar events out of merged blocks from /api/realty/calendar-blocks
function buildCalendarEvents(blocks) {
  const out = [];
  (blocks || []).forEach((b) => {
    const start = ymdToDate(b.start);

    // blocks are inclusive [start..end], but react-big-calendar
    // expects end to be EXCLUSIVE, so add 1 day
    const endInclusive = ymdToDate(b.end);
    const endExclusive = new Date(endInclusive);
    endExclusive.setDate(endExclusive.getDate() + 1);

    out.push({
      title: b.label || 'Booked',
      start,
      end: endExclusive,
      allDay: true,
      resource: b.kind || 'blocked',
    });
  });
  return out;
}

// small helper for quote breakdown rows
function MoneyRow({ label, value }) {
  return (
    <div className="flex justify-between text-sm">
      <span>{label}</span>
      <span>${Number(value || 0).toFixed(2)}</span>
    </div>
  );
}

export default function PropertyDetail() {
  const router = useRouter();
  const { slug } = router.query;

  // property record from Supabase
  const [property, setProperty] = useState(null);

  // unavailable ranges (paid reservations + synced external blocks)
  const [blocks, setBlocks] = useState([]);

  // booking form state
  const [checkin, setCheckin] = useState('');
  const [checkout, setCheckout] = useState('');
  const [guests, setGuests] = useState(1);

  // guest info (for checkout)
  const [guestName, setGuestName] = useState('');
  const [guestEmail, setGuestEmail] = useState('');
  const [guestPhone, setGuestPhone] = useState('');
  const [notes, setNotes] = useState('');

  // quote result from server (pricing summary, nights, tax, etc.)
  const [quote, setQuote] = useState(null);

  // ui state flags
  const [loading, setLoading] = useState(true);
  const [busy, setBusy] = useState(false);

  // --- LOAD PROPERTY + BLOCKED DATES ---
  useEffect(() => {
    if (!slug) return;
    (async () => {
      try {
        // 1. property details (name, desc, gallery, metadata, etc.)
        const propRes = await fetch(`/api/realty/property?slug=${slug}`);
        const propJson = await propRes.json();

        if (!propJson.ok || !propJson.property) {
          setProperty(null);
          setBlocks([]);
          setLoading(false);
          return;
        }

        const propRow = propJson.property;
        setProperty(propRow);

        // 2. merged calendar blocks (paid reservations + external blocks)
        const blkRes = await fetch(
          `/api/realty/calendar-blocks?property_id=${encodeURIComponent(
            propRow.id
          )}`
        );
        const blkJson = await blkRes.json();
        setBlocks(blkJson.blocks || []);
      } catch (err) {
        console.error('property load err:', err);
        setProperty(null);
        setBlocks([]);
      } finally {
        setLoading(false);
      }
    })();
  }, [slug]);

  // events for react-big-calendar
  const calendarEvents = useMemo(
    () => buildCalendarEvents(blocks),
    [blocks]
  );

  // Get server-side quote
  async function getQuote() {
    if (!checkin || !checkout) {
      alert('Select check-in and check-out');
      return;
    }
    if (!property) return;

    setBusy(true);
    try {
      const res = await fetch('/api/realty/quote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          property_id: property.id,
          checkin,
          checkout,
        }),
      });

      let data;
      try {
        data = await res.json();
      } catch (parseErr) {
        const txt = await res.text();
        console.error('Non-JSON response from /quote:', txt);
        throw new Error('Server returned non-JSON for quote');
      }

      if (!data.ok) {
        throw new Error(data.error || 'Failed to get quote');
      }

      setQuote(data);
    } catch (e) {
      alert(e.message);
    } finally {
      setBusy(false);
    }
  }

  // Start Stripe Checkout session
  async function book() {
    if (!quote) {
      alert('Get a quote first');
      return;
    }
    if (!guestName || !guestEmail) {
      alert('Enter name and email');
      return;
    }

    // ADDED:
    // If they don't meet min stay, block booking
    if (quote && quote.meets_min_stay === false) {
      alert(
        `This stay does not meet the minimum of ${quote.min_nights_required} night${
          Number(quote.min_nights_required) === 1 ? '' : 's'
        } for those dates.`
      );
      return;
    }

    setBusy(true);
    try {
      const res = await fetch('/api/realty/create-checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          property_id: property.id,
          checkin,
          checkout,
          guests,
          guest_name: guestName,
          guest_email: guestEmail,
          guest_phone: guestPhone,
          notes,
        }),
      });

      let data;
      try {
        data = await res.json();
      } catch (parseErr) {
        const txt = await res.text();
        console.error('Non-JSON response from /create-checkout:', txt);
        throw new Error('Server error starting checkout (see console).');
      }

      if (data.url) {
        window.location.href = data.url;
      } else {
        alert(data.error || 'Checkout failed');
      }
    } catch (e) {
      alert(e.message);
    } finally {
      setBusy(false);
    }
  }

  // CHANGED:
  // min-stay warning now uses the server's result
  const minStayWarning = useMemo(() => {
    if (!quote) return '';
    if (quote.meets_min_stay === false) {
      const req = Number(quote.min_nights_required || 0);
      if (req > 1) {
        return `This stay is below the ${req}-night minimum for those dates.`;
      } else {
        return 'This stay may not meet the minimum nights requirement.';
      }
    }
    return '';
  }, [quote]);

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16">
        Loading property...
      </div>
    );
  }

  if (!property) {
    return (
      <div className="container mx-auto px-4 py-16">
        Property not found.
      </div>
    );
  }

  // ---- UI DERIVED FIELDS ----

  // Gallery
  const coverImg =
    property.metadata?.cover_url ||
    property.image_url ||
    '/placeholder.png';

  const galleryFromMeta = Array.isArray(
    property.metadata?.gallery_urls
  )
    ? property.metadata.gallery_urls
    : [];
  const galleryLegacy = Array.isArray(property.gallery_urls)
    ? property.gallery_urls
    : [];
  const gallery =
    galleryFromMeta.length > 0
      ? galleryFromMeta
      : galleryLegacy.length > 0
      ? galleryLegacy
      : [coverImg];

  // Property location for map
  const mapQuery =
    typeof property.metadata?.location === 'string' &&
    property.metadata.location.trim().length > 2
      ? property.metadata.location.trim()
      : null;

  // Stats
  const beds = property.metadata?.beds;
  const baths = property.metadata?.baths;
  const sleeps = property.metadata?.sleeps;
  const amenities = Array.isArray(property.metadata?.amenities)
    ? property.metadata.amenities
    : [];

  return (
    <>
      <Head>
        <title>{property.name} ‚Äî Manyagi Realty</title>
        <meta
          name="description"
          content={property.description || ''}
        />
      </Head>

      <section className="container mx-auto px-4 pb-32 pt-16 md:pb-16 max-w-5xl">
        {/* Title */}
        <h1 className="text-4xl font-bold mb-6">{property.name}</h1>

        {/* HERO IMAGE + THUMBS */}
        <div className="mb-8">
          {/* main hero image */}
          <div className="w-full h-64 md:h-[400px] rounded overflow-hidden bg-gray-200 mb-4">
            <img
              src={gallery[0]}
              alt={property.name}
              className="w-full h-full object-cover"
            />
          </div>

          {/* thumbnails */}
          {gallery.length > 1 && (
            <div className="grid grid-cols-3 md:grid-cols-6 gap-2">
              {gallery.slice(1, 7).map((url, idx) => (
                <div
                  key={idx}
                  className="w-full h-24 md:h-28 rounded overflow-hidden bg-gray-200"
                >
                  <img
                    src={url}
                    alt={`Gallery ${idx + 2}`}
                    className="w-full h-full object-cover"
                  />
                </div>
              ))}
            </div>
          )}

          {/* more photos indicator */}
          {gallery.length > 6 && (
            <div className="text-sm text-blue-600 mt-2 cursor-pointer">
              + {gallery.length - 6} more photos
            </div>
          )}
        </div>

        {/* QUICK FACTS */}
        <section className="border-b border-gray-200 dark:border-gray-700 pb-6 mb-8">
          <div className="flex flex-wrap gap-4 text-sm text-gray-700 dark:text-gray-300">
            {beds ? (
              <div className="flex items-center gap-1">
                <span role="img" aria-label="beds">
                  üõèÔ∏è
                </span>
                <span>{beds} Beds</span>
              </div>
            ) : null}

            {baths ? (
              <div className="flex items-center gap-1">
                <span role="img" aria-label="baths">
                  üõÅ
                </span>
                <span>{baths} Baths</span>
              </div>
            ) : null}

            {sleeps ? (
              <div className="flex items-center gap-1">
                <span role="img" aria-label="sleeps">
                  üßç‚Äç‚ôÇÔ∏è
                </span>
                <span>Sleeps {sleeps}</span>
              </div>
            ) : null}

            {property.nightly_price ? (
              <div className="flex items-center gap-1 font-semibold text-yellow-700 bg-yellow-100 px-2 py-1 rounded text-xs">
                <span>From ${property.nightly_price}/night</span>
              </div>
            ) : null}
          </div>

          {amenities.length > 0 && (
            <ul className="mt-4 flex flex-wrap gap-2 text-xs">
              {amenities.map((am, i) => (
                <li
                  key={i}
                  className="px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded border border-gray-300 dark:border-gray-700"
                >
                  {am}
                </li>
              ))}
            </ul>
          )}
        </section>

        {/* DESCRIPTION */}
        <p className="mb-6 whitespace-pre-line text-gray-800 dark:text-gray-200">
          {property.description}
        </p>

        {/* PRICE REMINDER */}
        <p className="mb-10 font-semibold">
          Price per night:{' '}
          {property.nightly_price
            ? `$${property.nightly_price}`
            : '‚Äî'}
        </p>

        {/* MAP */}
        {mapQuery && (
          <div className="mt-8 mb-12">
            <h2 className="text-2xl font-bold mb-2">Location</h2>
            <div className="w-full h-[350px] bg-gray-200 rounded overflow-hidden border border-gray-300 dark:border-gray-700">
              <iframe
                src={`https://maps.google.com/maps?q=${encodeURIComponent(
                  mapQuery
                )}&output=embed`}
                width="100%"
                height="350"
                style={{ border: 0 }}
                loading="lazy"
                allowFullScreen
                referrerPolicy="no-referrer-when-downgrade"
                className="w-full h-full"
              />
            </div>
          </div>
        )}

        {/* AVAILABILITY CALENDAR */}
        <div className="mt-12 mb-12">
          <h2 className="text-2xl font-bold mb-2">Availability</h2>

          <div className="bg-white dark:bg-gray-900 rounded shadow p-4 overflow-auto border border-gray-200 dark:border-gray-700">
            <Calendar
              localizer={localizer}
              events={calendarEvents}
              startAccessor="start"
              endAccessor="end"
              views={['month']}
              defaultView="month"
              popup
              tooltipAccessor={(event) => event.title}
              style={{ height: 500 }}
              eventPropGetter={() => {
                // style blocked ranges (booked/unavailable)
                return {
                  className:
                    'bg-red-500/20 text-red-700 border border-red-300 rounded',
                };
              }}
            />
            <p className="text-xs opacity-70 mt-2">
              Marked dates are unavailable.
            </p>
          </div>
        </div>

        {/* BOOKING FORM */}
        <div className="mt-12" id="booking-form">
          <h2 className="text-2xl font-bold mb-4">
            Book Your Stay
          </h2>

          {/* inputs for checkin / checkout / guests / Get Quote */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div>
              <label className="block text-sm font-semibold">
                Check-in
              </label>
              <input
                type="date"
                className="border rounded px-2 py-1 w-full dark:bg-gray-800 dark:border-gray-600"
                value={checkin}
                onChange={(e) => setCheckin(e.target.value)}
              />
            </div>

            <div>
              <label className="block text-sm font-semibold">
                Check-out
              </label>
              <input
                type="date"
                className="border rounded px-2 py-1 w-full dark:bg-gray-800 dark:border-gray-600"
                value={checkout}
                onChange={(e) => setCheckout(e.target.value)}
              />
            </div>

            <div>
              <label className="block text-sm font-semibold">
                Guests
              </label>
              <input
                type="number"
                min="1"
                className="border rounded px-2 py-1 w-full dark:bg-gray-800 dark:border-gray-600"
                value={guests}
                onChange={(e) => setGuests(e.target.value)}
              />
            </div>

            <div className="flex items-end">
              <button
                onClick={getQuote}
                disabled={busy}
                className="bg-blue-600 text-white rounded px-4 py-2 w-full font-semibold disabled:opacity-50"
              >
                {busy ? 'Calculating‚Ä¶' : 'Get Quote'}
              </button>
            </div>
          </div>

          {/* QUOTE BREAKDOWN */}
          {quote && quote.summary && (
            <div className="bg-gray-50 dark:bg-gray-800 rounded p-4 mb-6 text-sm border border-gray-200 dark:border-gray-700">
              <div className="font-semibold mb-2">
                {quote.summary.nights} night
                {quote.summary.nights === 1 ? '' : 's'} breakdown
              </div>

              {/* ADDED: show min stay requirement if >1 */}
              {Number(quote.min_nights_required || 0) > 1 && (
                <div className="text-xs mb-2 text-gray-700 dark:text-gray-300">
                  {quote.min_nights_required}-night minimum for
                  these dates.
                </div>
              )}

              <MoneyRow
                label="Nightly subtotal"
                value={quote.summary.base_subtotal}
              />
              {Number(quote.summary.cleaning_fee || 0) > 0 && (
                <MoneyRow
                  label="Cleaning fee"
                  value={quote.summary.cleaning_fee}
                />
              )}
              {Number(quote.summary.tax_amount || 0) > 0 && (
                <MoneyRow
                  label={`Tax (${(
                    Number(quote.summary.tax_rate || 0) * 100
                  ).toFixed(1)}%)`}
                  value={quote.summary.tax_amount}
                />
              )}

              <div className="border-t my-2 dark:border-gray-600" />

              <div className="flex justify-between text-base font-semibold">
                <span>Total</span>
                <span>
                  ${Number(quote.summary.total || 0).toFixed(2)}
                </span>
              </div>

              {/* CHANGED: smarter warning */}
              {minStayWarning && (
                <div className="mt-2 text-yellow-700 bg-yellow-100 border border-yellow-300 text-xs rounded p-2 dark:bg-yellow-800 dark:text-yellow-100 dark:border-yellow-600">
                  {minStayWarning}
                </div>
              )}
            </div>
          )}

          {/* GUEST INFO + CHECKOUT */}
          {quote && quote.summary && (
            <div className="space-y-3">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input
                  className="border rounded px-2 py-2 w-full dark:bg-gray-800 dark:border-gray-600"
                  placeholder="Full name"
                  value={guestName}
                  onChange={(e) => setGuestName(e.target.value)}
                />
                <input
                  className="border rounded px-2 py-2 w-full dark:bg-gray-800 dark:border-gray-600"
                  placeholder="Email"
                  value={guestEmail}
                  onChange={(e) => setGuestEmail(e.target.value)}
                />
                <input
                  className="border rounded px-2 py-2 w-full dark:bg-gray-800 dark:border-gray-600"
                  placeholder="Phone (optional)"
                  value={guestPhone}
                  onChange={(e) => setGuestPhone(e.target.value)}
                />
              </div>

              <textarea
                className="border rounded px-2 py-2 w-full dark:bg-gray-800 dark:border-gray-600"
                placeholder="Notes for host (optional)"
                value={notes}
                onChange={(e) => setNotes(e.target.value)}
              />

              <button
                onClick={book}
                disabled={
                  busy ||
                  (quote && quote.meets_min_stay === false)
                }
                className="bg-green-600 text-white rounded px-4 py-3 font-semibold w-full md:w-auto disabled:opacity-50"
              >
                {busy
                  ? 'Processing‚Ä¶'
                  : quote && quote.meets_min_stay === false
                  ? 'Minimum Not Met'
                  : 'Book Now'}
              </button>
            </div>
          )}
        </div>

        {/* Contact fallback if no quote yet */}
        {!quote && (
          <div className="text-xs opacity-70 mt-8">
            Need custom dates or long-term stay? Contact us.
          </div>
        )}
      </section>

      {/* Sticky mobile CTA */}
      <div className="fixed bottom-0 left-0 right-0 md:hidden bg-white dark:bg-gray-900 text-black dark:text-white border-t border-gray-200 dark:border-gray-700 p-3 flex justify-between items-center z-50 shadow-[0_-2px_8px_rgba(0,0,0,0.08)]">
        <div className="text-sm font-semibold">
          {property.nightly_price
            ? `From $${property.nightly_price}/night`
            : ''}
        </div>
        <button
          onClick={() => {
            const el = document.getElementById('booking-form');
            if (el) {
              el.scrollIntoView({ behavior: 'smooth' });
            }
          }}
          className="bg-yellow-500 text-black dark:text-black font-semibold py-2 px-4 rounded hover:bg-yellow-400 transition"
        >
          Book Now
        </button>
      </div>
    </>
  );
}


===== FILE: pages/realty/booking/[slug].js  (size=3308 bytes) =====
// pages/realty/booking/[slug].js
import { useRouter } from 'next/router';
import { useState } from 'react';

export default function BookingForm() {
  const router = useRouter();
  const { slug } = router.query;
  const [form, setForm] = useState({
    checkin: '', checkout: '', guests: 1, guestName: '', guestEmail: '', guestPhone: '', notes: '',
  });
  const [quote, setQuote] = useState(null);
  const [loading, setLoading] = useState(false);

  const handleQuote = async () => {
    setLoading(true);
    try {
      const res = await fetch('/api/realty/quote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ property_id: slug, checkin: form.checkin, checkout: form.checkout }),
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error);
      setQuote(json);
    } catch (e) {
      alert(e.message);
    } finally {
      setLoading(false);
    }
  };

  const handleBook = async () => {
    setLoading(true);
    try {
      const res = await fetch('/api/realty/book', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          property_id: slug,
          checkin: form.checkin,
          checkout: form.checkout,
          guests: form.guests,
          quote_total_cents: quote?.summary?.total * 100,
          guestName: form.guestName,
          guestEmail: form.guestEmail,
          guestPhone: form.guestPhone,
          notes: form.notes,
        }),
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error);
      window.location.href = json.url; // Redirect to Stripe
    } catch (e) {
      alert(e.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="container mx-auto px-4 py-10">
      <h1>Book Property</h1>
      <div className="grid gap-4 max-w-md">
        <input type="date" value={form.checkin} onChange={e => setForm({ ...form, checkin: e.target.value })} />
        <input type="date" value={form.checkout} onChange={e => setForm({ ...form, checkout: e.target.value })} />
        <input type="number" value={form.guests} onChange={e => setForm({ ...form, guests: e.target.value })} />
        <button onClick={handleQuote} disabled={loading} className="btn bg-blue-600 text-white">
          Get Quote
        </button>
        {quote && (
          <div>
            <p>Total: ${(quote.summary.total / 100).toFixed(2)}</p>
            <input placeholder="Name" value={form.guestName} onChange={e => setForm({ ...form, guestName: e.target.value })} />
            <input placeholder="Email" value={form.guestEmail} onChange={e => setForm({ ...form, guestEmail: e.target.value })} />
            <input placeholder="Phone" value={form.guestPhone} onChange={e => setForm({ ...form, guestPhone: e.target.value })} />
            <textarea placeholder="Notes" value={form.notes} onChange={e => setForm({ ...form, notes: e.target.value })} />
            <button onClick={handleBook} disabled={loading} className="btn bg-green-600 text-white">
              Book Now
            </button>
          </div>
        )}
      </div>
    </div>
  );
}


===== FILE: pages/signup.js  (size=3189 bytes) =====
import Head from 'next/head';
import { useState } from 'react';
import { useRouter } from 'next/router';
import { supabase } from '@/lib/supabase';
import Hero from '../components/Hero';

export default function Signup() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState(null);
  const [loading, setLoading] = useState(false);

  const handleSignup = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      const { data, error: authError } = await supabase.auth.signUp({ email, password });
      if (authError) throw authError;
      await supabase.from('users').insert({
        id: data.user.id,
        email,
        role: 'user',
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      });
      router.push('/dashboard');
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const handleGoogleSignup = async () => {
    try {
      const { error } = await supabase.auth.signInWithOAuth({ provider: 'google' });
      if (error) throw error;
    } catch (err) {
      setError(err.message);
    }
  };

  return (
    <>
      <Head>
        <title>Sign Up - Manyagi</title>
      </Head>
      <Hero
        kicker="Join Us"
        title="Sign Up"
        lead="Create your Manyagi account."
        carouselImages={[]}
        height="h-screen"
      >
        <div className="card max-w-md mx-auto bg-white text-black glass p-8 rounded-lg shadow-xl">
          {error && <p className="text-red-500 mb-4 text-center">{error}</p>}
          <form onSubmit={handleSignup} className="space-y-4">
            <input
              type="email"
              placeholder="Email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full p-3 border rounded bg-white text-black"
              required
            />
            <input
              type="password"
              placeholder="Password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full p-3 border rounded bg-white text-black"
              required
            />
            <button
              type="submit"
              disabled={loading}
              className="w-full p-3 bg-black text-white rounded disabled:opacity-50 hover:bg-gray-800 transition"
            >
              {loading ? 'Processing...' : 'Sign Up'}
            </button>
          </form>
          <button
            onClick={handleGoogleSignup}
            className="mt-4 w-full p-3 bg-blue-500 text-white rounded hover:bg-blue-600 transition"
          >
            Sign Up with Google
          </button>
          <button
            onClick={() => router.push('/login')}
            className="mt-4 text-blue-500 underline w-full text-center"
          >
            Already have an account? Login
          </button>
        </div>
      </Hero>
    </>
  );
}


===== FILE: pages/tech.js  (size=6041 bytes) =====
// pages/tech.js
import Head from 'next/head';
import Link from 'next/link';
import { useEffect, useState } from 'react';

import SubscriptionForm from '../components/SubscriptionForm';
import Recommender from '../components/Recommender';
import Hero from '../components/Hero';
import Card from '../components/Card';

// normalize API response
const asList = (v) => {
  if (Array.isArray(v)) return v;
  if (Array.isArray(v?.items)) return v.items;
  return [];
};

export default function Tech() {
  const [apps, setApps] = useState([]);
  const [loading, setLoading] = useState(true);

  // fetch "tech" showcase items from /api/posts
  useEffect(() => {
    (async () => {
      try {
        const res = await fetch('/api/posts?division=tech');
        const json = await res.json();

        // expecting { items: [...] }
        const list = asList(json).map((p) => ({
          id: p.id,
          title: p.title,
          excerpt: p.excerpt || p.content?.slice(0, 140) || '',
          image:
            p.featured_image ||
            p.metadata?.screenshot ||
            'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/app-placeholder.webp',
          appUrl: p.metadata?.app_url || null,
          appType: p.metadata?.app_type || 'app',
        }));

        if (list.length === 0) {
          // fallback demo card so page never looks empty
          setApps([
            {
              id: 'fallback-daito',
              title: 'Daito Productivity App',
              excerpt:
                'Lightweight productivity and focus companion. Track tasks, lock in, get more done.',
              image:
                'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/daito-screenshot.webp',
              appUrl: 'https://example.com/daito',
              appType: 'app',
            },
          ]);
        } else {
          setApps(list);
        }
      } catch (err) {
        console.error('tech fetch error:', err);
        // fallback if API blows up
        setApps([
          {
            id: 'fallback-daito',
            title: 'Daito Productivity App',
            excerpt:
              'Lightweight productivity and focus companion. Track tasks, lock in, get more done.',
            image:
              'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/daito-screenshot.webp',
            appUrl: 'https://example.com/daito',
            appType: 'app',
          },
        ]);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const carouselImages = [
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/app-carousel-1.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/app-carousel-2.webp',
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/images/app-carousel-3.webp',
  ];

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16 text-center">
        Loading apps...
      </div>
    );
  }

  return (
    <>
      <Head>
        <title>Manyagi Tech ‚Äî Apps & Tools</title>
        <meta
          name="description"
          content="Explore in-house tools, apps, bots, and platforms built by Manyagi Tech."
        />
      </Head>

      <Hero
        kicker="Tech"
        title="Innovate with Manyagi Tech"
        lead="Internal tools, public apps, and experimental platforms."
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <Link
          href="#apps"
          className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition"
        >
          Browse Apps
        </Link>
      </Hero>

      {/* Showcase grid */}
      <section
        id="apps"
        className="container mx-auto px-4 py-16 grid grid-cols-1 md:grid-cols-3 gap-5"
      >
        {apps.length === 0 ? (
          <div className="col-span-full text-center text-lg">
            No apps yet. Check back soon.
          </div>
        ) : (
          apps.map((app) => (
            <Card
              key={app.id}
              title={
                <div className="space-y-1">
                  <div className="text-lg font-semibold leading-snug">
                    {app.title}
                  </div>
                  <div className="text-[11px] inline-block bg-gray-800 text-white px-2 py-1 rounded uppercase tracking-wide">
                    {app.appType === 'website'
                      ? 'Web'
                      : app.appType === 'review'
                      ? 'Review'
                      : 'App'}
                  </div>
                </div>
              }
              description={app.excerpt || '‚Äî'}
              image={app.image}
              category="tech"
            >
              {app.appUrl ? (
                <a
                  href={app.appUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition text-sm font-semibold inline-block"
                >
                  Visit / Download
                </a>
              ) : (
                <span className="text-xs opacity-70">
                  Coming soon
                </span>
              )}
            </Card>
          ))
        )}
      </section>

      {/* Email capture for new drops */}
      <section id="subscribe" className="container mx-auto px-4 py-16">
        <SubscriptionForm
          formId="8427849"
          uid="637df68a02"
          title="Get Early Access"
          description="Be first in line for new app betas, tools, and private releases."
        />
      </section>

      {/* Cross promo / recommendations */}
      <Recommender />
    </>
  );
}


===== FILE: pages/tech/[slug].js  (size=4026 bytes) =====
// pages/tech/[slug].js
import Head from 'next/head';
import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';

const pickImage = (post) =>
  post?.featured_image ||
  post?.thumbnail_url ||
  post?.metadata?.cover_url ||
  '/placeholder.png';

export default function TechDetailPage() {
  const router = useRouter();
  const { slug } = router.query;

  const [post, setPost] = useState(null);
  const [loading, setLoading] = useState(true);

  // fetch single tech post by slug
  useEffect(() => {
    if (!slug) return;
    (async () => {
      try {
        // NOTE: you have /api/posts right now which returns ALL posts.
        // You‚Äôll want to extend /api/posts to handle ?division=tech&slug=...
        // (We already planned that in the posts.js change.)
        const res = await fetch(`/api/posts?division=tech&slug=${slug}`);
        const json = await res.json();

        // accept a few shapes
        let row = null;
        if (Array.isArray(json)) {
          row = json[0] || null;
        } else if (json.post) {
          row = json.post;
        } else if (json.items) {
          row = json.items[0] || null;
        }

        setPost(row);
      } catch (err) {
        console.error('tech slug fetch error:', err);
        setPost(null);
      } finally {
        setLoading(false);
      }
    })();
  }, [slug]);

  if (loading) {
    return (
      <div className="container mx-auto px-4 py-16">
        Loading‚Ä¶
      </div>
    );
  }

  if (!post) {
    return (
      <div className="container mx-auto px-4 py-16">
        Tech item not found.
      </div>
    );
  }

  const heroImg = pickImage(post);
  const appUrl = post?.metadata?.app_url;
  const appType = post?.metadata?.app_type;

  return (
    <>
      <Head>
        <title>{post.title} ‚Äî Manyagi Tech</title>
        <meta
          name="description"
          content={post.excerpt || 'Manyagi Tech showcase'}
        />
      </Head>

      <section className="container mx-auto px-4 pb-32 pt-16 md:pb-16 max-w-3xl text-gray-900 dark:text-gray-100">
        {/* Title */}
        <h1 className="text-4xl font-bold mb-4">{post.title}</h1>

        {/* Badges */}
        <div className="flex flex-wrap gap-2 text-xs mb-6">
          {appType && (
            <span className="inline-block bg-gray-900 text-white px-2 py-1 rounded font-semibold dark:bg-gray-100 dark:text-gray-900">
              {appType}
            </span>
          )}
          <span className="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded font-semibold dark:bg-blue-900 dark:text-blue-100">
            Manyagi Tech
          </span>
        </div>

        {/* Hero image */}
        <div className="w-full h-64 md:h-[360px] rounded overflow-hidden bg-gray-200 dark:bg-gray-800 mb-6 border border-gray-300 dark:border-gray-700">
          <img
            src={heroImg}
            alt={post.title}
            className="w-full h-full object-cover"
          />
        </div>

        {/* CTA button */}
        {appUrl && (
          <div className="mb-8">
            <a
              href={appUrl}
              target="_blank"
              rel="noopener noreferrer"
              className="inline-block bg-blue-600 text-white py-2 px-4 rounded font-semibold hover:bg-blue-700 transition dark:bg-yellow-500 dark:text-black dark:hover:bg-yellow-400"
            >
              Visit App
            </a>
          </div>
        )}

        {/* Excerpt */}
        {post.excerpt && (
          <p className="mb-6 text-lg text-gray-800 dark:text-gray-200">
            {post.excerpt}
          </p>
        )}

        {/* Long content / body */}
        {post.content && (
          <article className="prose prose-neutral dark:prose-invert max-w-none whitespace-pre-line">
            {post.content}
          </article>
        )}
      </section>
    </>
  );
}


===== FILE: pages/terms.js  (size=1167 bytes) =====
// pages/terms.js
import Head from 'next/head';
import Link from 'next/link';
import Hero from '../components/Hero';

export default function Terms() {
  return (
    <>
      <Head>
        <title>Manyagi ‚Äî Terms of Service</title>
        <meta name="description" content="Read Manyagi‚Äôs Terms of Service." />
      </Head>
      <Hero
        kicker="Terms"
        title="Terms of Service"
        lead="Understand the terms governing our services."
        carouselImages={['/images/og-home.webp']}
        height="h-[600px]"
      />
      <section className="container mx-auto px-4 py-16 text-sm space-y-4">
        <h2 className="text-xl font-bold">1. Introduction</h2>
        <p>By using Manyagi, you agree to these terms.</p>
        <h2 className="text-xl font-bold">2. Services</h2>
        <p>Details about our publishing, designs, capital, tech, and media services.</p>
        <h2 className="text-xl font-bold">3. GDPR Compliance</h2>
        <p>We comply with GDPR for data protection. See our <Link href="/privacy" className="text-blue-600 hover:underline">Privacy Policy</Link>.</p>
      </section>
    </>
  );
};


===== FILE: pages/thank-you.js  (size=5496 bytes) =====
// pages/thank-you.js
import Head from 'next/head';
import Link from 'next/link';
import Hero from '../components/Hero';
import { FaTwitter, FaFacebook, FaInstagram } from 'react-icons/fa';
import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';

export default function ThankYou() {
  const router = useRouter();
  const { session_id } = router.query;
  const [orderDetails, setOrderDetails] = useState(null);
  const [error, setError] = useState('');
  const site = process.env.NEXT_PUBLIC_SITE_URL || (typeof window !== 'undefined' ? window.location.origin : 'https://manyagi.net');

  const carouselImages = [
    '/images/og-designs.webp',
    '/images/merch-carousel-1.webp',
    '/images/merch-carousel-2.webp',
  ];

  useEffect(() => {
    if (session_id) {
      fetch(`/api/order-details?session_id=${session_id}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) setError(data.error);
          else setOrderDetails(data);
        })
        .catch(err => {
          console.error('Fetch order details error:', err);
          setError('Failed to fetch order details');
        });
    }
  }, [session_id]);

  const leadText = error
    ? 'Your purchase is complete, but we couldn‚Äôt fetch order details. Check your email for confirmation.'
    : orderDetails
    ? (orderDetails.type === 'signals'
        ? 'Your subscription is active. Check Telegram for your invite/message.'
        : orderDetails.type === 'download'
        ? 'Your download is ready below.'
        : orderDetails.type === 'book'
        ? 'Your eBook is ready below.'
        : orderDetails.type === 'merch'
        ? 'Thanks! We‚Äôll notify you when it ships.'
        : 'Your purchase is complete. Check your email for details.')
    : 'Your purchase is complete. Check your email for details.';

  // Supabase public asset URLs (avoid missing /public/assets/)
  const BOT_LICENSE_PDF =
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/pdfs/bot-license.pdf';
  const LEGACY_CH1_PDF =
    'https://dlbbjeohndiwtofitwec.supabase.co/storage/v1/object/public/assets/pdfs/Legacy_of_the_Hidden_Clans_(Chapter_1)_by_D.N._Manyagi.pdf';

  return (
    <>
      <Head>
        <title>Manyagi ‚Äî Thank You</title>
        <meta name="description" content="Thank you for your purchase!" />
      </Head>
      <Hero
        kicker="Thank You"
        title="Order Confirmed"
        lead={leadText}
        carouselImages={carouselImages}
        height="h-[600px]"
      >
        <Link href="/designs" className="btn bg-blue-600 text-white py-4 px-6 rounded hover:scale-105 transition">
          Continue Shopping
        </Link>
      </Hero>
      <section className="container mx-auto px-4 py-16">
        <h2 className="text-3xl font-bold mb-6">Share Your Purchase</h2>
        {error && <p className="text-red-500 text-base mb-4">{error}</p>}

        {orderDetails && (
          <div className="space-y-3 mb-8">
            <p>Type: {orderDetails.type}</p>

            {orderDetails.type === 'merch' && (
              <p>
                Track your order at <Link href="/track" className="text-blue-600 hover:underline">/track</Link> (you‚Äôll need your order ID).
              </p>
            )}

            {orderDetails.type === 'download' && (
              <a
                href={BOT_LICENSE_PDF}
                className="text-blue-600 hover:underline"
                target="_blank"
                rel="noopener noreferrer"
              >
                Download your license
              </a>
            )}

            {orderDetails.type === 'book' && (
              <a
                href={LEGACY_CH1_PDF}
                className="text-blue-600 hover:underline"
                target="_blank"
                rel="noopener noreferrer"
              >
                Download eBook
              </a>
            )}

            {orderDetails.type === 'signals' && (
              <div className="space-y-2">
                <p>Welcome to Manyagi Capital Signals!</p>
                {process.env.NEXT_PUBLIC_TELEGRAM_INVITE_LINK ? (
                  <a
                    href={process.env.NEXT_PUBLIC_TELEGRAM_INVITE_LINK}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="inline-block text-blue-600 hover:underline"
                  >
                    Join the Telegram group
                  </a>
                ) : (
                  <p>Check your Telegram DMs for the invite link.</p>
                )}
              </div>
            )}
          </div>
        )}

        <div className="flex gap-4 text-lg">
          <a href={`https://x.com/share?url=${encodeURIComponent(site)}`} className="text-blue-600 hover:text-blue-500" aria-label="Share on X">
            <FaTwitter size={24} />
          </a>
          <a href={`https://facebook.com/sharer/sharer.php?u=${encodeURIComponent(site)}`} className="text-blue-600 hover:text-blue-500" aria-label="Share on Facebook">
            <FaFacebook size={24} />
          </a>
          <a href="https://instagram.com/manyagi.official" className="text-blue-600 hover:text-blue-500" aria-label="Instagram">
            <FaInstagram size={24} />
          </a>
        </div>
      </section>
    </>
  );
}


===== FILE: pages/track.js  (size=2442 bytes) =====
// pages/track.js
import Head from 'next/head';
import { useState } from 'react';

export default function Track() {
  const [orderId, setOrderId] = useState('');
  const [result, setResult] = useState(null);
  const [error, setError] = useState('');

  const handleLookup = async (e) => {
    e.preventDefault();
    setError('');
    setResult(null);
    if (!orderId) {
      setError('Please enter an order ID');
      return;
    }
    try {
      const res = await fetch(`/api/track?order_id=${encodeURIComponent(orderId)}`);
      const data = await res.json();
      if (!res.ok || data.error) {
        setError(data.error || 'Not found');
      } else {
        setResult(data);
      }
    } catch (err) {
      setError('Failed to fetch tracking info');
    }
  };

  return (
    <>
      <Head>
        <title>Track Order ‚Äî Manyagi</title>
        <meta name="description" content="Look up your Manyagi order status." />
      </Head>
      <section className="container mx-auto px-4 py-16 max-w-2xl">
        <h1 className="text-3xl font-bold mb-4">Track Your Order</h1>
        <form onSubmit={handleLookup} className="flex gap-2 mb-6">
          <input
            type="text"
            value={orderId}
            onChange={(e) => setOrderId(e.target.value)}
            placeholder="Enter your order ID"
            className="flex-1 p-3 border rounded"
          />
          <button type="submit" className="px-4 py-3 bg-black text-white rounded hover:opacity-90">
            Track
          </button>
        </form>
        {error && <p className="text-red-600 mb-4">{error}</p>}
        {result && (
          <div className="border rounded p-4 space-y-2 bg-white">
            <p><strong>Status:</strong> {result.status}</p>
            {result.estimated_delivery && <p><strong>Updated:</strong> {new Date(result.estimated_delivery).toLocaleString()}</p>}
            <p><strong>Division:</strong> {result.division}</p>
            <p><strong>Total:</strong> ${Number(result.total).toFixed(2)}</p>
            <div>
              <strong>Items:</strong>
              <ul className="list-disc ml-6">
                {(result.items || []).map((i, idx) => (
                  <li key={idx}>{i.name} x {i.quantity || 1}</li>
                ))}
              </ul>
            </div>
          </div>
        )}
      </section>
    </>
  );
}


===== FILE: postcss.config.js  (size=82 bytes) =====
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};


===== FILE: posts/example-post.mdx  (size=286 bytes) =====
---
title: '#001 ‚Äî The HQ Goes Live'
date: '2025-08-15'
---

We launched a unified HQ for Publishing, Designs, Media, Capital, and Tech. Here‚Äôs how we built it and what‚Äôs next.

**Key Updates:**
- Publishing: Chapter 1 released.
- Designs: New tee drop.

[Read more...]


===== FILE: public/images/logo.svg  (size=2639 bytes) =====
<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200px" height="200px" viewBox="0 0 200 200" version="1.1">
<g id="surface1">
<path style=" stroke:none;fill-rule:nonzero;fill:rgb(0%,0%,0%);fill-opacity:1;" d="M 62 69.132812 C 58.332031 69.867188 59.535156 70.464844 63.933594 70.132812 C 70.132812 69.734375 73.601562 71.066406 78 75.464844 L 81.332031 78.800781 L 81.332031 94.265625 C 81.332031 111.132812 80.867188 113.332031 77.332031 115.132812 C 75.867188 115.867188 76.464844 116 82 116 C 88.199219 116 88.265625 115.933594 86.199219 114.933594 C 82.332031 113 81.933594 111.199219 82.132812 94.535156 L 82.332031 79.667969 L 84.464844 83.132812 C 85.667969 85.066406 89.398438 92.734375 92.734375 100.132812 C 96.132812 107.601562 100 115.464844 101.398438 117.734375 C 104.464844 122.601562 110 127.933594 114.066406 130 C 117.464844 131.800781 126.667969 132.734375 126.667969 131.398438 C 126.667969 130.867188 126.132812 130.734375 125.332031 131 C 122.535156 131.867188 118.535156 130.601562 115.535156 127.800781 C 112 124.535156 108.933594 119.265625 105.398438 110.066406 L 102.734375 103.199219 L 107.800781 93.800781 C 110.535156 88.667969 113.132812 83.667969 113.535156 82.734375 C 114.199219 81.332031 114.398438 83.601562 114.535156 94.332031 C 114.734375 109.464844 114.464844 112.867188 112.601562 114.734375 C 111.332031 116 111.398438 116 118.398438 116 C 125.464844 116 125.464844 116 123.933594 114.734375 L 122.332031 113.464844 L 122.332031 79.867188 L 123.933594 78.601562 L 125.464844 77.332031 L 115.464844 77.332031 L 112.132812 83.464844 C 110.332031 86.867188 107.398438 92.464844 105.667969 95.867188 L 102.535156 102.132812 L 98.332031 93.535156 C 90.066406 76.667969 81.398438 69.535156 68.667969 69 C 65.933594 68.867188 62.933594 68.933594 62 69.132812 Z M 93.667969 89.933594 C 96.800781 95.601562 100.667969 104.398438 103 111 C 104 113.933594 105.132812 116.734375 105.464844 117.132812 C 105.933594 117.734375 105.933594 118 105.464844 118 C 104 118 100.332031 111.265625 94 96.667969 C 91.667969 91.265625 87.332031 82.667969 85.601562 80 C 85 79.066406 86.066406 80 87.867188 81.933594 C 89.734375 83.933594 92.332031 87.535156 93.667969 89.933594 Z M 119.398438 94.800781 C 119.398438 103 119.535156 110.332031 119.734375 111.199219 C 120 112.867188 118.199219 114.066406 117.398438 112.734375 C 117.132812 112.265625 116.800781 105.132812 116.734375 96.867188 C 116.601562 82.265625 116.867188 80 118.734375 80 C 119.066406 80 119.332031 86.667969 119.398438 94.800781 Z M 119.398438 94.800781 "/>
</g>
</svg>


===== FILE: public/robots.txt  (size=114 bytes) =====
# *
User-agent: *
Allow: /

# Host
Host: https://manyagi.net

# Sitemaps
Sitemap: https://manyagi.net/sitemap.xml


===== FILE: requirements.txt  (size=51 bytes) =====
requests==2.32.3
colorama==0.4.6
graphviz==0.20.3


===== FILE: styles/globals.css  (size=3958 bytes) =====
/* Tailwind base, components, and utilities */
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Base styles */
body {
  @apply bg-white text-black font-sans antialiased leading-relaxed text-left;
}

h1, h2, h3 {
  @apply font-bold tracking-wide;
}

/* Layout and components */
.container {
  @apply mx-auto px-4;
}

.card {
  @apply bg-white border border-gray-300 rounded-xl shadow-md p-4 mb-6 hover:shadow-xl transition;
}

.btn {
  @apply bg-yellow-500 text-black py-3 px-6 rounded-lg font-bold hover:bg-yellow-400 transition duration-300;
}

.section {
  @apply py-12;
}

/* Hover effects */
.hover\:text-gold:hover {
  color: #FFD700;
}

/* Dark mode */
.dark {
  --bg: #111;
  --text: #fff;
  --gray-100: #333;
  @apply bg-gray-900 text-white;
}

/* Glassmorphism */
.glass {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
}

/* Gradient background */
.gradient-bg {
  background: linear-gradient(135deg, #9333ea, #FFD700, #4f46e5);
  background-size: 200% 200%;
  animation: gradientAnimation 15s ease infinite;
}

@keyframes gradientAnimation {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Blur and grainy effects */
.blur-bg {
  backdrop-filter: blur(5px);
}

.grainy {
  position: relative;
  overflow: hidden;
}

.grainy::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: url('/images/grain-texture.png') repeat;
  opacity: 0.05;
  pointer-events: none;
}

/* Bento grid */
.bento-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}

/* Prose for text uniformity */
.prose {
  @apply text-left max-w-3xl mx-auto text-gray-800;
}

@tailwind base;
@tailwind components;
@tailwind utilities;

@font-face {
  font-family: 'PlayfulSans';
  src: url('/fonts/playful-sans.woff2') format('woff2');
  font-weight: normal;
  font-style: normal;
}

.font-playful {
  font-family: 'PlayfulSans', sans-serif;
}

.font-serif {
  font-family: 'Georgia', serif;
}



@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 0 0% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 0 0% 3.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 0 0% 3.9%;
    --primary: 0 0% 9%;
    --primary-foreground: 0 0% 98%;
    --secondary: 0 0% 96.1%;
    --secondary-foreground: 0 0% 9%;
    --muted: 0 0% 96.1%;
    --muted-foreground: 0 0% 45.1%;
    --accent: 0 0% 96.1%;
    --accent-foreground: 0 0% 9%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 89.8%;
    --input: 0 0% 89.8%;
    --ring: 0 0% 3.9%;
    --chart-1: 12 76% 61%;
    --chart-2: 173 58% 39%;
    --chart-3: 197 37% 24%;
    --chart-4: 43 74% 66%;
    --chart-5: 27 87% 67%;
    --radius: 0.5rem;
  }
  .dark {
    --background: 0 0% 3.9%;
    --foreground: 0 0% 98%;
    --card: 0 0% 3.9%;
    --card-foreground: 0 0% 98%;
    --popover: 0 0% 3.9%;
    --popover-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 0 0% 9%;
    --secondary: 0 0% 14.9%;
    --secondary-foreground: 0 0% 98%;
    --muted: 0 0% 14.9%;
    --muted-foreground: 0 0% 63.9%;
    --accent: 0 0% 14.9%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 14.9%;
    --input: 0 0% 14.9%;
    --ring: 0 0% 83.1%;
    --chart-1: 220 70% 50%;
    --chart-2: 160 60% 45%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;
  }
}



@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}


===== FILE: tailwind.config.js  (size=1987 bytes) =====
/** @type {import('tailwindcss').Config} */
module.exports = {
    darkMode: ['class'],
    content: [
    './pages/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
  	extend: {
  		colors: {
  			yellow: {
  				'400': '#FFCA28',
  				'500': '#FFD700'
  			},
  			purple: {
  				'500': '#6A1B9A'
  			},
  			gray: {
  				'100': '#F5F5F5'
  			},
  			background: 'hsl(var(--background))',
  			foreground: 'hsl(var(--foreground))',
  			card: {
  				DEFAULT: 'hsl(var(--card))',
  				foreground: 'hsl(var(--card-foreground))'
  			},
  			popover: {
  				DEFAULT: 'hsl(var(--popover))',
  				foreground: 'hsl(var(--popover-foreground))'
  			},
  			primary: {
  				DEFAULT: 'hsl(var(--primary))',
  				foreground: 'hsl(var(--primary-foreground))'
  			},
  			secondary: {
  				DEFAULT: 'hsl(var(--secondary))',
  				foreground: 'hsl(var(--secondary-foreground))'
  			},
  			muted: {
  				DEFAULT: 'hsl(var(--muted))',
  				foreground: 'hsl(var(--muted-foreground))'
  			},
  			accent: {
  				DEFAULT: 'hsl(var(--accent))',
  				foreground: 'hsl(var(--accent-foreground))'
  			},
  			destructive: {
  				DEFAULT: 'hsl(var(--destructive))',
  				foreground: 'hsl(var(--destructive-foreground))'
  			},
  			border: 'hsl(var(--border))',
  			input: 'hsl(var(--input))',
  			ring: 'hsl(var(--ring))',
  			chart: {
  				'1': 'hsl(var(--chart-1))',
  				'2': 'hsl(var(--chart-2))',
  				'3': 'hsl(var(--chart-3))',
  				'4': 'hsl(var(--chart-4))',
  				'5': 'hsl(var(--chart-5))'
  			}
  		},
  		fontFamily: {
  			sans: [
  				'Roboto',
  				'sans-serif'
  			]
  		},
  		fontSize: {
  			'14px': '14px',
  			'16px': '16px',
  			'32px': '32px',
  			'36px': '36px',
  			'40px': '40px',
  			'48px': '48px'
  		},
  		borderRadius: {
  			lg: 'var(--radius)',
  			md: 'calc(var(--radius) - 2px)',
  			sm: 'calc(var(--radius) - 4px)'
  		}
  	}
  },
    plugins: [
    require('tailwindcss-animate'),
  ],
};


===== FILE: tsconfig.json  (size=605 bytes) =====
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", "**/*.js"],
  "exclude": ["node_modules"]
}
